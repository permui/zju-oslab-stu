{"config":{"indexing":"full","lang":["en"],"min_search_length":3,"prebuild_index":false,"separator":"[\\s\\-]+"},"docs":[{"location":"","text":"\u6d59\u6c5f\u5927\u5b6621\u5e74\u79cb\u64cd\u4f5c\u7cfb\u7edf\u5b9e\u9a8c \u672c \u4ed3\u5e93 \u662f\u6d59\u6c5f\u5927\u5b6621\u5e74\u79cb \u64cd\u4f5c\u7cfb\u7edf \u8bfe\u7a0b\u7684\u6559\u5b66\u4ed3\u5e93\uff0c\u5305\u542b\u5728\u64cd\u4f5c\u7cfb\u7edf\u8bfe\u7a0b\u4e0a\u6240\u6709\u7684\u5b9e\u9a8c\u6587\u6863\u548c\u516c\u5f00\u4ee3\u7801\u3002\u4ed3\u5e93\u76ee\u5f55\u7ed3\u6784\uff1a 1 2 3 4 \u251c\u2500\u2500 README.md \u251c\u2500\u2500 docs/ # \u5b9e\u9a8c\u6587\u6863 \u251c\u2500\u2500 mkdocs.yml \u2514\u2500\u2500 src/ # \u516c\u5f00\u4ee3\u7801 \u5b9e\u9a8c\u6587\u6863\u5df2\u7ecf\u90e8\u7f72\u5728\u4e86 gitee pages \u4e0a\uff0c\u65b9\u4fbf\u5927\u5bb6\u9605\u8bfb\u3002 \u672c\u5730\u6e32\u67d3\u6587\u6863 \u6587\u6863\u91c7\u7528\u4e86 mkdocs-material \u5de5\u5177\u6784\u5efa\u548c\u90e8\u7f72\u3002\u5982\u679c\u60f3\u5728\u672c\u5730\u6e32\u67d3\uff1a 1 2 3 4 5 6 7 $ pip3 install mkdocs-material # \u5b89\u88c5 mkdocs-material $ git clone https://gitee.com/zjusec/os21fall # clone \u672c repo $ mkdocs serve # \u672c\u5730\u6e32\u67d3 INFO - Building documentation... INFO - Cleaning site directory ... INFO - [ 11 :00:57 ] Serving on http://127.0.0.1:8000/os21fall/ \u81f4\u8c22 \u611f\u8c22\u4ee5\u4e0b\u5404\u4f4d\u8001\u5e08\u548c\u52a9\u6559\u7684\u8f9b\u52e4\u4ed8\u51fa\uff01 \u7533\u6587\u535a \u3001 \u5468\u4e9a\u91d1 \u3001\u5f90\u91d1\u7131\u3001\u5468\u4fa0\u3001\u7ba1\u7ae0\u8f89\u3001\u5f20\u6587\u9f99\u3001\u5218\u5f3a\u3001\u5b59\u5bb6\u680b\u3001\u5468\u5929\u6631\u3001\u5e84\u963f\u5f97\u3001\u738b\u7428\u3001\u6c88\u97ec\u7acb\u3001\u738b\u661f\u5b87\u3001\u6731\u749f\u68ee\u3001\u8c22\u6d35\u3001 \u6f58\u5b50\u66f0 \u3001\u6731\u82e5\u51e1\u3001\u5b63\u9ad8\u5f3a\u3001\u90ed\u82e5\u5bb9\u3001\u675c\u4e91\u6f47","title":"\u6d59\u6c5f\u5927\u5b6621\u5e74\u79cb\u64cd\u4f5c\u7cfb\u7edf\u5b9e\u9a8c"},{"location":"#21","text":"\u672c \u4ed3\u5e93 \u662f\u6d59\u6c5f\u5927\u5b6621\u5e74\u79cb \u64cd\u4f5c\u7cfb\u7edf \u8bfe\u7a0b\u7684\u6559\u5b66\u4ed3\u5e93\uff0c\u5305\u542b\u5728\u64cd\u4f5c\u7cfb\u7edf\u8bfe\u7a0b\u4e0a\u6240\u6709\u7684\u5b9e\u9a8c\u6587\u6863\u548c\u516c\u5f00\u4ee3\u7801\u3002\u4ed3\u5e93\u76ee\u5f55\u7ed3\u6784\uff1a 1 2 3 4 \u251c\u2500\u2500 README.md \u251c\u2500\u2500 docs/ # \u5b9e\u9a8c\u6587\u6863 \u251c\u2500\u2500 mkdocs.yml \u2514\u2500\u2500 src/ # \u516c\u5f00\u4ee3\u7801 \u5b9e\u9a8c\u6587\u6863\u5df2\u7ecf\u90e8\u7f72\u5728\u4e86 gitee pages \u4e0a\uff0c\u65b9\u4fbf\u5927\u5bb6\u9605\u8bfb\u3002","title":"\u6d59\u6c5f\u5927\u5b6621\u5e74\u79cb\u64cd\u4f5c\u7cfb\u7edf\u5b9e\u9a8c"},{"location":"#_1","text":"\u6587\u6863\u91c7\u7528\u4e86 mkdocs-material \u5de5\u5177\u6784\u5efa\u548c\u90e8\u7f72\u3002\u5982\u679c\u60f3\u5728\u672c\u5730\u6e32\u67d3\uff1a 1 2 3 4 5 6 7 $ pip3 install mkdocs-material # \u5b89\u88c5 mkdocs-material $ git clone https://gitee.com/zjusec/os21fall # clone \u672c repo $ mkdocs serve # \u672c\u5730\u6e32\u67d3 INFO - Building documentation... INFO - Cleaning site directory ... INFO - [ 11 :00:57 ] Serving on http://127.0.0.1:8000/os21fall/","title":"\u672c\u5730\u6e32\u67d3\u6587\u6863"},{"location":"#_2","text":"\u611f\u8c22\u4ee5\u4e0b\u5404\u4f4d\u8001\u5e08\u548c\u52a9\u6559\u7684\u8f9b\u52e4\u4ed8\u51fa\uff01 \u7533\u6587\u535a \u3001 \u5468\u4e9a\u91d1 \u3001\u5f90\u91d1\u7131\u3001\u5468\u4fa0\u3001\u7ba1\u7ae0\u8f89\u3001\u5f20\u6587\u9f99\u3001\u5218\u5f3a\u3001\u5b59\u5bb6\u680b\u3001\u5468\u5929\u6631\u3001\u5e84\u963f\u5f97\u3001\u738b\u7428\u3001\u6c88\u97ec\u7acb\u3001\u738b\u661f\u5b87\u3001\u6731\u749f\u68ee\u3001\u8c22\u6d35\u3001 \u6f58\u5b50\u66f0 \u3001\u6731\u82e5\u51e1\u3001\u5b63\u9ad8\u5f3a\u3001\u90ed\u82e5\u5bb9\u3001\u675c\u4e91\u6f47","title":"\u81f4\u8c22"},{"location":"faq/","text":"\u5e38\u89c1\u95ee\u9898\u53ca\u89e3\u7b54 Linux \u6e90\u7801\u653e\u5728\u5171\u4eab\u6587\u4ef6\u5939\u4e0b\u7f16\u8bd1\u5931\u8d25 1 Linux \u6e90\u7801\u653e\u5728\u5171\u4eab\u6587\u4ef6\u5939\u4e0b\u7f16\u8bd1\u5931\u8d25 \u8fd9\u79cd\u60c5\u51b5\u8bf7\u4f7f\u7528 wget \u7b49\u5de5\u5177\u5c06 Linux \u6e90\u7801\u4e0b\u8f7d\u81f3\u5bb9\u5668\u5185\u76ee\u5f55 \u800c\u975e\u5171\u4eab\u76ee\u5f55 \uff0c\u7136\u540e\u6267\u884c\u7f16\u8bd1\u3002 2 QEMU+GDB \u4f7f\u7528 si \u5355\u6307\u4ee4\u8c03\u8bd5\u9047\u5230\u6a21\u5f0f\u5207\u6362\u5931\u6548 \u5728\u9047\u5230\u8bf8\u5982 mret , sret \u7b49\u6307\u4ee4\u9020\u6210\u7684\u6a21\u5f0f\u5207\u6362\u65f6\uff0c si \u6307\u4ee4\u4f1a\u5931\u6548\uff0c\u53ef\u80fd\u8868\u73b0\u4e3a\u7a0b\u5e8f\u5f00\u59cb\u4e0d\u505c\u8dd1\uff0c\u5f71\u54cd\u5bf9\u7a0b\u5e8f\u8fd0\u884c\u884c\u4e3a\u7684\u5224\u65ad\u3002 \u4e00\u4e2a\u89e3\u51b3\u65b9\u6cd5\u662f\u5728\u7a0b\u5e8f \u9884\u671f\u8df3\u8f6c \u7684\u4f4d\u7f6e\u6253\u4e0a\u65ad\u70b9\uff0c\u65ad\u70b9\u4e0d\u4f1a\u53d7\u5230\u6a21\u5f0f\u5207\u6362\u7684\u5f71\u54cd\uff0c\u6bd4\u5982\uff1a 1 2 3 4 5 6 7 ( gdb ) i r sepc sepc 0x8000babe ( gdb ) b * 0x8000babe Breakpoint 1 at 0x8000babe ( gdb ) si # \u6216\u8005\u4f7f\u7528 c Breakpoint 1 , 0x000000008000babe in _never_gonna_give_you_up () ... \u8fd9\u6837\u5c31\u53ef\u4ee5\u770b\u5230\u65ad\u70b9\u88ab\u89e6\u53d1\uff0c\u53ef\u4ee5\u7ee7\u7eed\u8c03\u8bd5\u4e86\u3002","title":"\u5e38\u89c1\u95ee\u9898\u53ca\u89e3\u7b54"},{"location":"faq/#_1","text":"Linux \u6e90\u7801\u653e\u5728\u5171\u4eab\u6587\u4ef6\u5939\u4e0b\u7f16\u8bd1\u5931\u8d25","title":"\u5e38\u89c1\u95ee\u9898\u53ca\u89e3\u7b54"},{"location":"faq/#1-linux","text":"\u8fd9\u79cd\u60c5\u51b5\u8bf7\u4f7f\u7528 wget \u7b49\u5de5\u5177\u5c06 Linux \u6e90\u7801\u4e0b\u8f7d\u81f3\u5bb9\u5668\u5185\u76ee\u5f55 \u800c\u975e\u5171\u4eab\u76ee\u5f55 \uff0c\u7136\u540e\u6267\u884c\u7f16\u8bd1\u3002","title":"1 Linux \u6e90\u7801\u653e\u5728\u5171\u4eab\u6587\u4ef6\u5939\u4e0b\u7f16\u8bd1\u5931\u8d25"},{"location":"faq/#2-qemugdb-si","text":"\u5728\u9047\u5230\u8bf8\u5982 mret , sret \u7b49\u6307\u4ee4\u9020\u6210\u7684\u6a21\u5f0f\u5207\u6362\u65f6\uff0c si \u6307\u4ee4\u4f1a\u5931\u6548\uff0c\u53ef\u80fd\u8868\u73b0\u4e3a\u7a0b\u5e8f\u5f00\u59cb\u4e0d\u505c\u8dd1\uff0c\u5f71\u54cd\u5bf9\u7a0b\u5e8f\u8fd0\u884c\u884c\u4e3a\u7684\u5224\u65ad\u3002 \u4e00\u4e2a\u89e3\u51b3\u65b9\u6cd5\u662f\u5728\u7a0b\u5e8f \u9884\u671f\u8df3\u8f6c \u7684\u4f4d\u7f6e\u6253\u4e0a\u65ad\u70b9\uff0c\u65ad\u70b9\u4e0d\u4f1a\u53d7\u5230\u6a21\u5f0f\u5207\u6362\u7684\u5f71\u54cd\uff0c\u6bd4\u5982\uff1a 1 2 3 4 5 6 7 ( gdb ) i r sepc sepc 0x8000babe ( gdb ) b * 0x8000babe Breakpoint 1 at 0x8000babe ( gdb ) si # \u6216\u8005\u4f7f\u7528 c Breakpoint 1 , 0x000000008000babe in _never_gonna_give_you_up () ... \u8fd9\u6837\u5c31\u53ef\u4ee5\u770b\u5230\u65ad\u70b9\u88ab\u89e6\u53d1\uff0c\u53ef\u4ee5\u7ee7\u7eed\u8c03\u8bd5\u4e86\u3002","title":"2 QEMU+GDB \u4f7f\u7528 si \u5355\u6307\u4ee4\u8c03\u8bd5\u9047\u5230\u6a21\u5f0f\u5207\u6362\u5931\u6548"},{"location":"lab0/","text":"Lab 0: GDB + QEMU \u8c03\u8bd5 64 \u4f4d RISC-V LINUX 1 \u5b9e\u9a8c\u76ee\u7684 \u4e86\u89e3\u5bb9\u5668\u7684\u4f7f\u7528 \u4f7f\u7528\u4ea4\u53c9\u7f16\u8bd1\u5de5\u5177, \u5b8c\u6210Linux\u5185\u6838\u4ee3\u7801\u7f16\u8bd1 \u4f7f\u7528QEMU\u8fd0\u884c\u5185\u6838 \u719f\u6089GDB\u548cQEMU\u8054\u5408\u8c03\u8bd5 2 \u5b9e\u9a8c\u73af\u5883 Docker \u5b9e\u9a8c\u73af\u5883\u955c\u50cf \u4e0b\u8f7d\u5730\u5740 3 \u5b9e\u9a8c\u57fa\u7840\u77e5\u8bc6\u4ecb\u7ecd 3.1 Linux \u4f7f\u7528\u57fa\u7840 \u5728Linux\u73af\u5883\u4e0b\uff0c\u4eba\u4eec\u901a\u5e38\u4f7f\u7528\u547d\u4ee4\u884c\u63a5\u53e3\u6765\u5b8c\u6210\u4e0e\u8ba1\u7b97\u673a\u7684\u4ea4\u4e92\u3002\u7ec8\u7aef\uff08Terminal\uff09\u662f\u7528\u4e8e\u5904\u7406\u8be5\u8fc7\u7a0b\u7684\u4e00\u4e2a\u5e94\u7528\u7a0b\u5e8f\uff0c\u901a\u8fc7\u7ec8\u7aef\u4f60\u53ef\u4ee5\u8fd0\u884c\u5404\u79cd\u7a0b\u5e8f\u4ee5\u53ca\u5728\u81ea\u5df1\u7684\u8ba1\u7b97\u673a\u4e0a\u5904\u7406\u6587\u4ef6\u3002\u5728\u7c7bUnix\u7684\u64cd\u4f5c\u7cfb\u7edf\u4e0a\uff0c\u7ec8\u7aef\u53ef\u4ee5\u4e3a\u4f60\u5b8c\u6210\u4e00\u5207\u4f60\u6240\u9700\u8981\u7684\u64cd\u4f5c\u3002\u4e0b\u9762\u6211\u4eec\u4ec5\u5bf9\u5b9e\u9a8c\u4e2d\u6d89\u53ca\u7684\u4e00\u4e9b\u6982\u5ff5\u8fdb\u884c\u4ecb\u7ecd\uff0c\u4f60\u53ef\u4ee5\u901a\u8fc7\u4e0b\u9762\u7684\u94fe\u63a5\u6765\u5bf9\u547d\u4ee4\u884c\u7684\u4f7f\u7528\u8fdb\u884c\u5b66\u4e60\uff1a The Missing Semester of Your CS Education >>Video<< GNU/Linux Command-Line Tools Summary Basics of UNIX 3.2 Docker \u4f7f\u7528\u57fa\u7840 Docker \u57fa\u672c\u4ecb\u7ecd Docker \u662f\u4e00\u79cd\u5229\u7528\u5bb9\u5668\uff08container\uff09\u6765\u8fdb\u884c\u521b\u5efa\u3001\u90e8\u7f72\u548c\u8fd0\u884c\u5e94\u7528\u7684\u5de5\u5177\u3002Docker\u628a\u4e00\u4e2a\u5e94\u7528\u7a0b\u5e8f\u8fd0\u884c\u9700\u8981\u7684\u4e8c\u8fdb\u5236\u6587\u4ef6\u3001\u8fd0\u884c\u9700\u8981\u7684\u5e93\u4ee5\u53ca\u5176\u4ed6\u4f9d\u8d56\u6587\u4ef6\u6253\u5305\u4e3a\u4e00\u4e2a\u5305\uff08package\uff09\uff0c\u7136\u540e\u901a\u8fc7\u8be5\u5305\u521b\u5efa\u5bb9\u5668\u5e76\u8fd0\u884c\uff0c\u7531\u6b64\u88ab\u6253\u5305\u7684\u5e94\u7528\u4fbf\u6210\u529f\u8fd0\u884c\u5728\u4e86Docker\u5bb9\u5668\u4e2d\u3002\u4e4b\u6240\u4ee5\u8981\u628a\u5e94\u7528\u7a0b\u5e8f\u6253\u5305\uff0c\u5e76\u4ee5\u5bb9\u5668\u7684\u65b9\u5f0f\u8fd0\u884c\uff0c\u4e3b\u8981\u662f\u56e0\u4e3a\u5728\u751f\u4ea7\u5f00\u53d1\u73af\u5883\u4e2d\uff0c\u5e38\u5e38\u4f1a\u9047\u5230\u5e94\u7528\u7a0b\u5e8f\u548c\u7cfb\u7edf\u73af\u5883\u53d8\u91cf\u4ee5\u53ca\u4e00\u4e9b\u4f9d\u8d56\u7684\u5e93\u6587\u4ef6\u4e0d\u5339\u914d\uff0c\u5bfc\u81f4\u5e94\u7528\u65e0\u6cd5\u6b63\u5e38\u8fd0\u884c\u7684\u95ee\u9898\u3002Docker\u5e26\u6765\u7684\u597d\u5904\u662f\u53ea\u8981\u6211\u4eec\u5c06\u5e94\u7528\u7a0b\u5e8f\u6253\u5305\u5b8c\u6210\uff08\u7ec4\u88c5\u6210\u4e3aDocker imgae\uff09\uff0c\u5728\u4efb\u610f\u5b89\u88c5\u4e86Docker\u7684\u673a\u5668\u4e0a\uff0c\u90fd\u53ef\u4ee5\u901a\u8fc7\u8fd0\u884c\u5bb9\u5668\u7684\u65b9\u5f0f\u6765\u8fd0\u884c\u8be5\u5e94\u7528\u7a0b\u5e8f\uff0c\u56e0\u800c\u5c06\u4f9d\u8d56\u3001\u73af\u5883\u53d8\u91cf\u7b49\u5e26\u6765\u7684\u5e94\u7528\u90e8\u7f72\u95ee\u9898\u89e3\u51b3\u4e86\u3002 \u5982\u679c\u60f3\u4e86\u89e3\u66f4\u591a Docker \u7684\u8be6\u60c5\uff0c\u8bf7\u53c2\u8003 \u5b98\u7f51 \u3002 Docker \u5b89\u88c5 \u8bf7\u6839\u636e https://docs.docker.com/get-docker \u81ea\u884c\u5728\u672c\u673a\u5b89\u88c5 Docker \u73af\u5883\u3002\u4f60\u53ef\u4ee5\u4ece 2 \u5b9e\u9a8c\u73af\u5883 \u4e2d\u83b7\u5f97\u5b9e\u9a8c\u6240\u9700\u7684\u73af\u5883\uff0c\u6211\u4eec\u5df2\u7ecf\u4e3a\u4f60\u51c6\u5907\u597d\u4e86 RISC-V \u5de5\u5177\u94fe\uff0c\u4ee5\u53ca QEMU \u6a21\u62df\u5668\uff0c\u4f7f\u7528\u65b9\u6cd5\u8bf7\u53c2\u89c1 4 \u5b9e\u9a8c\u6b65\u9aa4 \u3002 3.3 QEMU \u4f7f\u7528\u57fa\u7840 \u4ec0\u4e48\u662fQEMU QEMU \u662f\u4e00\u4e2a\u529f\u80fd\u5f3a\u5927\u7684\u6a21\u62df\u5668\uff0c\u53ef\u4ee5\u5728 x86 \u5e73\u53f0\u4e0a\u6267\u884c\u4e0d\u540c\u67b6\u6784\u4e0b\u7684\u7a0b\u5e8f\u3002\u6211\u4eec\u5b9e\u9a8c\u4e2d\u91c7\u7528 QEMU \u6765\u5b8c\u6210 RISC-V \u67b6\u6784\u7684\u7a0b\u5e8f\u7684\u6a21\u62df\u3002 \u5982\u4f55\u4f7f\u7528 QEMU\uff08\u5e38\u89c1\u53c2\u6570\u4ecb\u7ecd\uff09 \u4ee5\u4ee5\u4e0b\u547d\u4ee4\u4e3a\u4f8b\uff0c\u6211\u4eec\u7b80\u5355\u4ecb\u7ecd QEMU \u7684\u53c2\u6570\u6240\u4ee3\u8868\u7684\u542b\u4e49 1 2 3 4 5 6 7 8 9 $ qemu-system-riscv64 \\ -nographic \\ -machine virt \\ -kernel path/to/linux/arch/riscv/boot/Image \\ -device virtio-blk-device,drive = hd0 \\ -append \"root=/dev/vda ro console=ttyS0\" \\ -bios default \\ -drive file = rootfs.img,format = raw,id = hd0 \\ -S -s -nographic : \u4e0d\u4f7f\u7528\u56fe\u5f62\u7a97\u53e3\uff0c\u4f7f\u7528\u547d\u4ee4\u884c -machine : \u6307\u5b9a\u8981emulate\u7684\u673a\u5668\uff0c\u53ef\u4ee5\u901a\u8fc7\u547d\u4ee4 qemu-system-riscv64 -machine help \u67e5\u770b\u53ef\u9009\u62e9\u7684\u673a\u5668\u9009\u9879 -kernel : \u6307\u5b9a\u5185\u6838image -append cmdline : \u4f7f\u7528cmdline\u4f5c\u4e3a\u5185\u6838\u7684\u547d\u4ee4\u884c -device : \u6307\u5b9a\u8981\u6a21\u62df\u7684\u8bbe\u5907\uff0c\u53ef\u4ee5\u901a\u8fc7\u547d\u4ee4 qemu-system-riscv64 -device help \u67e5\u770b\u53ef\u9009\u62e9\u7684\u8bbe\u5907\uff0c\u901a\u8fc7\u547d\u4ee4 qemu-system-riscv64 -device <\u5177\u4f53\u7684\u8bbe\u5907>,help \u67e5\u770b\u67d0\u4e2a\u8bbe\u5907\u7684\u547d\u4ee4\u9009\u9879 -drive, file=<file_name> : \u4f7f\u7528 file_name \u4f5c\u4e3a\u6587\u4ef6\u7cfb\u7edf -S : \u542f\u52a8\u65f6\u6682\u505cCPU\u6267\u884c -s : -gdb tcp::1234 \u7684\u7b80\u5199 -bios default : \u4f7f\u7528\u9ed8\u8ba4\u7684 OpenSBI firmware \u4f5c\u4e3a bootloader \u66f4\u591a\u53c2\u6570\u4fe1\u606f\u53ef\u4ee5\u53c2\u8003 \u8fd9\u91cc 3.4 GDB \u4f7f\u7528\u57fa\u7840 \u4ec0\u4e48\u662f GDB GNU \u8c03\u8bd5\u5668\uff08\u82f1\u8bed\uff1aGNU Debugger\uff0c\u7f29\u5199\uff1agdb\uff09\u662f\u4e00\u4e2a\u7531 GNU \u5f00\u6e90\u7ec4\u7ec7\u53d1\u5e03\u7684\u3001UNIX/LINUX\u64cd\u4f5c\u7cfb\u7edf\u4e0b\u7684\u3001\u57fa\u4e8e\u547d\u4ee4\u884c\u7684\u3001\u529f\u80fd\u5f3a\u5927\u7684\u7a0b\u5e8f\u8c03\u8bd5\u5de5\u5177\u3002\u501f\u52a9\u8c03\u8bd5\u5668\uff0c\u6211\u4eec\u80fd\u591f\u67e5\u770b\u53e6\u4e00\u4e2a\u7a0b\u5e8f\u5728\u6267\u884c\u65f6\u5b9e\u9645\u5728\u505a\u4ec0\u4e48\uff08\u6bd4\u5982\u8bbf\u95ee\u54ea\u4e9b\u5185\u5b58\u3001\u5bc4\u5b58\u5668\uff09\uff0c\u5728\u5176\u4ed6\u7a0b\u5e8f\u5d29\u6e83\u7684\u65f6\u5019\u53ef\u4ee5\u6bd4\u8f83\u5feb\u901f\u5730\u4e86\u89e3\u5bfc\u81f4\u7a0b\u5e8f\u5d29\u6e83\u7684\u539f\u56e0\u3002 \u88ab\u8c03\u8bd5\u7684\u7a0b\u5e8f\u53ef\u4ee5\u662f\u548cgdb\u5728\u540c\u4e00\u53f0\u673a\u5668\u4e0a\uff08\u672c\u5730\u8c03\u8bd5\uff0cor native debug\uff09\uff0c\u4e5f\u53ef\u4ee5\u662f\u4e0d\u540c\u673a\u5668\u4e0a\uff08\u8fdc\u7a0b\u8c03\u8bd5\uff0c or remote debug\uff09\u3002 \u603b\u7684\u6765\u8bf4\uff0cgdb\u53ef\u4ee5\u6709\u4ee5\u4e0b4\u4e2a\u529f\u80fd\uff1a \u542f\u52a8\u7a0b\u5e8f\uff0c\u5e76\u6307\u5b9a\u53ef\u80fd\u5f71\u54cd\u5176\u884c\u4e3a\u7684\u6240\u6709\u5185\u5bb9 \u4f7f\u7a0b\u5e8f\u5728\u6307\u5b9a\u6761\u4ef6\u4e0b\u505c\u6b62 \u68c0\u67e5\u7a0b\u5e8f\u505c\u6b62\u65f6\u53d1\u751f\u4e86\u4ec0\u4e48 \u66f4\u6539\u7a0b\u5e8f\u4e2d\u7684\u5185\u5bb9\uff0c\u4ee5\u4fbf\u7ea0\u6b63\u4e00\u4e2abug\u7684\u5f71\u54cd GDB \u57fa\u672c\u547d\u4ee4\u4ecb\u7ecd (gdb) layout asm: \u663e\u793a\u6c47\u7f16\u4ee3\u7801 (gdb) start: \u5355\u6b65\u6267\u884c\uff0c\u8fd0\u884c\u7a0b\u5e8f\uff0c\u505c\u5728\u7b2c\u4e00\u6267\u884c\u8bed\u53e5 (gdb) continue: \u4ece\u65ad\u70b9\u540e\u7ee7\u7eed\u6267\u884c\uff0c\u7b80\u5199 c (gdb) next: \u5355\u6b65\u8c03\u8bd5\uff08\u9010\u8fc7\u7a0b\uff0c\u51fd\u6570\u76f4\u63a5\u6267\u884c\uff09\uff0c\u7b80\u5199 n (gdb) step instruction: \u6267\u884c\u5355\u6761\u6307\u4ee4\uff0c\u7b80\u5199 si (gdb) run: \u91cd\u65b0\u5f00\u59cb\u8fd0\u884c\u6587\u4ef6\uff08run-text\uff1a\u52a0\u8f7d\u6587\u672c\u6587\u4ef6\uff0crun-bin\uff1a\u52a0\u8f7d\u4e8c\u8fdb\u5236\u6587\u4ef6\uff09\uff0c\u7b80\u5199 r (gdb) backtrace\uff1a\u67e5\u770b\u51fd\u6570\u7684\u8c03\u7528\u7684\u6808\u5e27\u548c\u5c42\u7ea7\u5173\u7cfb\uff0c\u7b80\u5199 bt (gdb) break \u8bbe\u7f6e\u65ad\u70b9\uff0c\u7b80\u5199 b \u65ad\u5728 foo \u51fd\u6570\uff1a b foo \u65ad\u5728\u67d0\u5730\u5740: b * 0x80200000 (gdb) finish: \u7ed3\u675f\u5f53\u524d\u51fd\u6570\uff0c\u8fd4\u56de\u5230\u51fd\u6570\u8c03\u7528\u70b9 (gdb) frame: \u5207\u6362\u51fd\u6570\u7684\u6808\u5e27\uff0c\u7b80\u5199 f (gdb) print: \u6253\u5370\u503c\u53ca\u5730\u5740\uff0c\u7b80\u5199 p (gdb) info\uff1a\u67e5\u770b\u51fd\u6570\u5185\u90e8\u5c40\u90e8\u53d8\u91cf\u7684\u6570\u503c\uff0c\u7b80\u5199 i \u67e5\u770b\u5bc4\u5b58\u5668 ra \u7684\u503c\uff1a i r ra (gdb) display\uff1a\u8ffd\u8e2a\u67e5\u770b\u5177\u4f53\u53d8\u91cf\u503c (gdb) x/4x : \u4ee5 16 \u8fdb\u5236\u6253\u5370 \u5904\u5f00\u59cb\u7684 16 Bytes \u5185\u5bb9 \u66f4\u591a\u547d\u4ee4\u53ef\u4ee5\u53c2\u8003 100\u4e2agdb\u5c0f\u6280\u5de7 3.5 Linux \u5185\u6838\u7f16\u8bd1\u57fa\u7840 \u4ea4\u53c9\u7f16\u8bd1 \u4ea4\u53c9\u7f16\u8bd1\u6307\u7684\u662f\u5728\u4e00\u4e2a\u5e73\u53f0\u4e0a\u7f16\u8bd1\u53ef\u4ee5\u5728\u53e6\u4e00\u4e2a\u67b6\u6784\u8fd0\u884c\u7684\u7a0b\u5e8f\u3002\u4f8b\u5982\u5728 x86 \u673a\u5668\u4e0a\u7f16\u8bd1\u53ef\u4ee5\u5728 RISC-V \u67b6\u6784\u8fd0\u884c\u7684\u7a0b\u5e8f\uff0c\u4ea4\u53c9\u7f16\u8bd1\u9700\u8981\u4ea4\u53c9\u7f16\u8bd1\u5de5\u5177\u94fe\u7684\u652f\u6301\uff0c\u5728\u6211\u4eec\u7684\u5b9e\u9a8c\u4e2d\u6240\u7528\u7684\u4ea4\u53c9\u7f16\u8bd1\u5de5\u5177\u94fe\u5c31\u662f riscv-gnu-toolchain \u3002 \u5185\u6838\u914d\u7f6e \u5185\u6838\u914d\u7f6e\u662f\u7528\u4e8e\u914d\u7f6e\u662f\u5426\u542f\u7528\u5185\u6838\u7684\u5404\u9879\u7279\u6027\uff0c\u5185\u6838\u4f1a\u63d0\u4f9b\u4e00\u4e2a\u540d\u4e3a defconfig (\u5373default configuration) \u7684\u9ed8\u8ba4\u914d\u7f6e\uff0c\u8be5\u914d\u7f6e\u6587\u4ef6\u4f4d\u4e8e\u5404\u4e2a\u67b6\u6784\u76ee\u5f55\u7684 configs \u6587\u4ef6\u5939\u4e0b\uff0c\u4f8b\u5982\u5bf9\u4e8eRISC-V\u800c\u8a00\uff0c\u5176\u9ed8\u8ba4\u914d\u7f6e\u6587\u4ef6\u4e3a arch/riscv/configs/defconfig \u3002\u4f7f\u7528 make ARCH=riscv defconfig \u547d\u4ee4\u53ef\u4ee5\u5728\u5185\u6838\u6839\u76ee\u5f55\u4e0b\u751f\u6210\u4e00\u4e2a\u540d\u4e3a .config \u7684\u6587\u4ef6\uff0c\u5305\u542b\u4e86\u5185\u6838\u5b8c\u6574\u7684\u914d\u7f6e\uff0c\u5185\u6838\u5728\u7f16\u8bd1\u65f6\u4f1a\u6839\u636e .config \u8fdb\u884c\u7f16\u8bd1\u3002\u914d\u7f6e\u4e4b\u95f4\u5b58\u5728\u76f8\u4e92\u7684\u4f9d\u8d56\u5173\u7cfb\uff0c\u76f4\u63a5\u4fee\u6539defconfig\u6587\u4ef6\u6216\u8005 .config \u6709\u65f6\u5019\u5e76\u4e0d\u80fd\u8fbe\u5230\u60f3\u8981\u7684\u6548\u679c\u3002\u56e0\u6b64\u5982\u679c\u9700\u8981\u4fee\u6539\u914d\u7f6e\u4e00\u822c\u91c7\u7528 make ARCH=riscv menuconfig \u7684\u65b9\u5f0f\u5bf9\u5185\u6838\u8fdb\u884c\u914d\u7f6e\u3002 \u5e38\u89c1\u53c2\u6570 ARCH \u6307\u5b9a\u67b6\u6784\uff0c\u53ef\u9009\u7684\u503c\u5305\u62ecarch\u76ee\u5f55\u4e0b\u7684\u6587\u4ef6\u5939\u540d\uff0c\u5982 x86\u3001arm\u3001arm64 \u7b49\uff0c\u4e0d\u540c\u4e8e arm \u548c arm64\uff0c32 \u4f4d\u548c 64 \u4f4d\u7684RISC-V\u5171\u7528 arch/riscv \u76ee\u5f55\uff0c\u901a\u8fc7\u4f7f\u7528\u4e0d\u540c\u7684 config \u53ef\u4ee5\u7f16\u8bd1 32 \u4f4d\u6216 64 \u4f4d\u7684\u5185\u6838\u3002 CROSS_COMPILE \u6307\u5b9a\u4f7f\u7528\u7684\u4ea4\u53c9\u7f16\u8bd1\u5de5\u5177\u94fe\uff0c\u4f8b\u5982\u6307\u5b9a CROSS_COMPILE=riscv64-unknown-linux-gnu- \uff0c\u5219\u7f16\u8bd1\u65f6\u4f1a\u91c7\u7528 riscv64-unknown-linux-gnu-gcc \u4f5c\u4e3a\u7f16\u8bd1\u5668\uff0c\u7f16\u8bd1\u53ef\u4ee5\u5728 RISC-V 64 \u4f4d\u5e73\u53f0\u4e0a\u8fd0\u884c\u7684 kernel\u3002 \u5e38\u7528\u7684 Linux \u4e0b\u7684\u7f16\u8bd1\u9009\u9879 1 2 3 4 5 6 7 8 9 10 $ make help # \u67e5\u770bmake\u547d\u4ee4\u7684\u5404\u79cd\u53c2\u6570\u89e3\u91ca $ make defconfig # \u4f7f\u7528\u5f53\u524d\u5e73\u53f0\u7684\u9ed8\u8ba4\u914d\u7f6e\uff0c\u5728x86\u673a\u5668\u4e0a\u4f1a\u4f7f\u7528x86\u7684\u9ed8\u8ba4\u914d\u7f6e $ make -j $( nproc ) # \u7f16\u8bd1\u5f53\u524d\u5e73\u53f0\u7684\u5185\u6838\uff0c-j$(nproc) \u4e3a\u4ee5\u5168\u90e8\u673a\u5668\u786c\u4ef6\u7ebf\u7a0b\u6570\u8fdb\u884c\u591a\u7ebf\u7a0b\u7f16\u8bd1 $ make -j4 # \u7f16\u8bd1\u5f53\u524d\u5e73\u53f0\u7684\u5185\u6838\uff0c-j4 \u4e3a\u4f7f\u7528 4 \u7ebf\u7a0b\u8fdb\u884c\u591a\u7ebf\u7a0b\u7f16\u8bd1 $ make ARCH = riscv defconfig # \u4f7f\u7528 RISC-V \u5e73\u53f0\u7684\u9ed8\u8ba4\u914d\u7f6e $ make ARCH = riscv CROSS_COMPILE = riscv64-linux-gnu- -j $( nproc ) # \u7f16\u8bd1 RISC-V \u5e73\u53f0\u5185\u6838 $ make clean # \u6e05\u9664\u6240\u6709\u7f16\u8bd1\u597d\u7684 object \u6587\u4ef6 4 \u5b9e\u9a8c\u6b65\u9aa4 \u5728\u6267\u884c\u6bcf\u4e00\u6761\u547d\u4ee4\u524d\uff0c\u8bf7\u4f60\u5bf9\u5c06\u8981\u8fdb\u884c\u7684\u64cd\u4f5c\u8fdb\u884c\u601d\u8003\uff0c\u7ed9\u51fa\u7684\u547d\u4ee4\u4e0d\u9700\u8981\u5168\u90e8\u6267\u884c\uff0c\u5e76\u4e14\u4e0d\u662f\u6240\u6709\u7684\u547d\u4ee4\u90fd\u53ef\u4ee5\u65e0\u6761\u4ef6\u6267\u884c\uff0c\u8bf7\u4e0d\u8981\u76f4\u63a5\u590d\u5236\u7c98\u8d34\u547d\u4ee4\u53bb\u6267\u884c\u3002 4.1 \u642d\u5efa Docker \u73af\u5883 \u8bf7\u6839\u636e 3.2 Docker \u4f7f\u7528\u57fa\u7840 \u5b89\u88c5 Docker \u73af\u5883\u3002\u7136\u540e \u53c2\u8003\u5e76\u7406\u89e3 \u4ee5\u4e0b\u6b65\u9aa4\uff0c\u5bfc\u5165\u6211\u4eec\u5df2\u7ecf\u51c6\u5907\u597d\u7684 Docker \u955c\u50cf\uff1a 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 # \u5bfc\u5165docker\u955c\u50cf $ cat oslab.tar | docker import - oslab:2021 # \u67e5\u770bdocker\u955c\u50cf $ docker images REPOSITORY TAG IMAGE ID CREATED SIZE oslab latest b2b39a3bcd81 404 days ago 3 .62GB # \u4ece\u955c\u50cf\u521b\u5efa\u4e00\u4e2a\u5bb9\u5668 $ docker run --name oslab -it oslab:2021 bash # --name:\u5bb9\u5668\u540d\u79f0 -i:\u4ea4\u4e92\u5f0f\u64cd\u4f5c -t:\u7ec8\u7aef root@132a140bd724:/# # \u63d0\u793a\u7b26\u53d8\u4e3a '#' \u8868\u660e\u6210\u529f\u8fdb\u5165\u5bb9\u5668 \u540e\u9762\u7684\u5b57\u7b26\u4e32\u6839\u636e\u5bb9\u5668\u800c\u751f\u6210\uff0c\u4e3a\u5bb9\u5668id root@132a140bd724:/# exit ( or CTRL+D ) # \u4ece\u5bb9\u5668\u4e2d\u9000\u51fa \u6b64\u65f6\u8fd0\u884cdocker ps\uff0c\u8fd0\u884c\u5bb9\u5668\u7684\u5217\u8868\u4e3a\u7a7a # \u542f\u52a8\u5904\u4e8e\u505c\u6b62\u72b6\u6001\u7684\u5bb9\u5668 $ docker start oslab # oslab\u4e3a\u5bb9\u5668\u540d\u79f0 $ docker ps # \u53ef\u770b\u5230\u5bb9\u5668\u5df2\u7ecf\u542f\u52a8 CONTAINER ID IMAGE COMMAND CREATED STATUS PORTS NAMES 132a140bd724 oslab:2021 \"bash\" About a minute ago Up 1 second oslab # \u4ece\u7ec8\u7aef\u8fde\u5165 docker \u5bb9\u5668 $ docker exec -it oslab bash # \u6302\u8f7d\u672c\u5730\u76ee\u5f55 # \u628a\u7528\u6237\u7684 home \u76ee\u5f55\u6620\u5c04\u5230 docker \u955c\u50cf\u5185\u7684 have-fun-debugging \u76ee\u5f55 $ docker run --name oslab -it -v ${ HOME } :/have-fun-debugging oslab:2021 bash # -v \u672c\u5730\u76ee\u5f55:\u5bb9\u5668\u5185\u76ee\u5f55 4.2 \u83b7\u53d6 Linux \u6e90\u7801\u548c\u5df2\u7ecf\u7f16\u8bd1\u597d\u7684\u6587\u4ef6\u7cfb\u7edf \u4ece https://www.kernel.org \u4e0b\u8f7d\u6700\u65b0\u7684 Linux \u6e90\u7801\u3002 \u5e76\u4e14\u4f7f\u7528 git \u5de5\u5177 clone \u672c\u4ed3\u5e93 \u3002\u5176\u4e2d\u5df2\u7ecf\u51c6\u5907\u597d\u4e86\u6839\u6587\u4ef6\u7cfb\u7edf\u7684\u955c\u50cf\u3002 \u6839\u6587\u4ef6\u7cfb\u7edf\u4e3a Linux Kenrel \u63d0\u4f9b\u4e86\u57fa\u7840\u7684\u6587\u4ef6\u670d\u52a1\uff0c\u5728\u542f\u52a8 Linux Kernel \u65f6\u662f\u5fc5\u8981\u7684\u3002 1 2 3 4 $ git clone https://gitee.com/zjusec/os21fall $ cd os21fall/src/lab0 $ ls rootfs.img # \u5df2\u7ecf\u6784\u5efa\u5b8c\u6210\u7684\u6839\u6587\u4ef6\u7cfb\u7edf\u7684\u955c\u50cf 4.3 \u7f16\u8bd1 linux \u5185\u6838 1 2 3 4 $ pwd path/to/lab0/linux $ make ARCH = riscv CROSS_COMPILE = riscv64-unknown-linux-gnu- defconfig # \u751f\u6210\u914d\u7f6e $ make ARCH = riscv CROSS_COMPILE = riscv64-unknown-linux-gnu- -j $( nproc ) # \u7f16\u8bd1 \u4f7f\u7528\u591a\u7ebf\u7a0b\u7f16\u8bd1\u4e00\u822c\u4f1a\u8017\u8d39\u5927\u91cf\u5185\u5b58\uff0c\u5982\u679c -j \u9009\u9879\u5bfc\u81f4\u5185\u5b58\u8017\u5c3d (out of memory)\uff0c\u8bf7\u5c1d\u8bd5\u8c03\u4f4e\u7ebf\u7a0b\u6570\uff0c\u6bd4\u5982 -j4 , -j8 \u7b49\u3002 4.4 \u4f7f\u7528QEMU\u8fd0\u884c\u5185\u6838 1 2 3 $ qemu-system-riscv64 -nographic -machine virt -kernel path/to/linux/arch/riscv/boot/Image \\ -device virtio-blk-device,drive = hd0 -append \"root=/dev/vda ro console=ttyS0\" \\ -bios default -drive file = rootfs.img,format = raw,id = hd0 \u9000\u51fa QEMU \u7684\u65b9\u6cd5\u4e3a\uff1a\u4f7f\u7528 Ctrl+A\uff0c \u677e\u5f00 \u540e\u518d\u6309\u4e0b X \u952e\u5373\u53ef\u9000\u51fa QEMU\u3002 4.5 \u4f7f\u7528 GDB \u5bf9\u5185\u6838\u8fdb\u884c\u8c03\u8bd5 \u8fd9\u4e00\u6b65\u9700\u8981\u5f00\u542f\u4e24\u4e2a Terminal Session\uff0c\u4e00\u4e2a Terminal \u4f7f\u7528 QEMU \u542f\u52a8 Linux\uff0c\u53e6\u4e00\u4e2a Terminal \u4f7f\u7528 GDB \u4e0e QEMU \u8fdc\u7a0b\u901a\u4fe1\uff08\u4f7f\u7528 tcp::1234 \u7aef\u53e3\uff09\u8fdb\u884c\u8c03\u8bd5\u3002 1 2 3 4 5 6 7 8 9 10 11 # Terminal 1 $ qemu-system-riscv64 -nographic -machine virt -kernel path/to/linux/arch/riscv/boot/Image \\ -device virtio-blk-device,drive = hd0 -append \"root=/dev/vda ro console=ttyS0\" \\ -bios default -drive file = rootfs.img,format = raw,id = hd0 -S -s # Terminal 2 $ riscv64-unknown-linux-gnu-gdb path/to/linux/vmlinux ( gdb ) target remote :1234 # \u8fde\u63a5 qemu ( gdb ) b start_kernel # \u8bbe\u7f6e\u65ad\u70b9 ( gdb ) continue # \u7ee7\u7eed\u6267\u884c ( gdb ) quit # \u9000\u51fa gdb 5 \u5b9e\u9a8c\u4efb\u52a1\u4e0e\u8981\u6c42 \u8bf7\u5404\u4f4d\u540c\u5b66\u72ec\u7acb\u5b8c\u6210\u4f5c\u4e1a\uff0c\u4efb\u4f55\u6284\u88ad\u884c\u4e3a\u90fd\u5c06\u4f7f\u672c\u6b21\u4f5c\u4e1a\u5224\u4e3a0\u5206\u3002 \u7f16\u8bd1\u5185\u6838\u5e76\u7528 GDB + QEMU \u8c03\u8bd5\uff0c\u5728\u5185\u6838\u521d\u59cb\u5316\u8fc7\u7a0b\u4e2d\u8bbe\u7f6e\u65ad\u70b9\uff0c\u5bf9\u5185\u6838\u7684\u542f\u52a8\u8fc7\u7a0b\u8fdb\u884c\u8ddf\u8e2a\uff0c\u5e76\u5c1d\u8bd5\u4f7f\u7528gdb\u7684\u5404\u9879\u547d\u4ee4\uff08\u5982backtrace\u3001finish\u3001frame\u3001info\u3001break\u3001display\u3001next\u3001layout\u7b49\uff09\u3002 \u5728\u5b66\u5728\u6d59\u5927\u4e2d\u63d0\u4ea4 pdf \u683c\u5f0f\u7684\u5b9e\u9a8c\u62a5\u544a\uff0c\u8bb0\u5f55\u5b9e\u9a8c\u8fc7\u7a0b\u5e76\u622a\u56fe\uff084.1-4.4\uff09.\uff0c\u5bf9\u6bcf\u4e00\u6b65\u7684\u547d\u4ee4\u4ee5\u53ca\u7ed3\u679c\u8fdb\u884c\u5fc5\u8981\u7684\u89e3\u91ca\uff0c\u8bb0\u5f55\u9047\u5230\u7684\u95ee\u9898\u548c\u5fc3\u5f97\u4f53\u4f1a\u3002 \u601d\u8003\u9898 \u4f7f\u7528 riscv64-unknown-elf-gcc \u7f16\u8bd1\u5355\u4e2a .c \u6587\u4ef6 \u4f7f\u7528 riscv64-unknown-elf-objdump \u53cd\u6c47\u7f16 1 \u4e2d\u5f97\u5230\u7684\u7f16\u8bd1\u4ea7\u7269 \u8c03\u8bd5 Linux \u65f6: \u5728 GDB \u4e2d\u67e5\u770b\u6c47\u7f16\u4ee3\u7801 \u5728 0x80000000 \u5904\u4e0b\u65ad\u70b9 \u67e5\u770b\u6240\u6709\u5df2\u4e0b\u7684\u65ad\u70b9 \u5728 0x80200000 \u5904\u4e0b\u65ad\u70b9 \u6e05\u9664 0x80000000 \u5904\u7684\u65ad\u70b9 \u7ee7\u7eed\u8fd0\u884c\u76f4\u5230\u89e6\u53d1 0x80200000 \u5904\u7684\u65ad\u70b9 \u5355\u6b65\u8c03\u8bd5\u4e00\u6b21 \u9000\u51fa QEMU \u4f7f\u7528 make \u5de5\u5177\u6e05\u9664 Linux \u7684\u6784\u5efa\u4ea7\u7269 vmlinux \u548c Image \u7684\u5173\u7cfb\u548c\u533a\u522b\u662f\u4ec0\u4e48\uff1f","title":"\u5b9e\u9a8c\u6307\u5bfc\u96f6"},{"location":"lab0/#lab-0-gdb-qemu-64-risc-v-linux","text":"","title":"Lab 0: GDB + QEMU \u8c03\u8bd5 64 \u4f4d RISC-V LINUX"},{"location":"lab0/#1","text":"\u4e86\u89e3\u5bb9\u5668\u7684\u4f7f\u7528 \u4f7f\u7528\u4ea4\u53c9\u7f16\u8bd1\u5de5\u5177, \u5b8c\u6210Linux\u5185\u6838\u4ee3\u7801\u7f16\u8bd1 \u4f7f\u7528QEMU\u8fd0\u884c\u5185\u6838 \u719f\u6089GDB\u548cQEMU\u8054\u5408\u8c03\u8bd5","title":"1 \u5b9e\u9a8c\u76ee\u7684"},{"location":"lab0/#2","text":"Docker \u5b9e\u9a8c\u73af\u5883\u955c\u50cf \u4e0b\u8f7d\u5730\u5740","title":"2 \u5b9e\u9a8c\u73af\u5883"},{"location":"lab0/#3","text":"","title":"3 \u5b9e\u9a8c\u57fa\u7840\u77e5\u8bc6\u4ecb\u7ecd"},{"location":"lab0/#31-linux","text":"\u5728Linux\u73af\u5883\u4e0b\uff0c\u4eba\u4eec\u901a\u5e38\u4f7f\u7528\u547d\u4ee4\u884c\u63a5\u53e3\u6765\u5b8c\u6210\u4e0e\u8ba1\u7b97\u673a\u7684\u4ea4\u4e92\u3002\u7ec8\u7aef\uff08Terminal\uff09\u662f\u7528\u4e8e\u5904\u7406\u8be5\u8fc7\u7a0b\u7684\u4e00\u4e2a\u5e94\u7528\u7a0b\u5e8f\uff0c\u901a\u8fc7\u7ec8\u7aef\u4f60\u53ef\u4ee5\u8fd0\u884c\u5404\u79cd\u7a0b\u5e8f\u4ee5\u53ca\u5728\u81ea\u5df1\u7684\u8ba1\u7b97\u673a\u4e0a\u5904\u7406\u6587\u4ef6\u3002\u5728\u7c7bUnix\u7684\u64cd\u4f5c\u7cfb\u7edf\u4e0a\uff0c\u7ec8\u7aef\u53ef\u4ee5\u4e3a\u4f60\u5b8c\u6210\u4e00\u5207\u4f60\u6240\u9700\u8981\u7684\u64cd\u4f5c\u3002\u4e0b\u9762\u6211\u4eec\u4ec5\u5bf9\u5b9e\u9a8c\u4e2d\u6d89\u53ca\u7684\u4e00\u4e9b\u6982\u5ff5\u8fdb\u884c\u4ecb\u7ecd\uff0c\u4f60\u53ef\u4ee5\u901a\u8fc7\u4e0b\u9762\u7684\u94fe\u63a5\u6765\u5bf9\u547d\u4ee4\u884c\u7684\u4f7f\u7528\u8fdb\u884c\u5b66\u4e60\uff1a The Missing Semester of Your CS Education >>Video<< GNU/Linux Command-Line Tools Summary Basics of UNIX","title":"3.1 Linux \u4f7f\u7528\u57fa\u7840"},{"location":"lab0/#32-docker","text":"","title":"3.2 Docker \u4f7f\u7528\u57fa\u7840"},{"location":"lab0/#docker","text":"Docker \u662f\u4e00\u79cd\u5229\u7528\u5bb9\u5668\uff08container\uff09\u6765\u8fdb\u884c\u521b\u5efa\u3001\u90e8\u7f72\u548c\u8fd0\u884c\u5e94\u7528\u7684\u5de5\u5177\u3002Docker\u628a\u4e00\u4e2a\u5e94\u7528\u7a0b\u5e8f\u8fd0\u884c\u9700\u8981\u7684\u4e8c\u8fdb\u5236\u6587\u4ef6\u3001\u8fd0\u884c\u9700\u8981\u7684\u5e93\u4ee5\u53ca\u5176\u4ed6\u4f9d\u8d56\u6587\u4ef6\u6253\u5305\u4e3a\u4e00\u4e2a\u5305\uff08package\uff09\uff0c\u7136\u540e\u901a\u8fc7\u8be5\u5305\u521b\u5efa\u5bb9\u5668\u5e76\u8fd0\u884c\uff0c\u7531\u6b64\u88ab\u6253\u5305\u7684\u5e94\u7528\u4fbf\u6210\u529f\u8fd0\u884c\u5728\u4e86Docker\u5bb9\u5668\u4e2d\u3002\u4e4b\u6240\u4ee5\u8981\u628a\u5e94\u7528\u7a0b\u5e8f\u6253\u5305\uff0c\u5e76\u4ee5\u5bb9\u5668\u7684\u65b9\u5f0f\u8fd0\u884c\uff0c\u4e3b\u8981\u662f\u56e0\u4e3a\u5728\u751f\u4ea7\u5f00\u53d1\u73af\u5883\u4e2d\uff0c\u5e38\u5e38\u4f1a\u9047\u5230\u5e94\u7528\u7a0b\u5e8f\u548c\u7cfb\u7edf\u73af\u5883\u53d8\u91cf\u4ee5\u53ca\u4e00\u4e9b\u4f9d\u8d56\u7684\u5e93\u6587\u4ef6\u4e0d\u5339\u914d\uff0c\u5bfc\u81f4\u5e94\u7528\u65e0\u6cd5\u6b63\u5e38\u8fd0\u884c\u7684\u95ee\u9898\u3002Docker\u5e26\u6765\u7684\u597d\u5904\u662f\u53ea\u8981\u6211\u4eec\u5c06\u5e94\u7528\u7a0b\u5e8f\u6253\u5305\u5b8c\u6210\uff08\u7ec4\u88c5\u6210\u4e3aDocker imgae\uff09\uff0c\u5728\u4efb\u610f\u5b89\u88c5\u4e86Docker\u7684\u673a\u5668\u4e0a\uff0c\u90fd\u53ef\u4ee5\u901a\u8fc7\u8fd0\u884c\u5bb9\u5668\u7684\u65b9\u5f0f\u6765\u8fd0\u884c\u8be5\u5e94\u7528\u7a0b\u5e8f\uff0c\u56e0\u800c\u5c06\u4f9d\u8d56\u3001\u73af\u5883\u53d8\u91cf\u7b49\u5e26\u6765\u7684\u5e94\u7528\u90e8\u7f72\u95ee\u9898\u89e3\u51b3\u4e86\u3002 \u5982\u679c\u60f3\u4e86\u89e3\u66f4\u591a Docker \u7684\u8be6\u60c5\uff0c\u8bf7\u53c2\u8003 \u5b98\u7f51 \u3002","title":"Docker \u57fa\u672c\u4ecb\u7ecd"},{"location":"lab0/#docker_1","text":"\u8bf7\u6839\u636e https://docs.docker.com/get-docker \u81ea\u884c\u5728\u672c\u673a\u5b89\u88c5 Docker \u73af\u5883\u3002\u4f60\u53ef\u4ee5\u4ece 2 \u5b9e\u9a8c\u73af\u5883 \u4e2d\u83b7\u5f97\u5b9e\u9a8c\u6240\u9700\u7684\u73af\u5883\uff0c\u6211\u4eec\u5df2\u7ecf\u4e3a\u4f60\u51c6\u5907\u597d\u4e86 RISC-V \u5de5\u5177\u94fe\uff0c\u4ee5\u53ca QEMU \u6a21\u62df\u5668\uff0c\u4f7f\u7528\u65b9\u6cd5\u8bf7\u53c2\u89c1 4 \u5b9e\u9a8c\u6b65\u9aa4 \u3002","title":"Docker \u5b89\u88c5"},{"location":"lab0/#33-qemu","text":"","title":"3.3 QEMU \u4f7f\u7528\u57fa\u7840"},{"location":"lab0/#qemu","text":"QEMU \u662f\u4e00\u4e2a\u529f\u80fd\u5f3a\u5927\u7684\u6a21\u62df\u5668\uff0c\u53ef\u4ee5\u5728 x86 \u5e73\u53f0\u4e0a\u6267\u884c\u4e0d\u540c\u67b6\u6784\u4e0b\u7684\u7a0b\u5e8f\u3002\u6211\u4eec\u5b9e\u9a8c\u4e2d\u91c7\u7528 QEMU \u6765\u5b8c\u6210 RISC-V \u67b6\u6784\u7684\u7a0b\u5e8f\u7684\u6a21\u62df\u3002","title":"\u4ec0\u4e48\u662fQEMU"},{"location":"lab0/#qemu_1","text":"\u4ee5\u4ee5\u4e0b\u547d\u4ee4\u4e3a\u4f8b\uff0c\u6211\u4eec\u7b80\u5355\u4ecb\u7ecd QEMU \u7684\u53c2\u6570\u6240\u4ee3\u8868\u7684\u542b\u4e49 1 2 3 4 5 6 7 8 9 $ qemu-system-riscv64 \\ -nographic \\ -machine virt \\ -kernel path/to/linux/arch/riscv/boot/Image \\ -device virtio-blk-device,drive = hd0 \\ -append \"root=/dev/vda ro console=ttyS0\" \\ -bios default \\ -drive file = rootfs.img,format = raw,id = hd0 \\ -S -s -nographic : \u4e0d\u4f7f\u7528\u56fe\u5f62\u7a97\u53e3\uff0c\u4f7f\u7528\u547d\u4ee4\u884c -machine : \u6307\u5b9a\u8981emulate\u7684\u673a\u5668\uff0c\u53ef\u4ee5\u901a\u8fc7\u547d\u4ee4 qemu-system-riscv64 -machine help \u67e5\u770b\u53ef\u9009\u62e9\u7684\u673a\u5668\u9009\u9879 -kernel : \u6307\u5b9a\u5185\u6838image -append cmdline : \u4f7f\u7528cmdline\u4f5c\u4e3a\u5185\u6838\u7684\u547d\u4ee4\u884c -device : \u6307\u5b9a\u8981\u6a21\u62df\u7684\u8bbe\u5907\uff0c\u53ef\u4ee5\u901a\u8fc7\u547d\u4ee4 qemu-system-riscv64 -device help \u67e5\u770b\u53ef\u9009\u62e9\u7684\u8bbe\u5907\uff0c\u901a\u8fc7\u547d\u4ee4 qemu-system-riscv64 -device <\u5177\u4f53\u7684\u8bbe\u5907>,help \u67e5\u770b\u67d0\u4e2a\u8bbe\u5907\u7684\u547d\u4ee4\u9009\u9879 -drive, file=<file_name> : \u4f7f\u7528 file_name \u4f5c\u4e3a\u6587\u4ef6\u7cfb\u7edf -S : \u542f\u52a8\u65f6\u6682\u505cCPU\u6267\u884c -s : -gdb tcp::1234 \u7684\u7b80\u5199 -bios default : \u4f7f\u7528\u9ed8\u8ba4\u7684 OpenSBI firmware \u4f5c\u4e3a bootloader \u66f4\u591a\u53c2\u6570\u4fe1\u606f\u53ef\u4ee5\u53c2\u8003 \u8fd9\u91cc","title":"\u5982\u4f55\u4f7f\u7528 QEMU\uff08\u5e38\u89c1\u53c2\u6570\u4ecb\u7ecd\uff09"},{"location":"lab0/#34-gdb","text":"","title":"3.4 GDB \u4f7f\u7528\u57fa\u7840"},{"location":"lab0/#gdb","text":"GNU \u8c03\u8bd5\u5668\uff08\u82f1\u8bed\uff1aGNU Debugger\uff0c\u7f29\u5199\uff1agdb\uff09\u662f\u4e00\u4e2a\u7531 GNU \u5f00\u6e90\u7ec4\u7ec7\u53d1\u5e03\u7684\u3001UNIX/LINUX\u64cd\u4f5c\u7cfb\u7edf\u4e0b\u7684\u3001\u57fa\u4e8e\u547d\u4ee4\u884c\u7684\u3001\u529f\u80fd\u5f3a\u5927\u7684\u7a0b\u5e8f\u8c03\u8bd5\u5de5\u5177\u3002\u501f\u52a9\u8c03\u8bd5\u5668\uff0c\u6211\u4eec\u80fd\u591f\u67e5\u770b\u53e6\u4e00\u4e2a\u7a0b\u5e8f\u5728\u6267\u884c\u65f6\u5b9e\u9645\u5728\u505a\u4ec0\u4e48\uff08\u6bd4\u5982\u8bbf\u95ee\u54ea\u4e9b\u5185\u5b58\u3001\u5bc4\u5b58\u5668\uff09\uff0c\u5728\u5176\u4ed6\u7a0b\u5e8f\u5d29\u6e83\u7684\u65f6\u5019\u53ef\u4ee5\u6bd4\u8f83\u5feb\u901f\u5730\u4e86\u89e3\u5bfc\u81f4\u7a0b\u5e8f\u5d29\u6e83\u7684\u539f\u56e0\u3002 \u88ab\u8c03\u8bd5\u7684\u7a0b\u5e8f\u53ef\u4ee5\u662f\u548cgdb\u5728\u540c\u4e00\u53f0\u673a\u5668\u4e0a\uff08\u672c\u5730\u8c03\u8bd5\uff0cor native debug\uff09\uff0c\u4e5f\u53ef\u4ee5\u662f\u4e0d\u540c\u673a\u5668\u4e0a\uff08\u8fdc\u7a0b\u8c03\u8bd5\uff0c or remote debug\uff09\u3002 \u603b\u7684\u6765\u8bf4\uff0cgdb\u53ef\u4ee5\u6709\u4ee5\u4e0b4\u4e2a\u529f\u80fd\uff1a \u542f\u52a8\u7a0b\u5e8f\uff0c\u5e76\u6307\u5b9a\u53ef\u80fd\u5f71\u54cd\u5176\u884c\u4e3a\u7684\u6240\u6709\u5185\u5bb9 \u4f7f\u7a0b\u5e8f\u5728\u6307\u5b9a\u6761\u4ef6\u4e0b\u505c\u6b62 \u68c0\u67e5\u7a0b\u5e8f\u505c\u6b62\u65f6\u53d1\u751f\u4e86\u4ec0\u4e48 \u66f4\u6539\u7a0b\u5e8f\u4e2d\u7684\u5185\u5bb9\uff0c\u4ee5\u4fbf\u7ea0\u6b63\u4e00\u4e2abug\u7684\u5f71\u54cd","title":"\u4ec0\u4e48\u662f GDB"},{"location":"lab0/#gdb_1","text":"(gdb) layout asm: \u663e\u793a\u6c47\u7f16\u4ee3\u7801 (gdb) start: \u5355\u6b65\u6267\u884c\uff0c\u8fd0\u884c\u7a0b\u5e8f\uff0c\u505c\u5728\u7b2c\u4e00\u6267\u884c\u8bed\u53e5 (gdb) continue: \u4ece\u65ad\u70b9\u540e\u7ee7\u7eed\u6267\u884c\uff0c\u7b80\u5199 c (gdb) next: \u5355\u6b65\u8c03\u8bd5\uff08\u9010\u8fc7\u7a0b\uff0c\u51fd\u6570\u76f4\u63a5\u6267\u884c\uff09\uff0c\u7b80\u5199 n (gdb) step instruction: \u6267\u884c\u5355\u6761\u6307\u4ee4\uff0c\u7b80\u5199 si (gdb) run: \u91cd\u65b0\u5f00\u59cb\u8fd0\u884c\u6587\u4ef6\uff08run-text\uff1a\u52a0\u8f7d\u6587\u672c\u6587\u4ef6\uff0crun-bin\uff1a\u52a0\u8f7d\u4e8c\u8fdb\u5236\u6587\u4ef6\uff09\uff0c\u7b80\u5199 r (gdb) backtrace\uff1a\u67e5\u770b\u51fd\u6570\u7684\u8c03\u7528\u7684\u6808\u5e27\u548c\u5c42\u7ea7\u5173\u7cfb\uff0c\u7b80\u5199 bt (gdb) break \u8bbe\u7f6e\u65ad\u70b9\uff0c\u7b80\u5199 b \u65ad\u5728 foo \u51fd\u6570\uff1a b foo \u65ad\u5728\u67d0\u5730\u5740: b * 0x80200000 (gdb) finish: \u7ed3\u675f\u5f53\u524d\u51fd\u6570\uff0c\u8fd4\u56de\u5230\u51fd\u6570\u8c03\u7528\u70b9 (gdb) frame: \u5207\u6362\u51fd\u6570\u7684\u6808\u5e27\uff0c\u7b80\u5199 f (gdb) print: \u6253\u5370\u503c\u53ca\u5730\u5740\uff0c\u7b80\u5199 p (gdb) info\uff1a\u67e5\u770b\u51fd\u6570\u5185\u90e8\u5c40\u90e8\u53d8\u91cf\u7684\u6570\u503c\uff0c\u7b80\u5199 i \u67e5\u770b\u5bc4\u5b58\u5668 ra \u7684\u503c\uff1a i r ra (gdb) display\uff1a\u8ffd\u8e2a\u67e5\u770b\u5177\u4f53\u53d8\u91cf\u503c (gdb) x/4x : \u4ee5 16 \u8fdb\u5236\u6253\u5370 \u5904\u5f00\u59cb\u7684 16 Bytes \u5185\u5bb9 \u66f4\u591a\u547d\u4ee4\u53ef\u4ee5\u53c2\u8003 100\u4e2agdb\u5c0f\u6280\u5de7","title":"GDB \u57fa\u672c\u547d\u4ee4\u4ecb\u7ecd"},{"location":"lab0/#35-linux","text":"","title":"3.5 Linux \u5185\u6838\u7f16\u8bd1\u57fa\u7840"},{"location":"lab0/#_1","text":"\u4ea4\u53c9\u7f16\u8bd1\u6307\u7684\u662f\u5728\u4e00\u4e2a\u5e73\u53f0\u4e0a\u7f16\u8bd1\u53ef\u4ee5\u5728\u53e6\u4e00\u4e2a\u67b6\u6784\u8fd0\u884c\u7684\u7a0b\u5e8f\u3002\u4f8b\u5982\u5728 x86 \u673a\u5668\u4e0a\u7f16\u8bd1\u53ef\u4ee5\u5728 RISC-V \u67b6\u6784\u8fd0\u884c\u7684\u7a0b\u5e8f\uff0c\u4ea4\u53c9\u7f16\u8bd1\u9700\u8981\u4ea4\u53c9\u7f16\u8bd1\u5de5\u5177\u94fe\u7684\u652f\u6301\uff0c\u5728\u6211\u4eec\u7684\u5b9e\u9a8c\u4e2d\u6240\u7528\u7684\u4ea4\u53c9\u7f16\u8bd1\u5de5\u5177\u94fe\u5c31\u662f riscv-gnu-toolchain \u3002","title":"\u4ea4\u53c9\u7f16\u8bd1"},{"location":"lab0/#_2","text":"\u5185\u6838\u914d\u7f6e\u662f\u7528\u4e8e\u914d\u7f6e\u662f\u5426\u542f\u7528\u5185\u6838\u7684\u5404\u9879\u7279\u6027\uff0c\u5185\u6838\u4f1a\u63d0\u4f9b\u4e00\u4e2a\u540d\u4e3a defconfig (\u5373default configuration) \u7684\u9ed8\u8ba4\u914d\u7f6e\uff0c\u8be5\u914d\u7f6e\u6587\u4ef6\u4f4d\u4e8e\u5404\u4e2a\u67b6\u6784\u76ee\u5f55\u7684 configs \u6587\u4ef6\u5939\u4e0b\uff0c\u4f8b\u5982\u5bf9\u4e8eRISC-V\u800c\u8a00\uff0c\u5176\u9ed8\u8ba4\u914d\u7f6e\u6587\u4ef6\u4e3a arch/riscv/configs/defconfig \u3002\u4f7f\u7528 make ARCH=riscv defconfig \u547d\u4ee4\u53ef\u4ee5\u5728\u5185\u6838\u6839\u76ee\u5f55\u4e0b\u751f\u6210\u4e00\u4e2a\u540d\u4e3a .config \u7684\u6587\u4ef6\uff0c\u5305\u542b\u4e86\u5185\u6838\u5b8c\u6574\u7684\u914d\u7f6e\uff0c\u5185\u6838\u5728\u7f16\u8bd1\u65f6\u4f1a\u6839\u636e .config \u8fdb\u884c\u7f16\u8bd1\u3002\u914d\u7f6e\u4e4b\u95f4\u5b58\u5728\u76f8\u4e92\u7684\u4f9d\u8d56\u5173\u7cfb\uff0c\u76f4\u63a5\u4fee\u6539defconfig\u6587\u4ef6\u6216\u8005 .config \u6709\u65f6\u5019\u5e76\u4e0d\u80fd\u8fbe\u5230\u60f3\u8981\u7684\u6548\u679c\u3002\u56e0\u6b64\u5982\u679c\u9700\u8981\u4fee\u6539\u914d\u7f6e\u4e00\u822c\u91c7\u7528 make ARCH=riscv menuconfig \u7684\u65b9\u5f0f\u5bf9\u5185\u6838\u8fdb\u884c\u914d\u7f6e\u3002","title":"\u5185\u6838\u914d\u7f6e"},{"location":"lab0/#_3","text":"ARCH \u6307\u5b9a\u67b6\u6784\uff0c\u53ef\u9009\u7684\u503c\u5305\u62ecarch\u76ee\u5f55\u4e0b\u7684\u6587\u4ef6\u5939\u540d\uff0c\u5982 x86\u3001arm\u3001arm64 \u7b49\uff0c\u4e0d\u540c\u4e8e arm \u548c arm64\uff0c32 \u4f4d\u548c 64 \u4f4d\u7684RISC-V\u5171\u7528 arch/riscv \u76ee\u5f55\uff0c\u901a\u8fc7\u4f7f\u7528\u4e0d\u540c\u7684 config \u53ef\u4ee5\u7f16\u8bd1 32 \u4f4d\u6216 64 \u4f4d\u7684\u5185\u6838\u3002 CROSS_COMPILE \u6307\u5b9a\u4f7f\u7528\u7684\u4ea4\u53c9\u7f16\u8bd1\u5de5\u5177\u94fe\uff0c\u4f8b\u5982\u6307\u5b9a CROSS_COMPILE=riscv64-unknown-linux-gnu- \uff0c\u5219\u7f16\u8bd1\u65f6\u4f1a\u91c7\u7528 riscv64-unknown-linux-gnu-gcc \u4f5c\u4e3a\u7f16\u8bd1\u5668\uff0c\u7f16\u8bd1\u53ef\u4ee5\u5728 RISC-V 64 \u4f4d\u5e73\u53f0\u4e0a\u8fd0\u884c\u7684 kernel\u3002","title":"\u5e38\u89c1\u53c2\u6570"},{"location":"lab0/#linux","text":"1 2 3 4 5 6 7 8 9 10 $ make help # \u67e5\u770bmake\u547d\u4ee4\u7684\u5404\u79cd\u53c2\u6570\u89e3\u91ca $ make defconfig # \u4f7f\u7528\u5f53\u524d\u5e73\u53f0\u7684\u9ed8\u8ba4\u914d\u7f6e\uff0c\u5728x86\u673a\u5668\u4e0a\u4f1a\u4f7f\u7528x86\u7684\u9ed8\u8ba4\u914d\u7f6e $ make -j $( nproc ) # \u7f16\u8bd1\u5f53\u524d\u5e73\u53f0\u7684\u5185\u6838\uff0c-j$(nproc) \u4e3a\u4ee5\u5168\u90e8\u673a\u5668\u786c\u4ef6\u7ebf\u7a0b\u6570\u8fdb\u884c\u591a\u7ebf\u7a0b\u7f16\u8bd1 $ make -j4 # \u7f16\u8bd1\u5f53\u524d\u5e73\u53f0\u7684\u5185\u6838\uff0c-j4 \u4e3a\u4f7f\u7528 4 \u7ebf\u7a0b\u8fdb\u884c\u591a\u7ebf\u7a0b\u7f16\u8bd1 $ make ARCH = riscv defconfig # \u4f7f\u7528 RISC-V \u5e73\u53f0\u7684\u9ed8\u8ba4\u914d\u7f6e $ make ARCH = riscv CROSS_COMPILE = riscv64-linux-gnu- -j $( nproc ) # \u7f16\u8bd1 RISC-V \u5e73\u53f0\u5185\u6838 $ make clean # \u6e05\u9664\u6240\u6709\u7f16\u8bd1\u597d\u7684 object \u6587\u4ef6","title":"\u5e38\u7528\u7684 Linux \u4e0b\u7684\u7f16\u8bd1\u9009\u9879"},{"location":"lab0/#4","text":"\u5728\u6267\u884c\u6bcf\u4e00\u6761\u547d\u4ee4\u524d\uff0c\u8bf7\u4f60\u5bf9\u5c06\u8981\u8fdb\u884c\u7684\u64cd\u4f5c\u8fdb\u884c\u601d\u8003\uff0c\u7ed9\u51fa\u7684\u547d\u4ee4\u4e0d\u9700\u8981\u5168\u90e8\u6267\u884c\uff0c\u5e76\u4e14\u4e0d\u662f\u6240\u6709\u7684\u547d\u4ee4\u90fd\u53ef\u4ee5\u65e0\u6761\u4ef6\u6267\u884c\uff0c\u8bf7\u4e0d\u8981\u76f4\u63a5\u590d\u5236\u7c98\u8d34\u547d\u4ee4\u53bb\u6267\u884c\u3002","title":"4 \u5b9e\u9a8c\u6b65\u9aa4"},{"location":"lab0/#41-docker","text":"\u8bf7\u6839\u636e 3.2 Docker \u4f7f\u7528\u57fa\u7840 \u5b89\u88c5 Docker \u73af\u5883\u3002\u7136\u540e \u53c2\u8003\u5e76\u7406\u89e3 \u4ee5\u4e0b\u6b65\u9aa4\uff0c\u5bfc\u5165\u6211\u4eec\u5df2\u7ecf\u51c6\u5907\u597d\u7684 Docker \u955c\u50cf\uff1a 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 # \u5bfc\u5165docker\u955c\u50cf $ cat oslab.tar | docker import - oslab:2021 # \u67e5\u770bdocker\u955c\u50cf $ docker images REPOSITORY TAG IMAGE ID CREATED SIZE oslab latest b2b39a3bcd81 404 days ago 3 .62GB # \u4ece\u955c\u50cf\u521b\u5efa\u4e00\u4e2a\u5bb9\u5668 $ docker run --name oslab -it oslab:2021 bash # --name:\u5bb9\u5668\u540d\u79f0 -i:\u4ea4\u4e92\u5f0f\u64cd\u4f5c -t:\u7ec8\u7aef root@132a140bd724:/# # \u63d0\u793a\u7b26\u53d8\u4e3a '#' \u8868\u660e\u6210\u529f\u8fdb\u5165\u5bb9\u5668 \u540e\u9762\u7684\u5b57\u7b26\u4e32\u6839\u636e\u5bb9\u5668\u800c\u751f\u6210\uff0c\u4e3a\u5bb9\u5668id root@132a140bd724:/# exit ( or CTRL+D ) # \u4ece\u5bb9\u5668\u4e2d\u9000\u51fa \u6b64\u65f6\u8fd0\u884cdocker ps\uff0c\u8fd0\u884c\u5bb9\u5668\u7684\u5217\u8868\u4e3a\u7a7a # \u542f\u52a8\u5904\u4e8e\u505c\u6b62\u72b6\u6001\u7684\u5bb9\u5668 $ docker start oslab # oslab\u4e3a\u5bb9\u5668\u540d\u79f0 $ docker ps # \u53ef\u770b\u5230\u5bb9\u5668\u5df2\u7ecf\u542f\u52a8 CONTAINER ID IMAGE COMMAND CREATED STATUS PORTS NAMES 132a140bd724 oslab:2021 \"bash\" About a minute ago Up 1 second oslab # \u4ece\u7ec8\u7aef\u8fde\u5165 docker \u5bb9\u5668 $ docker exec -it oslab bash # \u6302\u8f7d\u672c\u5730\u76ee\u5f55 # \u628a\u7528\u6237\u7684 home \u76ee\u5f55\u6620\u5c04\u5230 docker \u955c\u50cf\u5185\u7684 have-fun-debugging \u76ee\u5f55 $ docker run --name oslab -it -v ${ HOME } :/have-fun-debugging oslab:2021 bash # -v \u672c\u5730\u76ee\u5f55:\u5bb9\u5668\u5185\u76ee\u5f55","title":"4.1 \u642d\u5efa Docker \u73af\u5883"},{"location":"lab0/#42-linux","text":"\u4ece https://www.kernel.org \u4e0b\u8f7d\u6700\u65b0\u7684 Linux \u6e90\u7801\u3002 \u5e76\u4e14\u4f7f\u7528 git \u5de5\u5177 clone \u672c\u4ed3\u5e93 \u3002\u5176\u4e2d\u5df2\u7ecf\u51c6\u5907\u597d\u4e86\u6839\u6587\u4ef6\u7cfb\u7edf\u7684\u955c\u50cf\u3002 \u6839\u6587\u4ef6\u7cfb\u7edf\u4e3a Linux Kenrel \u63d0\u4f9b\u4e86\u57fa\u7840\u7684\u6587\u4ef6\u670d\u52a1\uff0c\u5728\u542f\u52a8 Linux Kernel \u65f6\u662f\u5fc5\u8981\u7684\u3002 1 2 3 4 $ git clone https://gitee.com/zjusec/os21fall $ cd os21fall/src/lab0 $ ls rootfs.img # \u5df2\u7ecf\u6784\u5efa\u5b8c\u6210\u7684\u6839\u6587\u4ef6\u7cfb\u7edf\u7684\u955c\u50cf","title":"4.2 \u83b7\u53d6 Linux \u6e90\u7801\u548c\u5df2\u7ecf\u7f16\u8bd1\u597d\u7684\u6587\u4ef6\u7cfb\u7edf"},{"location":"lab0/#43-linux","text":"1 2 3 4 $ pwd path/to/lab0/linux $ make ARCH = riscv CROSS_COMPILE = riscv64-unknown-linux-gnu- defconfig # \u751f\u6210\u914d\u7f6e $ make ARCH = riscv CROSS_COMPILE = riscv64-unknown-linux-gnu- -j $( nproc ) # \u7f16\u8bd1 \u4f7f\u7528\u591a\u7ebf\u7a0b\u7f16\u8bd1\u4e00\u822c\u4f1a\u8017\u8d39\u5927\u91cf\u5185\u5b58\uff0c\u5982\u679c -j \u9009\u9879\u5bfc\u81f4\u5185\u5b58\u8017\u5c3d (out of memory)\uff0c\u8bf7\u5c1d\u8bd5\u8c03\u4f4e\u7ebf\u7a0b\u6570\uff0c\u6bd4\u5982 -j4 , -j8 \u7b49\u3002","title":"4.3 \u7f16\u8bd1 linux \u5185\u6838"},{"location":"lab0/#44-qemu","text":"1 2 3 $ qemu-system-riscv64 -nographic -machine virt -kernel path/to/linux/arch/riscv/boot/Image \\ -device virtio-blk-device,drive = hd0 -append \"root=/dev/vda ro console=ttyS0\" \\ -bios default -drive file = rootfs.img,format = raw,id = hd0 \u9000\u51fa QEMU \u7684\u65b9\u6cd5\u4e3a\uff1a\u4f7f\u7528 Ctrl+A\uff0c \u677e\u5f00 \u540e\u518d\u6309\u4e0b X \u952e\u5373\u53ef\u9000\u51fa QEMU\u3002","title":"4.4 \u4f7f\u7528QEMU\u8fd0\u884c\u5185\u6838"},{"location":"lab0/#45-gdb","text":"\u8fd9\u4e00\u6b65\u9700\u8981\u5f00\u542f\u4e24\u4e2a Terminal Session\uff0c\u4e00\u4e2a Terminal \u4f7f\u7528 QEMU \u542f\u52a8 Linux\uff0c\u53e6\u4e00\u4e2a Terminal \u4f7f\u7528 GDB \u4e0e QEMU \u8fdc\u7a0b\u901a\u4fe1\uff08\u4f7f\u7528 tcp::1234 \u7aef\u53e3\uff09\u8fdb\u884c\u8c03\u8bd5\u3002 1 2 3 4 5 6 7 8 9 10 11 # Terminal 1 $ qemu-system-riscv64 -nographic -machine virt -kernel path/to/linux/arch/riscv/boot/Image \\ -device virtio-blk-device,drive = hd0 -append \"root=/dev/vda ro console=ttyS0\" \\ -bios default -drive file = rootfs.img,format = raw,id = hd0 -S -s # Terminal 2 $ riscv64-unknown-linux-gnu-gdb path/to/linux/vmlinux ( gdb ) target remote :1234 # \u8fde\u63a5 qemu ( gdb ) b start_kernel # \u8bbe\u7f6e\u65ad\u70b9 ( gdb ) continue # \u7ee7\u7eed\u6267\u884c ( gdb ) quit # \u9000\u51fa gdb","title":"4.5 \u4f7f\u7528 GDB \u5bf9\u5185\u6838\u8fdb\u884c\u8c03\u8bd5"},{"location":"lab0/#5","text":"\u8bf7\u5404\u4f4d\u540c\u5b66\u72ec\u7acb\u5b8c\u6210\u4f5c\u4e1a\uff0c\u4efb\u4f55\u6284\u88ad\u884c\u4e3a\u90fd\u5c06\u4f7f\u672c\u6b21\u4f5c\u4e1a\u5224\u4e3a0\u5206\u3002 \u7f16\u8bd1\u5185\u6838\u5e76\u7528 GDB + QEMU \u8c03\u8bd5\uff0c\u5728\u5185\u6838\u521d\u59cb\u5316\u8fc7\u7a0b\u4e2d\u8bbe\u7f6e\u65ad\u70b9\uff0c\u5bf9\u5185\u6838\u7684\u542f\u52a8\u8fc7\u7a0b\u8fdb\u884c\u8ddf\u8e2a\uff0c\u5e76\u5c1d\u8bd5\u4f7f\u7528gdb\u7684\u5404\u9879\u547d\u4ee4\uff08\u5982backtrace\u3001finish\u3001frame\u3001info\u3001break\u3001display\u3001next\u3001layout\u7b49\uff09\u3002 \u5728\u5b66\u5728\u6d59\u5927\u4e2d\u63d0\u4ea4 pdf \u683c\u5f0f\u7684\u5b9e\u9a8c\u62a5\u544a\uff0c\u8bb0\u5f55\u5b9e\u9a8c\u8fc7\u7a0b\u5e76\u622a\u56fe\uff084.1-4.4\uff09.\uff0c\u5bf9\u6bcf\u4e00\u6b65\u7684\u547d\u4ee4\u4ee5\u53ca\u7ed3\u679c\u8fdb\u884c\u5fc5\u8981\u7684\u89e3\u91ca\uff0c\u8bb0\u5f55\u9047\u5230\u7684\u95ee\u9898\u548c\u5fc3\u5f97\u4f53\u4f1a\u3002","title":"5 \u5b9e\u9a8c\u4efb\u52a1\u4e0e\u8981\u6c42"},{"location":"lab0/#_4","text":"\u4f7f\u7528 riscv64-unknown-elf-gcc \u7f16\u8bd1\u5355\u4e2a .c \u6587\u4ef6 \u4f7f\u7528 riscv64-unknown-elf-objdump \u53cd\u6c47\u7f16 1 \u4e2d\u5f97\u5230\u7684\u7f16\u8bd1\u4ea7\u7269 \u8c03\u8bd5 Linux \u65f6: \u5728 GDB \u4e2d\u67e5\u770b\u6c47\u7f16\u4ee3\u7801 \u5728 0x80000000 \u5904\u4e0b\u65ad\u70b9 \u67e5\u770b\u6240\u6709\u5df2\u4e0b\u7684\u65ad\u70b9 \u5728 0x80200000 \u5904\u4e0b\u65ad\u70b9 \u6e05\u9664 0x80000000 \u5904\u7684\u65ad\u70b9 \u7ee7\u7eed\u8fd0\u884c\u76f4\u5230\u89e6\u53d1 0x80200000 \u5904\u7684\u65ad\u70b9 \u5355\u6b65\u8c03\u8bd5\u4e00\u6b21 \u9000\u51fa QEMU \u4f7f\u7528 make \u5de5\u5177\u6e05\u9664 Linux \u7684\u6784\u5efa\u4ea7\u7269 vmlinux \u548c Image \u7684\u5173\u7cfb\u548c\u533a\u522b\u662f\u4ec0\u4e48\uff1f","title":"\u601d\u8003\u9898"},{"location":"lab1/","text":"Lab 1: RV64 \u5185\u6838\u5f15\u5bfc 1 \u5b9e\u9a8c\u76ee\u7684 \u5b66\u4e60 RISC-V \u6c47\u7f16\uff0c \u7f16\u5199 head.S \u5b9e\u73b0\u8df3\u8f6c\u5230\u5185\u6838\u8fd0\u884c\u7684\u7b2c\u4e00\u4e2a C \u51fd\u6570\u3002 \u5b66\u4e60 OpenSBI\uff0c\u7406\u89e3 OpenSBI \u5728\u5b9e\u9a8c\u4e2d\u6240\u8d77\u5230\u7684\u4f5c\u7528\uff0c\u5e76\u8c03\u7528 OpenSBI \u63d0\u4f9b\u7684\u63a5\u53e3\u5b8c\u6210\u5b57\u7b26\u7684\u8f93\u51fa\u3002 \u5b66\u4e60 Makefile \u76f8\u5173\u77e5\u8bc6\uff0c \u8865\u5145\u9879\u76ee\u4e2d\u7684 Makefile \u6587\u4ef6\uff0c \u6765\u5b8c\u6210\u5bf9\u6574\u4e2a\u5de5\u7a0b\u7684\u7ba1\u7406\u3002 2 \u5b9e\u9a8c\u73af\u5883 Docker in Lab0 3 \u5b9e\u9a8c\u57fa\u7840\u77e5\u8bc6\u4ecb\u7ecd 3.1 \u524d\u7f6e\u77e5\u8bc6 \u4e3a\u4e86\u987a\u5229\u5b8c\u6210 OS \u5b9e\u9a8c\uff0c\u6211\u4eec\u9700\u8981\u4e00\u4e9b\u524d\u7f6e\u77e5\u8bc6\u548c\u8f83\u591a\u8c03\u8bd5\u6280\u5de7\u3002\u5728 OS \u5b9e\u9a8c\u4e2d\u6211\u4eec\u9700\u8981 RISC-V\u6c47\u7f16 \u7684\u524d\u7f6e\u77e5\u8bc6\uff0c\u8bfe\u5802\u4e0a\u4e0d\u4f1a\u8bb2\u6388\uff0c\u8bf7\u540c\u5b66\u4eec\u901a\u8fc7\u9605\u8bfb\u4ee5\u4e0b\u56db\u4efd\u6587\u6863\u81ea\u5b66\uff1a RISC-V Assembly Programmer's Manual RISC-V Unprivileged Spec RISC-V Privileged Spec RISC-V \u624b\u518c\uff08\u4e2d\u6587\uff09 \u6ce8\uff1aRISC-V \u624b\u518c\uff08\u4e2d\u6587\uff09\u4e2d\u6709\u4e00\u4e9b Typo\uff0c\u8bf7\u8c28\u614e\u53c2\u8003\u3002 3.2 RISC-V \u7684\u4e09\u79cd\u7279\u6743\u6a21\u5f0f RISC-V \u6709\u4e09\u4e2a\u7279\u6743\u6a21\u5f0f\uff1aU (user) \u6a21\u5f0f\u3001S (supervisor) \u6a21\u5f0f\u548c M (machine) \u6a21\u5f0f\u3002 Level Encoding Name Abbreviation 0 00 User/Application U 1 01 Supervisor S 2 10 Reserved 3 11 Machine M \u5176\u4e2d\uff1a M \u6a21\u5f0f\u662f\u5bf9\u786c\u4ef6\u64cd\u4f5c\u7684\u62bd\u8c61\uff0c\u6709 \u6700\u9ad8 \u7ea7\u522b\u7684\u6743\u9650 S \u6a21\u5f0f\u4ecb\u4e8e M \u6a21\u5f0f\u548c U \u6a21\u5f0f\u4e4b\u95f4\uff0c\u5728\u64cd\u4f5c\u7cfb\u7edf\u4e2d\u5bf9\u5e94\u4e8e\u5185\u6838\u6001 (Kernel)\u3002\u5f53\u7528\u6237\u9700\u8981\u5185\u6838\u8d44\u6e90\u65f6\uff0c\u5411\u5185\u6838\u7533\u8bf7\uff0c\u5e76\u5207\u6362\u5230\u5185\u6838\u6001\u8fdb\u884c\u5904\u7406 U \u6a21\u5f0f\u7528\u4e8e\u6267\u884c\u7528\u6237\u7a0b\u5e8f\uff0c\u5728\u64cd\u4f5c\u7cfb\u7edf\u4e2d\u5bf9\u5e94\u4e8e\u7528\u6237\u6001\uff0c\u6709 \u6700\u4f4e \u7ea7\u522b\u7684\u6743\u9650 3.3 \u4ece\u8ba1\u7b97\u673a\u4e0a\u7535\u5230 OS \u8fd0\u884c \u6211\u4eec\u4ee5\u6700\u57fa\u7840\u7684\u5d4c\u5165\u5f0f\u7cfb\u7edf\u4e3a\u4f8b\uff0c\u8ba1\u7b97\u673a\u4e0a\u7535\u540e\uff0c\u9996\u5148\u786c\u4ef6\u8fdb\u884c\u4e00\u4e9b\u57fa\u7840\u7684\u521d\u59cb\u5316\u540e\uff0c\u5c06 CPU \u7684 Program Counter \u79fb\u52a8\u5230\u5185\u5b58\u4e2d Bootloader \u7684\u8d77\u59cb\u5730\u5740\u3002 Bootloader \u662f\u64cd\u4f5c\u7cfb\u7edf\u5185\u6838\u8fd0\u884c\u4e4b\u524d\uff0c\u7528\u4e8e\u521d\u59cb\u5316\u786c\u4ef6\uff0c\u52a0\u8f7d\u64cd\u4f5c\u7cfb\u7edf\u5185\u6838\u3002 \u5728 RISC-V \u67b6\u6784\u91cc\uff0cBootloader \u8fd0\u884c\u5728 M \u6a21\u5f0f\u4e0b\u3002Bootloader \u8fd0\u884c\u5b8c\u6bd5\u540e\u5c31\u4f1a\u628a\u5f53\u524d\u6a21\u5f0f\u5207\u6362\u5230 S \u6a21\u5f0f\u4e0b\uff0c\u673a\u5668\u968f\u540e\u5f00\u59cb\u8fd0\u884c Kernel\u3002 \u8fd9\u4e2a\u8fc7\u7a0b\u7b80\u5355\u800c\u8a00\u5c31\u662f\u8fd9\u6837\uff1a 1 2 3 4 Hardware RISC-V M Mode RISC-V S Mode +------------+ +--------------+ +----------+ | Power On | ----> | Bootloader | ----> | Kernel | +------------+ +--------------+ +----------+ 3.4 SBI \u4e0e OpenSBI SBI (Supervisor Binary Interface) \u662f S-mode \u7684 Kernel \u548c M-mode \u6267\u884c\u73af\u5883\u4e4b\u95f4\u7684\u63a5\u53e3\u89c4\u8303\uff0c\u800c OpenSBI \u662f\u4e00\u4e2a RISC-V SBI \u89c4\u8303\u7684\u5f00\u6e90\u5b9e\u73b0\u3002RISC-V \u5e73\u53f0\u548c SoC \u4f9b\u5e94\u5546\u53ef\u4ee5\u81ea\u4e3b\u6269\u5c55 OpenSBI \u5b9e\u73b0\uff0c\u4ee5\u9002\u5e94\u7279\u5b9a\u7684\u786c\u4ef6\u914d\u7f6e\u3002 \u7b80\u5355\u7684\u8bf4\uff0c\u4e3a\u4e86\u4f7f\u64cd\u4f5c\u7cfb\u7edf\u5185\u6838\u9002\u914d\u4e0d\u540c\u786c\u4ef6\uff0cOpenSBI \u63d0\u51fa\u4e86\u4e00\u7cfb\u5217\u89c4\u8303\u5bf9 M-mode \u4e0b\u7684\u786c\u4ef6\u8fdb\u884c\u4e86\u7edf\u4e00\u5b9a\u4e49\uff0c\u8fd0\u884c\u5728 S-mode \u4e0b\u7684\u5185\u6838\u53ef\u4ee5\u6309\u7167\u8fd9\u4e9b\u89c4\u8303\u5bf9\u4e0d\u540c\u786c\u4ef6\u8fdb\u884c\u64cd\u4f5c\u3002 \u4e3a\u964d\u4f4e\u5b9e\u9a8c\u96be\u5ea6\uff0c\u6211\u4eec\u9009\u62e9 OpenSBI \u4f5c\u4e3a Bootloader \u6765\u5b8c\u6210\u673a\u5668\u542f\u52a8\u65f6 M-mode \u4e0b\u7684\u786c\u4ef6\u521d\u59cb\u5316\u4e0e\u5bc4\u5b58\u5668\u8bbe\u7f6e\uff0c\u5e76\u4f7f\u7528 OpenSBI \u6240\u63d0\u4f9b\u7684\u63a5\u53e3\u5b8c\u6210\u8bf8\u5982\u5b57\u7b26\u6253\u5370\u7684\u64cd\u4f5c\u3002 \u5728\u5b9e\u9a8c\u4e2d\uff0cQEMU \u5df2\u7ecf\u5185\u7f6e\u4e86 OpenSBI \u4f5c\u4e3a Bootloader\uff0c\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528 -bios default \u542f\u7528\u3002\u5982\u679c\u542f\u7528\uff0cQEMU \u4f1a\u5c06 OpenSBI \u4ee3\u7801\u52a0\u8f7d\u5230 0x80000000 \u8d77\u59cb\u5904\u3002OpenSBI \u521d\u59cb\u5316\u5b8c\u6210\u540e\uff0c\u4f1a\u8df3\u8f6c\u5230 0x80200000 \u5904\uff08\u4e5f\u5c31\u662f Kernel \u7684\u8d77\u59cb\u5730\u5740\uff09\u3002\u56e0\u6b64\uff0c\u6211\u4eec\u6240\u7f16\u8bd1\u7684\u4ee3\u7801\u9700\u8981\u653e\u5230 0x80200000 \u5904\u3002 \u5982\u679c\u4f60\u5bf9 RISC-V \u67b6\u6784\u7684 Boot \u6d41\u7a0b\u6709\u66f4\u591a\u7684\u597d\u5947\uff0c\u53ef\u4ee5\u53c2\u8003\u8fd9\u4efd bootflow \u3002 3.5 Makefile Makefile \u53ef\u4ee5\u7b80\u5355\u7684\u8ba4\u4e3a\u662f\u4e00\u4e2a\u5de5\u7a0b\u6587\u4ef6\u7684\u7f16\u8bd1\u89c4\u5219\uff0c\u63cf\u8ff0\u4e86\u6574\u4e2a\u5de5\u7a0b\u7684\u7f16\u8bd1\u548c\u94fe\u63a5\u6d41\u7a0b\u3002\u5728 Lab0 \u4e2d\u6211\u4eec\u5df2\u7ecf\u4f7f\u7528\u4e86 make \u5de5\u5177\u5229\u7528 Makefile \u6587\u4ef6\u6765\u7ba1\u7406\u6574\u4e2a\u5de5\u7a0b\u3002\u5728\u9605\u8bfb\u4e86 Makefile\u4ecb\u7ecd \u8fd9\u4e00\u7ae0\u8282\u540e\uff0c\u540c\u5b66\u4eec\u53ef\u4ee5\u6839\u636e\u5de5\u7a0b\u6587\u4ef6\u5939\u91cc Makefile \u7684\u4ee3\u7801\u6765\u638c\u63e1\u4e00\u4e9b\u57fa\u672c\u7684\u4f7f\u7528\u6280\u5de7\u3002 3.6 \u5185\u8054\u6c47\u7f16 \u5185\u8054\u6c47\u7f16\uff08\u901a\u5e38\u7531 asm \u6216\u8005 __asm__ \u5173\u952e\u5b57\u5f15\u5165\uff09\u63d0\u4f9b\u4e86\u5c06\u6c47\u7f16\u8bed\u8a00\u6e90\u4ee3\u7801\u5d4c\u5165 C \u7a0b\u5e8f\u7684\u80fd\u529b\u3002 \u5185\u8054\u6c47\u7f16\u7684\u8be6\u7ec6\u4ecb\u7ecd\u8bf7\u53c2\u8003 Assembler Instructions with C Expression Operands \u3002 \u4e0b\u9762\u7b80\u8981\u4ecb\u7ecd\u4e00\u4e0b\u8fd9\u6b21\u5b9e\u9a8c\u4f1a\u7528\u5230\u7684\u4e00\u4e9b\u5185\u8054\u6c47\u7f16\u77e5\u8bc6\uff1a \u5185\u8054\u6c47\u7f16\u57fa\u672c\u683c\u5f0f\u4e3a\uff1a 1 2 3 4 5 6 7 8 9 10 __asm__ volatile ( \"instruction1 \\n \" \"instruction2 \\n \" ...... ...... \"instruction3 \\n \" : [ out1 ] \"=r\" ( v1 ),[ out2 ] \"=r\" ( v2 ) : [ in1 ] \"r\" ( v1 ), [ in2 ] \"r\" ( v2 ) : \"memory\" ); \u5176\u4e2d\uff0c\u4e09\u4e2a : \u5c06\u6c47\u7f16\u90e8\u5206\u5206\u6210\u4e86\u56db\u90e8\u5206\uff1a \u7b2c\u4e00\u90e8\u5206\u662f\u6c47\u7f16\u6307\u4ee4\uff0c\u6307\u4ee4\u672b\u5c3e\u9700\u8981\u6dfb\u52a0 '\\n'\u3002 \u7b2c\u4e8c\u90e8\u5206\u662f\u8f93\u51fa\u64cd\u4f5c\u6570\u90e8\u5206\u3002 \u7b2c\u4e09\u90e8\u5206\u662f\u8f93\u5165\u64cd\u4f5c\u6570\u90e8\u5206\u3002 \u7b2c\u56db\u90e8\u5206\u662f\u53ef\u80fd\u5f71\u54cd\u7684\u5bc4\u5b58\u5668\u6216\u5b58\u50a8\u5668\uff0c\u7528\u4e8e\u544a\u77e5\u7f16\u8bd1\u5668\u5f53\u524d\u5185\u8054\u6c47\u7f16\u8bed\u53e5\u53ef\u80fd\u4f1a\u5bf9\u67d0\u4e9b\u5bc4\u5b58\u5668\u6216\u5185\u5b58\u8fdb\u884c\u4fee\u6539\uff0c\u4f7f\u5f97\u7f16\u8bd1\u5668\u5728\u4f18\u5316\u65f6\u5c06\u5176\u56e0\u7d20\u8003\u8651\u8fdb\u53bb\u3002 \u8fd9\u56db\u90e8\u5206\u4e2d\u540e\u4e09\u90e8\u5206\u4e0d\u662f\u5fc5\u987b\u7684\u3002 \u793a\u4f8b\u4e00 1 2 3 4 5 6 7 8 9 10 11 12 unsigned long long s_example ( unsigned long long type , unsigned long long arg0 ) { unsigned long long ret_val ; __asm__ volatile ( \"mv x10, %[type] \\n \" \"mv x11, %[arg0] \\n \" \"mv %[ret_val], x12\" : [ ret_val ] \"=r\" ( ret_val ) : [ type ] \"r\" ( type ), [ arg0 ] \"r\" ( arg0 ) : \"memory\" ); return ret_val ; } \u793a\u4f8b\u4e00\u4e2d\u6307\u4ee4\u90e8\u5206\uff0c %[type] \u3001 %[arg0] \u4ee5\u53ca %[ret_val] \u4ee3\u8868\u7740\u7279\u5b9a\u7684\u5bc4\u5b58\u5668\u6216\u662f\u5185\u5b58\u3002 \u8f93\u5165\u8f93\u51fa\u90e8\u5206\u4e2d\uff0c [type] \"r\" (type) \u4ee3\u8868\u7740\u5c06 () \u4e2d\u7684\u53d8\u91cf type \u653e\u5165\u5bc4\u5b58\u5668\u4e2d\uff08 \"r\" \u6307\u653e\u5165\u5bc4\u5b58\u5668\uff0c\u5982\u679c\u662f \"m\" \u5219\u4e3a\u653e\u5165\u5185\u5b58\uff09\uff0c\u5e76\u4e14\u7ed1\u5b9a\u5230 [] \u4e2d\u547d\u540d\u7684\u7b26\u53f7\u4e2d\u53bb\u3002 [ret_val] \"=r\" (ret_val) \u4ee3\u8868\u7740\u5c06\u6c47\u7f16\u6307\u4ee4\u4e2d %[ret_val] \u7684\u503c\u66f4\u65b0\u5230\u53d8\u91cf ret_val \u4e2d\u3002 \u793a\u4f8b\u4e8c 1 2 #define write_csr(reg, val) ({ __asm__ volatile ( \"csrw \" # reg \", %0\" :: \"r\" ( val )); }) \u793a\u4f8b\u4e8c\u5b9a\u4e49\u4e86\u4e00\u4e2a\u5b8f\uff0c\u5176\u4e2d %0 \u4ee3\u8868\u7740\u8f93\u51fa\u8f93\u5165\u90e8\u5206\u7684\u7b2c\u4e00\u4e2a\u7b26\u53f7\uff0c\u5373 val \u3002 #reg \u662fc\u8bed\u8a00\u7684\u4e00\u4e2a\u7279\u6b8a\u5b8f\u5b9a\u4e49\u8bed\u6cd5\uff0c\u76f8\u5f53\u4e8e\u5c06reg\u8fdb\u884c\u5b8f\u66ff\u6362\u5e76\u7528\u53cc\u5f15\u53f7\u5305\u88f9\u8d77\u6765\u3002 \u4f8b\u5982 write_csr(sstatus,val) \u7ecf\u5b8f\u5c55\u5f00\u4f1a\u5f97\u5230\uff1a 1 2 ({ __asm__ volatile ( \"csrw \" \"sstatus\" \", %0\" :: \"r\" ( val )); }) 3.7 \u7f16\u8bd1\u76f8\u5173\u77e5\u8bc6\u4ecb\u7ecd vmlinux.lds GNU ld \u5373\u94fe\u63a5\u5668\uff0c\u7528\u4e8e\u5c06 *.o \u6587\u4ef6\uff08\u548c\u5e93\u6587\u4ef6\uff09\u94fe\u63a5\u6210\u53ef\u6267\u884c\u6587\u4ef6\u3002\u5728\u64cd\u4f5c\u7cfb\u7edf\u5f00\u53d1\u4e2d\uff0c\u4e3a\u4e86\u6307\u5b9a\u7a0b\u5e8f\u7684\u5185\u5b58\u5e03\u5c40\uff0cld \u4f7f\u7528\u94fe\u63a5\u811a\u672c\uff08Linker Script\uff09\u6765\u63a7\u5236\uff0c\u5728 Linux Kernel \u4e2d\u94fe\u63a5\u811a\u672c\u88ab\u547d\u540d\u4e3a vmlinux.lds\u3002\u66f4\u591a\u5173\u4e8e ld \u7684\u4ecb\u7ecd\u53ef\u4ee5\u4f7f\u7528 man ld \u547d\u4ee4\u3002 \u4e0b\u9762\u7ed9\u51fa\u4e00\u4e2a vmlinux.lds \u7684\u4f8b\u5b50\uff1a 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 /* \u76ee\u6807\u67b6\u6784 */ OUTPUT_ARCH( \"riscv\" ) /* \u7a0b\u5e8f\u5165\u53e3 */ ENTRY( _start ) /* kernel\u4ee3\u7801\u8d77\u59cb\u4f4d\u7f6e */ BASE_ADDR = 0x80200000; SECTIONS { /* . \u4ee3\u8868\u5f53\u524d\u5730\u5740 */ . = BASE_ADDR; /* \u8bb0\u5f55kernel\u4ee3\u7801\u7684\u8d77\u59cb\u5730\u5740 */ _skernel = .; /* ALIGN(0x1000) \u8868\u793a4KB\u5bf9\u9f50 */ /* _stext, _etext \u5206\u522b\u8bb0\u5f55\u4e86text\u6bb5\u7684\u8d77\u59cb\u4e0e\u7ed3\u675f\u5730\u5740 */ .text : ALIGN(0x1000){ _stext = .; *(.text.entry) *(.text .text.*) _etext = .; } .rodata : ALIGN(0x1000){ _srodata = .; *(.rodata .rodata.*) _erodata = .; } .data : ALIGN(0x1000){ _sdata = .; *(.data .data.*) _edata = .; } .bss : ALIGN(0x1000){ _sbss = .; *(.bss.stack) sbss = .; *(.bss .bss.*) _ebss = .; } /* \u8bb0\u5f55kernel\u4ee3\u7801\u7684\u7ed3\u675f\u5730\u5740 */ _ekernel = .; } \u9996\u5148\u6211\u4eec\u4f7f\u7528 OUTPUT_ARCH \u6307\u5b9a\u4e86\u67b6\u6784\u4e3a RISC-V \uff0c\u4e4b\u540e\u4f7f\u7528 ENTRY \u6307\u5b9a\u7a0b\u5e8f\u5165\u53e3\u70b9\u4e3a _start \u51fd\u6570\uff0c\u7a0b\u5e8f\u5165\u53e3\u70b9\u5373\u7a0b\u5e8f\u542f\u52a8\u65f6\u8fd0\u884c\u7684\u51fd\u6570\uff0c\u7ecf\u8fc7\u8fd9\u6837\u7684\u6307\u5b9a\u540e\u5728head.S\u4e2d\u9700\u8981\u7f16\u5199 _start \u51fd\u6570\uff0c\u7a0b\u5e8f\u624d\u80fd\u6b63\u5e38\u8fd0\u884c\u3002 \u94fe\u63a5\u811a\u672c\u4e2d\u6709 . * \u4e24\u4e2a\u91cd\u8981\u7684\u7b26\u53f7\u3002\u5355\u72ec\u7684 . \u5728\u94fe\u63a5\u811a\u672c\u4ee3\u8868\u5f53\u524d\u5730\u5740\uff0c\u5b83\u6709\u8d4b\u503c\u3001\u88ab\u8d4b\u503c\u3001\u81ea\u589e\u7b49\u64cd\u4f5c\u3002\u800c * \u6709\u4e24\u79cd\u7528\u6cd5\uff0c\u5176\u4e00\u662f *() \u5728\u5927\u62ec\u53f7\u4e2d\u8868\u793a\u5c06\u6240\u6709\u6587\u4ef6\u4e2d\u7b26\u5408\u62ec\u53f7\u5185\u8981\u6c42\u7684\u6bb5\u653e\u7f6e\u5728\u5f53\u524d\u4f4d\u7f6e\uff0c\u5176\u4e8c\u662f\u4f5c\u4e3a\u901a\u914d\u7b26\u3002 \u94fe\u63a5\u811a\u672c\u7684\u4e3b\u4f53\u662fSECTIONS\u90e8\u5206\uff0c\u5728\u8fd9\u91cc\u94fe\u63a5\u811a\u672c\u7684\u5de5\u4f5c\u662f\u5c06\u7a0b\u5e8f\u7684\u5404\u4e2a\u6bb5\u6309\u987a\u5e8f\u653e\u5728\u5404\u4e2a\u5730\u5740\u4e0a\uff0c\u5728\u4f8b\u5b50\u4e2d\u5c31\u662f\u4ece0x80200000\u5730\u5740\u5f00\u59cb\u653e\u7f6e\u4e86 .text \uff0c .rodata \uff0c .data \u548c .bss \u6bb5\u3002\u5404\u4e2a\u6bb5\u7684\u4f5c\u7528\u53ef\u4ee5\u7b80\u8981\u6982\u62ec\u6210\uff1a \u6bb5\u540d \u4e3b\u8981\u4f5c\u7528 .text \u901a\u5e38\u5b58\u653e\u7a0b\u5e8f\u6267\u884c\u4ee3\u7801 .rodata \u901a\u5e38\u5b58\u653e\u5e38\u91cf\u7b49\u53ea\u8bfb\u6570\u636e .data \u901a\u5e38\u5b58\u653e\u5df2\u521d\u59cb\u5316\u7684\u5168\u5c40\u53d8\u91cf\u3001\u9759\u6001\u53d8\u91cf .bss \u901a\u5e38\u5b58\u653e\u672a\u521d\u59cb\u5316\u7684\u5168\u5c40\u53d8\u91cf\u3001\u9759\u6001\u53d8\u91cf \u5728\u94fe\u63a5\u811a\u672c\u4e2d\u53ef\u4ee5\u81ea\u5b9a\u4e49\u7b26\u53f7\uff0c\u4f8b\u5982\u4ee5\u4e0a\u6240\u6709 _s \u4e0e _e \u5f00\u5934\u7684\u7b26\u53f7\u90fd\u662f\u6211\u4eec\u81ea\u5df1\u5b9a\u4e49\u7684\u3002 \u66f4\u591a\u6709\u5173\u94fe\u63a5\u811a\u672c\u8bed\u6cd5\u53ef\u4ee5\u53c2\u8003 \u8fd9\u91cc \u3002 vmlinux vmlinux \u901a\u5e38\u6307 Linux Kernel \u7f16\u8bd1\u51fa\u7684\u53ef\u6267\u884c\u6587\u4ef6 (Executable and Linkable Format / ELF)\uff0c\u7279\u70b9\u662f\u672a\u538b\u7f29\u7684\uff0c\u5e26\u8c03\u8bd5\u4fe1\u606f\u548c\u7b26\u53f7\u8868\u7684\u3002\u5728\u6574\u5957 OS \u5b9e\u9a8c\u4e2d\uff0cvmlinux \u901a\u5e38\u6307\u5c06\u4f60\u7684\u4ee3\u7801\u8fdb\u884c\u7f16\u8bd1\uff0c\u94fe\u63a5\u540e\u751f\u6210\u7684\u53ef\u4f9b QEMU \u8fd0\u884c\u7684 RV64 \u67b6\u6784\u7a0b\u5e8f\u3002\u5982\u679c\u5bf9 vmlinux \u4f7f\u7528 file \u547d\u4ee4\uff0c\u4f60\u5c06\u770b\u5230\u5982\u4e0b\u4fe1\u606f\uff1a 1 2 $ file vmlinux vmlinux: ELF 64 -bit LSB executable, UCB RISC-V, version 1 ( SYSV ) , statically linked, not stripped System.map System.map\u662f\u5185\u6838\u7b26\u53f7\u8868\uff08Kernel Symbol Table\uff09\u6587\u4ef6\uff0c\u662f\u5b58\u50a8\u4e86\u6240\u6709\u5185\u6838\u7b26\u53f7\u53ca\u5176\u5730\u5740\u7684\u4e00\u4e2a\u5217\u8868\u3002\u201c\u7b26\u53f7\u201d\u901a\u5e38\u6307\u7684\u662f\u51fd\u6570\u540d\uff0c\u5168\u5c40\u53d8\u91cf\u540d\u7b49\u7b49\u3002\u4f7f\u7528 nm vmlinux \u547d\u4ee4\u5373\u53ef\u6253\u5370vmlinux\u7684\u7b26\u53f7\u8868\uff0c\u7b26\u53f7\u8868\u7684\u6837\u4f8b\u5982\u4e0b\uff1a 1 2 3 4 5 6 7 8 9 10 0000000000000800 A __vdso_rt_sigreturn ffffffe000000000 T __init_begin ffffffe000000000 T _sinittext ffffffe000000000 T _start ffffffe000000040 T _start_kernel ffffffe000000076 t clear_bss ffffffe000000080 t clear_bss_done ffffffe0000000c0 t relocate ffffffe00000017c t set_reset_devices ffffffe000000190 t debug_kernel \u4f7f\u7528 System.map \u53ef\u4ee5\u65b9\u4fbf\u5730\u8bfb\u51fa\u51fd\u6570\u6216\u53d8\u91cf\u7684\u5730\u5740\uff0c\u4e3a Debug \u63d0\u4f9b\u4e86\u65b9\u4fbf\u3002 4 \u5b9e\u9a8c\u6b65\u9aa4 4.1 \u51c6\u5907\u5de5\u7a0b \u4ece repo \u540c\u6b65\u5b9e\u9a8c\u4ee3\u7801\u6846\u67b6\uff0c \u53c2\u8003 Lab0 \u4e2d\uff0c\u5c06\u5de5\u7a0b\u4ee3\u7801\u6620\u5c04\u8fdb\u5bb9\u5668\u4e2d\u3002\u8fd9\u6837\u5c31\u53ef\u4ee5\u65b9\u4fbf\u7684\u5728\u672c\u5730\u5f00\u53d1\uff0c\u540c\u65f6\u4f7f\u7528\u5bb9\u5668\u5185\u7684\u5de5\u5177\u8fdb\u884c\u7f16\u8bd1\u3002 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 \u251c\u2500\u2500 arch \u2502 \u2514\u2500\u2500 riscv \u2502 \u251c\u2500\u2500 include \u2502 \u2502 \u251c\u2500\u2500 defs.h \u2502 \u2502 \u2514\u2500\u2500 sbi.h \u2502 \u251c\u2500\u2500 kernel \u2502 \u2502 \u251c\u2500\u2500 head.S \u2502 \u2502 \u251c\u2500\u2500 Makefile \u2502 \u2502 \u251c\u2500\u2500 sbi.c \u2502 \u2502 \u2514\u2500\u2500 vmlinux.lds \u2502 \u2514\u2500\u2500 Makefile \u251c\u2500\u2500 include \u2502 \u251c\u2500\u2500 print.h \u2502 \u2514\u2500\u2500 types.h \u251c\u2500\u2500 init \u2502 \u251c\u2500\u2500 main.c \u2502 \u251c\u2500\u2500 Makefile \u2502 \u2514\u2500\u2500 test.c \u251c\u2500\u2500 lib \u2502 \u251c\u2500\u2500 Makefile \u2502 \u2514\u2500\u2500 print.c \u2514\u2500\u2500 Makefile \u9700\u8981\u5b8c\u5584\u4ee5\u4e0b\u6587\u4ef6\uff1a arch/riscv/kernel/head.S lib/Makefile arch/riscv/kernel/sbi.c lib/print.c arch/riscv/include/defs.h 4.2 \u7f16\u5199head.S \u5b66\u4e60riscv\u7684\u6c47\u7f16\u3002 \u5b8c\u6210 arch/riscv/kernel/head.S \u3002\u6211\u4eec\u9996\u5148\u4e3a\u5373\u5c06\u8fd0\u884c\u7684\u7b2c\u4e00\u4e2a C \u51fd\u6570\u8bbe\u7f6e\u7a0b\u5e8f\u6808\uff08\u6808\u7684\u5927\u5c0f\u53ef\u4ee5\u8bbe\u7f6e\u4e3a4KB\uff09\uff0c\u5e76\u5c06\u8be5\u6808\u653e\u7f6e\u5728 .bss.stack \u6bb5\u3002\u63a5\u4e0b\u6765\u6211\u4eec\u53ea\u9700\u8981\u901a\u8fc7\u8df3\u8f6c\u6307\u4ee4\uff0c\u8df3\u8f6c\u81f3 main.c \u4e2d\u7684 start_kernel \u51fd\u6570\u5373\u53ef\u3002 4.3 \u5b8c\u5584 Makefile \u811a\u672c \u9605\u8bfb\u6587\u6863\u4e2d\u5173\u4e8e Makefile \u7684\u7ae0\u8282\uff0c\u4ee5\u53ca\u5de5\u7a0b\u6587\u4ef6\u4e2d\u7684 Makefile \u6587\u4ef6\uff0c\u6839\u636e\u6ce8\u91ca\u5b66\u4f1a Makefile \u7684\u4f7f\u7528\u89c4\u5219\u540e\uff0c\u8865\u5145 lib/Makefile \uff0c\u4f7f\u5de5\u7a0b\u5f97\u4ee5\u7f16\u8bd1\u3002 \u5b8c\u6210\u6b64\u6b65\u540e\u5728\u5de5\u7a0b\u6839\u6587\u4ef6\u5939\u6267\u884c make\uff0c\u53ef\u4ee5\u770b\u5230\u5de5\u7a0b\u6210\u529f\u7f16\u8bd1\u51fa vmlinux\u3002 4.4 \u8865\u5145 sbi.c OpenSBI \u5728 M \u6001\uff0c\u4e3a S \u6001\u63d0\u4f9b\u4e86\u591a\u79cd\u63a5\u53e3\uff0c\u6bd4\u5982\u5b57\u7b26\u4e32\u8f93\u5165\u8f93\u51fa\u3002\u56e0\u6b64\u6211\u4eec\u9700\u8981\u5b9e\u73b0\u8c03\u7528 OpenSBI \u63a5\u53e3\u7684\u529f\u80fd\u3002\u7ed9\u51fa\u51fd\u6570\u5b9a\u4e49\u5982\u4e0b\uff1a 1 2 3 4 5 6 7 8 struct sbiret { long error ; long value ; }; struct sbiret sbi_ecall ( int ext , int fid , uint64 arg0 , uint64 arg1 , uint64 arg2 , uint64 arg3 , uint64 arg4 , uint64 arg5 ); sbi_ecall \u51fd\u6570\u4e2d\uff0c\u9700\u8981\u5b8c\u6210\u4ee5\u4e0b\u5185\u5bb9\uff1a \u5c06 ext (Extension ID) \u653e\u5165\u5bc4\u5b58\u5668 a7 \u4e2d\uff0cfid (Function ID) \u653e\u5165\u5bc4\u5b58\u5668 a6 \u4e2d\uff0c\u5c06 arg0 ~ arg5 \u653e\u5165\u5bc4\u5b58\u5668 a0 ~ a5 \u4e2d\u3002 \u4f7f\u7528 ecall \u6307\u4ee4\u3002 ecall \u4e4b\u540e\u7cfb\u7edf\u4f1a\u8fdb\u5165 M \u6a21\u5f0f\uff0c\u4e4b\u540e OpenSBI \u4f1a\u5b8c\u6210\u76f8\u5173\u64cd\u4f5c\u3002 OpenSBI \u7684\u8fd4\u56de\u7ed3\u679c\u4f1a\u5b58\u653e\u5728\u5bc4\u5b58\u5668 a0 \uff0c a1 \u4e2d\uff0c\u5176\u4e2d a0 \u4e3a error code\uff0c a1 \u4e3a\u8fd4\u56de\u503c\uff0c \u6211\u4eec\u7528 sbiret \u6765\u63a5\u53d7\u8fd9\u4e24\u4e2a\u8fd4\u56de\u503c\u3002 \u540c\u5b66\u4eec\u53ef\u4ee5\u53c2\u7167\u5185\u8054\u6c47\u7f16\u7684\u793a\u4f8b\u4e00\u5b8c\u6210\u8be5\u51fd\u6570\u7684\u7f16\u5199\u3002 \u7f16\u5199\u6210\u529f\u540e\uff0c\u8c03\u7528 sbi_ecall(0x1, 0x0\uff0c 0x30, 0, 0\uff0c 0\uff0c 0\uff0c 0) \u5c06\u4f1a\u8f93\u51fa\u5b57\u7b26'0'\u3002\u5176\u4e2d 0x1 \u4ee3\u8868 sbi_console_putchar \u7684 ExtensionID\uff0c 0x0 \u4ee3\u8868FunctionID, 0x30\u4ee3\u8868'0'\u7684ascii\u503c\uff0c\u5176\u4f59\u53c2\u6570\u586b0\u3002 \u8bf7\u5728 arch/riscv/kernel/sbi.c \u4e2d\u8865\u5145 sbi_ecall() \u3002 \u4e0b\u9762\u5217\u51fa\u4e86\u4e00\u4e9b\u5728\u540e\u7eed\u7684\u5b9e\u9a8c\u4e2d\u53ef\u80fd\u9700\u8981\u4f7f\u7528\u7684\u529f\u80fd\u3002 Function Name Function ID Extension ID sbi_set_timer \uff08\u8bbe\u7f6e\u65f6\u949f\u76f8\u5173\u5bc4\u5b58\u5668\uff09 0 0x00 sbi_console_putchar \uff08\u6253\u5370\u5b57\u7b26\uff09 0 0x01 sbi_console_getchar \uff08\u63a5\u6536\u5b57\u7b26\uff09 0 0x02 sbi_shutdown \uff08\u5173\u673a\uff09 0 0x08 4.5 puts() \u548c puti() \u8c03\u7528\u4ee5\u4e0a\u5b8c\u6210\u7684 sbi_ecall , \u5b8c\u6210 puts() \u548c puti() \u7684\u5b9e\u73b0\u3002 puts() \u7528\u4e8e\u6253\u5370\u5b57\u7b26\u4e32\uff0c puti() \u7528\u4e8e\u6253\u5370\u6574\u578b\u53d8\u91cf\u3002 \u8bf7\u7f16\u5199 lib/print.c \u4e2d\u7684 puts() \u548c puti() \uff0c \u51fd\u6570\u7684\u76f8\u5173\u5b9a\u4e49\u5df2\u7ecf\u5199\u5728\u4e86 print.h \u6587\u4ef6\u3002 4.6 \u4fee\u6539 defs \u5185\u8054\u6c47\u7f16\u7684\u76f8\u5173\u77e5\u8bc6\u89c1 \u5185\u8054\u6c47\u7f16 \u3002 \u5b66\u4e60\u4e86\u89e3\u4e86\u4ee5\u4e0a\u77e5\u8bc6\u540e\uff0c\u8865\u5145 arch/riscv/include/defs.h \u4e2d\u7684\u4ee3\u7801\u5b8c\u6210\uff1a \u8865\u5145\u5b8c read_csr \u8fd9\u4e2a\u5b8f\u5b9a\u4e49\u3002\u8fd9\u91cc\u6709\u76f8\u5173 \u793a\u4f8b \u3002 \u601d\u8003\u9898 \u8bf7\u603b\u7ed3\u4e00\u4e0b RISC-V \u7684 calling convention\uff0c\u5e76\u89e3\u91ca Caller / Callee Saved Register \u6709\u4ec0\u4e48\u533a\u522b\uff1f \u7f16\u8bd1\u4e4b\u540e\uff0c\u901a\u8fc7 System.map \u67e5\u770b vmlinux.lds \u4e2d\u81ea\u5b9a\u4e49\u7b26\u53f7\u7684\u503c \u4f5c\u4e1a\u63d0\u4ea4 \u540c\u5b66\u9700\u8981\u63d0\u4ea4\u5b9e\u9a8c\u62a5\u544a\u4ee5\u53ca\u6574\u4e2a\u5de5\u7a0b\u4ee3\u7801\u3002\u5728\u63d0\u4ea4\u524d\u8bf7\u4f7f\u7528 make clean \u6e05\u9664\u6240\u6709\u6784\u5efa\u4ea7\u7269\u3002","title":"\u5b9e\u9a8c\u6307\u5bfc\u4e00"},{"location":"lab1/#lab-1-rv64","text":"","title":"Lab 1: RV64 \u5185\u6838\u5f15\u5bfc"},{"location":"lab1/#1","text":"\u5b66\u4e60 RISC-V \u6c47\u7f16\uff0c \u7f16\u5199 head.S \u5b9e\u73b0\u8df3\u8f6c\u5230\u5185\u6838\u8fd0\u884c\u7684\u7b2c\u4e00\u4e2a C \u51fd\u6570\u3002 \u5b66\u4e60 OpenSBI\uff0c\u7406\u89e3 OpenSBI \u5728\u5b9e\u9a8c\u4e2d\u6240\u8d77\u5230\u7684\u4f5c\u7528\uff0c\u5e76\u8c03\u7528 OpenSBI \u63d0\u4f9b\u7684\u63a5\u53e3\u5b8c\u6210\u5b57\u7b26\u7684\u8f93\u51fa\u3002 \u5b66\u4e60 Makefile \u76f8\u5173\u77e5\u8bc6\uff0c \u8865\u5145\u9879\u76ee\u4e2d\u7684 Makefile \u6587\u4ef6\uff0c \u6765\u5b8c\u6210\u5bf9\u6574\u4e2a\u5de5\u7a0b\u7684\u7ba1\u7406\u3002","title":"1 \u5b9e\u9a8c\u76ee\u7684"},{"location":"lab1/#2","text":"Docker in Lab0","title":"2 \u5b9e\u9a8c\u73af\u5883"},{"location":"lab1/#3","text":"","title":"3 \u5b9e\u9a8c\u57fa\u7840\u77e5\u8bc6\u4ecb\u7ecd"},{"location":"lab1/#31","text":"\u4e3a\u4e86\u987a\u5229\u5b8c\u6210 OS \u5b9e\u9a8c\uff0c\u6211\u4eec\u9700\u8981\u4e00\u4e9b\u524d\u7f6e\u77e5\u8bc6\u548c\u8f83\u591a\u8c03\u8bd5\u6280\u5de7\u3002\u5728 OS \u5b9e\u9a8c\u4e2d\u6211\u4eec\u9700\u8981 RISC-V\u6c47\u7f16 \u7684\u524d\u7f6e\u77e5\u8bc6\uff0c\u8bfe\u5802\u4e0a\u4e0d\u4f1a\u8bb2\u6388\uff0c\u8bf7\u540c\u5b66\u4eec\u901a\u8fc7\u9605\u8bfb\u4ee5\u4e0b\u56db\u4efd\u6587\u6863\u81ea\u5b66\uff1a RISC-V Assembly Programmer's Manual RISC-V Unprivileged Spec RISC-V Privileged Spec RISC-V \u624b\u518c\uff08\u4e2d\u6587\uff09 \u6ce8\uff1aRISC-V \u624b\u518c\uff08\u4e2d\u6587\uff09\u4e2d\u6709\u4e00\u4e9b Typo\uff0c\u8bf7\u8c28\u614e\u53c2\u8003\u3002","title":"3.1 \u524d\u7f6e\u77e5\u8bc6"},{"location":"lab1/#32-risc-v","text":"RISC-V \u6709\u4e09\u4e2a\u7279\u6743\u6a21\u5f0f\uff1aU (user) \u6a21\u5f0f\u3001S (supervisor) \u6a21\u5f0f\u548c M (machine) \u6a21\u5f0f\u3002 Level Encoding Name Abbreviation 0 00 User/Application U 1 01 Supervisor S 2 10 Reserved 3 11 Machine M \u5176\u4e2d\uff1a M \u6a21\u5f0f\u662f\u5bf9\u786c\u4ef6\u64cd\u4f5c\u7684\u62bd\u8c61\uff0c\u6709 \u6700\u9ad8 \u7ea7\u522b\u7684\u6743\u9650 S \u6a21\u5f0f\u4ecb\u4e8e M \u6a21\u5f0f\u548c U \u6a21\u5f0f\u4e4b\u95f4\uff0c\u5728\u64cd\u4f5c\u7cfb\u7edf\u4e2d\u5bf9\u5e94\u4e8e\u5185\u6838\u6001 (Kernel)\u3002\u5f53\u7528\u6237\u9700\u8981\u5185\u6838\u8d44\u6e90\u65f6\uff0c\u5411\u5185\u6838\u7533\u8bf7\uff0c\u5e76\u5207\u6362\u5230\u5185\u6838\u6001\u8fdb\u884c\u5904\u7406 U \u6a21\u5f0f\u7528\u4e8e\u6267\u884c\u7528\u6237\u7a0b\u5e8f\uff0c\u5728\u64cd\u4f5c\u7cfb\u7edf\u4e2d\u5bf9\u5e94\u4e8e\u7528\u6237\u6001\uff0c\u6709 \u6700\u4f4e \u7ea7\u522b\u7684\u6743\u9650","title":"3.2 RISC-V \u7684\u4e09\u79cd\u7279\u6743\u6a21\u5f0f"},{"location":"lab1/#33-os","text":"\u6211\u4eec\u4ee5\u6700\u57fa\u7840\u7684\u5d4c\u5165\u5f0f\u7cfb\u7edf\u4e3a\u4f8b\uff0c\u8ba1\u7b97\u673a\u4e0a\u7535\u540e\uff0c\u9996\u5148\u786c\u4ef6\u8fdb\u884c\u4e00\u4e9b\u57fa\u7840\u7684\u521d\u59cb\u5316\u540e\uff0c\u5c06 CPU \u7684 Program Counter \u79fb\u52a8\u5230\u5185\u5b58\u4e2d Bootloader \u7684\u8d77\u59cb\u5730\u5740\u3002 Bootloader \u662f\u64cd\u4f5c\u7cfb\u7edf\u5185\u6838\u8fd0\u884c\u4e4b\u524d\uff0c\u7528\u4e8e\u521d\u59cb\u5316\u786c\u4ef6\uff0c\u52a0\u8f7d\u64cd\u4f5c\u7cfb\u7edf\u5185\u6838\u3002 \u5728 RISC-V \u67b6\u6784\u91cc\uff0cBootloader \u8fd0\u884c\u5728 M \u6a21\u5f0f\u4e0b\u3002Bootloader \u8fd0\u884c\u5b8c\u6bd5\u540e\u5c31\u4f1a\u628a\u5f53\u524d\u6a21\u5f0f\u5207\u6362\u5230 S \u6a21\u5f0f\u4e0b\uff0c\u673a\u5668\u968f\u540e\u5f00\u59cb\u8fd0\u884c Kernel\u3002 \u8fd9\u4e2a\u8fc7\u7a0b\u7b80\u5355\u800c\u8a00\u5c31\u662f\u8fd9\u6837\uff1a 1 2 3 4 Hardware RISC-V M Mode RISC-V S Mode +------------+ +--------------+ +----------+ | Power On | ----> | Bootloader | ----> | Kernel | +------------+ +--------------+ +----------+","title":"3.3 \u4ece\u8ba1\u7b97\u673a\u4e0a\u7535\u5230 OS \u8fd0\u884c"},{"location":"lab1/#34-sbi-opensbi","text":"SBI (Supervisor Binary Interface) \u662f S-mode \u7684 Kernel \u548c M-mode \u6267\u884c\u73af\u5883\u4e4b\u95f4\u7684\u63a5\u53e3\u89c4\u8303\uff0c\u800c OpenSBI \u662f\u4e00\u4e2a RISC-V SBI \u89c4\u8303\u7684\u5f00\u6e90\u5b9e\u73b0\u3002RISC-V \u5e73\u53f0\u548c SoC \u4f9b\u5e94\u5546\u53ef\u4ee5\u81ea\u4e3b\u6269\u5c55 OpenSBI \u5b9e\u73b0\uff0c\u4ee5\u9002\u5e94\u7279\u5b9a\u7684\u786c\u4ef6\u914d\u7f6e\u3002 \u7b80\u5355\u7684\u8bf4\uff0c\u4e3a\u4e86\u4f7f\u64cd\u4f5c\u7cfb\u7edf\u5185\u6838\u9002\u914d\u4e0d\u540c\u786c\u4ef6\uff0cOpenSBI \u63d0\u51fa\u4e86\u4e00\u7cfb\u5217\u89c4\u8303\u5bf9 M-mode \u4e0b\u7684\u786c\u4ef6\u8fdb\u884c\u4e86\u7edf\u4e00\u5b9a\u4e49\uff0c\u8fd0\u884c\u5728 S-mode \u4e0b\u7684\u5185\u6838\u53ef\u4ee5\u6309\u7167\u8fd9\u4e9b\u89c4\u8303\u5bf9\u4e0d\u540c\u786c\u4ef6\u8fdb\u884c\u64cd\u4f5c\u3002 \u4e3a\u964d\u4f4e\u5b9e\u9a8c\u96be\u5ea6\uff0c\u6211\u4eec\u9009\u62e9 OpenSBI \u4f5c\u4e3a Bootloader \u6765\u5b8c\u6210\u673a\u5668\u542f\u52a8\u65f6 M-mode \u4e0b\u7684\u786c\u4ef6\u521d\u59cb\u5316\u4e0e\u5bc4\u5b58\u5668\u8bbe\u7f6e\uff0c\u5e76\u4f7f\u7528 OpenSBI \u6240\u63d0\u4f9b\u7684\u63a5\u53e3\u5b8c\u6210\u8bf8\u5982\u5b57\u7b26\u6253\u5370\u7684\u64cd\u4f5c\u3002 \u5728\u5b9e\u9a8c\u4e2d\uff0cQEMU \u5df2\u7ecf\u5185\u7f6e\u4e86 OpenSBI \u4f5c\u4e3a Bootloader\uff0c\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528 -bios default \u542f\u7528\u3002\u5982\u679c\u542f\u7528\uff0cQEMU \u4f1a\u5c06 OpenSBI \u4ee3\u7801\u52a0\u8f7d\u5230 0x80000000 \u8d77\u59cb\u5904\u3002OpenSBI \u521d\u59cb\u5316\u5b8c\u6210\u540e\uff0c\u4f1a\u8df3\u8f6c\u5230 0x80200000 \u5904\uff08\u4e5f\u5c31\u662f Kernel \u7684\u8d77\u59cb\u5730\u5740\uff09\u3002\u56e0\u6b64\uff0c\u6211\u4eec\u6240\u7f16\u8bd1\u7684\u4ee3\u7801\u9700\u8981\u653e\u5230 0x80200000 \u5904\u3002 \u5982\u679c\u4f60\u5bf9 RISC-V \u67b6\u6784\u7684 Boot \u6d41\u7a0b\u6709\u66f4\u591a\u7684\u597d\u5947\uff0c\u53ef\u4ee5\u53c2\u8003\u8fd9\u4efd bootflow \u3002","title":"3.4 SBI \u4e0e OpenSBI"},{"location":"lab1/#35-makefile","text":"Makefile \u53ef\u4ee5\u7b80\u5355\u7684\u8ba4\u4e3a\u662f\u4e00\u4e2a\u5de5\u7a0b\u6587\u4ef6\u7684\u7f16\u8bd1\u89c4\u5219\uff0c\u63cf\u8ff0\u4e86\u6574\u4e2a\u5de5\u7a0b\u7684\u7f16\u8bd1\u548c\u94fe\u63a5\u6d41\u7a0b\u3002\u5728 Lab0 \u4e2d\u6211\u4eec\u5df2\u7ecf\u4f7f\u7528\u4e86 make \u5de5\u5177\u5229\u7528 Makefile \u6587\u4ef6\u6765\u7ba1\u7406\u6574\u4e2a\u5de5\u7a0b\u3002\u5728\u9605\u8bfb\u4e86 Makefile\u4ecb\u7ecd \u8fd9\u4e00\u7ae0\u8282\u540e\uff0c\u540c\u5b66\u4eec\u53ef\u4ee5\u6839\u636e\u5de5\u7a0b\u6587\u4ef6\u5939\u91cc Makefile \u7684\u4ee3\u7801\u6765\u638c\u63e1\u4e00\u4e9b\u57fa\u672c\u7684\u4f7f\u7528\u6280\u5de7\u3002","title":"3.5 Makefile"},{"location":"lab1/#36","text":"\u5185\u8054\u6c47\u7f16\uff08\u901a\u5e38\u7531 asm \u6216\u8005 __asm__ \u5173\u952e\u5b57\u5f15\u5165\uff09\u63d0\u4f9b\u4e86\u5c06\u6c47\u7f16\u8bed\u8a00\u6e90\u4ee3\u7801\u5d4c\u5165 C \u7a0b\u5e8f\u7684\u80fd\u529b\u3002 \u5185\u8054\u6c47\u7f16\u7684\u8be6\u7ec6\u4ecb\u7ecd\u8bf7\u53c2\u8003 Assembler Instructions with C Expression Operands \u3002 \u4e0b\u9762\u7b80\u8981\u4ecb\u7ecd\u4e00\u4e0b\u8fd9\u6b21\u5b9e\u9a8c\u4f1a\u7528\u5230\u7684\u4e00\u4e9b\u5185\u8054\u6c47\u7f16\u77e5\u8bc6\uff1a \u5185\u8054\u6c47\u7f16\u57fa\u672c\u683c\u5f0f\u4e3a\uff1a 1 2 3 4 5 6 7 8 9 10 __asm__ volatile ( \"instruction1 \\n \" \"instruction2 \\n \" ...... ...... \"instruction3 \\n \" : [ out1 ] \"=r\" ( v1 ),[ out2 ] \"=r\" ( v2 ) : [ in1 ] \"r\" ( v1 ), [ in2 ] \"r\" ( v2 ) : \"memory\" ); \u5176\u4e2d\uff0c\u4e09\u4e2a : \u5c06\u6c47\u7f16\u90e8\u5206\u5206\u6210\u4e86\u56db\u90e8\u5206\uff1a \u7b2c\u4e00\u90e8\u5206\u662f\u6c47\u7f16\u6307\u4ee4\uff0c\u6307\u4ee4\u672b\u5c3e\u9700\u8981\u6dfb\u52a0 '\\n'\u3002 \u7b2c\u4e8c\u90e8\u5206\u662f\u8f93\u51fa\u64cd\u4f5c\u6570\u90e8\u5206\u3002 \u7b2c\u4e09\u90e8\u5206\u662f\u8f93\u5165\u64cd\u4f5c\u6570\u90e8\u5206\u3002 \u7b2c\u56db\u90e8\u5206\u662f\u53ef\u80fd\u5f71\u54cd\u7684\u5bc4\u5b58\u5668\u6216\u5b58\u50a8\u5668\uff0c\u7528\u4e8e\u544a\u77e5\u7f16\u8bd1\u5668\u5f53\u524d\u5185\u8054\u6c47\u7f16\u8bed\u53e5\u53ef\u80fd\u4f1a\u5bf9\u67d0\u4e9b\u5bc4\u5b58\u5668\u6216\u5185\u5b58\u8fdb\u884c\u4fee\u6539\uff0c\u4f7f\u5f97\u7f16\u8bd1\u5668\u5728\u4f18\u5316\u65f6\u5c06\u5176\u56e0\u7d20\u8003\u8651\u8fdb\u53bb\u3002 \u8fd9\u56db\u90e8\u5206\u4e2d\u540e\u4e09\u90e8\u5206\u4e0d\u662f\u5fc5\u987b\u7684\u3002","title":"3.6 \u5185\u8054\u6c47\u7f16"},{"location":"lab1/#_1","text":"1 2 3 4 5 6 7 8 9 10 11 12 unsigned long long s_example ( unsigned long long type , unsigned long long arg0 ) { unsigned long long ret_val ; __asm__ volatile ( \"mv x10, %[type] \\n \" \"mv x11, %[arg0] \\n \" \"mv %[ret_val], x12\" : [ ret_val ] \"=r\" ( ret_val ) : [ type ] \"r\" ( type ), [ arg0 ] \"r\" ( arg0 ) : \"memory\" ); return ret_val ; } \u793a\u4f8b\u4e00\u4e2d\u6307\u4ee4\u90e8\u5206\uff0c %[type] \u3001 %[arg0] \u4ee5\u53ca %[ret_val] \u4ee3\u8868\u7740\u7279\u5b9a\u7684\u5bc4\u5b58\u5668\u6216\u662f\u5185\u5b58\u3002 \u8f93\u5165\u8f93\u51fa\u90e8\u5206\u4e2d\uff0c [type] \"r\" (type) \u4ee3\u8868\u7740\u5c06 () \u4e2d\u7684\u53d8\u91cf type \u653e\u5165\u5bc4\u5b58\u5668\u4e2d\uff08 \"r\" \u6307\u653e\u5165\u5bc4\u5b58\u5668\uff0c\u5982\u679c\u662f \"m\" \u5219\u4e3a\u653e\u5165\u5185\u5b58\uff09\uff0c\u5e76\u4e14\u7ed1\u5b9a\u5230 [] \u4e2d\u547d\u540d\u7684\u7b26\u53f7\u4e2d\u53bb\u3002 [ret_val] \"=r\" (ret_val) \u4ee3\u8868\u7740\u5c06\u6c47\u7f16\u6307\u4ee4\u4e2d %[ret_val] \u7684\u503c\u66f4\u65b0\u5230\u53d8\u91cf ret_val \u4e2d\u3002","title":"\u793a\u4f8b\u4e00"},{"location":"lab1/#_2","text":"1 2 #define write_csr(reg, val) ({ __asm__ volatile ( \"csrw \" # reg \", %0\" :: \"r\" ( val )); }) \u793a\u4f8b\u4e8c\u5b9a\u4e49\u4e86\u4e00\u4e2a\u5b8f\uff0c\u5176\u4e2d %0 \u4ee3\u8868\u7740\u8f93\u51fa\u8f93\u5165\u90e8\u5206\u7684\u7b2c\u4e00\u4e2a\u7b26\u53f7\uff0c\u5373 val \u3002 #reg \u662fc\u8bed\u8a00\u7684\u4e00\u4e2a\u7279\u6b8a\u5b8f\u5b9a\u4e49\u8bed\u6cd5\uff0c\u76f8\u5f53\u4e8e\u5c06reg\u8fdb\u884c\u5b8f\u66ff\u6362\u5e76\u7528\u53cc\u5f15\u53f7\u5305\u88f9\u8d77\u6765\u3002 \u4f8b\u5982 write_csr(sstatus,val) \u7ecf\u5b8f\u5c55\u5f00\u4f1a\u5f97\u5230\uff1a 1 2 ({ __asm__ volatile ( \"csrw \" \"sstatus\" \", %0\" :: \"r\" ( val )); })","title":"\u793a\u4f8b\u4e8c"},{"location":"lab1/#37","text":"","title":"3.7 \u7f16\u8bd1\u76f8\u5173\u77e5\u8bc6\u4ecb\u7ecd"},{"location":"lab1/#vmlinuxlds","text":"GNU ld \u5373\u94fe\u63a5\u5668\uff0c\u7528\u4e8e\u5c06 *.o \u6587\u4ef6\uff08\u548c\u5e93\u6587\u4ef6\uff09\u94fe\u63a5\u6210\u53ef\u6267\u884c\u6587\u4ef6\u3002\u5728\u64cd\u4f5c\u7cfb\u7edf\u5f00\u53d1\u4e2d\uff0c\u4e3a\u4e86\u6307\u5b9a\u7a0b\u5e8f\u7684\u5185\u5b58\u5e03\u5c40\uff0cld \u4f7f\u7528\u94fe\u63a5\u811a\u672c\uff08Linker Script\uff09\u6765\u63a7\u5236\uff0c\u5728 Linux Kernel \u4e2d\u94fe\u63a5\u811a\u672c\u88ab\u547d\u540d\u4e3a vmlinux.lds\u3002\u66f4\u591a\u5173\u4e8e ld \u7684\u4ecb\u7ecd\u53ef\u4ee5\u4f7f\u7528 man ld \u547d\u4ee4\u3002 \u4e0b\u9762\u7ed9\u51fa\u4e00\u4e2a vmlinux.lds \u7684\u4f8b\u5b50\uff1a 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 /* \u76ee\u6807\u67b6\u6784 */ OUTPUT_ARCH( \"riscv\" ) /* \u7a0b\u5e8f\u5165\u53e3 */ ENTRY( _start ) /* kernel\u4ee3\u7801\u8d77\u59cb\u4f4d\u7f6e */ BASE_ADDR = 0x80200000; SECTIONS { /* . \u4ee3\u8868\u5f53\u524d\u5730\u5740 */ . = BASE_ADDR; /* \u8bb0\u5f55kernel\u4ee3\u7801\u7684\u8d77\u59cb\u5730\u5740 */ _skernel = .; /* ALIGN(0x1000) \u8868\u793a4KB\u5bf9\u9f50 */ /* _stext, _etext \u5206\u522b\u8bb0\u5f55\u4e86text\u6bb5\u7684\u8d77\u59cb\u4e0e\u7ed3\u675f\u5730\u5740 */ .text : ALIGN(0x1000){ _stext = .; *(.text.entry) *(.text .text.*) _etext = .; } .rodata : ALIGN(0x1000){ _srodata = .; *(.rodata .rodata.*) _erodata = .; } .data : ALIGN(0x1000){ _sdata = .; *(.data .data.*) _edata = .; } .bss : ALIGN(0x1000){ _sbss = .; *(.bss.stack) sbss = .; *(.bss .bss.*) _ebss = .; } /* \u8bb0\u5f55kernel\u4ee3\u7801\u7684\u7ed3\u675f\u5730\u5740 */ _ekernel = .; } \u9996\u5148\u6211\u4eec\u4f7f\u7528 OUTPUT_ARCH \u6307\u5b9a\u4e86\u67b6\u6784\u4e3a RISC-V \uff0c\u4e4b\u540e\u4f7f\u7528 ENTRY \u6307\u5b9a\u7a0b\u5e8f\u5165\u53e3\u70b9\u4e3a _start \u51fd\u6570\uff0c\u7a0b\u5e8f\u5165\u53e3\u70b9\u5373\u7a0b\u5e8f\u542f\u52a8\u65f6\u8fd0\u884c\u7684\u51fd\u6570\uff0c\u7ecf\u8fc7\u8fd9\u6837\u7684\u6307\u5b9a\u540e\u5728head.S\u4e2d\u9700\u8981\u7f16\u5199 _start \u51fd\u6570\uff0c\u7a0b\u5e8f\u624d\u80fd\u6b63\u5e38\u8fd0\u884c\u3002 \u94fe\u63a5\u811a\u672c\u4e2d\u6709 . * \u4e24\u4e2a\u91cd\u8981\u7684\u7b26\u53f7\u3002\u5355\u72ec\u7684 . \u5728\u94fe\u63a5\u811a\u672c\u4ee3\u8868\u5f53\u524d\u5730\u5740\uff0c\u5b83\u6709\u8d4b\u503c\u3001\u88ab\u8d4b\u503c\u3001\u81ea\u589e\u7b49\u64cd\u4f5c\u3002\u800c * \u6709\u4e24\u79cd\u7528\u6cd5\uff0c\u5176\u4e00\u662f *() \u5728\u5927\u62ec\u53f7\u4e2d\u8868\u793a\u5c06\u6240\u6709\u6587\u4ef6\u4e2d\u7b26\u5408\u62ec\u53f7\u5185\u8981\u6c42\u7684\u6bb5\u653e\u7f6e\u5728\u5f53\u524d\u4f4d\u7f6e\uff0c\u5176\u4e8c\u662f\u4f5c\u4e3a\u901a\u914d\u7b26\u3002 \u94fe\u63a5\u811a\u672c\u7684\u4e3b\u4f53\u662fSECTIONS\u90e8\u5206\uff0c\u5728\u8fd9\u91cc\u94fe\u63a5\u811a\u672c\u7684\u5de5\u4f5c\u662f\u5c06\u7a0b\u5e8f\u7684\u5404\u4e2a\u6bb5\u6309\u987a\u5e8f\u653e\u5728\u5404\u4e2a\u5730\u5740\u4e0a\uff0c\u5728\u4f8b\u5b50\u4e2d\u5c31\u662f\u4ece0x80200000\u5730\u5740\u5f00\u59cb\u653e\u7f6e\u4e86 .text \uff0c .rodata \uff0c .data \u548c .bss \u6bb5\u3002\u5404\u4e2a\u6bb5\u7684\u4f5c\u7528\u53ef\u4ee5\u7b80\u8981\u6982\u62ec\u6210\uff1a \u6bb5\u540d \u4e3b\u8981\u4f5c\u7528 .text \u901a\u5e38\u5b58\u653e\u7a0b\u5e8f\u6267\u884c\u4ee3\u7801 .rodata \u901a\u5e38\u5b58\u653e\u5e38\u91cf\u7b49\u53ea\u8bfb\u6570\u636e .data \u901a\u5e38\u5b58\u653e\u5df2\u521d\u59cb\u5316\u7684\u5168\u5c40\u53d8\u91cf\u3001\u9759\u6001\u53d8\u91cf .bss \u901a\u5e38\u5b58\u653e\u672a\u521d\u59cb\u5316\u7684\u5168\u5c40\u53d8\u91cf\u3001\u9759\u6001\u53d8\u91cf \u5728\u94fe\u63a5\u811a\u672c\u4e2d\u53ef\u4ee5\u81ea\u5b9a\u4e49\u7b26\u53f7\uff0c\u4f8b\u5982\u4ee5\u4e0a\u6240\u6709 _s \u4e0e _e \u5f00\u5934\u7684\u7b26\u53f7\u90fd\u662f\u6211\u4eec\u81ea\u5df1\u5b9a\u4e49\u7684\u3002 \u66f4\u591a\u6709\u5173\u94fe\u63a5\u811a\u672c\u8bed\u6cd5\u53ef\u4ee5\u53c2\u8003 \u8fd9\u91cc \u3002","title":"vmlinux.lds"},{"location":"lab1/#vmlinux","text":"vmlinux \u901a\u5e38\u6307 Linux Kernel \u7f16\u8bd1\u51fa\u7684\u53ef\u6267\u884c\u6587\u4ef6 (Executable and Linkable Format / ELF)\uff0c\u7279\u70b9\u662f\u672a\u538b\u7f29\u7684\uff0c\u5e26\u8c03\u8bd5\u4fe1\u606f\u548c\u7b26\u53f7\u8868\u7684\u3002\u5728\u6574\u5957 OS \u5b9e\u9a8c\u4e2d\uff0cvmlinux \u901a\u5e38\u6307\u5c06\u4f60\u7684\u4ee3\u7801\u8fdb\u884c\u7f16\u8bd1\uff0c\u94fe\u63a5\u540e\u751f\u6210\u7684\u53ef\u4f9b QEMU \u8fd0\u884c\u7684 RV64 \u67b6\u6784\u7a0b\u5e8f\u3002\u5982\u679c\u5bf9 vmlinux \u4f7f\u7528 file \u547d\u4ee4\uff0c\u4f60\u5c06\u770b\u5230\u5982\u4e0b\u4fe1\u606f\uff1a 1 2 $ file vmlinux vmlinux: ELF 64 -bit LSB executable, UCB RISC-V, version 1 ( SYSV ) , statically linked, not stripped","title":"vmlinux"},{"location":"lab1/#systemmap","text":"System.map\u662f\u5185\u6838\u7b26\u53f7\u8868\uff08Kernel Symbol Table\uff09\u6587\u4ef6\uff0c\u662f\u5b58\u50a8\u4e86\u6240\u6709\u5185\u6838\u7b26\u53f7\u53ca\u5176\u5730\u5740\u7684\u4e00\u4e2a\u5217\u8868\u3002\u201c\u7b26\u53f7\u201d\u901a\u5e38\u6307\u7684\u662f\u51fd\u6570\u540d\uff0c\u5168\u5c40\u53d8\u91cf\u540d\u7b49\u7b49\u3002\u4f7f\u7528 nm vmlinux \u547d\u4ee4\u5373\u53ef\u6253\u5370vmlinux\u7684\u7b26\u53f7\u8868\uff0c\u7b26\u53f7\u8868\u7684\u6837\u4f8b\u5982\u4e0b\uff1a 1 2 3 4 5 6 7 8 9 10 0000000000000800 A __vdso_rt_sigreturn ffffffe000000000 T __init_begin ffffffe000000000 T _sinittext ffffffe000000000 T _start ffffffe000000040 T _start_kernel ffffffe000000076 t clear_bss ffffffe000000080 t clear_bss_done ffffffe0000000c0 t relocate ffffffe00000017c t set_reset_devices ffffffe000000190 t debug_kernel \u4f7f\u7528 System.map \u53ef\u4ee5\u65b9\u4fbf\u5730\u8bfb\u51fa\u51fd\u6570\u6216\u53d8\u91cf\u7684\u5730\u5740\uff0c\u4e3a Debug \u63d0\u4f9b\u4e86\u65b9\u4fbf\u3002","title":"System.map"},{"location":"lab1/#4","text":"","title":"4 \u5b9e\u9a8c\u6b65\u9aa4"},{"location":"lab1/#41","text":"\u4ece repo \u540c\u6b65\u5b9e\u9a8c\u4ee3\u7801\u6846\u67b6\uff0c \u53c2\u8003 Lab0 \u4e2d\uff0c\u5c06\u5de5\u7a0b\u4ee3\u7801\u6620\u5c04\u8fdb\u5bb9\u5668\u4e2d\u3002\u8fd9\u6837\u5c31\u53ef\u4ee5\u65b9\u4fbf\u7684\u5728\u672c\u5730\u5f00\u53d1\uff0c\u540c\u65f6\u4f7f\u7528\u5bb9\u5668\u5185\u7684\u5de5\u5177\u8fdb\u884c\u7f16\u8bd1\u3002 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 \u251c\u2500\u2500 arch \u2502 \u2514\u2500\u2500 riscv \u2502 \u251c\u2500\u2500 include \u2502 \u2502 \u251c\u2500\u2500 defs.h \u2502 \u2502 \u2514\u2500\u2500 sbi.h \u2502 \u251c\u2500\u2500 kernel \u2502 \u2502 \u251c\u2500\u2500 head.S \u2502 \u2502 \u251c\u2500\u2500 Makefile \u2502 \u2502 \u251c\u2500\u2500 sbi.c \u2502 \u2502 \u2514\u2500\u2500 vmlinux.lds \u2502 \u2514\u2500\u2500 Makefile \u251c\u2500\u2500 include \u2502 \u251c\u2500\u2500 print.h \u2502 \u2514\u2500\u2500 types.h \u251c\u2500\u2500 init \u2502 \u251c\u2500\u2500 main.c \u2502 \u251c\u2500\u2500 Makefile \u2502 \u2514\u2500\u2500 test.c \u251c\u2500\u2500 lib \u2502 \u251c\u2500\u2500 Makefile \u2502 \u2514\u2500\u2500 print.c \u2514\u2500\u2500 Makefile \u9700\u8981\u5b8c\u5584\u4ee5\u4e0b\u6587\u4ef6\uff1a arch/riscv/kernel/head.S lib/Makefile arch/riscv/kernel/sbi.c lib/print.c arch/riscv/include/defs.h","title":"4.1 \u51c6\u5907\u5de5\u7a0b"},{"location":"lab1/#42-heads","text":"\u5b66\u4e60riscv\u7684\u6c47\u7f16\u3002 \u5b8c\u6210 arch/riscv/kernel/head.S \u3002\u6211\u4eec\u9996\u5148\u4e3a\u5373\u5c06\u8fd0\u884c\u7684\u7b2c\u4e00\u4e2a C \u51fd\u6570\u8bbe\u7f6e\u7a0b\u5e8f\u6808\uff08\u6808\u7684\u5927\u5c0f\u53ef\u4ee5\u8bbe\u7f6e\u4e3a4KB\uff09\uff0c\u5e76\u5c06\u8be5\u6808\u653e\u7f6e\u5728 .bss.stack \u6bb5\u3002\u63a5\u4e0b\u6765\u6211\u4eec\u53ea\u9700\u8981\u901a\u8fc7\u8df3\u8f6c\u6307\u4ee4\uff0c\u8df3\u8f6c\u81f3 main.c \u4e2d\u7684 start_kernel \u51fd\u6570\u5373\u53ef\u3002","title":"4.2 \u7f16\u5199head.S"},{"location":"lab1/#43-makefile","text":"\u9605\u8bfb\u6587\u6863\u4e2d\u5173\u4e8e Makefile \u7684\u7ae0\u8282\uff0c\u4ee5\u53ca\u5de5\u7a0b\u6587\u4ef6\u4e2d\u7684 Makefile \u6587\u4ef6\uff0c\u6839\u636e\u6ce8\u91ca\u5b66\u4f1a Makefile \u7684\u4f7f\u7528\u89c4\u5219\u540e\uff0c\u8865\u5145 lib/Makefile \uff0c\u4f7f\u5de5\u7a0b\u5f97\u4ee5\u7f16\u8bd1\u3002 \u5b8c\u6210\u6b64\u6b65\u540e\u5728\u5de5\u7a0b\u6839\u6587\u4ef6\u5939\u6267\u884c make\uff0c\u53ef\u4ee5\u770b\u5230\u5de5\u7a0b\u6210\u529f\u7f16\u8bd1\u51fa vmlinux\u3002","title":"4.3 \u5b8c\u5584 Makefile \u811a\u672c"},{"location":"lab1/#44-sbic","text":"OpenSBI \u5728 M \u6001\uff0c\u4e3a S \u6001\u63d0\u4f9b\u4e86\u591a\u79cd\u63a5\u53e3\uff0c\u6bd4\u5982\u5b57\u7b26\u4e32\u8f93\u5165\u8f93\u51fa\u3002\u56e0\u6b64\u6211\u4eec\u9700\u8981\u5b9e\u73b0\u8c03\u7528 OpenSBI \u63a5\u53e3\u7684\u529f\u80fd\u3002\u7ed9\u51fa\u51fd\u6570\u5b9a\u4e49\u5982\u4e0b\uff1a 1 2 3 4 5 6 7 8 struct sbiret { long error ; long value ; }; struct sbiret sbi_ecall ( int ext , int fid , uint64 arg0 , uint64 arg1 , uint64 arg2 , uint64 arg3 , uint64 arg4 , uint64 arg5 ); sbi_ecall \u51fd\u6570\u4e2d\uff0c\u9700\u8981\u5b8c\u6210\u4ee5\u4e0b\u5185\u5bb9\uff1a \u5c06 ext (Extension ID) \u653e\u5165\u5bc4\u5b58\u5668 a7 \u4e2d\uff0cfid (Function ID) \u653e\u5165\u5bc4\u5b58\u5668 a6 \u4e2d\uff0c\u5c06 arg0 ~ arg5 \u653e\u5165\u5bc4\u5b58\u5668 a0 ~ a5 \u4e2d\u3002 \u4f7f\u7528 ecall \u6307\u4ee4\u3002 ecall \u4e4b\u540e\u7cfb\u7edf\u4f1a\u8fdb\u5165 M \u6a21\u5f0f\uff0c\u4e4b\u540e OpenSBI \u4f1a\u5b8c\u6210\u76f8\u5173\u64cd\u4f5c\u3002 OpenSBI \u7684\u8fd4\u56de\u7ed3\u679c\u4f1a\u5b58\u653e\u5728\u5bc4\u5b58\u5668 a0 \uff0c a1 \u4e2d\uff0c\u5176\u4e2d a0 \u4e3a error code\uff0c a1 \u4e3a\u8fd4\u56de\u503c\uff0c \u6211\u4eec\u7528 sbiret \u6765\u63a5\u53d7\u8fd9\u4e24\u4e2a\u8fd4\u56de\u503c\u3002 \u540c\u5b66\u4eec\u53ef\u4ee5\u53c2\u7167\u5185\u8054\u6c47\u7f16\u7684\u793a\u4f8b\u4e00\u5b8c\u6210\u8be5\u51fd\u6570\u7684\u7f16\u5199\u3002 \u7f16\u5199\u6210\u529f\u540e\uff0c\u8c03\u7528 sbi_ecall(0x1, 0x0\uff0c 0x30, 0, 0\uff0c 0\uff0c 0\uff0c 0) \u5c06\u4f1a\u8f93\u51fa\u5b57\u7b26'0'\u3002\u5176\u4e2d 0x1 \u4ee3\u8868 sbi_console_putchar \u7684 ExtensionID\uff0c 0x0 \u4ee3\u8868FunctionID, 0x30\u4ee3\u8868'0'\u7684ascii\u503c\uff0c\u5176\u4f59\u53c2\u6570\u586b0\u3002 \u8bf7\u5728 arch/riscv/kernel/sbi.c \u4e2d\u8865\u5145 sbi_ecall() \u3002 \u4e0b\u9762\u5217\u51fa\u4e86\u4e00\u4e9b\u5728\u540e\u7eed\u7684\u5b9e\u9a8c\u4e2d\u53ef\u80fd\u9700\u8981\u4f7f\u7528\u7684\u529f\u80fd\u3002 Function Name Function ID Extension ID sbi_set_timer \uff08\u8bbe\u7f6e\u65f6\u949f\u76f8\u5173\u5bc4\u5b58\u5668\uff09 0 0x00 sbi_console_putchar \uff08\u6253\u5370\u5b57\u7b26\uff09 0 0x01 sbi_console_getchar \uff08\u63a5\u6536\u5b57\u7b26\uff09 0 0x02 sbi_shutdown \uff08\u5173\u673a\uff09 0 0x08","title":"4.4 \u8865\u5145 sbi.c"},{"location":"lab1/#45-puts-puti","text":"\u8c03\u7528\u4ee5\u4e0a\u5b8c\u6210\u7684 sbi_ecall , \u5b8c\u6210 puts() \u548c puti() \u7684\u5b9e\u73b0\u3002 puts() \u7528\u4e8e\u6253\u5370\u5b57\u7b26\u4e32\uff0c puti() \u7528\u4e8e\u6253\u5370\u6574\u578b\u53d8\u91cf\u3002 \u8bf7\u7f16\u5199 lib/print.c \u4e2d\u7684 puts() \u548c puti() \uff0c \u51fd\u6570\u7684\u76f8\u5173\u5b9a\u4e49\u5df2\u7ecf\u5199\u5728\u4e86 print.h \u6587\u4ef6\u3002","title":"4.5 puts() \u548c puti()"},{"location":"lab1/#46-defs","text":"\u5185\u8054\u6c47\u7f16\u7684\u76f8\u5173\u77e5\u8bc6\u89c1 \u5185\u8054\u6c47\u7f16 \u3002 \u5b66\u4e60\u4e86\u89e3\u4e86\u4ee5\u4e0a\u77e5\u8bc6\u540e\uff0c\u8865\u5145 arch/riscv/include/defs.h \u4e2d\u7684\u4ee3\u7801\u5b8c\u6210\uff1a \u8865\u5145\u5b8c read_csr \u8fd9\u4e2a\u5b8f\u5b9a\u4e49\u3002\u8fd9\u91cc\u6709\u76f8\u5173 \u793a\u4f8b \u3002","title":"4.6 \u4fee\u6539 defs"},{"location":"lab1/#_3","text":"\u8bf7\u603b\u7ed3\u4e00\u4e0b RISC-V \u7684 calling convention\uff0c\u5e76\u89e3\u91ca Caller / Callee Saved Register \u6709\u4ec0\u4e48\u533a\u522b\uff1f \u7f16\u8bd1\u4e4b\u540e\uff0c\u901a\u8fc7 System.map \u67e5\u770b vmlinux.lds \u4e2d\u81ea\u5b9a\u4e49\u7b26\u53f7\u7684\u503c","title":"\u601d\u8003\u9898"},{"location":"lab1/#_4","text":"\u540c\u5b66\u9700\u8981\u63d0\u4ea4\u5b9e\u9a8c\u62a5\u544a\u4ee5\u53ca\u6574\u4e2a\u5de5\u7a0b\u4ee3\u7801\u3002\u5728\u63d0\u4ea4\u524d\u8bf7\u4f7f\u7528 make clean \u6e05\u9664\u6240\u6709\u6784\u5efa\u4ea7\u7269\u3002","title":"\u4f5c\u4e1a\u63d0\u4ea4"},{"location":"lab2/","text":"Lab 2: RV64 \u65f6\u949f\u4e2d\u65ad\u5904\u7406 1 \u5b9e\u9a8c\u76ee\u7684 \u5b66\u4e60 RISC-V \u7684\u5f02\u5e38\u5904\u7406\u76f8\u5173\u5bc4\u5b58\u5668\u4e0e\u6307\u4ee4\uff0c\u5b8c\u6210\u5bf9\u5f02\u5e38\u5904\u7406\u7684\u521d\u59cb\u5316\u3002 \u7406\u89e3 CPU \u4e0a\u4e0b\u6587\u5207\u6362\u673a\u5236\uff0c\u5e76\u6b63\u786e\u5b9e\u73b0\u4e0a\u4e0b\u6587\u5207\u6362\u529f\u80fd\u3002 \u7f16\u5199\u5f02\u5e38\u5904\u7406\u51fd\u6570\uff0c\u5b8c\u6210\u5bf9\u7279\u5b9a\u5f02\u5e38\u7684\u5904\u7406\u3002 \u8c03\u7528 OpenSBI \u63d0\u4f9b\u7684\u63a5\u53e3\uff0c\u5b8c\u6210\u5bf9\u65f6\u949f\u4e2d\u65ad\u4e8b\u4ef6\u7684\u8bbe\u7f6e\u3002 2 \u5b9e\u9a8c\u73af\u5883 Docker in Lab0 3 \u80cc\u666f\u77e5\u8bc6 3.0 \u524d\u8a00 \u5728 lab1 \u4e2d\u6211\u4eec\u6210\u529f\u7684\u5c06\u4e00\u4e2a\u6700\u7b80\u5355\u7684 OS \u542f\u52a8\u8d77\u6765\uff0c \u4f46\u8fd8\u6ca1\u6709\u529e\u6cd5\u4e0e\u4e4b\u4ea4\u4e92\u3002\u6211\u4eec\u5728\u8bfe\u7a0b\u4e2d\u8bb2\u8fc7\u64cd\u4f5c\u7cfb\u7edf\u542f\u52a8\u4e4b\u540e\u7531 \u4e8b\u4ef6 \uff08 event \uff09\u9a71\u52a8\uff0c\u5728\u672c\u6b21\u5b9e\u9a8c\u4e2d\u6211\u4eec\u5c06\u5f15\u5165\u4e00\u79cd\u91cd\u8981\u7684\u4e8b\u4ef6 \u5f02\u5e38 \uff0c \u5f02\u5e38\u7ed9\u4e86 OS \u4e0e\u786c\u4ef6\u3001\u8f6f\u4ef6\u4ea4\u4e92\u7684\u80fd\u529b\u3002\u5728 lab1 \u4e2d\u6211\u4eec\u4ecb\u7ecd\u4e86\u5728 RISC-V \u4e2d\u6709\u4e09\u79cd\u7279\u6743\u7ea7 ( M \u6001\u3001 S \u6001\u3001 U \u6001 )\uff0c \u5728 Boot \u9636\u6bb5\uff0c OpenSBI \u5df2\u7ecf\u5e2e\u6211\u4eec\u5c06 M \u6001\u7684\u5f02\u5e38\u5904\u7406\u8fdb\u884c\u4e86\u521d\u59cb\u5316\uff0c\u8fd9\u4e00\u90e8\u5206\u4e0d\u9700\u8981\u6211\u4eec\u518d\u53bb\u5b9e\u73b0\uff0c\u56e0\u6b64\u672c\u6b21\u8bd5\u9a8c\u6211\u4eec\u91cd\u70b9\u5173\u6ce8 S \u6001\u7684\u5f02\u5e38\u5904\u7406\u3002 3.1 RISC-V \u4e2d\u7684 Interrupt \u548c Exception 3.1.1 \u4ec0\u4e48\u662f Interrupt \u548c Exception We use the term exception to refer to an unusual condition occurring at run time associated with an instruction in the current RISC-V hart. We use the term interrupt to refer to an external asynchronous event that may cause a RISC-V hart to experience an unexpected transfer of control. We use the term trap to refer to the transfer of control to a trap handler caused by either an exception or an interrupt. \u4e0a\u8ff0\u662f RISC-V Unprivileged Spec 1.6 \u8282\u4e2d\u5bf9\u4e8e Trap \u3001 Interrupt \u4e0e Exception \u7684\u63cf\u8ff0\u3002\u603b\u7ed3\u8d77\u6765 Interrupt \u4e0e Exception \u7684\u4e3b\u8981\u533a\u522b\u5982\u4e0b\u8868\uff1a Interrupt Exception Hardware generate Software generate These are asynchronous external requests for service (like keyboard or printer needs service). These are synchronous internal requests for service based upon abnormal events (think of illegal instructions, illegal address, overflow etc). These are normal events and shouldn\u2019t interfere with the normal running of a computer. These are abnormal events and often result in the termination of a program \u4e0a\u6587\u4e2d\u7684 Trap \u63cf\u8ff0\u7684\u662f\u4e00\u79cd\u63a7\u5236\u8f6c\u79fb\u7684\u8fc7\u7a0b, \u8fd9\u4e2a\u8fc7\u7a0b\u662f\u7531 Interrupt \u6216\u8005 Exception \u5f15\u8d77\u7684\u3002\u8fd9\u91cc\u4e3a\u4e86\u65b9\u4fbf\u8d77\u89c1\uff0c\u6211\u4eec\u5728\u8fd9\u91cc\u7ea6\u5b9a Trap \u4e3a Interrput \u4e0e Exception \u7684\u603b\u79f0\u3002 \u5728\u4e0b\u6587\u4e2d \u6211\u4eec\u7528 \u5f02\u5e38 \u4ee3\u6307 Trap 3.1.2 \u76f8\u5173\u5bc4\u5b58\u5668 \u9664\u4e8632\u4e2a\u901a\u7528\u5bc4\u5b58\u5668\u4e4b\u5916\uff0cRISC-V \u67b6\u6784\u8fd8\u6709\u5927\u91cf\u7684 \u63a7\u5236\u72b6\u6001\u5bc4\u5b58\u5668 Control and Status Registers(CSRs) \uff0c\u4e0b\u9762\u5c06\u4ecb\u7ecd\u51e0\u4e2a\u548c\u5f02\u5e38\u673a\u5236\u76f8\u5173\u7684\u91cd\u8981\u5bc4\u5b58\u5668\u3002 Supervisor Mode \u5f02\u5e38\u76f8\u5173\u5bc4\u5bc4\u5b58\u5668: sstatus ( Supervisor Status Register )\u4e2d\u5b58\u5728\u4e00\u4e2a SIE ( Supervisor Interrupt Enable ) \u6bd4\u7279\u4f4d\uff0c\u5f53\u8be5\u6bd4\u7279\u4f4d\u8bbe\u7f6e\u4e3a 1 \u65f6\uff0c\u4f1a\u5bf9\u6240\u6709\u7684 S \u6001\u5f02\u5e38 \u54cd\u5e94 \uff0c \u5426\u5219\u5c06\u4f1a\u7981\u7528\u6240\u6709 S \u6001\u5f02\u5e38\u3002 sie ( Supervisor Interrupt Eable Register )\u3002\u5728 RISC-V \u4e2d\uff0c Interrupt \u88ab\u5212\u5206\u4e3a\u4e09\u7c7b Software Interrupt \uff0c Timer Interrupt \uff0c External Interrupt \u3002\u5728\u5f00\u542f\u4e86 sstatus[SIE] \u4e4b\u540e\uff0c\u7cfb\u7edf\u4f1a\u6839\u636e sie \u4e2d\u7684\u76f8\u5173\u6bd4\u7279\u4f4d\u6765\u51b3\u5b9a\u662f\u5426\u5bf9\u8be5 Interrupt \u8fdb\u884c \u5904\u7406 \u3002 stvec ( Supervisor Trap Vector Base Address Register ) \u5373\u6240\u8c13\u7684\u201d\u4e2d\u65ad\u5411\u91cf\u8868\u57fa\u5740\u201d\u3002 stvec \u6709\u4e24\u79cd\u6a21\u5f0f\uff1a Direct \u6a21\u5f0f \uff0c\u9002\u7528\u4e8e\u7cfb\u7edf\u4e2d\u53ea\u6709\u4e00\u4e2a\u4e2d\u65ad\u5904\u7406\u7a0b\u5e8f, \u5176\u6307\u5411\u4e2d\u65ad\u5904\u7406\u5165\u53e3\u51fd\u6570 \uff08 \u672c\u6b21\u5b9e\u9a8c\u4e2d\u6211\u4eec\u6240\u7528\u7684\u6a21\u5f0f \uff09\u3002 Vectored \u6a21\u5f0f \uff0c\u6307\u5411\u4e2d\u65ad\u5411\u91cf\u8868\uff0c \u9002\u7528\u4e8e\u7cfb\u7edf\u4e2d\u6709\u591a\u4e2a\u4e2d\u65ad\u5904\u7406\u7a0b\u5e8f \uff08 \u8be5\u6a21\u5f0f\u53ef\u4ee5\u53c2\u8003 RISC-V \u5185\u6838\u6e90\u7801 \uff09\u3002 scause ( Supervisor Cause Register ), \u4f1a\u8bb0\u5f55\u5f02\u5e38\u53d1\u751f\u7684\u539f\u56e0\uff0c\u8fd8\u4f1a\u8bb0\u5f55\u8be5\u5f02\u5e38\u662f Interrupt \u8fd8\u662f Exception \u3002 sepc ( Supervisor Exception Program Counter ), \u4f1a\u8bb0\u5f55\u89e6\u53d1\u5f02\u5e38\u7684\u90a3\u6761\u6307\u4ee4\u7684\u5730\u5740\u3002 Machine Mode \u5f02\u5e38\u76f8\u5173\u5bc4\u5bc4\u5b58\u5668: \u7c7b\u4f3c\u4e8e Supervisor Mode\uff0c Machine Mode \u4e5f\u6709\u76f8\u5bf9\u5e94\u7684\u5bc4\u5b58\u5668\uff0c\u4f46\u7531\u4e8e\u672c\u5b9e\u9a8c\u540c\u5b66\u4e0d\u9700\u8981\u64cd\u4f5c\u8fd9\u4e9b\u5bc4\u5b58\u5668\uff0c\u6545\u4e0d\u5728\u6b64\u4f5c\u4ecb\u7ecd\u3002 \u4ee5\u4e0a\u5bc4\u5b58\u5668\u7684\u8be6\u7ec6\u4ecb\u7ecd\u8bf7\u540c\u5b66\u4eec\u53c2\u8003 RISC-V Privileged Spec 3.1.3 \u76f8\u5173\u7279\u6743\u6307\u4ee4 ecall ( Environment Call )\uff0c\u5f53\u6211\u4eec\u5728 S \u6001\u6267\u884c\u8fd9\u6761\u6307\u4ee4\u65f6\uff0c\u4f1a\u89e6\u53d1\u4e00\u4e2a ecall-from-s-mode-exception \uff0c\u4ece\u800c\u8fdb\u5165 M \u6a21\u5f0f\u4e2d\u7684\u4e2d\u65ad\u5904\u7406\u6d41\u7a0b( \u5982\u8bbe\u7f6e\u5b9a\u65f6\u5668\u7b49 )\uff1b\u5f53\u6211\u4eec\u5728 U \u6001\u6267\u884c\u8fd9\u6761\u6307\u4ee4\u65f6\uff0c\u4f1a\u89e6\u53d1\u4e00\u4e2a ecall-from-u-mode-exception \uff0c\u4ece\u800c\u8fdb\u5165 S \u6a21\u5f0f\u4e2d\u7684\u4e2d\u65ad\u5904\u7406\u6d41\u7a0b ( \u5e38\u7528\u6765\u8fdb\u884c\u7cfb\u7edf\u8c03\u7528 )\u3002 sret \u7528\u4e8e S \u6001\u5f02\u5e38\u8fd4\u56de, \u901a\u8fc7 sepc \u6765\u8bbe\u7f6e pc \u7684\u503c\uff0c \u8fd4\u56de\u5230\u4e4b\u524d\u7a0b\u5e8f\u7ee7\u7eed\u8fd0\u884c\u3002 \u4ee5\u4e0a\u6307\u4ee4\u7684\u8be6\u7ec6\u4ecb\u7ecd\u8bf7\u540c\u5b66\u4eec\u53c2\u8003 RISC-V Privileged Spec 3.2 \u4e0a\u4e0b\u6587\u5904\u7406 \u7531\u4e8e\u5728\u5904\u7406\u5f02\u5e38\u65f6\uff0c\u6709\u53ef\u80fd\u4f1a\u6539\u53d8\u7cfb\u7edf\u7684\u72b6\u6001\u3002\u6240\u4ee5\u5728\u771f\u6b63\u5904\u7406\u5f02\u5e38\u4e4b\u524d\uff0c\u6211\u4eec\u6709\u5fc5\u8981\u5bf9\u7cfb\u7edf\u7684\u5f53\u524d\u72b6\u6001\u8fdb\u884c\u4fdd\u5b58\uff0c\u5728\u5f02\u5e38\u5904\u7406\u5b8c\u6210\u4e4b\u540e\uff0c\u6211\u4eec\u518d\u5c06\u7cfb\u7edf\u6062\u590d\u81f3\u539f\u5148\u7684\u72b6\u6001\uff0c\u5c31\u53ef\u4ee5\u786e\u4fdd\u4e4b\u524d\u7684\u7a0b\u5e8f\u7ee7\u7eed\u6b63\u5e38\u8fd0\u884c\u3002 \u8fd9\u91cc\u7684\u7cfb\u7edf\u72b6\u6001\u901a\u5e38\u662f\u6307\u5bc4\u5b58\u5668\uff0c\u8fd9\u4e9b\u5bc4\u5b58\u5668\u4e5f\u53eb\u505aCPU\u7684\u4e0a\u4e0b\u6587 ( Context ). 3.3 \u5f02\u5e38\u5904\u7406\u7a0b\u5e8f \u5f02\u5e38\u5904\u7406\u7a0b\u5e8f\u6839\u636e scause \u7684\u503c\uff0c \u8fdb\u5165\u4e0d\u540c\u7684\u5904\u7406\u903b\u8f91\uff0c\u5728\u672c\u6b21\u8bd5\u9a8c\u4e2d\u6211\u4eec\u9700\u8981\u5173\u5fc3\u7684\u53ea\u6709 Superviosr Timer Interrupt \u3002 3.4 \u65f6\u949f\u4e2d\u65ad \u65f6\u949f\u4e2d\u65ad\u9700\u8981 CPU \u786c\u4ef6\u7684\u652f\u6301\u3002CPU \u4ee5\"\u65f6\u949f\u5468\u671f\"\u4e3a\u5de5\u4f5c\u7684\u57fa\u672c\u65f6\u95f4\u5355\u4f4d\uff0c\u5bf9\u903b\u8f91\u95e8\u7684\u65f6\u5e8f\u7535\u8def\u8fdb\u884c\u540c\u6b65\u3002\u800c\u65f6\u949f\u4e2d\u65ad\u5b9e\u9645\u4e0a\u5c31\u662f\u201c\u6bcf\u9694\u82e5\u5e72\u4e2a\u65f6\u949f\u5468\u671f\u6267\u884c\u4e00\u6b21\u7684\u7a0b\u5e8f\u201d\u3002\u4e0b\u9762\u4ecb\u7ecd\u4e0e\u65f6\u949f\u4e2d\u65ad\u76f8\u5173\u7684\u5bc4\u5b58\u5668\u4ee5\u53ca\u5982\u4f55\u4ea7\u751f\u65f6\u949f\u4e2d\u65ad\u3002 mtime \u4e0e mtimecmp ( Machine Timer Register )\u3002 mtime \u662f\u4e00\u4e2a\u5b9e\u65f6\u8ba1\u65f6\u5668\uff0c \u7531\u786c\u4ef6\u4ee5\u6052\u5b9a\u7684\u9891\u7387\u81ea\u589e\u3002 mtimecmp \u4e2d\u4fdd\u5b58\u7740\u4e0b\u4e00\u6b21\u65f6\u949f\u4e2d\u65ad\u53d1\u751f\u7684\u65f6\u95f4\u70b9\uff0c\u5f53 mtime \u7684\u503c\u5927\u4e8e\u6216\u7b49\u4e8e mtimecmp \u7684\u503c\uff0c\u7cfb\u7edf\u5c31\u4f1a\u89e6\u53d1\u4e00\u6b21\u65f6\u949f\u4e2d\u65ad\u3002\u56e0\u6b64\u6211\u4eec\u53ea\u9700\u8981\u66f4\u65b0 mtimecmp \u4e2d\u7684\u503c\uff0c\u5c31\u53ef\u4ee5\u8bbe\u7f6e\u4e0b\u4e00\u6b21\u65f6\u949f\u4e2d\u65ad\u7684\u89e6\u53d1\u70b9\u3002 OpenSBI \u5df2\u7ecf\u4e3a\u6211\u4eec\u63d0\u4f9b\u4e86\u66f4\u65b0 mtimecmp \u7684\u63a5\u53e3 sbi_set_timer ( \u89c1 lab1 4.4\u8282 )\u3002 mcounteren ( Counter-Enable Registers )\u3002\u7531\u4e8e mtime \u662f\u5c5e\u4e8e M \u6001\u7684\u5bc4\u5b58\u5668\uff0c\u6211\u4eec\u5728 S \u6001\u65e0\u6cd5\u76f4\u63a5\u5bf9\u5176\u8bfb\u5199\uff0c \u5e78\u8fd0\u7684\u662f OpenSBI \u5728 M \u6001\u5df2\u7ecf\u901a\u8fc7\u8bbe\u7f6e mcounteren \u5bc4\u5b58\u5668\u7684 TM \u6bd4\u7279\u4f4d\uff0c \u8ba9\u6211\u4eec\u53ef\u4ee5\u5728 S \u6001\u4e2d\u53ef\u4ee5\u901a\u8fc7 time \u8fd9\u4e2a \u53ea\u8bfb \u5bc4\u5b58\u5668\u8bfb\u53d6\u5230 mtime \u7684\u5f53\u524d\u503c\uff0c\u76f8\u5173\u6c47\u7f16\u6307\u4ee4\u662f rdtime \u3002 \u4ee5\u4e0a\u5bc4\u5b58\u5668\u7684\u8be6\u7ec6\u4ecb\u7ecd\u8bf7\u540c\u5b66\u4eec\u53c2\u8003 RISC-V Privileged Spec 4 \u5b9e\u9a8c\u6b65\u9aa4 4.1 \u51c6\u5907\u5de5\u7a0b \u6b64\u6b21\u5b9e\u9a8c\u57fa\u4e8e lab1 \u540c\u5b66\u6240\u5b9e\u73b0\u7684\u4ee3\u7801\u8fdb\u884c\u3002 \u5728 lab1 \u4e2d\u6211\u4eec\u5b9e\u73b0\u7684 puti puts \u4f7f\u7528\u8d77\u6765\u8f83\u4e3a\u7e41\u7410\uff0c\u56e0\u6b64\u5728\u8fd9\u91cc\u6211\u4eec\u63d0\u4f9b\u4e86\u7b80\u5316\u7248\u7684 printk \u3002 \u4ece repo \u540c\u6b65\u4ee5\u4e0b\u4ee3\u7801: stddef.h printk.h printk.c \uff0c\u5e76\u6309\u5982\u4e0b\u76ee\u5f55\u7ed3\u6784\u653e\u7f6e\u3002 \u8fd8\u9700\u8981\u5c06\u4e4b\u524d\u6240\u6709 print.h puti puts \u7684\u5f15\u7528\u4fee\u6539\u4e3a printk.h printk \u3002 1 2 3 4 5 6 7 8 9 10 11 . \u251c\u2500\u2500 Makefile \u251c\u2500\u2500 arch \u251c\u2500\u2500 include \u2502 \u251c\u2500\u2500 printk.h \u2502 \u251c\u2500\u2500 stddef.h \u2502 \u2514\u2500\u2500 types.h \u251c\u2500\u2500 init \u2514\u2500\u2500 lib \u251c\u2500\u2500 Makefile \u2514\u2500\u2500 printk.c \u4fee\u6539 vmlinux.lds \u4ee5\u53ca head.S 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 <<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<< \u539f\u5148\u7684 vmlinux.lds ... .text : ALIGN(0x1000){ _stext = .; *(.text.entry) *(.text .text.*) _etext = .; } ... >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>> \u4fee\u6539\u4e4b\u540e\u7684 vmlinux.lds ... .text : ALIGN(0x1000){ _stext = .; *(.text.init) <- \u52a0\u5165\u4e86 .text.init *(.text.entry) <- \u4e4b\u540e\u6211\u4eec\u5b9e\u73b0 \u4e2d\u65ad\u5904\u7406\u903b\u8f91 \u4f1a\u653e\u7f6e\u5728 .text.entry *(.text .text.*) _etext = .; } ... 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 <<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<< \u539f\u5148\u7684 head.S extern start_kernel .section .text.entry <- \u4e4b\u524d\u7684 _start \u653e\u7f6e\u5728 .text.entry section .globl _start _start: ... .section .bss.stack .globl boot_stack boot_stack: .space 4096 .globl boot_stack_top boot_stack_top: >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>> \u4fee\u6539\u4e4b\u540e\u7684 head.S extern start_kernel .section .text.init <- \u5c06 _start \u653e\u5165.text.init section .globl _start _start: ... .section .bss.stack .globl boot_stack boot_stack: .space 4096 .globl boot_stack_top boot_stack_top: 4.2 \u5f00\u542f\u5f02\u5e38\u5904\u7406 \u5728\u8fd0\u884c start_kernel \u4e4b\u524d\uff0c\u6211\u4eec\u8981\u5bf9\u4e0a\u9762\u63d0\u5230\u7684 CSR \u8fdb\u884c\u521d\u59cb\u5316\uff0c\u521d\u59cb\u5316\u5305\u62ec\u4ee5\u4e0b\u51e0\u4e2a\u6b65\u9aa4\uff1a \u8bbe\u7f6e stvec \uff0c \u5c06 _traps ( _trap \u5728 4.3 \u4e2d\u5b9e\u73b0 ) \u6240\u8868\u793a\u7684\u5730\u5740\u5199\u5165 stvec \uff0c\u8fd9\u91cc\u6211\u4eec\u91c7\u7528 Direct \u6a21\u5f0f , \u800c _traps \u5219\u662f\u4e2d\u65ad\u5904\u7406\u5165\u53e3\u51fd\u6570\u7684\u57fa\u5730\u5740\u3002 \u5f00\u542f\u65f6\u949f\u4e2d\u65ad\uff0c\u5c06 sie[STIE] \u7f6e 1\u3002 \u8bbe\u7f6e\u7b2c\u4e00\u6b21\u65f6\u949f\u4e2d\u65ad\uff0c\u53c2\u8003 clock_set_next_event() ( clock_set_next_event() \u5728 4.5 \u4e2d\u4ecb\u7ecd ) \u4e2d\u7684\u903b\u8f91\u7528\u6c47\u7f16\u5b9e\u73b0\u3002 \u5f00\u542f S \u6001\u4e0b\u7684\u4e2d\u65ad\u54cd\u5e94\uff0c \u5c06 sstatus[SIE] \u7f6e 1\u3002 \u6309\u7167\u4e0b\u65b9\u6a21\u7248\u4fee\u6539 arch/riscv/kernel/head.S \uff0c \u5e76\u8865\u5168 _start \u4e2d\u7684\u903b\u8f91\u3002 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 .extern start_kernel .section .text.init .globl _start _start: # YOUR CODE HERE # ------------------ # set stvec = _traps # ------------------ # set sie[STIE] = 1 # ------------------ # set first time interrupt # ------------------ # set sstatus[SIE] = 1 # ------------------ # ------------------ # - your lab1 code - # ------------------ ... Debug \u63d0\u793a\uff1a \u53ef\u4ee5\u5148\u4e0d\u5b9e\u73b0 stvec \u548c first time interrupt\uff0c \u5148\u5173\u6ce8 sie \u548c sstatus \u662f\u5426\u8bbe\u7f6e\u6b63\u786e\u3002 4.3 \u5b9e\u73b0\u4e0a\u4e0b\u6587\u5207\u6362 \u6211\u4eec\u8981\u4f7f\u7528\u6c47\u7f16\u5b9e\u73b0\u4e0a\u4e0b\u6587\u5207\u6362\u673a\u5236\uff0c \u5305\u542b\u4ee5\u4e0b\u51e0\u4e2a\u6b65\u9aa4\uff1a \u5728 arch/riscv/kernel/ \u76ee\u5f55\u4e0b\u6dfb\u52a0 entry.S \u6587\u4ef6\u3002 \u4fdd\u5b58CPU\u7684\u5bc4\u5b58\u5668\uff08\u4e0a\u4e0b\u6587\uff09\u5230\u5185\u5b58\u4e2d\uff08\u6808\u4e0a\uff09\u3002 \u5c06 scause \u548c sepc \u4e2d\u7684\u503c\u4f20\u5165\u5f02\u5e38\u5904\u7406\u51fd\u6570 trap_handler ( trap_handler \u5728 4.4 \u4e2d\u4ecb\u7ecd ) \uff0c\u6211\u4eec\u5c06\u4f1a\u5728 trap_handler \u4e2d\u5b9e\u73b0\u5bf9\u5f02\u5e38\u7684\u5904\u7406\u3002 \u5728\u5b8c\u6210\u5bf9\u5f02\u5e38\u7684\u5904\u7406\u4e4b\u540e\uff0c \u6211\u4eec\u4ece\u5185\u5b58\u4e2d\uff08\u6808\u4e0a\uff09\u6062\u590dCPU\u7684\u5bc4\u5b58\u5668\uff08\u4e0a\u4e0b\u6587\uff09\u3002 \u4ece trap \u4e2d\u8fd4\u56de\u3002 \u6309\u7167\u4e0b\u65b9\u6a21\u7248\u4fee\u6539 arch/riscv/kernel/entry.S \uff0c \u5e76\u8865\u5168 _traps \u4e2d\u7684\u903b\u8f91\u3002 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 .section .text.entry .align 2 .globl _traps _traps : # YOUR CODE HERE # ----------- # 1. save 32 registers and sepc to stack # ----------- # 2. call trap_handler # ----------- # 3. restore sepc and 32 registers (x2(sp) should be restore last) from stack # ----------- # 4. return from trap # ----------- Debug \u63d0\u793a\uff1a \u53ef\u4ee5\u5148\u4e0d\u5b9e\u73b0 call trap_handler\uff0c \u5148\u5b9e\u73b0\u4e0a\u5199\u6587\u5207\u6362\u903b\u8f91\u3002\u901a\u8fc7 gdb \u8ddf\u8e2a\u5404\u4e2a\u5bc4\u5b58\u5668\uff0c\u786e\u4fdd\u4e0a\u4e0b\u6587\u7684 save \u4e0e restore \u6b63\u786e\u5b9e\u73b0\u5e76\u6b63\u786e\u8fd4\u56de\u3002 4.4 \u5b9e\u73b0\u5f02\u5e38\u5904\u7406\u51fd\u6570 \u5728 arch/riscv/kernel/ \u76ee\u5f55\u4e0b\u6dfb\u52a0 trap.c \u6587\u4ef6\u3002 \u5728 trap.c \u4e2d\u5b9e\u73b0\u5f02\u5e38\u5904\u7406\u51fd\u6570 trap_handler() , \u5176\u63a5\u6536\u7684\u4e24\u4e2a\u53c2\u6570\u5206\u522b\u662f scause \u548c sepc \u4e24\u4e2a\u5bc4\u5b58\u5668\u4e2d\u7684\u503c\u3002 1 2 3 4 5 6 7 8 9 10 11 // trap.c void trap_handler ( unsigned long scause , unsigned long sepc ) { // \u901a\u8fc7 `scause` \u5224\u65adtrap\u7c7b\u578b // \u5982\u679c\u662finterrupt \u5224\u65ad\u662f\u5426\u662ftimer interrupt // \u5982\u679c\u662ftimer interrupt \u5219\u6253\u5370\u8f93\u51fa\u76f8\u5173\u4fe1\u606f, \u5e76\u901a\u8fc7 `clock_set_next_event()` \u8bbe\u7f6e\u4e0b\u4e00\u6b21\u65f6\u949f\u4e2d\u65ad // `clock_set_next_event()` \u89c1 4.5 \u8282 // \u5176\u4ed6interrupt / exception \u53ef\u4ee5\u76f4\u63a5\u5ffd\u7565 # YOUR CODE HERE } 4.5 \u5b9e\u73b0\u65f6\u949f\u4e2d\u65ad\u76f8\u5173\u51fd\u6570 \u5728 arch/riscv/kernel/ \u76ee\u5f55\u4e0b\u6dfb\u52a0 clock.c \u6587\u4ef6\u3002 \u5728 clock.c \u4e2d\u5b9e\u73b0 get_cycles ( ) : \u4f7f\u7528 rdtime \u6c47\u7f16\u6307\u4ee4\u83b7\u5f97\u5f53\u524d time \u5bc4\u5b58\u5668\u4e2d\u7684\u503c\u3002 \u5728 clock.c \u4e2d\u5b9e\u73b0 clock_set_next_event ( ) : \u8c03\u7528 sbi_ecall \uff0c\u8bbe\u7f6e\u4e0b\u4e00\u4e2a\u65f6\u949f\u4e2d\u65ad\u4e8b\u4ef6\u3002 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 // clock.c // QEMU\u4e2d\u65f6\u949f\u7684\u9891\u7387\u662f10MHz, \u4e5f\u5c31\u662f1\u79d2\u949f\u76f8\u5f53\u4e8e10000000\u4e2a\u65f6\u949f\u5468\u671f\u3002 unsigned long TIMECLOCK = 10000000 ; unsigned long get_cycles () { // \u4f7f\u7528 rdtime \u7f16\u5199\u5185\u8054\u6c47\u7f16\uff0c\u83b7\u53d6 time \u5bc4\u5b58\u5668\u4e2d (\u4e5f\u5c31\u662fmtime \u5bc4\u5b58\u5668 )\u7684\u503c\u5e76\u8fd4\u56de # YOUR CODE HERE } void clock_set_next_event () { // \u4e0b\u4e00\u6b21 \u65f6\u949f\u4e2d\u65ad \u7684\u65f6\u95f4\u70b9 unsigned long next = get_cycles () + TIMECLOCK ; // \u4f7f\u7528 sbi_ecall \u6765\u5b8c\u6210\u5bf9\u4e0b\u4e00\u6b21\u65f6\u949f\u4e2d\u65ad\u7684\u8bbe\u7f6e # YOUR CODE HERE } 4.6 \u7f16\u8bd1\u53ca\u6d4b\u8bd5 \u7531\u4e8e\u52a0\u5165\u4e86\u4e00\u4e9b\u65b0\u7684 .c \u6587\u4ef6\uff0c\u53ef\u80fd\u9700\u8981\u4fee\u6539\u4e00\u4e9bMakefile\u6587\u4ef6\uff0c\u8bf7\u540c\u5b66\u81ea\u5df1\u5c1d\u8bd5\u4fee\u6539\uff0c\u4f7f\u9879\u76ee\u53ef\u4ee5\u7f16\u8bd1\u5e76\u8fd0\u884c\u3002 \u4e0b\u9762\u662f\u4e00\u4e2a\u6b63\u786e\u5b9e\u73b0\u7684\u8f93\u51fa\u6837\u4f8b\u3002\uff08 \u4ec5\u4f9b\u53c2\u8003 \uff09 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 kernel is running! [S] Supervisor Mode Timer Interrupt kernel is running! [S] Supervisor Mode Timer Interrupt kernel is running! [S] Supervisor Mode Timer Interrupt kernel is running! [S] Supervisor Mode Timer Interrupt kernel is running! [S] Supervisor Mode Timer Interrupt kernel is running! [S] Supervisor Mode Timer Interrupt kernel is running! [S] Supervisor Mode Timer Interrupt kernel is running! [S] Supervisor Mode Timer Interrupt kernel is running! [S] Supervisor Mode Timer Interrupt \u601d\u8003\u9898 \u5728\u6211\u4eec\u4f7f\u7528make run\u65f6\uff0c OpenSBI \u4f1a\u4ea7\u751f\u5982\u4e0b\u8f93\u51fa: 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 OpenSBI v0.9 ____ _____ ____ _____ / __ \\ / ____ | _ \\_ _ | | | | | _ __ ___ _ __ | ( ___ | | _ ) || | | | | | '_ \\ / _ \\ ' _ \\ \\_ __ \\| _ < | | | | __ | | | _ ) | __/ | | | ____ ) | | _ ) || | _ \\_ ___/ | .__/ \\_ __ | _ | | _ | _____/ | ____/_____ | | | | _ | ...... Boot HART MIDELEG : 0x0000000000000222 Boot HART MEDELEG : 0x000000000000b109 ...... \u901a\u8fc7\u67e5\u770b RISC-V Privileged Spec \u4e2d\u7684 medeleg \u548c mideleg \u89e3\u91ca\u4e0a\u9762 MIDELEG \u503c\u7684\u542b\u4e49\u3002 \u4f5c\u4e1a\u63d0\u4ea4 \u540c\u5b66\u9700\u8981\u63d0\u4ea4\u5b9e\u9a8c\u62a5\u544a\u4ee5\u53ca\u6574\u4e2a\u5de5\u7a0b\u4ee3\u7801\u3002\u5728\u63d0\u4ea4\u524d\u8bf7\u4f7f\u7528 make clean \u6e05\u9664\u6240\u6709\u6784\u5efa\u4ea7\u7269\u3002","title":"\u5b9e\u9a8c\u6307\u5bfc\u4e8c"},{"location":"lab2/#lab-2-rv64","text":"","title":"Lab 2: RV64 \u65f6\u949f\u4e2d\u65ad\u5904\u7406"},{"location":"lab2/#1","text":"\u5b66\u4e60 RISC-V \u7684\u5f02\u5e38\u5904\u7406\u76f8\u5173\u5bc4\u5b58\u5668\u4e0e\u6307\u4ee4\uff0c\u5b8c\u6210\u5bf9\u5f02\u5e38\u5904\u7406\u7684\u521d\u59cb\u5316\u3002 \u7406\u89e3 CPU \u4e0a\u4e0b\u6587\u5207\u6362\u673a\u5236\uff0c\u5e76\u6b63\u786e\u5b9e\u73b0\u4e0a\u4e0b\u6587\u5207\u6362\u529f\u80fd\u3002 \u7f16\u5199\u5f02\u5e38\u5904\u7406\u51fd\u6570\uff0c\u5b8c\u6210\u5bf9\u7279\u5b9a\u5f02\u5e38\u7684\u5904\u7406\u3002 \u8c03\u7528 OpenSBI \u63d0\u4f9b\u7684\u63a5\u53e3\uff0c\u5b8c\u6210\u5bf9\u65f6\u949f\u4e2d\u65ad\u4e8b\u4ef6\u7684\u8bbe\u7f6e\u3002","title":"1 \u5b9e\u9a8c\u76ee\u7684"},{"location":"lab2/#2","text":"Docker in Lab0","title":"2 \u5b9e\u9a8c\u73af\u5883"},{"location":"lab2/#3","text":"","title":"3 \u80cc\u666f\u77e5\u8bc6"},{"location":"lab2/#30","text":"\u5728 lab1 \u4e2d\u6211\u4eec\u6210\u529f\u7684\u5c06\u4e00\u4e2a\u6700\u7b80\u5355\u7684 OS \u542f\u52a8\u8d77\u6765\uff0c \u4f46\u8fd8\u6ca1\u6709\u529e\u6cd5\u4e0e\u4e4b\u4ea4\u4e92\u3002\u6211\u4eec\u5728\u8bfe\u7a0b\u4e2d\u8bb2\u8fc7\u64cd\u4f5c\u7cfb\u7edf\u542f\u52a8\u4e4b\u540e\u7531 \u4e8b\u4ef6 \uff08 event \uff09\u9a71\u52a8\uff0c\u5728\u672c\u6b21\u5b9e\u9a8c\u4e2d\u6211\u4eec\u5c06\u5f15\u5165\u4e00\u79cd\u91cd\u8981\u7684\u4e8b\u4ef6 \u5f02\u5e38 \uff0c \u5f02\u5e38\u7ed9\u4e86 OS \u4e0e\u786c\u4ef6\u3001\u8f6f\u4ef6\u4ea4\u4e92\u7684\u80fd\u529b\u3002\u5728 lab1 \u4e2d\u6211\u4eec\u4ecb\u7ecd\u4e86\u5728 RISC-V \u4e2d\u6709\u4e09\u79cd\u7279\u6743\u7ea7 ( M \u6001\u3001 S \u6001\u3001 U \u6001 )\uff0c \u5728 Boot \u9636\u6bb5\uff0c OpenSBI \u5df2\u7ecf\u5e2e\u6211\u4eec\u5c06 M \u6001\u7684\u5f02\u5e38\u5904\u7406\u8fdb\u884c\u4e86\u521d\u59cb\u5316\uff0c\u8fd9\u4e00\u90e8\u5206\u4e0d\u9700\u8981\u6211\u4eec\u518d\u53bb\u5b9e\u73b0\uff0c\u56e0\u6b64\u672c\u6b21\u8bd5\u9a8c\u6211\u4eec\u91cd\u70b9\u5173\u6ce8 S \u6001\u7684\u5f02\u5e38\u5904\u7406\u3002","title":"3.0 \u524d\u8a00"},{"location":"lab2/#31-risc-v-interrupt-exception","text":"","title":"3.1 RISC-V \u4e2d\u7684 Interrupt \u548c Exception"},{"location":"lab2/#311-interrupt-exception","text":"We use the term exception to refer to an unusual condition occurring at run time associated with an instruction in the current RISC-V hart. We use the term interrupt to refer to an external asynchronous event that may cause a RISC-V hart to experience an unexpected transfer of control. We use the term trap to refer to the transfer of control to a trap handler caused by either an exception or an interrupt. \u4e0a\u8ff0\u662f RISC-V Unprivileged Spec 1.6 \u8282\u4e2d\u5bf9\u4e8e Trap \u3001 Interrupt \u4e0e Exception \u7684\u63cf\u8ff0\u3002\u603b\u7ed3\u8d77\u6765 Interrupt \u4e0e Exception \u7684\u4e3b\u8981\u533a\u522b\u5982\u4e0b\u8868\uff1a Interrupt Exception Hardware generate Software generate These are asynchronous external requests for service (like keyboard or printer needs service). These are synchronous internal requests for service based upon abnormal events (think of illegal instructions, illegal address, overflow etc). These are normal events and shouldn\u2019t interfere with the normal running of a computer. These are abnormal events and often result in the termination of a program \u4e0a\u6587\u4e2d\u7684 Trap \u63cf\u8ff0\u7684\u662f\u4e00\u79cd\u63a7\u5236\u8f6c\u79fb\u7684\u8fc7\u7a0b, \u8fd9\u4e2a\u8fc7\u7a0b\u662f\u7531 Interrupt \u6216\u8005 Exception \u5f15\u8d77\u7684\u3002\u8fd9\u91cc\u4e3a\u4e86\u65b9\u4fbf\u8d77\u89c1\uff0c\u6211\u4eec\u5728\u8fd9\u91cc\u7ea6\u5b9a Trap \u4e3a Interrput \u4e0e Exception \u7684\u603b\u79f0\u3002 \u5728\u4e0b\u6587\u4e2d \u6211\u4eec\u7528 \u5f02\u5e38 \u4ee3\u6307 Trap","title":"3.1.1 \u4ec0\u4e48\u662f Interrupt \u548c Exception"},{"location":"lab2/#312","text":"\u9664\u4e8632\u4e2a\u901a\u7528\u5bc4\u5b58\u5668\u4e4b\u5916\uff0cRISC-V \u67b6\u6784\u8fd8\u6709\u5927\u91cf\u7684 \u63a7\u5236\u72b6\u6001\u5bc4\u5b58\u5668 Control and Status Registers(CSRs) \uff0c\u4e0b\u9762\u5c06\u4ecb\u7ecd\u51e0\u4e2a\u548c\u5f02\u5e38\u673a\u5236\u76f8\u5173\u7684\u91cd\u8981\u5bc4\u5b58\u5668\u3002 Supervisor Mode \u5f02\u5e38\u76f8\u5173\u5bc4\u5bc4\u5b58\u5668: sstatus ( Supervisor Status Register )\u4e2d\u5b58\u5728\u4e00\u4e2a SIE ( Supervisor Interrupt Enable ) \u6bd4\u7279\u4f4d\uff0c\u5f53\u8be5\u6bd4\u7279\u4f4d\u8bbe\u7f6e\u4e3a 1 \u65f6\uff0c\u4f1a\u5bf9\u6240\u6709\u7684 S \u6001\u5f02\u5e38 \u54cd\u5e94 \uff0c \u5426\u5219\u5c06\u4f1a\u7981\u7528\u6240\u6709 S \u6001\u5f02\u5e38\u3002 sie ( Supervisor Interrupt Eable Register )\u3002\u5728 RISC-V \u4e2d\uff0c Interrupt \u88ab\u5212\u5206\u4e3a\u4e09\u7c7b Software Interrupt \uff0c Timer Interrupt \uff0c External Interrupt \u3002\u5728\u5f00\u542f\u4e86 sstatus[SIE] \u4e4b\u540e\uff0c\u7cfb\u7edf\u4f1a\u6839\u636e sie \u4e2d\u7684\u76f8\u5173\u6bd4\u7279\u4f4d\u6765\u51b3\u5b9a\u662f\u5426\u5bf9\u8be5 Interrupt \u8fdb\u884c \u5904\u7406 \u3002 stvec ( Supervisor Trap Vector Base Address Register ) \u5373\u6240\u8c13\u7684\u201d\u4e2d\u65ad\u5411\u91cf\u8868\u57fa\u5740\u201d\u3002 stvec \u6709\u4e24\u79cd\u6a21\u5f0f\uff1a Direct \u6a21\u5f0f \uff0c\u9002\u7528\u4e8e\u7cfb\u7edf\u4e2d\u53ea\u6709\u4e00\u4e2a\u4e2d\u65ad\u5904\u7406\u7a0b\u5e8f, \u5176\u6307\u5411\u4e2d\u65ad\u5904\u7406\u5165\u53e3\u51fd\u6570 \uff08 \u672c\u6b21\u5b9e\u9a8c\u4e2d\u6211\u4eec\u6240\u7528\u7684\u6a21\u5f0f \uff09\u3002 Vectored \u6a21\u5f0f \uff0c\u6307\u5411\u4e2d\u65ad\u5411\u91cf\u8868\uff0c \u9002\u7528\u4e8e\u7cfb\u7edf\u4e2d\u6709\u591a\u4e2a\u4e2d\u65ad\u5904\u7406\u7a0b\u5e8f \uff08 \u8be5\u6a21\u5f0f\u53ef\u4ee5\u53c2\u8003 RISC-V \u5185\u6838\u6e90\u7801 \uff09\u3002 scause ( Supervisor Cause Register ), \u4f1a\u8bb0\u5f55\u5f02\u5e38\u53d1\u751f\u7684\u539f\u56e0\uff0c\u8fd8\u4f1a\u8bb0\u5f55\u8be5\u5f02\u5e38\u662f Interrupt \u8fd8\u662f Exception \u3002 sepc ( Supervisor Exception Program Counter ), \u4f1a\u8bb0\u5f55\u89e6\u53d1\u5f02\u5e38\u7684\u90a3\u6761\u6307\u4ee4\u7684\u5730\u5740\u3002 Machine Mode \u5f02\u5e38\u76f8\u5173\u5bc4\u5bc4\u5b58\u5668: \u7c7b\u4f3c\u4e8e Supervisor Mode\uff0c Machine Mode \u4e5f\u6709\u76f8\u5bf9\u5e94\u7684\u5bc4\u5b58\u5668\uff0c\u4f46\u7531\u4e8e\u672c\u5b9e\u9a8c\u540c\u5b66\u4e0d\u9700\u8981\u64cd\u4f5c\u8fd9\u4e9b\u5bc4\u5b58\u5668\uff0c\u6545\u4e0d\u5728\u6b64\u4f5c\u4ecb\u7ecd\u3002 \u4ee5\u4e0a\u5bc4\u5b58\u5668\u7684\u8be6\u7ec6\u4ecb\u7ecd\u8bf7\u540c\u5b66\u4eec\u53c2\u8003 RISC-V Privileged Spec","title":"3.1.2 \u76f8\u5173\u5bc4\u5b58\u5668"},{"location":"lab2/#313","text":"ecall ( Environment Call )\uff0c\u5f53\u6211\u4eec\u5728 S \u6001\u6267\u884c\u8fd9\u6761\u6307\u4ee4\u65f6\uff0c\u4f1a\u89e6\u53d1\u4e00\u4e2a ecall-from-s-mode-exception \uff0c\u4ece\u800c\u8fdb\u5165 M \u6a21\u5f0f\u4e2d\u7684\u4e2d\u65ad\u5904\u7406\u6d41\u7a0b( \u5982\u8bbe\u7f6e\u5b9a\u65f6\u5668\u7b49 )\uff1b\u5f53\u6211\u4eec\u5728 U \u6001\u6267\u884c\u8fd9\u6761\u6307\u4ee4\u65f6\uff0c\u4f1a\u89e6\u53d1\u4e00\u4e2a ecall-from-u-mode-exception \uff0c\u4ece\u800c\u8fdb\u5165 S \u6a21\u5f0f\u4e2d\u7684\u4e2d\u65ad\u5904\u7406\u6d41\u7a0b ( \u5e38\u7528\u6765\u8fdb\u884c\u7cfb\u7edf\u8c03\u7528 )\u3002 sret \u7528\u4e8e S \u6001\u5f02\u5e38\u8fd4\u56de, \u901a\u8fc7 sepc \u6765\u8bbe\u7f6e pc \u7684\u503c\uff0c \u8fd4\u56de\u5230\u4e4b\u524d\u7a0b\u5e8f\u7ee7\u7eed\u8fd0\u884c\u3002 \u4ee5\u4e0a\u6307\u4ee4\u7684\u8be6\u7ec6\u4ecb\u7ecd\u8bf7\u540c\u5b66\u4eec\u53c2\u8003 RISC-V Privileged Spec","title":"3.1.3 \u76f8\u5173\u7279\u6743\u6307\u4ee4"},{"location":"lab2/#32","text":"\u7531\u4e8e\u5728\u5904\u7406\u5f02\u5e38\u65f6\uff0c\u6709\u53ef\u80fd\u4f1a\u6539\u53d8\u7cfb\u7edf\u7684\u72b6\u6001\u3002\u6240\u4ee5\u5728\u771f\u6b63\u5904\u7406\u5f02\u5e38\u4e4b\u524d\uff0c\u6211\u4eec\u6709\u5fc5\u8981\u5bf9\u7cfb\u7edf\u7684\u5f53\u524d\u72b6\u6001\u8fdb\u884c\u4fdd\u5b58\uff0c\u5728\u5f02\u5e38\u5904\u7406\u5b8c\u6210\u4e4b\u540e\uff0c\u6211\u4eec\u518d\u5c06\u7cfb\u7edf\u6062\u590d\u81f3\u539f\u5148\u7684\u72b6\u6001\uff0c\u5c31\u53ef\u4ee5\u786e\u4fdd\u4e4b\u524d\u7684\u7a0b\u5e8f\u7ee7\u7eed\u6b63\u5e38\u8fd0\u884c\u3002 \u8fd9\u91cc\u7684\u7cfb\u7edf\u72b6\u6001\u901a\u5e38\u662f\u6307\u5bc4\u5b58\u5668\uff0c\u8fd9\u4e9b\u5bc4\u5b58\u5668\u4e5f\u53eb\u505aCPU\u7684\u4e0a\u4e0b\u6587 ( Context ).","title":"3.2 \u4e0a\u4e0b\u6587\u5904\u7406"},{"location":"lab2/#33","text":"\u5f02\u5e38\u5904\u7406\u7a0b\u5e8f\u6839\u636e scause \u7684\u503c\uff0c \u8fdb\u5165\u4e0d\u540c\u7684\u5904\u7406\u903b\u8f91\uff0c\u5728\u672c\u6b21\u8bd5\u9a8c\u4e2d\u6211\u4eec\u9700\u8981\u5173\u5fc3\u7684\u53ea\u6709 Superviosr Timer Interrupt \u3002","title":"3.3 \u5f02\u5e38\u5904\u7406\u7a0b\u5e8f"},{"location":"lab2/#34","text":"\u65f6\u949f\u4e2d\u65ad\u9700\u8981 CPU \u786c\u4ef6\u7684\u652f\u6301\u3002CPU \u4ee5\"\u65f6\u949f\u5468\u671f\"\u4e3a\u5de5\u4f5c\u7684\u57fa\u672c\u65f6\u95f4\u5355\u4f4d\uff0c\u5bf9\u903b\u8f91\u95e8\u7684\u65f6\u5e8f\u7535\u8def\u8fdb\u884c\u540c\u6b65\u3002\u800c\u65f6\u949f\u4e2d\u65ad\u5b9e\u9645\u4e0a\u5c31\u662f\u201c\u6bcf\u9694\u82e5\u5e72\u4e2a\u65f6\u949f\u5468\u671f\u6267\u884c\u4e00\u6b21\u7684\u7a0b\u5e8f\u201d\u3002\u4e0b\u9762\u4ecb\u7ecd\u4e0e\u65f6\u949f\u4e2d\u65ad\u76f8\u5173\u7684\u5bc4\u5b58\u5668\u4ee5\u53ca\u5982\u4f55\u4ea7\u751f\u65f6\u949f\u4e2d\u65ad\u3002 mtime \u4e0e mtimecmp ( Machine Timer Register )\u3002 mtime \u662f\u4e00\u4e2a\u5b9e\u65f6\u8ba1\u65f6\u5668\uff0c \u7531\u786c\u4ef6\u4ee5\u6052\u5b9a\u7684\u9891\u7387\u81ea\u589e\u3002 mtimecmp \u4e2d\u4fdd\u5b58\u7740\u4e0b\u4e00\u6b21\u65f6\u949f\u4e2d\u65ad\u53d1\u751f\u7684\u65f6\u95f4\u70b9\uff0c\u5f53 mtime \u7684\u503c\u5927\u4e8e\u6216\u7b49\u4e8e mtimecmp \u7684\u503c\uff0c\u7cfb\u7edf\u5c31\u4f1a\u89e6\u53d1\u4e00\u6b21\u65f6\u949f\u4e2d\u65ad\u3002\u56e0\u6b64\u6211\u4eec\u53ea\u9700\u8981\u66f4\u65b0 mtimecmp \u4e2d\u7684\u503c\uff0c\u5c31\u53ef\u4ee5\u8bbe\u7f6e\u4e0b\u4e00\u6b21\u65f6\u949f\u4e2d\u65ad\u7684\u89e6\u53d1\u70b9\u3002 OpenSBI \u5df2\u7ecf\u4e3a\u6211\u4eec\u63d0\u4f9b\u4e86\u66f4\u65b0 mtimecmp \u7684\u63a5\u53e3 sbi_set_timer ( \u89c1 lab1 4.4\u8282 )\u3002 mcounteren ( Counter-Enable Registers )\u3002\u7531\u4e8e mtime \u662f\u5c5e\u4e8e M \u6001\u7684\u5bc4\u5b58\u5668\uff0c\u6211\u4eec\u5728 S \u6001\u65e0\u6cd5\u76f4\u63a5\u5bf9\u5176\u8bfb\u5199\uff0c \u5e78\u8fd0\u7684\u662f OpenSBI \u5728 M \u6001\u5df2\u7ecf\u901a\u8fc7\u8bbe\u7f6e mcounteren \u5bc4\u5b58\u5668\u7684 TM \u6bd4\u7279\u4f4d\uff0c \u8ba9\u6211\u4eec\u53ef\u4ee5\u5728 S \u6001\u4e2d\u53ef\u4ee5\u901a\u8fc7 time \u8fd9\u4e2a \u53ea\u8bfb \u5bc4\u5b58\u5668\u8bfb\u53d6\u5230 mtime \u7684\u5f53\u524d\u503c\uff0c\u76f8\u5173\u6c47\u7f16\u6307\u4ee4\u662f rdtime \u3002 \u4ee5\u4e0a\u5bc4\u5b58\u5668\u7684\u8be6\u7ec6\u4ecb\u7ecd\u8bf7\u540c\u5b66\u4eec\u53c2\u8003 RISC-V Privileged Spec","title":"3.4 \u65f6\u949f\u4e2d\u65ad"},{"location":"lab2/#4","text":"","title":"4 \u5b9e\u9a8c\u6b65\u9aa4"},{"location":"lab2/#41","text":"\u6b64\u6b21\u5b9e\u9a8c\u57fa\u4e8e lab1 \u540c\u5b66\u6240\u5b9e\u73b0\u7684\u4ee3\u7801\u8fdb\u884c\u3002 \u5728 lab1 \u4e2d\u6211\u4eec\u5b9e\u73b0\u7684 puti puts \u4f7f\u7528\u8d77\u6765\u8f83\u4e3a\u7e41\u7410\uff0c\u56e0\u6b64\u5728\u8fd9\u91cc\u6211\u4eec\u63d0\u4f9b\u4e86\u7b80\u5316\u7248\u7684 printk \u3002 \u4ece repo \u540c\u6b65\u4ee5\u4e0b\u4ee3\u7801: stddef.h printk.h printk.c \uff0c\u5e76\u6309\u5982\u4e0b\u76ee\u5f55\u7ed3\u6784\u653e\u7f6e\u3002 \u8fd8\u9700\u8981\u5c06\u4e4b\u524d\u6240\u6709 print.h puti puts \u7684\u5f15\u7528\u4fee\u6539\u4e3a printk.h printk \u3002 1 2 3 4 5 6 7 8 9 10 11 . \u251c\u2500\u2500 Makefile \u251c\u2500\u2500 arch \u251c\u2500\u2500 include \u2502 \u251c\u2500\u2500 printk.h \u2502 \u251c\u2500\u2500 stddef.h \u2502 \u2514\u2500\u2500 types.h \u251c\u2500\u2500 init \u2514\u2500\u2500 lib \u251c\u2500\u2500 Makefile \u2514\u2500\u2500 printk.c \u4fee\u6539 vmlinux.lds \u4ee5\u53ca head.S 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 <<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<< \u539f\u5148\u7684 vmlinux.lds ... .text : ALIGN(0x1000){ _stext = .; *(.text.entry) *(.text .text.*) _etext = .; } ... >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>> \u4fee\u6539\u4e4b\u540e\u7684 vmlinux.lds ... .text : ALIGN(0x1000){ _stext = .; *(.text.init) <- \u52a0\u5165\u4e86 .text.init *(.text.entry) <- \u4e4b\u540e\u6211\u4eec\u5b9e\u73b0 \u4e2d\u65ad\u5904\u7406\u903b\u8f91 \u4f1a\u653e\u7f6e\u5728 .text.entry *(.text .text.*) _etext = .; } ... 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 <<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<< \u539f\u5148\u7684 head.S extern start_kernel .section .text.entry <- \u4e4b\u524d\u7684 _start \u653e\u7f6e\u5728 .text.entry section .globl _start _start: ... .section .bss.stack .globl boot_stack boot_stack: .space 4096 .globl boot_stack_top boot_stack_top: >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>> \u4fee\u6539\u4e4b\u540e\u7684 head.S extern start_kernel .section .text.init <- \u5c06 _start \u653e\u5165.text.init section .globl _start _start: ... .section .bss.stack .globl boot_stack boot_stack: .space 4096 .globl boot_stack_top boot_stack_top:","title":"4.1 \u51c6\u5907\u5de5\u7a0b"},{"location":"lab2/#42","text":"\u5728\u8fd0\u884c start_kernel \u4e4b\u524d\uff0c\u6211\u4eec\u8981\u5bf9\u4e0a\u9762\u63d0\u5230\u7684 CSR \u8fdb\u884c\u521d\u59cb\u5316\uff0c\u521d\u59cb\u5316\u5305\u62ec\u4ee5\u4e0b\u51e0\u4e2a\u6b65\u9aa4\uff1a \u8bbe\u7f6e stvec \uff0c \u5c06 _traps ( _trap \u5728 4.3 \u4e2d\u5b9e\u73b0 ) \u6240\u8868\u793a\u7684\u5730\u5740\u5199\u5165 stvec \uff0c\u8fd9\u91cc\u6211\u4eec\u91c7\u7528 Direct \u6a21\u5f0f , \u800c _traps \u5219\u662f\u4e2d\u65ad\u5904\u7406\u5165\u53e3\u51fd\u6570\u7684\u57fa\u5730\u5740\u3002 \u5f00\u542f\u65f6\u949f\u4e2d\u65ad\uff0c\u5c06 sie[STIE] \u7f6e 1\u3002 \u8bbe\u7f6e\u7b2c\u4e00\u6b21\u65f6\u949f\u4e2d\u65ad\uff0c\u53c2\u8003 clock_set_next_event() ( clock_set_next_event() \u5728 4.5 \u4e2d\u4ecb\u7ecd ) \u4e2d\u7684\u903b\u8f91\u7528\u6c47\u7f16\u5b9e\u73b0\u3002 \u5f00\u542f S \u6001\u4e0b\u7684\u4e2d\u65ad\u54cd\u5e94\uff0c \u5c06 sstatus[SIE] \u7f6e 1\u3002 \u6309\u7167\u4e0b\u65b9\u6a21\u7248\u4fee\u6539 arch/riscv/kernel/head.S \uff0c \u5e76\u8865\u5168 _start \u4e2d\u7684\u903b\u8f91\u3002 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 .extern start_kernel .section .text.init .globl _start _start: # YOUR CODE HERE # ------------------ # set stvec = _traps # ------------------ # set sie[STIE] = 1 # ------------------ # set first time interrupt # ------------------ # set sstatus[SIE] = 1 # ------------------ # ------------------ # - your lab1 code - # ------------------ ... Debug \u63d0\u793a\uff1a \u53ef\u4ee5\u5148\u4e0d\u5b9e\u73b0 stvec \u548c first time interrupt\uff0c \u5148\u5173\u6ce8 sie \u548c sstatus \u662f\u5426\u8bbe\u7f6e\u6b63\u786e\u3002","title":"4.2 \u5f00\u542f\u5f02\u5e38\u5904\u7406"},{"location":"lab2/#43","text":"\u6211\u4eec\u8981\u4f7f\u7528\u6c47\u7f16\u5b9e\u73b0\u4e0a\u4e0b\u6587\u5207\u6362\u673a\u5236\uff0c \u5305\u542b\u4ee5\u4e0b\u51e0\u4e2a\u6b65\u9aa4\uff1a \u5728 arch/riscv/kernel/ \u76ee\u5f55\u4e0b\u6dfb\u52a0 entry.S \u6587\u4ef6\u3002 \u4fdd\u5b58CPU\u7684\u5bc4\u5b58\u5668\uff08\u4e0a\u4e0b\u6587\uff09\u5230\u5185\u5b58\u4e2d\uff08\u6808\u4e0a\uff09\u3002 \u5c06 scause \u548c sepc \u4e2d\u7684\u503c\u4f20\u5165\u5f02\u5e38\u5904\u7406\u51fd\u6570 trap_handler ( trap_handler \u5728 4.4 \u4e2d\u4ecb\u7ecd ) \uff0c\u6211\u4eec\u5c06\u4f1a\u5728 trap_handler \u4e2d\u5b9e\u73b0\u5bf9\u5f02\u5e38\u7684\u5904\u7406\u3002 \u5728\u5b8c\u6210\u5bf9\u5f02\u5e38\u7684\u5904\u7406\u4e4b\u540e\uff0c \u6211\u4eec\u4ece\u5185\u5b58\u4e2d\uff08\u6808\u4e0a\uff09\u6062\u590dCPU\u7684\u5bc4\u5b58\u5668\uff08\u4e0a\u4e0b\u6587\uff09\u3002 \u4ece trap \u4e2d\u8fd4\u56de\u3002 \u6309\u7167\u4e0b\u65b9\u6a21\u7248\u4fee\u6539 arch/riscv/kernel/entry.S \uff0c \u5e76\u8865\u5168 _traps \u4e2d\u7684\u903b\u8f91\u3002 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 .section .text.entry .align 2 .globl _traps _traps : # YOUR CODE HERE # ----------- # 1. save 32 registers and sepc to stack # ----------- # 2. call trap_handler # ----------- # 3. restore sepc and 32 registers (x2(sp) should be restore last) from stack # ----------- # 4. return from trap # ----------- Debug \u63d0\u793a\uff1a \u53ef\u4ee5\u5148\u4e0d\u5b9e\u73b0 call trap_handler\uff0c \u5148\u5b9e\u73b0\u4e0a\u5199\u6587\u5207\u6362\u903b\u8f91\u3002\u901a\u8fc7 gdb \u8ddf\u8e2a\u5404\u4e2a\u5bc4\u5b58\u5668\uff0c\u786e\u4fdd\u4e0a\u4e0b\u6587\u7684 save \u4e0e restore \u6b63\u786e\u5b9e\u73b0\u5e76\u6b63\u786e\u8fd4\u56de\u3002","title":"4.3 \u5b9e\u73b0\u4e0a\u4e0b\u6587\u5207\u6362"},{"location":"lab2/#44","text":"\u5728 arch/riscv/kernel/ \u76ee\u5f55\u4e0b\u6dfb\u52a0 trap.c \u6587\u4ef6\u3002 \u5728 trap.c \u4e2d\u5b9e\u73b0\u5f02\u5e38\u5904\u7406\u51fd\u6570 trap_handler() , \u5176\u63a5\u6536\u7684\u4e24\u4e2a\u53c2\u6570\u5206\u522b\u662f scause \u548c sepc \u4e24\u4e2a\u5bc4\u5b58\u5668\u4e2d\u7684\u503c\u3002 1 2 3 4 5 6 7 8 9 10 11 // trap.c void trap_handler ( unsigned long scause , unsigned long sepc ) { // \u901a\u8fc7 `scause` \u5224\u65adtrap\u7c7b\u578b // \u5982\u679c\u662finterrupt \u5224\u65ad\u662f\u5426\u662ftimer interrupt // \u5982\u679c\u662ftimer interrupt \u5219\u6253\u5370\u8f93\u51fa\u76f8\u5173\u4fe1\u606f, \u5e76\u901a\u8fc7 `clock_set_next_event()` \u8bbe\u7f6e\u4e0b\u4e00\u6b21\u65f6\u949f\u4e2d\u65ad // `clock_set_next_event()` \u89c1 4.5 \u8282 // \u5176\u4ed6interrupt / exception \u53ef\u4ee5\u76f4\u63a5\u5ffd\u7565 # YOUR CODE HERE }","title":"4.4 \u5b9e\u73b0\u5f02\u5e38\u5904\u7406\u51fd\u6570"},{"location":"lab2/#45","text":"\u5728 arch/riscv/kernel/ \u76ee\u5f55\u4e0b\u6dfb\u52a0 clock.c \u6587\u4ef6\u3002 \u5728 clock.c \u4e2d\u5b9e\u73b0 get_cycles ( ) : \u4f7f\u7528 rdtime \u6c47\u7f16\u6307\u4ee4\u83b7\u5f97\u5f53\u524d time \u5bc4\u5b58\u5668\u4e2d\u7684\u503c\u3002 \u5728 clock.c \u4e2d\u5b9e\u73b0 clock_set_next_event ( ) : \u8c03\u7528 sbi_ecall \uff0c\u8bbe\u7f6e\u4e0b\u4e00\u4e2a\u65f6\u949f\u4e2d\u65ad\u4e8b\u4ef6\u3002 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 // clock.c // QEMU\u4e2d\u65f6\u949f\u7684\u9891\u7387\u662f10MHz, \u4e5f\u5c31\u662f1\u79d2\u949f\u76f8\u5f53\u4e8e10000000\u4e2a\u65f6\u949f\u5468\u671f\u3002 unsigned long TIMECLOCK = 10000000 ; unsigned long get_cycles () { // \u4f7f\u7528 rdtime \u7f16\u5199\u5185\u8054\u6c47\u7f16\uff0c\u83b7\u53d6 time \u5bc4\u5b58\u5668\u4e2d (\u4e5f\u5c31\u662fmtime \u5bc4\u5b58\u5668 )\u7684\u503c\u5e76\u8fd4\u56de # YOUR CODE HERE } void clock_set_next_event () { // \u4e0b\u4e00\u6b21 \u65f6\u949f\u4e2d\u65ad \u7684\u65f6\u95f4\u70b9 unsigned long next = get_cycles () + TIMECLOCK ; // \u4f7f\u7528 sbi_ecall \u6765\u5b8c\u6210\u5bf9\u4e0b\u4e00\u6b21\u65f6\u949f\u4e2d\u65ad\u7684\u8bbe\u7f6e # YOUR CODE HERE }","title":"4.5 \u5b9e\u73b0\u65f6\u949f\u4e2d\u65ad\u76f8\u5173\u51fd\u6570"},{"location":"lab2/#46","text":"\u7531\u4e8e\u52a0\u5165\u4e86\u4e00\u4e9b\u65b0\u7684 .c \u6587\u4ef6\uff0c\u53ef\u80fd\u9700\u8981\u4fee\u6539\u4e00\u4e9bMakefile\u6587\u4ef6\uff0c\u8bf7\u540c\u5b66\u81ea\u5df1\u5c1d\u8bd5\u4fee\u6539\uff0c\u4f7f\u9879\u76ee\u53ef\u4ee5\u7f16\u8bd1\u5e76\u8fd0\u884c\u3002 \u4e0b\u9762\u662f\u4e00\u4e2a\u6b63\u786e\u5b9e\u73b0\u7684\u8f93\u51fa\u6837\u4f8b\u3002\uff08 \u4ec5\u4f9b\u53c2\u8003 \uff09 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 kernel is running! [S] Supervisor Mode Timer Interrupt kernel is running! [S] Supervisor Mode Timer Interrupt kernel is running! [S] Supervisor Mode Timer Interrupt kernel is running! [S] Supervisor Mode Timer Interrupt kernel is running! [S] Supervisor Mode Timer Interrupt kernel is running! [S] Supervisor Mode Timer Interrupt kernel is running! [S] Supervisor Mode Timer Interrupt kernel is running! [S] Supervisor Mode Timer Interrupt kernel is running! [S] Supervisor Mode Timer Interrupt","title":"4.6 \u7f16\u8bd1\u53ca\u6d4b\u8bd5"},{"location":"lab2/#_1","text":"\u5728\u6211\u4eec\u4f7f\u7528make run\u65f6\uff0c OpenSBI \u4f1a\u4ea7\u751f\u5982\u4e0b\u8f93\u51fa: 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 OpenSBI v0.9 ____ _____ ____ _____ / __ \\ / ____ | _ \\_ _ | | | | | _ __ ___ _ __ | ( ___ | | _ ) || | | | | | '_ \\ / _ \\ ' _ \\ \\_ __ \\| _ < | | | | __ | | | _ ) | __/ | | | ____ ) | | _ ) || | _ \\_ ___/ | .__/ \\_ __ | _ | | _ | _____/ | ____/_____ | | | | _ | ...... Boot HART MIDELEG : 0x0000000000000222 Boot HART MEDELEG : 0x000000000000b109 ...... \u901a\u8fc7\u67e5\u770b RISC-V Privileged Spec \u4e2d\u7684 medeleg \u548c mideleg \u89e3\u91ca\u4e0a\u9762 MIDELEG \u503c\u7684\u542b\u4e49\u3002","title":"\u601d\u8003\u9898"},{"location":"lab2/#_2","text":"\u540c\u5b66\u9700\u8981\u63d0\u4ea4\u5b9e\u9a8c\u62a5\u544a\u4ee5\u53ca\u6574\u4e2a\u5de5\u7a0b\u4ee3\u7801\u3002\u5728\u63d0\u4ea4\u524d\u8bf7\u4f7f\u7528 make clean \u6e05\u9664\u6240\u6709\u6784\u5efa\u4ea7\u7269\u3002","title":"\u4f5c\u4e1a\u63d0\u4ea4"},{"location":"lab3/","text":"Lab 3: RV64 \u5185\u6838\u7ebf\u7a0b\u8c03\u5ea6 1 \u5b9e\u9a8c\u76ee\u7684 \u4e86\u89e3\u7ebf\u7a0b\u6982\u5ff5\uff0c\u5e76\u5b66\u4e60\u7ebf\u7a0b\u76f8\u5173\u7ed3\u6784\u4f53\uff0c\u5e76\u5b9e\u73b0\u7ebf\u7a0b\u7684\u521d\u59cb\u5316\u529f\u80fd\u3002 \u4e86\u89e3\u5982\u4f55\u4f7f\u7528\u65f6\u949f\u4e2d\u65ad\u6765\u5b9e\u73b0\u7ebf\u7a0b\u7684\u8c03\u5ea6\u3002 \u4e86\u89e3\u7ebf\u7a0b\u5207\u6362\u539f\u7406\uff0c\u5e76\u5b9e\u73b0\u7ebf\u7a0b\u7684\u5207\u6362\u3002 \u638c\u63e1\u7b80\u5355\u7684\u7ebf\u7a0b\u8c03\u5ea6\u7b97\u6cd5\uff0c\u5e76\u5b8c\u6210\u4e24\u79cd\u7b80\u5355\u8c03\u5ea6\u7b97\u6cd5\u7684\u5b9e\u73b0\u3002 2 \u5b9e\u9a8c\u73af\u5883 Docker in Lab0 3 \u80cc\u666f\u77e5\u8bc6 3.0 \u524d\u8a00 \u5728 lab2 \u4e2d\uff0c\u6211\u4eec\u5229\u7528\u5f02\u5e38\u8d4b\u4e88\u4e86 OS \u4e0e\u8f6f\u4ef6\uff0c\u786c\u4ef6\u7684\u4ea4\u4e92\u80fd\u529b\u3002\u4f46\u662f\u76ee\u524d\u6211\u4eec\u7684 OS \u8fd8\u4e0d\u5177\u5907\u591a\u8fdb\u7a0b\uff0c\u591a\u7ebf\u7a0b\u8c03\u5ea6\u4ee5\u53ca\u5e76\u53d1\u6267\u884c\u7684\u80fd\u529b\u3002\u5728\u672c\u6b21\u5b9e\u9a8c\u4e2d\uff0c\u6211\u4eec\u5c06\u5229\u7528\u65f6\u949f\u4e2d\u65ad\uff0c\u6765\u5b9e\u73b0\u591a\u8fdb\u7a0b\uff0c\u591a\u7ebf\u7a0b\u7684\u8c03\u5ea6\u4ee5\u53ca\u4f7f\u5f97\u591a\u4e2a\u8fdb\u7a0b\u7ebf\u7a0b\u5e76\u53d1\u6267\u884c\u3002 3.1 \u8fdb\u7a0b\u4e0e\u7ebf\u7a0b \u6e90\u4ee3\u7801 \u7ecf\u7f16\u8bd1\u5668\u4e00\u7cfb\u5217\u5904\u7406\uff08\u7f16\u8bd1\u3001\u94fe\u63a5\u3001\u4f18\u5316\u7b49\uff09\u540e\u5f97\u5230\u7684\u53ef\u6267\u884c\u6587\u4ef6\uff0c\u6211\u4eec\u79f0\u4e4b\u4e3a \u7a0b\u5e8f\uff08Program\uff09 \u3002\u800c\u901a\u4fd7\u5730\u8bf4\uff0c \u8fdb\u7a0b \u5c31\u662f \u6b63\u5728\u8fd0\u884c\u5e76\u4f7f\u7528\u8ba1\u7b97\u673a\u8d44\u6e90 \u7684\u7a0b\u5e8f\u3002 \u8fdb\u7a0b \u4e0e \u7a0b\u5e8f \u7684\u4e0d\u540c\u4e4b\u5904\u5728\u4e8e\uff0c \u8fdb\u7a0b \u662f\u4e00\u4e2a\u52a8\u6001\u7684\u6982\u5ff5\uff0c\u5176\u4e0d\u4ec5\u9700\u8981\u5c06\u5176\u8fd0\u884c\u7684\u7a0b\u5e8f\u7684\u4ee3\u7801/\u6570\u636e\u7b49\u52a0\u8f7d\u5230\u5185\u5b58\u7a7a\u95f4\u4e2d\uff0c\u8fd8\u9700\u8981\u62e5\u6709\u81ea\u5df1\u7684 \u8fd0\u884c\u6808 \u3002\u540c\u65f6\u4e00\u4e2a \u8fdb\u7a0b \u53ef\u4ee5\u5bf9\u5e94\u4e00\u4e2a\u6216\u591a\u4e2a \u7ebf\u7a0b \uff0c \u7ebf\u7a0b \u4e4b\u95f4\u5f80\u5f80\u5177\u6709\u76f8\u540c\u7684\u4ee3\u7801\uff0c\u5171\u4eab\u4e00\u5757\u5185\u5b58\uff0c\u4f46\u662f\u5374\u6709\u4e0d\u540c\u7684CPU\u6267\u884c\u72b6\u6001\u3002 \u5728\u672c\u6b21\u5b9e\u9a8c\u4e2d\uff0c\u4e3a\u4e86\u7b80\u5355\u8d77\u89c1\uff0c \u6211\u4eec\u91c7\u7528 single-threaded process \u6a21\u578b\uff0c \u5373 \u4e00\u4e2a\u8fdb\u7a0b \u5bf9\u5e94 \u4e00\u4e2a\u7ebf\u7a0b \uff0c\u8fdb\u7a0b\u4e0e\u7ebf\u7a0b\u4e0d\u505a\u660e\u663e\u533a\u5206\u3002 3.1 \u7ebf\u7a0b\u76f8\u5173\u5c5e\u6027 \u5728\u4e0d\u540c\u7684\u64cd\u4f5c\u7cfb\u7edf\u4e2d\uff0c\u4e3a\u6bcf\u4e2a\u7ebf\u7a0b\u6240\u4fdd\u5b58\u7684\u4fe1\u606f\u90fd\u4e0d\u540c\u3002\u5728\u8fd9\u91cc\uff0c\u6211\u4eec\u63d0\u4f9b\u4e00\u79cd\u57fa\u7840\u7684\u5b9e\u73b0\uff0c\u6bcf\u4e2a\u7ebf\u7a0b\u4f1a\u5305\u62ec\uff1a \u7ebf\u7a0bID \uff1a\u7528\u4e8e\u552f\u4e00\u786e\u8ba4\u4e00\u4e2a\u7ebf\u7a0b\u3002 \u8fd0\u884c\u6808 \uff1a\u6bcf\u4e2a\u7ebf\u7a0b\u90fd\u5fc5\u987b\u6709\u4e00\u4e2a\u72ec\u7acb\u7684\u8fd0\u884c\u6808\uff0c\u4fdd\u5b58\u8fd0\u884c\u65f6\u7684\u6570\u636e\u3002 \u6267\u884c\u4e0a\u4e0b\u6587 \uff1a\u5f53\u7ebf\u7a0b\u4e0d\u5728\u6267\u884c\u72b6\u6001\u65f6\uff0c\u6211\u4eec\u9700\u8981\u4fdd\u5b58\u5176\u4e0a\u4e0b\u6587\uff08\u5176\u5b9e\u5c31\u662f \u72b6\u6001\u5bc4\u5b58\u5668 \u7684\u503c\uff09\uff0c\u8fd9\u6837\u4e4b\u540e\u624d\u80fd\u591f\u5c06\u5176\u6062\u590d\uff0c\u7ee7\u7eed\u8fd0\u884c\u3002 \u8fd0\u884c\u65f6\u95f4\u7247 \uff1a\u4e3a\u6bcf\u4e2a\u7ebf\u7a0b\u5206\u914d\u7684\u8fd0\u884c\u65f6\u95f4\u3002 \u4f18\u5148\u7ea7 \uff1a\u5728\u4f18\u5148\u7ea7\u76f8\u5173\u8c03\u5ea6\u65f6\uff0c\u914d\u5408\u8c03\u5ea6\u7b97\u6cd5\uff0c\u6765\u9009\u51fa\u4e0b\u4e00\u4e2a\u6267\u884c\u7684\u7ebf\u7a0b\u3002 3.2 \u7ebf\u7a0b\u5207\u6362\u6d41\u7a0b\u56fe 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 Process 1 Operating System Process 2 + | X P1 executing | X | X v Timer Interrupt Trap X +----------------------> X + X X do_timer() X X + X X schedule() X X + X X save state to PCB1 X X + X X restore state from PCB2 X X + X X | X X v Timer Interrupt Ret X +---------------------> X | X | P2 executing X | X Timer Interrupt Trap v X <---------------------+ X + X do_timer() X + X schedule() X + X save state to PCB2 X + X restore state from PCB1 X + X | Timer Interrupt Ret v <----------------------+ | P1 executing | | v \u5728\u6bcf\u6b21\u5904\u7406\u65f6\u949f\u4e2d\u65ad\u65f6\uff0c\u64cd\u4f5c\u7cfb\u7edf\u9996\u5148\u4f1a\u5c06\u5f53\u524d\u7ebf\u7a0b\u7684\u8fd0\u884c\u5269\u4f59\u65f6\u95f4\u51cf\u5c11\u4e00\u4e2a\u5355\u4f4d\u3002\u4e4b\u540e\u6839\u636e\u8c03\u5ea6\u7b97\u6cd5\u6765\u786e\u5b9a\u662f\u7ee7\u7eed\u8fd0\u884c\u8fd8\u662f\u8c03\u5ea6\u5176\u4ed6\u7ebf\u7a0b\u6765\u6267\u884c\u3002 \u5728\u8fdb\u7a0b\u8c03\u5ea6\u65f6\uff0c\u64cd\u4f5c\u7cfb\u7edf\u4f1a\u904d\u5386\u6240\u6709\u53ef\u8fd0\u884c\u7684\u7ebf\u7a0b\uff0c\u6309\u7167\u4e00\u5b9a\u7684\u8c03\u5ea6\u7b97\u6cd5\u9009\u51fa\u4e0b\u4e00\u4e2a\u6267\u884c\u7684\u7ebf\u7a0b\u3002\u6700\u7ec8\u5c06\u9009\u62e9\u5f97\u5230\u7684\u7ebf\u7a0b\u4e0e\u5f53\u524d\u7ebf\u7a0b\u5207\u6362\u3002 \u5728\u5207\u6362\u7684\u8fc7\u7a0b\u4e2d\uff0c\u9996\u5148\u6211\u4eec\u9700\u8981\u4fdd\u5b58\u5f53\u524d\u7ebf\u7a0b\u7684\u6267\u884c\u4e0a\u4e0b\u6587\uff0c\u518d\u5c06\u5c06\u8981\u6267\u884c\u7ebf\u7a0b\u7684\u4e0a\u4e0b\u6587\u8f7d\u5165\u5230\u76f8\u5173\u5bc4\u5b58\u5668\u4e2d\uff0c\u81f3\u6b64\u6211\u4eec\u5c31\u5b8c\u6210\u4e86\u7ebf\u7a0b\u7684\u8c03\u5ea6\u4e0e\u5207\u6362\u3002 4 \u5b9e\u9a8c\u6b65\u9aa4 4.1 \u51c6\u5907\u5de5\u7a0b \u6b64\u6b21\u5b9e\u9a8c\u57fa\u4e8e lab2 \u540c\u5b66\u6240\u5b9e\u73b0\u7684\u4ee3\u7801\u8fdb\u884c\u3002 \u4ece repo \u540c\u6b65\u4ee5\u4e0b\u4ee3\u7801: rand.h/rand.c , string.h/string.c , mm.h/mm.c \u3002\u5e76\u6309\u7167\u4ee5\u4e0b\u6b65\u9aa4\u5c06\u8fd9\u4e9b\u6587\u4ef6\u6b63\u786e\u653e\u7f6e\u3002\u5176\u4e2d mm.h\\mm.c \u63d0\u4f9b\u4e86\u7b80\u5355\u7684\u7269\u7406\u5185\u5b58\u7ba1\u7406\u63a5\u53e3\uff0c rand.h\\rand.c \u63d0\u4f9b\u4e86 rand() \u63a5\u53e3\u7528\u4ee5\u63d0\u4f9b\u4f2a\u968f\u673a\u6570\u5e8f\u5217\uff0c string.h/string.c \u63d0\u4f9b\u4e86 memset \u63a5\u53e3\u7528\u4ee5\u521d\u59cb\u5316\u4e00\u6bb5\u5185\u5b58\u7a7a\u95f4\u3002 1 2 3 4 5 6 7 8 9 10 11 12 13 . \u251c\u2500\u2500 arch \u2502 \u2514\u2500\u2500 riscv \u2502 \u251c\u2500\u2500 include \u2502 \u2502 \u2514\u2500\u2500 mm.h \u2502 \u2514\u2500\u2500 kernel \u2502 \u2514\u2500\u2500 mm.c \u251c\u2500\u2500 include \u2502 \u251c\u2500\u2500 rand.h \u2502 \u2514\u2500\u2500 string.h \u2514\u2500\u2500 lib \u251c\u2500\u2500 rand.c \u2514\u2500\u2500 string.c \u5728 lab3 \u4e2d\u6211\u4eec\u9700\u8981\u4e00\u4e9b\u7269\u7406\u5185\u5b58\u7ba1\u7406\u7684\u63a5\u53e3\uff0c\u5728\u6b64\u6211\u4eec\u63d0\u4f9b\u4e86 kalloc \u63a5\u53e3 ( \u89c1 mm.c ) \u7ed9\u540c\u5b66\u3002\u540c\u5b66\u53ef\u4ee5\u7528 kalloc \u6765\u7533\u8bf7 4KB \u7684\u7269\u7406\u9875\u3002\u7531\u4e8e\u5f15\u5165\u4e86\u7b80\u5355\u7684\u7269\u7406\u5185\u5b58\u7ba1\u7406\uff0c\u9700\u8981\u5728 _start \u7684\u9002\u5f53\u4f4d\u7f6e\u8c03\u7528 mm_init , \u6765\u521d\u59cb\u5316\u5185\u5b58\u7ba1\u7406\u7cfb\u7edf\uff0c\u5e76\u4e14\u5728\u521d\u59cb\u5316\u65f6\u9700\u8981\u7528\u4e00\u4e9b\u81ea\u5b9a\u4e49\u7684\u5b8f\uff0c\u9700\u8981\u4fee\u6539 defs.h , \u5728 defs.h \u6dfb\u52a0 \u5982\u4e0b\u5185\u5bb9\uff1a 1 2 3 4 5 6 7 #define PHY_START 0x0000000080000000 #define PHY_SIZE 128 * 1024 * 1024 // 128MB\uff0c QEMU \u9ed8\u8ba4\u5185\u5b58\u5927\u5c0f #define PHY_END (PHY_START + PHY_SIZE) #define PGSIZE 0x1000 // 4KB #define PGROUNDUP(addr) ((addr + PGSIZE - 1) & (~(PGSIZE - 1))) #define PGROUNDDOWN(addr) (addr & (~(PGSIZE - 1))) \u8bf7\u5728\u6dfb\u52a0/\u4fee\u6539\u4e0a\u8ff0\u6587\u4ef6\u4ee3\u7801\u4e4b\u540e\uff0c\u786e\u4fdd\u5de5\u7a0b\u53ef\u4ee5\u6b63\u5e38\u8fd0\u884c\uff0c\u4e4b\u540e\u518d\u5f00\u59cb\u5b9e\u73b0 lab3 (\u6709\u53ef\u80fd\u9700\u8981\u540c\u5b66\u81ea\u5df1\u8c03\u6574\u4e00\u4e9b\u5934\u6587\u4ef6\u7684\u5f15\u5165)\u3002 \u5728 lab3 \u4e2d\u9700\u8981\u540c\u5b66\u9700\u8981\u6dfb\u52a0\u5e76\u4fee\u6539 arch/riscv/include/proc.h arch/riscv/kernel/proc.c \u4e24\u4e2a\u6587\u4ef6\u3002 \u672c\u6b21\u5b9e\u9a8c\u9700\u8981\u5b9e\u73b0\u4e24\u79cd\u4e0d\u540c\u7684\u8c03\u5ea6\u7b97\u6cd5\uff0c \u5982\u4f55\u63a7\u5236\u4ee3\u7801\u903b\u8f91\u89c1 4.4 4.2 proc.h \u6570\u636e\u7ed3\u6784\u5b9a\u4e49 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 // arch/riscv/include/proc.h #include \"types.h\" #define NR_TASKS (1 + 31) // \u7528\u4e8e\u63a7\u5236 \u6700\u5927\u7ebf\u7a0b\u6570\u91cf \uff08idle \u7ebf\u7a0b + 31 \u5185\u6838\u7ebf\u7a0b\uff09 #define TASK_RUNNING 0 // \u4e3a\u4e86\u7b80\u5316\u5b9e\u9a8c\uff0c\u6240\u6709\u7684\u7ebf\u7a0b\u90fd\u53ea\u6709\u4e00\u79cd\u72b6\u6001 #define PRIORITY_MIN 1 #define PRIORITY_MAX 10 /* \u7528\u4e8e\u8bb0\u5f55 `\u7ebf\u7a0b` \u7684 `\u5185\u6838\u6808\u4e0e\u7528\u6237\u6808\u6307\u9488` */ /* (lab3\u4e2d\u65e0\u9700\u8003\u8651\uff0c\u5728\u8fd9\u91cc\u5f15\u5165\u662f\u4e3a\u4e86\u4e4b\u540e\u5b9e\u9a8c\u7684\u4f7f\u7528) */ struct thread_info { uint64 kernel_sp ; uint64 user_sp ; }; /* \u7ebf\u7a0b\u72b6\u6001\u6bb5\u6570\u636e\u7ed3\u6784 */ struct thread_struct { uint64 ra ; uint64 sp ; uint64 s [ 12 ]; }; /* \u7ebf\u7a0b\u6570\u636e\u7ed3\u6784 */ struct task_struct { struct thread_info * thread_info ; uint64 state ; // \u7ebf\u7a0b\u72b6\u6001 uint64 counter ; // \u8fd0\u884c\u5269\u4f59\u65f6\u95f4 uint64 priority ; // \u8fd0\u884c\u4f18\u5148\u7ea7 1\u6700\u4f4e 10\u6700\u9ad8 uint64 pid ; // \u7ebf\u7a0bid struct thread_struct thread ; }; /* \u7ebf\u7a0b\u521d\u59cb\u5316 \u521b\u5efa NR_TASKS \u4e2a\u7ebf\u7a0b */ void task_init (); /* \u5728\u65f6\u949f\u4e2d\u65ad\u5904\u7406\u4e2d\u88ab\u8c03\u7528 \u7528\u4e8e\u5224\u65ad\u662f\u5426\u9700\u8981\u8fdb\u884c\u8c03\u5ea6 */ void do_timer (); /* \u8c03\u5ea6\u7a0b\u5e8f \u9009\u62e9\u51fa\u4e0b\u4e00\u4e2a\u8fd0\u884c\u7684\u7ebf\u7a0b */ void schedule (); /* \u7ebf\u7a0b\u5207\u6362\u5165\u53e3\u51fd\u6570*/ void switch_to ( struct task_struct * next ); /* dummy funciton: \u4e00\u4e2a\u5faa\u73af\u7a0b\u5e8f\uff0c\u5faa\u73af\u8f93\u51fa\u81ea\u5df1\u7684 pid \u4ee5\u53ca\u4e00\u4e2a\u81ea\u589e\u7684\u5c40\u90e8\u53d8\u91cf*/ void dummy (); 4.3 \u7ebf\u7a0b\u8c03\u5ea6\u529f\u80fd\u5b9e\u73b0 4.3.1 \u7ebf\u7a0b\u521d\u59cb\u5316 \u5728\u521d\u59cb\u5316\u7ebf\u7a0b\u7684\u65f6\u5019\uff0c\u6211\u4eec\u53c2\u8003 Linux v0.11\u4e2d\u7684\u5b9e\u73b0 \u4e3a\u6bcf\u4e2a\u7ebf\u7a0b\u5206\u914d\u4e00\u4e2a 4KB \u7684\u7269\u7406\u9875\uff0c\u6211\u4eec\u5c06 task_struct \u5b58\u653e\u5728\u8be5\u9875\u7684\u4f4e\u5730\u5740\u90e8\u5206\uff0c \u5c06\u7ebf\u7a0b\u7684\u6808\u6307\u9488 sp \u6307\u5411\u8be5\u9875\u7684\u9ad8\u5730\u5740\u3002\u5177\u4f53\u5185\u5b58\u5e03\u5c40\u5982\u4e0b\u56fe\u6240\u793a\uff1a 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\u25c4\u2500\u2500\u2500 High Address \u2502 \u2502 \u2502 stack \u2502 \u2502 \u2502 \u2502 \u2502 sp \u2500\u2500\u25ba\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2524 \u2502 \u2502 \u2502 \u2502 \u25bc \u2502 \u2502 \u2502 \u2502 \u2502 \u2502 \u2502 \u2502 \u2502 4KB Page \u2502 \u2502 \u2502 \u2502 \u2502 \u2502 \u2502 \u2502 \u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524 \u2502 \u2502 \u2502 \u2502 \u2502 task_struct \u2502 \u2502 \u2502 \u2502 \u2502 \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\u25c4\u2500\u2500\u2500 Low Address \u5f53\u6211\u4eec\u7684 OS run \u8d77\u6765\u65f6\u5019\uff0c\u5176\u672c\u8eab\u5c31\u662f\u4e00\u4e2a\u7ebf\u7a0b idle \u7ebf\u7a0b \uff0c\u4f46\u662f\u6211\u4eec\u5e76\u6ca1\u6709\u4e3a\u5b83\u8bbe\u8ba1\u597d task_struct \u3002\u6240\u4ee5\u7b2c\u4e00\u6b65\u6211\u4eec\u8981\u4e3a idle \u8bbe\u7f6e task_struct \u3002\u5e76\u5c06 current , task[0] \u90fd\u6307\u5411 idle \u3002 \u4e3a\u4e86\u65b9\u4fbf\u8d77\u89c1\uff0c\u6211\u4eec\u5c06 task[1] ~ task[NR_TASKS - 1] , \u5168\u90e8\u521d\u59cb\u5316\uff0c \u8fd9\u91cc\u548c idle \u8bbe\u7f6e\u7684\u533a\u522b\u5728\u4e8e\u8981\u4e3a\u8fd9\u4e9b\u7ebf\u7a0b\u8bbe\u7f6e thread_struct \u4e2d\u7684 ra \u548c sp . \u5728 _start \u9002\u5f53\u7684\u4f4d\u7f6e\u8c03\u7528 task_init 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 //arch/riscv/kernel/proc.c extern void __dummy (); struct task_struct * idle ; // idle process struct task_struct * current ; // \u6307\u5411\u5f53\u524d\u8fd0\u884c\u7ebf\u7a0b\u7684 `task_struct` struct task_struct * task [ NR_TASKS ]; // \u7ebf\u7a0b\u6570\u7ec4\uff0c\u6240\u6709\u7684\u7ebf\u7a0b\u90fd\u4fdd\u5b58\u5728\u6b64 void task_init () { // 1. \u8c03\u7528 kalloc() \u4e3a idle \u5206\u914d\u4e00\u4e2a\u7269\u7406\u9875 // 2. \u8bbe\u7f6e state \u4e3a TASK_RUNNING; // 3. \u7531\u4e8e idle \u4e0d\u53c2\u4e0e\u8c03\u5ea6 \u53ef\u4ee5\u5c06\u5176 counter / priority \u8bbe\u7f6e\u4e3a 0 // 4. \u8bbe\u7f6e idle \u7684 pid \u4e3a 0 // 5. \u5c06 current \u548c task[0] \u6307\u5411 idle /* YOUR CODE HERE */ // 1. \u53c2\u8003 idle \u7684\u8bbe\u7f6e, \u4e3a task[1] ~ task[NR_TASKS - 1] \u8fdb\u884c\u521d\u59cb\u5316 // 2. \u5176\u4e2d\u6bcf\u4e2a\u7ebf\u7a0b\u7684 state \u4e3a TASK_RUNNING, counter \u4e3a 0, priority \u4f7f\u7528 rand() \u6765\u8bbe\u7f6e, pid \u4e3a\u8be5\u7ebf\u7a0b\u5728\u7ebf\u7a0b\u6570\u7ec4\u4e2d\u7684\u4e0b\u6807\u3002 // 3. \u4e3a task[1] ~ task[NR_TASKS - 1] \u8bbe\u7f6e `thread_struct` \u4e2d\u7684 `ra` \u548c `sp`, // 4. \u5176\u4e2d `ra` \u8bbe\u7f6e\u4e3a __dummy \uff08\u89c1 4.3.2\uff09\u7684\u5730\u5740\uff0c `sp` \u8bbe\u7f6e\u4e3a \u8be5\u7ebf\u7a0b\u7533\u8bf7\u7684\u7269\u7406\u9875\u7684\u9ad8\u5730\u5740 /* YOUR CODE HERE */ printk ( \"...proc_init done! \\n \" ); } Debug \u63d0\u793a\uff1a \u4fee\u6539 proc.h \u4e2d\u7684 NR_TASKS \u4e3a\u4e00\u4e2a\u6bd4\u8f83\u5c0f\u7684\u503c, \u6bd4\u5982 5\uff0c \u8fd9\u6837 \u9664\u53bb task[0] ( idle )\uff0c\u53ea\u9700\u8981\u521d\u59cb\u5316 4 \u4e2a\u7ebf\u7a0b\uff0c\u65b9\u4fbf\u8c03\u8bd5\u3002 \u6ce8\u610f\u4ee5\u4e0a\u7684\u4fee\u6539\u53ea\u662f\u4e3a\u4e86\u5728\u505a\u5b9e\u9a8c\u7684\u8fc7\u7a0b\u4e2d\u65b9\u4fbf\u8c03\u8bd5\uff0c\u6700\u540e\u4e00\u5b9a\u8bb0\u4f4f\u8981\u4fee\u6539\u56de\u53bb\uff01\uff01\uff01 4.3.2 __dummy \u4e0e dummy \u4ecb\u7ecd task[1] ~ task[NR_TASKS - 1] \u90fd\u8fd0\u884c\u540c\u4e00\u6bb5\u4ee3\u7801 dummy() \u6211\u4eec\u5728 proc.c \u6dfb\u52a0 dummy() : 1 2 3 4 5 6 7 8 9 10 11 12 13 14 // arch/riscv/kernel/proc.c void dummy () { uint64 MOD = 1000000007 ; uint64 auto_inc_local_var = 0 ; int last_counter = -1 ; while ( 1 ) { if ( last_counter == -1 || current -> counter != last_counter ) { last_counter = current -> counter ; auto_inc_local_var = ( auto_inc_local_var + 1 ) % MOD ; printk ( \"[PID = %d] is running. auto_inc_local_var = %d \\n \" , current -> pid , auto_inc_local_var ); } } } Debug \u63d0\u793a\uff1a \u53ef\u4ee5\u4fee\u6539 printk \u6253\u5370\u66f4\u591a\u7684\u4fe1\u606f \u5f53\u7ebf\u7a0b\u5728\u8fd0\u884c\u65f6\uff0c\u7531\u4e8e\u65f6\u949f\u4e2d\u65ad\u7684\u89e6\u53d1\uff0c\u4f1a\u5c06\u5f53\u524d\u8fd0\u884c\u7ebf\u7a0b\u7684\u4e0a\u4e0b\u6587\u73af\u5883\u4fdd\u5b58\u5728\u6808\u4e0a ( lab2 \u4e2d\u5b9e\u73b0\u7684 _traps )\u3002 \u5f53\u7ebf\u7a0b\u518d\u6b21\u88ab\u8c03\u5ea6\u65f6\uff0c\u4f1a\u5c06\u4e0a\u4e0b\u6587\u4ece\u6808\u4e0a\u6062\u590d\uff0c\u4f46\u662f\u5f53\u6211\u4eec\u521b\u5efa\u4e00\u4e2a\u65b0\u7684\u7ebf\u7a0b\uff0c\u6b64\u65f6\u7ebf\u7a0b\u7684\u6808\u4e3a\u7a7a\uff0c\u5f53\u8fd9\u4e2a\u7ebf\u7a0b\u88ab\u8c03\u5ea6\u65f6\uff0c\u662f\u6ca1\u6709\u4e0a\u4e0b\u6587\u9700\u8981\u88ab\u6062\u590d\u7684\uff0c\u6240\u4ee5\u6211\u4eec\u9700\u8981\u4e3a\u7ebf\u7a0b \u7b2c\u4e00\u6b21\u8c03\u5ea6 \u63d0\u4f9b\u4e00\u4e2a\u7279\u6b8a\u7684\u8fd4\u56de\u51fd\u6570 __dummy \u5728 entry.S \u6dfb\u52a0 __dummy \u5728 __dummy \u4e2d\u5c06 sepc \u8bbe\u7f6e\u4e3a dummy() \u7684\u5730\u5740, \u5e76\u4f7f\u7528 sret \u4ece\u4e2d\u65ad\u4e2d\u8fd4\u56de\u3002 __dummy \u4e0e _traps \u7684 restore \u90e8\u5206\u76f8\u6bd4\uff0c \u5176\u5b9e\u5c31\u662f\u7701\u7565\u4e86\u4ece\u6808\u4e0a\u6062\u590d\u4e0a\u4e0b\u6587\u7684\u8fc7\u7a0b \uff08 \u4f46\u662f\u624b\u52a8\u8bbe\u7f6e\u4e86 sepc \uff09\u3002 1 2 3 4 5 # arch/riscv/kernel/entry.S .global __dummy __dummy: # YOUR CODE HERE 4.3.3 \u5b9e\u73b0\u7ebf\u7a0b\u5207\u6362 \u5224\u65ad\u4e0b\u4e00\u4e2a\u6267\u884c\u7684\u7ebf\u7a0b next \u4e0e\u5f53\u524d\u7684\u7ebf\u7a0b current \u662f\u5426\u4e3a\u540c\u4e00\u4e2a\u7ebf\u7a0b\uff0c\u5982\u679c\u662f\u540c\u4e00\u4e2a\u7ebf\u7a0b\uff0c\u5219\u65e0\u9700\u505a\u4efb\u4f55\u5904\u7406\uff0c\u5426\u5219\u8c03\u7528 __switch_to \u8fdb\u884c\u7ebf\u7a0b\u5207\u6362\u3002 1 2 3 4 5 6 7 // arch/riscv/kernel/proc.c extern void __switch_to ( struct task_struct * prev , struct task_struct * next ); void switch_to ( struct task_struct * next ) { /* YOUR CODE HERE */ } \u5728 entry.S \u4e2d\u5b9e\u73b0\u7ebf\u7a0b\u4e0a\u4e0b\u6587\u5207\u6362 __switch_to : __switch_to \u63a5\u53d7\u4e24\u4e2a task_struct \u6307\u9488\u4f5c\u4e3a\u53c2\u6570 \u4fdd\u5b58\u5f53\u524d\u7ebf\u7a0b\u7684 ra , sp , s0~s11 \u5230\u5f53\u524d\u7ebf\u7a0b\u7684 thread_struct \u4e2d \u5c06\u4e0b\u4e00\u4e2a\u7ebf\u7a0b\u7684 thread_struct \u4e2d\u7684\u76f8\u5173\u6570\u636e\u8f7d\u5165\u5230 ra , sp , s0~s11 \u4e2d\u3002 1 2 3 4 5 6 7 8 9 10 11 # arch/riscv/kernel/entry.S .globl __switch_to __switch_to: # save state to prev process # YOUR CODE HERE # restore state from next process # YOUR CODE HERE ret Debug \u63d0\u793a\uff1a \u53ef\u4ee5\u5c1d\u8bd5\u662f\u5426\u53ef\u4ee5\u4ece idle \u6b63\u786e\u5207\u6362\u5230 process 1 4.3.4 \u5b9e\u73b0\u8c03\u5ea6\u5165\u53e3\u51fd\u6570 \u5b9e\u73b0 do_timer() , \u5e76\u5728 \u65f6\u949f\u4e2d\u65ad\u5904\u7406\u51fd\u6570 \u4e2d\u8c03\u7528\u3002 1 2 3 4 5 6 7 8 // arch/riscv/kernel/proc.c void do_timer ( void ) { /* 1. \u5982\u679c\u5f53\u524d\u7ebf\u7a0b\u662f idle \u7ebf\u7a0b \u76f4\u63a5\u8fdb\u884c\u8c03\u5ea6 /* 2. \u5982\u679c\u5f53\u524d\u7ebf\u7a0b\u4e0d\u662f idle \u5bf9\u5f53\u524d\u7ebf\u7a0b\u7684\u8fd0\u884c\u5269\u4f59\u65f6\u95f4\u51cf1 \u82e5\u5269\u4f59\u65f6\u95f4\u4efb\u7136\u5927\u4e8e0 \u5219\u76f4\u63a5\u8fd4\u56de \u5426\u5219\u8fdb\u884c\u8c03\u5ea6*/ /* YOUR CODE HERE */ } 4.3.5 \u5b9e\u73b0\u7ebf\u7a0b\u8c03\u5ea6 \u672c\u6b21\u5b9e\u9a8c\u6211\u4eec\u9700\u8981\u5b9e\u73b0\u4e24\u79cd\u8c03\u5ea6\u7b97\u6cd5\uff1a1.\u77ed\u4f5c\u4e1a\u4f18\u5148\u8c03\u5ea6\u7b97\u6cd5\uff0c2.\u4f18\u5148\u7ea7\u8c03\u5ea6\u7b97\u6cd5\u3002 4.3.5.1 \u77ed\u4f5c\u4e1a\u4f18\u5148\u8c03\u5ea6\u7b97\u6cd5 \u5f53\u9700\u8981\u8fdb\u884c\u8c03\u5ea6\u65f6\u6309\u7167\u4e00\u4e0b\u89c4\u5219\u8fdb\u884c\u8c03\u5ea6\uff1a \u904d\u5386\u7ebf\u7a0b\u6307\u9488\u6570\u7ec4 task (\u4e0d\u5305\u62ec idle \uff0c\u5373 task[0] )\uff0c\u5728\u6240\u6709\u8fd0\u884c\u72b6\u6001 ( TASK_RUNNING ) \u4e0b\u7684\u7ebf\u7a0b\u8fd0\u884c\u5269\u4f59\u65f6\u95f4 \u6700\u5c11 \u7684\u7ebf\u7a0b\u4f5c\u4e3a\u4e0b\u4e00\u4e2a\u6267\u884c\u7684\u7ebf\u7a0b\u3002 \u5982\u679c \u6240\u6709 \u8fd0\u884c\u72b6\u6001\u4e0b\u7684\u7ebf\u7a0b\u8fd0\u884c\u5269\u4f59\u65f6\u95f4\u90fd\u4e3a0\uff0c\u5219\u5bf9 task[1] ~ task[NR_TASKS-1] \u7684\u8fd0\u884c\u5269\u4f59\u65f6\u95f4\u91cd\u65b0\u8d4b\u503c (\u4f7f\u7528 rand() ) \uff0c\u4e4b\u540e\u518d\u91cd\u65b0\u8fdb\u884c\u8c03\u5ea6\u3002 1 2 3 4 5 // arch/riscv/kernel/proc.c void schedule ( void ) { /* YOUR CODE HERE */ } Debug \u63d0\u793a\uff1a \u5c06 NR_TASKS \u6539\u4e3a\u8f83\u5c0f\u7684\u503c\uff0c\u8c03\u7528 printk \u5c06\u6240\u6709\u7ebf\u7a0b\u7684\u4fe1\u606f\u6253\u5370\u51fa\u6765\u3002 4.3.5.2 \u4f18\u5148\u7ea7\u8c03\u5ea6\u7b97\u6cd5 \u53c2\u8003 Linux v0.11 \u8c03\u5ea6\u7b97\u6cd5\u5b9e\u73b0 \u5b9e\u73b0\u3002 1 2 3 4 5 // arch/riscv/kernel/proc.c void schedule ( void ) { /* YOUR CODE HERE */ } 4.4 \u7f16\u8bd1\u53ca\u6d4b\u8bd5 \u7531\u4e8e\u52a0\u5165\u4e86\u4e00\u4e9b\u65b0\u7684 .c \u6587\u4ef6\uff0c\u53ef\u80fd\u9700\u8981\u4fee\u6539\u4e00\u4e9bMakefile\u6587\u4ef6\uff0c\u8bf7\u540c\u5b66\u81ea\u5df1\u5c1d\u8bd5\u4fee\u6539\uff0c\u4f7f\u9879\u76ee\u53ef\u4ee5\u7f16\u8bd1\u5e76\u8fd0\u884c\u3002 \u7531\u4e8e\u672c\u6b21\u5b9e\u9a8c\u9700\u8981\u5b8c\u6210\u4e24\u4e2a\u8c03\u5ea6\u7b97\u6cd5\uff0c\u56e0\u6b64\u9700\u8981\u4e24\u79cd\u8c03\u5ea6\u7b97\u6cd5\u53ef\u4ee5\u4f7f\u7528 gcc \u2013D \u9009\u9879\u8fdb\u884c\u63a7\u5236\u3002 DSJF \uff08\u77ed\u4f5c\u4e1a\u4f18\u5148\u8c03\u5ea6\uff09\u3002 DPRIORITY \uff08\u4f18\u5148\u7ea7\u8c03\u5ea6\uff09\u3002 \u5728 proc.c \u4e2d\u4f7f\u7528 #ifdef , #endif \u6765\u63a7\u5236\u4ee3\u7801\u3002 \u4fee\u6539Makefile\u4e2d\u7684 CFLAG = ${CF} ${INCLUDE} -DSJF / -DPRIORITY (\u4f5c\u4e1a\u63d0\u4ea4\u7684\u65f6\u5019 Makefile \u9009\u62e9\u4efb\u610f\u4e00\u4e2a\u90fd\u53ef\u4ee5) \u77ed\u4f5c\u4e1a\u4f18\u5148\u8c03\u5ea6\u8f93\u51fa\u793a\u4f8b (\u4e3a\u4e86\u4fbf\u4e8e\u5c55\u793a\uff0c\u8fd9\u91cc\u4e00\u5171\u53ea\u521d\u59cb\u5316\u4e86 4 \u4e2a\u7ebf\u7a0b) \u540c\u5b66\u4eec\u6700\u540e\u63d0\u4ea4\u65f6\u9700\u8981 \u4fdd\u8bc1 NR_TASKS \u4e3a 32 \u4e0d\u53d8 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 OpenSBI v0.9 ____ _____ ____ _____ / __ \\ / ____ | _ \\_ _ | | | | | _ __ ___ _ __ | ( ___ | | _ ) || | | | | | '_ \\ / _ \\ ' _ \\ \\_ __ \\| _ < | | | | __ | | | _ ) | __/ | | | ____ ) | | _ ) || | _ \\_ ___/ | .__/ \\_ __ | _ | | _ | _____/ | ____/_____ | | | | _ | ... Boot HART MIDELEG : 0x0000000000000222 Boot HART MEDELEG : 0x000000000000b109 ...mm_init done ! ...proc_init done ! Hello RISC-V idle process is running! SET [ PID = 1 COUNTER = 10 ] SET [ PID = 2 COUNTER = 10 ] SET [ PID = 3 COUNTER = 5 ] SET [ PID = 4 COUNTER = 2 ] switch to [ PID = 4 COUNTER = 2 ] [ PID = 4 ] is running. auto_inc_local_var = 1 [ PID = 4 ] is running. auto_inc_local_var = 2 switch to [ PID = 3 COUNTER = 5 ] [ PID = 3 ] is running. auto_inc_local_var = 1 ..... [ PID = 3 ] is running. auto_inc_local_var = 5 switch to [ PID = 2 COUNTER = 10 ] [ PID = 2 ] is running. auto_inc_local_var = 1 ... [ PID = 2 ] is running. auto_inc_local_var = 10 switch to [ PID = 1 COUNTER = 10 ] [ PID = 1 ] is running. auto_inc_local_var = 1 ... [ PID = 1 ] is running. auto_inc_local_var = 10 SET [ PID = 1 COUNTER = 9 ] SET [ PID = 2 COUNTER = 4 ] SET [ PID = 3 COUNTER = 4 ] SET [ PID = 4 COUNTER = 10 ] switch to [ PID = 3 COUNTER = 4 ] [ PID = 3 ] is running. auto_inc_local_var = 6 ... [ PID = 3 ] is running. auto_inc_local_var = 9 \u4f18\u5148\u7ea7\u8c03\u5ea6\u8f93\u51fa\u793a\u4f8b 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 OpenSBI v0.9 ____ _____ ____ _____ / __ \\ / ____ | _ \\_ _ | | | | | _ __ ___ _ __ | ( ___ | | _ ) || | | | | | '_ \\ / _ \\ ' _ \\ \\_ __ \\| _ < | | | | __ | | | _ ) | __/ | | | ____ ) | | _ ) || | _ \\_ ___/ | .__/ \\_ __ | _ | | _ | _____/ | ____/_____ | | | | _ | ... Boot HART MIDELEG : 0x0000000000000222 Boot HART MEDELEG : 0x000000000000b109 ...mm_init done ! ...proc_init done ! Hello RISC-V idle process is running! SET [ PID = 1 PRIORITY = 1 COUNTER = 1 ] SET [ PID = 2 PRIORITY = 4 COUNTER = 4 ] SET [ PID = 3 PRIORITY = 10 COUNTER = 10 ] SET [ PID = 4 PRIORITY = 4 COUNTER = 4 ] switch to [ PID = 3 PRIORITY = 10 COUNTER = 10 ] [ PID = 3 ] is running. auto_inc_local_var = 1 ... [ PID = 3 ] is running. auto_inc_local_var = 10 switch to [ PID = 4 PRIORITY = 4 COUNTER = 4 ] [ PID = 4 ] is running. auto_inc_local_var = 1 ... [ PID = 4 ] is running. auto_inc_local_var = 4 switch to [ PID = 2 PRIORITY = 4 COUNTER = 4 ] [ PID = 2 ] is running. auto_inc_local_var = 1 ... [ PID = 2 ] is running. auto_inc_local_var = 4 switch to [ PID = 1 PRIORITY = 1 COUNTER = 1 ] [ PID = 1 ] is running. auto_inc_local_var = 1 SET [ PID = 1 PRIORITY = 1 COUNTER = 1 ] SET [ PID = 2 PRIORITY = 4 COUNTER = 4 ] SET [ PID = 3 PRIORITY = 10 COUNTER = 10 ] SET [ PID = 4 PRIORITY = 4 COUNTER = 4 ] switch to [ PID = 3 PRIORITY = 10 COUNTER = 10 ] [ PID = 3 ] is running. auto_inc_local_var = 11 ... \u601d\u8003\u9898 \u5728 RV64 \u4e2d\u4e00\u5171\u7528 32 \u4e2a\u901a\u7528\u5bc4\u5b58\u5668\uff0c \u4e3a\u4ec0\u4e48 context_switch \u4e2d\u53ea\u4fdd\u5b58\u4e8614\u4e2a \uff1f \u5f53\u7ebf\u7a0b\u7b2c\u4e00\u6b21\u8c03\u7528\u65f6\uff0c \u5176 ra \u6240\u4ee3\u8868\u7684\u8fd4\u56de\u70b9\u662f __dummy \u3002 \u90a3\u4e48\u5728\u4e4b\u540e\u7684\u7ebf\u7a0b\u8c03\u7528\u4e2d context_switch \u4e2d\uff0c ra \u4fdd\u5b58/\u6062\u590d\u7684\u51fd\u6570\u8fd4\u56de\u70b9\u662f\u4ec0\u4e48\u5462 \uff1f \u8bf7\u540c\u5b66\u7528gdb\u5c1d\u8bd5\u8ffd\u8e2a\u4e00\u6b21\u5b8c\u6574\u7684\u7ebf\u7a0b\u5207\u6362\u6d41\u7a0b\uff0c \u5e76\u5173\u6ce8\u6bcf\u4e00\u6b21 ra \u7684\u53d8\u6362\u3002 \u4f5c\u4e1a\u63d0\u4ea4 \u540c\u5b66\u9700\u8981\u63d0\u4ea4\u5b9e\u9a8c\u62a5\u544a\u4ee5\u53ca\u6574\u4e2a\u5de5\u7a0b\u4ee3\u7801\u3002\u5728\u63d0\u4ea4\u524d\u8bf7\u4f7f\u7528 make clean \u6e05\u9664\u6240\u6709\u6784\u5efa\u4ea7\u7269\u3002","title":"\u5b9e\u9a8c\u6307\u5bfc\u4e09"},{"location":"lab3/#lab-3-rv64","text":"","title":"Lab 3: RV64 \u5185\u6838\u7ebf\u7a0b\u8c03\u5ea6"},{"location":"lab3/#1","text":"\u4e86\u89e3\u7ebf\u7a0b\u6982\u5ff5\uff0c\u5e76\u5b66\u4e60\u7ebf\u7a0b\u76f8\u5173\u7ed3\u6784\u4f53\uff0c\u5e76\u5b9e\u73b0\u7ebf\u7a0b\u7684\u521d\u59cb\u5316\u529f\u80fd\u3002 \u4e86\u89e3\u5982\u4f55\u4f7f\u7528\u65f6\u949f\u4e2d\u65ad\u6765\u5b9e\u73b0\u7ebf\u7a0b\u7684\u8c03\u5ea6\u3002 \u4e86\u89e3\u7ebf\u7a0b\u5207\u6362\u539f\u7406\uff0c\u5e76\u5b9e\u73b0\u7ebf\u7a0b\u7684\u5207\u6362\u3002 \u638c\u63e1\u7b80\u5355\u7684\u7ebf\u7a0b\u8c03\u5ea6\u7b97\u6cd5\uff0c\u5e76\u5b8c\u6210\u4e24\u79cd\u7b80\u5355\u8c03\u5ea6\u7b97\u6cd5\u7684\u5b9e\u73b0\u3002","title":"1 \u5b9e\u9a8c\u76ee\u7684"},{"location":"lab3/#2","text":"Docker in Lab0","title":"2 \u5b9e\u9a8c\u73af\u5883"},{"location":"lab3/#3","text":"","title":"3 \u80cc\u666f\u77e5\u8bc6"},{"location":"lab3/#30","text":"\u5728 lab2 \u4e2d\uff0c\u6211\u4eec\u5229\u7528\u5f02\u5e38\u8d4b\u4e88\u4e86 OS \u4e0e\u8f6f\u4ef6\uff0c\u786c\u4ef6\u7684\u4ea4\u4e92\u80fd\u529b\u3002\u4f46\u662f\u76ee\u524d\u6211\u4eec\u7684 OS \u8fd8\u4e0d\u5177\u5907\u591a\u8fdb\u7a0b\uff0c\u591a\u7ebf\u7a0b\u8c03\u5ea6\u4ee5\u53ca\u5e76\u53d1\u6267\u884c\u7684\u80fd\u529b\u3002\u5728\u672c\u6b21\u5b9e\u9a8c\u4e2d\uff0c\u6211\u4eec\u5c06\u5229\u7528\u65f6\u949f\u4e2d\u65ad\uff0c\u6765\u5b9e\u73b0\u591a\u8fdb\u7a0b\uff0c\u591a\u7ebf\u7a0b\u7684\u8c03\u5ea6\u4ee5\u53ca\u4f7f\u5f97\u591a\u4e2a\u8fdb\u7a0b\u7ebf\u7a0b\u5e76\u53d1\u6267\u884c\u3002","title":"3.0 \u524d\u8a00"},{"location":"lab3/#31","text":"\u6e90\u4ee3\u7801 \u7ecf\u7f16\u8bd1\u5668\u4e00\u7cfb\u5217\u5904\u7406\uff08\u7f16\u8bd1\u3001\u94fe\u63a5\u3001\u4f18\u5316\u7b49\uff09\u540e\u5f97\u5230\u7684\u53ef\u6267\u884c\u6587\u4ef6\uff0c\u6211\u4eec\u79f0\u4e4b\u4e3a \u7a0b\u5e8f\uff08Program\uff09 \u3002\u800c\u901a\u4fd7\u5730\u8bf4\uff0c \u8fdb\u7a0b \u5c31\u662f \u6b63\u5728\u8fd0\u884c\u5e76\u4f7f\u7528\u8ba1\u7b97\u673a\u8d44\u6e90 \u7684\u7a0b\u5e8f\u3002 \u8fdb\u7a0b \u4e0e \u7a0b\u5e8f \u7684\u4e0d\u540c\u4e4b\u5904\u5728\u4e8e\uff0c \u8fdb\u7a0b \u662f\u4e00\u4e2a\u52a8\u6001\u7684\u6982\u5ff5\uff0c\u5176\u4e0d\u4ec5\u9700\u8981\u5c06\u5176\u8fd0\u884c\u7684\u7a0b\u5e8f\u7684\u4ee3\u7801/\u6570\u636e\u7b49\u52a0\u8f7d\u5230\u5185\u5b58\u7a7a\u95f4\u4e2d\uff0c\u8fd8\u9700\u8981\u62e5\u6709\u81ea\u5df1\u7684 \u8fd0\u884c\u6808 \u3002\u540c\u65f6\u4e00\u4e2a \u8fdb\u7a0b \u53ef\u4ee5\u5bf9\u5e94\u4e00\u4e2a\u6216\u591a\u4e2a \u7ebf\u7a0b \uff0c \u7ebf\u7a0b \u4e4b\u95f4\u5f80\u5f80\u5177\u6709\u76f8\u540c\u7684\u4ee3\u7801\uff0c\u5171\u4eab\u4e00\u5757\u5185\u5b58\uff0c\u4f46\u662f\u5374\u6709\u4e0d\u540c\u7684CPU\u6267\u884c\u72b6\u6001\u3002 \u5728\u672c\u6b21\u5b9e\u9a8c\u4e2d\uff0c\u4e3a\u4e86\u7b80\u5355\u8d77\u89c1\uff0c \u6211\u4eec\u91c7\u7528 single-threaded process \u6a21\u578b\uff0c \u5373 \u4e00\u4e2a\u8fdb\u7a0b \u5bf9\u5e94 \u4e00\u4e2a\u7ebf\u7a0b \uff0c\u8fdb\u7a0b\u4e0e\u7ebf\u7a0b\u4e0d\u505a\u660e\u663e\u533a\u5206\u3002","title":"3.1 \u8fdb\u7a0b\u4e0e\u7ebf\u7a0b"},{"location":"lab3/#31_1","text":"\u5728\u4e0d\u540c\u7684\u64cd\u4f5c\u7cfb\u7edf\u4e2d\uff0c\u4e3a\u6bcf\u4e2a\u7ebf\u7a0b\u6240\u4fdd\u5b58\u7684\u4fe1\u606f\u90fd\u4e0d\u540c\u3002\u5728\u8fd9\u91cc\uff0c\u6211\u4eec\u63d0\u4f9b\u4e00\u79cd\u57fa\u7840\u7684\u5b9e\u73b0\uff0c\u6bcf\u4e2a\u7ebf\u7a0b\u4f1a\u5305\u62ec\uff1a \u7ebf\u7a0bID \uff1a\u7528\u4e8e\u552f\u4e00\u786e\u8ba4\u4e00\u4e2a\u7ebf\u7a0b\u3002 \u8fd0\u884c\u6808 \uff1a\u6bcf\u4e2a\u7ebf\u7a0b\u90fd\u5fc5\u987b\u6709\u4e00\u4e2a\u72ec\u7acb\u7684\u8fd0\u884c\u6808\uff0c\u4fdd\u5b58\u8fd0\u884c\u65f6\u7684\u6570\u636e\u3002 \u6267\u884c\u4e0a\u4e0b\u6587 \uff1a\u5f53\u7ebf\u7a0b\u4e0d\u5728\u6267\u884c\u72b6\u6001\u65f6\uff0c\u6211\u4eec\u9700\u8981\u4fdd\u5b58\u5176\u4e0a\u4e0b\u6587\uff08\u5176\u5b9e\u5c31\u662f \u72b6\u6001\u5bc4\u5b58\u5668 \u7684\u503c\uff09\uff0c\u8fd9\u6837\u4e4b\u540e\u624d\u80fd\u591f\u5c06\u5176\u6062\u590d\uff0c\u7ee7\u7eed\u8fd0\u884c\u3002 \u8fd0\u884c\u65f6\u95f4\u7247 \uff1a\u4e3a\u6bcf\u4e2a\u7ebf\u7a0b\u5206\u914d\u7684\u8fd0\u884c\u65f6\u95f4\u3002 \u4f18\u5148\u7ea7 \uff1a\u5728\u4f18\u5148\u7ea7\u76f8\u5173\u8c03\u5ea6\u65f6\uff0c\u914d\u5408\u8c03\u5ea6\u7b97\u6cd5\uff0c\u6765\u9009\u51fa\u4e0b\u4e00\u4e2a\u6267\u884c\u7684\u7ebf\u7a0b\u3002","title":"3.1 \u7ebf\u7a0b\u76f8\u5173\u5c5e\u6027"},{"location":"lab3/#32","text":"1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 Process 1 Operating System Process 2 + | X P1 executing | X | X v Timer Interrupt Trap X +----------------------> X + X X do_timer() X X + X X schedule() X X + X X save state to PCB1 X X + X X restore state from PCB2 X X + X X | X X v Timer Interrupt Ret X +---------------------> X | X | P2 executing X | X Timer Interrupt Trap v X <---------------------+ X + X do_timer() X + X schedule() X + X save state to PCB2 X + X restore state from PCB1 X + X | Timer Interrupt Ret v <----------------------+ | P1 executing | | v \u5728\u6bcf\u6b21\u5904\u7406\u65f6\u949f\u4e2d\u65ad\u65f6\uff0c\u64cd\u4f5c\u7cfb\u7edf\u9996\u5148\u4f1a\u5c06\u5f53\u524d\u7ebf\u7a0b\u7684\u8fd0\u884c\u5269\u4f59\u65f6\u95f4\u51cf\u5c11\u4e00\u4e2a\u5355\u4f4d\u3002\u4e4b\u540e\u6839\u636e\u8c03\u5ea6\u7b97\u6cd5\u6765\u786e\u5b9a\u662f\u7ee7\u7eed\u8fd0\u884c\u8fd8\u662f\u8c03\u5ea6\u5176\u4ed6\u7ebf\u7a0b\u6765\u6267\u884c\u3002 \u5728\u8fdb\u7a0b\u8c03\u5ea6\u65f6\uff0c\u64cd\u4f5c\u7cfb\u7edf\u4f1a\u904d\u5386\u6240\u6709\u53ef\u8fd0\u884c\u7684\u7ebf\u7a0b\uff0c\u6309\u7167\u4e00\u5b9a\u7684\u8c03\u5ea6\u7b97\u6cd5\u9009\u51fa\u4e0b\u4e00\u4e2a\u6267\u884c\u7684\u7ebf\u7a0b\u3002\u6700\u7ec8\u5c06\u9009\u62e9\u5f97\u5230\u7684\u7ebf\u7a0b\u4e0e\u5f53\u524d\u7ebf\u7a0b\u5207\u6362\u3002 \u5728\u5207\u6362\u7684\u8fc7\u7a0b\u4e2d\uff0c\u9996\u5148\u6211\u4eec\u9700\u8981\u4fdd\u5b58\u5f53\u524d\u7ebf\u7a0b\u7684\u6267\u884c\u4e0a\u4e0b\u6587\uff0c\u518d\u5c06\u5c06\u8981\u6267\u884c\u7ebf\u7a0b\u7684\u4e0a\u4e0b\u6587\u8f7d\u5165\u5230\u76f8\u5173\u5bc4\u5b58\u5668\u4e2d\uff0c\u81f3\u6b64\u6211\u4eec\u5c31\u5b8c\u6210\u4e86\u7ebf\u7a0b\u7684\u8c03\u5ea6\u4e0e\u5207\u6362\u3002","title":"3.2 \u7ebf\u7a0b\u5207\u6362\u6d41\u7a0b\u56fe"},{"location":"lab3/#4","text":"","title":"4 \u5b9e\u9a8c\u6b65\u9aa4"},{"location":"lab3/#41","text":"\u6b64\u6b21\u5b9e\u9a8c\u57fa\u4e8e lab2 \u540c\u5b66\u6240\u5b9e\u73b0\u7684\u4ee3\u7801\u8fdb\u884c\u3002 \u4ece repo \u540c\u6b65\u4ee5\u4e0b\u4ee3\u7801: rand.h/rand.c , string.h/string.c , mm.h/mm.c \u3002\u5e76\u6309\u7167\u4ee5\u4e0b\u6b65\u9aa4\u5c06\u8fd9\u4e9b\u6587\u4ef6\u6b63\u786e\u653e\u7f6e\u3002\u5176\u4e2d mm.h\\mm.c \u63d0\u4f9b\u4e86\u7b80\u5355\u7684\u7269\u7406\u5185\u5b58\u7ba1\u7406\u63a5\u53e3\uff0c rand.h\\rand.c \u63d0\u4f9b\u4e86 rand() \u63a5\u53e3\u7528\u4ee5\u63d0\u4f9b\u4f2a\u968f\u673a\u6570\u5e8f\u5217\uff0c string.h/string.c \u63d0\u4f9b\u4e86 memset \u63a5\u53e3\u7528\u4ee5\u521d\u59cb\u5316\u4e00\u6bb5\u5185\u5b58\u7a7a\u95f4\u3002 1 2 3 4 5 6 7 8 9 10 11 12 13 . \u251c\u2500\u2500 arch \u2502 \u2514\u2500\u2500 riscv \u2502 \u251c\u2500\u2500 include \u2502 \u2502 \u2514\u2500\u2500 mm.h \u2502 \u2514\u2500\u2500 kernel \u2502 \u2514\u2500\u2500 mm.c \u251c\u2500\u2500 include \u2502 \u251c\u2500\u2500 rand.h \u2502 \u2514\u2500\u2500 string.h \u2514\u2500\u2500 lib \u251c\u2500\u2500 rand.c \u2514\u2500\u2500 string.c \u5728 lab3 \u4e2d\u6211\u4eec\u9700\u8981\u4e00\u4e9b\u7269\u7406\u5185\u5b58\u7ba1\u7406\u7684\u63a5\u53e3\uff0c\u5728\u6b64\u6211\u4eec\u63d0\u4f9b\u4e86 kalloc \u63a5\u53e3 ( \u89c1 mm.c ) \u7ed9\u540c\u5b66\u3002\u540c\u5b66\u53ef\u4ee5\u7528 kalloc \u6765\u7533\u8bf7 4KB \u7684\u7269\u7406\u9875\u3002\u7531\u4e8e\u5f15\u5165\u4e86\u7b80\u5355\u7684\u7269\u7406\u5185\u5b58\u7ba1\u7406\uff0c\u9700\u8981\u5728 _start \u7684\u9002\u5f53\u4f4d\u7f6e\u8c03\u7528 mm_init , \u6765\u521d\u59cb\u5316\u5185\u5b58\u7ba1\u7406\u7cfb\u7edf\uff0c\u5e76\u4e14\u5728\u521d\u59cb\u5316\u65f6\u9700\u8981\u7528\u4e00\u4e9b\u81ea\u5b9a\u4e49\u7684\u5b8f\uff0c\u9700\u8981\u4fee\u6539 defs.h , \u5728 defs.h \u6dfb\u52a0 \u5982\u4e0b\u5185\u5bb9\uff1a 1 2 3 4 5 6 7 #define PHY_START 0x0000000080000000 #define PHY_SIZE 128 * 1024 * 1024 // 128MB\uff0c QEMU \u9ed8\u8ba4\u5185\u5b58\u5927\u5c0f #define PHY_END (PHY_START + PHY_SIZE) #define PGSIZE 0x1000 // 4KB #define PGROUNDUP(addr) ((addr + PGSIZE - 1) & (~(PGSIZE - 1))) #define PGROUNDDOWN(addr) (addr & (~(PGSIZE - 1))) \u8bf7\u5728\u6dfb\u52a0/\u4fee\u6539\u4e0a\u8ff0\u6587\u4ef6\u4ee3\u7801\u4e4b\u540e\uff0c\u786e\u4fdd\u5de5\u7a0b\u53ef\u4ee5\u6b63\u5e38\u8fd0\u884c\uff0c\u4e4b\u540e\u518d\u5f00\u59cb\u5b9e\u73b0 lab3 (\u6709\u53ef\u80fd\u9700\u8981\u540c\u5b66\u81ea\u5df1\u8c03\u6574\u4e00\u4e9b\u5934\u6587\u4ef6\u7684\u5f15\u5165)\u3002 \u5728 lab3 \u4e2d\u9700\u8981\u540c\u5b66\u9700\u8981\u6dfb\u52a0\u5e76\u4fee\u6539 arch/riscv/include/proc.h arch/riscv/kernel/proc.c \u4e24\u4e2a\u6587\u4ef6\u3002 \u672c\u6b21\u5b9e\u9a8c\u9700\u8981\u5b9e\u73b0\u4e24\u79cd\u4e0d\u540c\u7684\u8c03\u5ea6\u7b97\u6cd5\uff0c \u5982\u4f55\u63a7\u5236\u4ee3\u7801\u903b\u8f91\u89c1 4.4","title":"4.1 \u51c6\u5907\u5de5\u7a0b"},{"location":"lab3/#42-proch","text":"1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 // arch/riscv/include/proc.h #include \"types.h\" #define NR_TASKS (1 + 31) // \u7528\u4e8e\u63a7\u5236 \u6700\u5927\u7ebf\u7a0b\u6570\u91cf \uff08idle \u7ebf\u7a0b + 31 \u5185\u6838\u7ebf\u7a0b\uff09 #define TASK_RUNNING 0 // \u4e3a\u4e86\u7b80\u5316\u5b9e\u9a8c\uff0c\u6240\u6709\u7684\u7ebf\u7a0b\u90fd\u53ea\u6709\u4e00\u79cd\u72b6\u6001 #define PRIORITY_MIN 1 #define PRIORITY_MAX 10 /* \u7528\u4e8e\u8bb0\u5f55 `\u7ebf\u7a0b` \u7684 `\u5185\u6838\u6808\u4e0e\u7528\u6237\u6808\u6307\u9488` */ /* (lab3\u4e2d\u65e0\u9700\u8003\u8651\uff0c\u5728\u8fd9\u91cc\u5f15\u5165\u662f\u4e3a\u4e86\u4e4b\u540e\u5b9e\u9a8c\u7684\u4f7f\u7528) */ struct thread_info { uint64 kernel_sp ; uint64 user_sp ; }; /* \u7ebf\u7a0b\u72b6\u6001\u6bb5\u6570\u636e\u7ed3\u6784 */ struct thread_struct { uint64 ra ; uint64 sp ; uint64 s [ 12 ]; }; /* \u7ebf\u7a0b\u6570\u636e\u7ed3\u6784 */ struct task_struct { struct thread_info * thread_info ; uint64 state ; // \u7ebf\u7a0b\u72b6\u6001 uint64 counter ; // \u8fd0\u884c\u5269\u4f59\u65f6\u95f4 uint64 priority ; // \u8fd0\u884c\u4f18\u5148\u7ea7 1\u6700\u4f4e 10\u6700\u9ad8 uint64 pid ; // \u7ebf\u7a0bid struct thread_struct thread ; }; /* \u7ebf\u7a0b\u521d\u59cb\u5316 \u521b\u5efa NR_TASKS \u4e2a\u7ebf\u7a0b */ void task_init (); /* \u5728\u65f6\u949f\u4e2d\u65ad\u5904\u7406\u4e2d\u88ab\u8c03\u7528 \u7528\u4e8e\u5224\u65ad\u662f\u5426\u9700\u8981\u8fdb\u884c\u8c03\u5ea6 */ void do_timer (); /* \u8c03\u5ea6\u7a0b\u5e8f \u9009\u62e9\u51fa\u4e0b\u4e00\u4e2a\u8fd0\u884c\u7684\u7ebf\u7a0b */ void schedule (); /* \u7ebf\u7a0b\u5207\u6362\u5165\u53e3\u51fd\u6570*/ void switch_to ( struct task_struct * next ); /* dummy funciton: \u4e00\u4e2a\u5faa\u73af\u7a0b\u5e8f\uff0c\u5faa\u73af\u8f93\u51fa\u81ea\u5df1\u7684 pid \u4ee5\u53ca\u4e00\u4e2a\u81ea\u589e\u7684\u5c40\u90e8\u53d8\u91cf*/ void dummy ();","title":"4.2 proc.h \u6570\u636e\u7ed3\u6784\u5b9a\u4e49"},{"location":"lab3/#43","text":"","title":"4.3 \u7ebf\u7a0b\u8c03\u5ea6\u529f\u80fd\u5b9e\u73b0"},{"location":"lab3/#431","text":"\u5728\u521d\u59cb\u5316\u7ebf\u7a0b\u7684\u65f6\u5019\uff0c\u6211\u4eec\u53c2\u8003 Linux v0.11\u4e2d\u7684\u5b9e\u73b0 \u4e3a\u6bcf\u4e2a\u7ebf\u7a0b\u5206\u914d\u4e00\u4e2a 4KB \u7684\u7269\u7406\u9875\uff0c\u6211\u4eec\u5c06 task_struct \u5b58\u653e\u5728\u8be5\u9875\u7684\u4f4e\u5730\u5740\u90e8\u5206\uff0c \u5c06\u7ebf\u7a0b\u7684\u6808\u6307\u9488 sp \u6307\u5411\u8be5\u9875\u7684\u9ad8\u5730\u5740\u3002\u5177\u4f53\u5185\u5b58\u5e03\u5c40\u5982\u4e0b\u56fe\u6240\u793a\uff1a 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\u25c4\u2500\u2500\u2500 High Address \u2502 \u2502 \u2502 stack \u2502 \u2502 \u2502 \u2502 \u2502 sp \u2500\u2500\u25ba\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2524 \u2502 \u2502 \u2502 \u2502 \u25bc \u2502 \u2502 \u2502 \u2502 \u2502 \u2502 \u2502 \u2502 \u2502 4KB Page \u2502 \u2502 \u2502 \u2502 \u2502 \u2502 \u2502 \u2502 \u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524 \u2502 \u2502 \u2502 \u2502 \u2502 task_struct \u2502 \u2502 \u2502 \u2502 \u2502 \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\u25c4\u2500\u2500\u2500 Low Address \u5f53\u6211\u4eec\u7684 OS run \u8d77\u6765\u65f6\u5019\uff0c\u5176\u672c\u8eab\u5c31\u662f\u4e00\u4e2a\u7ebf\u7a0b idle \u7ebf\u7a0b \uff0c\u4f46\u662f\u6211\u4eec\u5e76\u6ca1\u6709\u4e3a\u5b83\u8bbe\u8ba1\u597d task_struct \u3002\u6240\u4ee5\u7b2c\u4e00\u6b65\u6211\u4eec\u8981\u4e3a idle \u8bbe\u7f6e task_struct \u3002\u5e76\u5c06 current , task[0] \u90fd\u6307\u5411 idle \u3002 \u4e3a\u4e86\u65b9\u4fbf\u8d77\u89c1\uff0c\u6211\u4eec\u5c06 task[1] ~ task[NR_TASKS - 1] , \u5168\u90e8\u521d\u59cb\u5316\uff0c \u8fd9\u91cc\u548c idle \u8bbe\u7f6e\u7684\u533a\u522b\u5728\u4e8e\u8981\u4e3a\u8fd9\u4e9b\u7ebf\u7a0b\u8bbe\u7f6e thread_struct \u4e2d\u7684 ra \u548c sp . \u5728 _start \u9002\u5f53\u7684\u4f4d\u7f6e\u8c03\u7528 task_init 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 //arch/riscv/kernel/proc.c extern void __dummy (); struct task_struct * idle ; // idle process struct task_struct * current ; // \u6307\u5411\u5f53\u524d\u8fd0\u884c\u7ebf\u7a0b\u7684 `task_struct` struct task_struct * task [ NR_TASKS ]; // \u7ebf\u7a0b\u6570\u7ec4\uff0c\u6240\u6709\u7684\u7ebf\u7a0b\u90fd\u4fdd\u5b58\u5728\u6b64 void task_init () { // 1. \u8c03\u7528 kalloc() \u4e3a idle \u5206\u914d\u4e00\u4e2a\u7269\u7406\u9875 // 2. \u8bbe\u7f6e state \u4e3a TASK_RUNNING; // 3. \u7531\u4e8e idle \u4e0d\u53c2\u4e0e\u8c03\u5ea6 \u53ef\u4ee5\u5c06\u5176 counter / priority \u8bbe\u7f6e\u4e3a 0 // 4. \u8bbe\u7f6e idle \u7684 pid \u4e3a 0 // 5. \u5c06 current \u548c task[0] \u6307\u5411 idle /* YOUR CODE HERE */ // 1. \u53c2\u8003 idle \u7684\u8bbe\u7f6e, \u4e3a task[1] ~ task[NR_TASKS - 1] \u8fdb\u884c\u521d\u59cb\u5316 // 2. \u5176\u4e2d\u6bcf\u4e2a\u7ebf\u7a0b\u7684 state \u4e3a TASK_RUNNING, counter \u4e3a 0, priority \u4f7f\u7528 rand() \u6765\u8bbe\u7f6e, pid \u4e3a\u8be5\u7ebf\u7a0b\u5728\u7ebf\u7a0b\u6570\u7ec4\u4e2d\u7684\u4e0b\u6807\u3002 // 3. \u4e3a task[1] ~ task[NR_TASKS - 1] \u8bbe\u7f6e `thread_struct` \u4e2d\u7684 `ra` \u548c `sp`, // 4. \u5176\u4e2d `ra` \u8bbe\u7f6e\u4e3a __dummy \uff08\u89c1 4.3.2\uff09\u7684\u5730\u5740\uff0c `sp` \u8bbe\u7f6e\u4e3a \u8be5\u7ebf\u7a0b\u7533\u8bf7\u7684\u7269\u7406\u9875\u7684\u9ad8\u5730\u5740 /* YOUR CODE HERE */ printk ( \"...proc_init done! \\n \" ); } Debug \u63d0\u793a\uff1a \u4fee\u6539 proc.h \u4e2d\u7684 NR_TASKS \u4e3a\u4e00\u4e2a\u6bd4\u8f83\u5c0f\u7684\u503c, \u6bd4\u5982 5\uff0c \u8fd9\u6837 \u9664\u53bb task[0] ( idle )\uff0c\u53ea\u9700\u8981\u521d\u59cb\u5316 4 \u4e2a\u7ebf\u7a0b\uff0c\u65b9\u4fbf\u8c03\u8bd5\u3002 \u6ce8\u610f\u4ee5\u4e0a\u7684\u4fee\u6539\u53ea\u662f\u4e3a\u4e86\u5728\u505a\u5b9e\u9a8c\u7684\u8fc7\u7a0b\u4e2d\u65b9\u4fbf\u8c03\u8bd5\uff0c\u6700\u540e\u4e00\u5b9a\u8bb0\u4f4f\u8981\u4fee\u6539\u56de\u53bb\uff01\uff01\uff01","title":"4.3.1 \u7ebf\u7a0b\u521d\u59cb\u5316"},{"location":"lab3/#432-__dummy-dummy","text":"task[1] ~ task[NR_TASKS - 1] \u90fd\u8fd0\u884c\u540c\u4e00\u6bb5\u4ee3\u7801 dummy() \u6211\u4eec\u5728 proc.c \u6dfb\u52a0 dummy() : 1 2 3 4 5 6 7 8 9 10 11 12 13 14 // arch/riscv/kernel/proc.c void dummy () { uint64 MOD = 1000000007 ; uint64 auto_inc_local_var = 0 ; int last_counter = -1 ; while ( 1 ) { if ( last_counter == -1 || current -> counter != last_counter ) { last_counter = current -> counter ; auto_inc_local_var = ( auto_inc_local_var + 1 ) % MOD ; printk ( \"[PID = %d] is running. auto_inc_local_var = %d \\n \" , current -> pid , auto_inc_local_var ); } } } Debug \u63d0\u793a\uff1a \u53ef\u4ee5\u4fee\u6539 printk \u6253\u5370\u66f4\u591a\u7684\u4fe1\u606f \u5f53\u7ebf\u7a0b\u5728\u8fd0\u884c\u65f6\uff0c\u7531\u4e8e\u65f6\u949f\u4e2d\u65ad\u7684\u89e6\u53d1\uff0c\u4f1a\u5c06\u5f53\u524d\u8fd0\u884c\u7ebf\u7a0b\u7684\u4e0a\u4e0b\u6587\u73af\u5883\u4fdd\u5b58\u5728\u6808\u4e0a ( lab2 \u4e2d\u5b9e\u73b0\u7684 _traps )\u3002 \u5f53\u7ebf\u7a0b\u518d\u6b21\u88ab\u8c03\u5ea6\u65f6\uff0c\u4f1a\u5c06\u4e0a\u4e0b\u6587\u4ece\u6808\u4e0a\u6062\u590d\uff0c\u4f46\u662f\u5f53\u6211\u4eec\u521b\u5efa\u4e00\u4e2a\u65b0\u7684\u7ebf\u7a0b\uff0c\u6b64\u65f6\u7ebf\u7a0b\u7684\u6808\u4e3a\u7a7a\uff0c\u5f53\u8fd9\u4e2a\u7ebf\u7a0b\u88ab\u8c03\u5ea6\u65f6\uff0c\u662f\u6ca1\u6709\u4e0a\u4e0b\u6587\u9700\u8981\u88ab\u6062\u590d\u7684\uff0c\u6240\u4ee5\u6211\u4eec\u9700\u8981\u4e3a\u7ebf\u7a0b \u7b2c\u4e00\u6b21\u8c03\u5ea6 \u63d0\u4f9b\u4e00\u4e2a\u7279\u6b8a\u7684\u8fd4\u56de\u51fd\u6570 __dummy \u5728 entry.S \u6dfb\u52a0 __dummy \u5728 __dummy \u4e2d\u5c06 sepc \u8bbe\u7f6e\u4e3a dummy() \u7684\u5730\u5740, \u5e76\u4f7f\u7528 sret \u4ece\u4e2d\u65ad\u4e2d\u8fd4\u56de\u3002 __dummy \u4e0e _traps \u7684 restore \u90e8\u5206\u76f8\u6bd4\uff0c \u5176\u5b9e\u5c31\u662f\u7701\u7565\u4e86\u4ece\u6808\u4e0a\u6062\u590d\u4e0a\u4e0b\u6587\u7684\u8fc7\u7a0b \uff08 \u4f46\u662f\u624b\u52a8\u8bbe\u7f6e\u4e86 sepc \uff09\u3002 1 2 3 4 5 # arch/riscv/kernel/entry.S .global __dummy __dummy: # YOUR CODE HERE","title":"4.3.2 __dummy \u4e0e dummy \u4ecb\u7ecd"},{"location":"lab3/#433","text":"\u5224\u65ad\u4e0b\u4e00\u4e2a\u6267\u884c\u7684\u7ebf\u7a0b next \u4e0e\u5f53\u524d\u7684\u7ebf\u7a0b current \u662f\u5426\u4e3a\u540c\u4e00\u4e2a\u7ebf\u7a0b\uff0c\u5982\u679c\u662f\u540c\u4e00\u4e2a\u7ebf\u7a0b\uff0c\u5219\u65e0\u9700\u505a\u4efb\u4f55\u5904\u7406\uff0c\u5426\u5219\u8c03\u7528 __switch_to \u8fdb\u884c\u7ebf\u7a0b\u5207\u6362\u3002 1 2 3 4 5 6 7 // arch/riscv/kernel/proc.c extern void __switch_to ( struct task_struct * prev , struct task_struct * next ); void switch_to ( struct task_struct * next ) { /* YOUR CODE HERE */ } \u5728 entry.S \u4e2d\u5b9e\u73b0\u7ebf\u7a0b\u4e0a\u4e0b\u6587\u5207\u6362 __switch_to : __switch_to \u63a5\u53d7\u4e24\u4e2a task_struct \u6307\u9488\u4f5c\u4e3a\u53c2\u6570 \u4fdd\u5b58\u5f53\u524d\u7ebf\u7a0b\u7684 ra , sp , s0~s11 \u5230\u5f53\u524d\u7ebf\u7a0b\u7684 thread_struct \u4e2d \u5c06\u4e0b\u4e00\u4e2a\u7ebf\u7a0b\u7684 thread_struct \u4e2d\u7684\u76f8\u5173\u6570\u636e\u8f7d\u5165\u5230 ra , sp , s0~s11 \u4e2d\u3002 1 2 3 4 5 6 7 8 9 10 11 # arch/riscv/kernel/entry.S .globl __switch_to __switch_to: # save state to prev process # YOUR CODE HERE # restore state from next process # YOUR CODE HERE ret Debug \u63d0\u793a\uff1a \u53ef\u4ee5\u5c1d\u8bd5\u662f\u5426\u53ef\u4ee5\u4ece idle \u6b63\u786e\u5207\u6362\u5230 process 1","title":"4.3.3 \u5b9e\u73b0\u7ebf\u7a0b\u5207\u6362"},{"location":"lab3/#434","text":"\u5b9e\u73b0 do_timer() , \u5e76\u5728 \u65f6\u949f\u4e2d\u65ad\u5904\u7406\u51fd\u6570 \u4e2d\u8c03\u7528\u3002 1 2 3 4 5 6 7 8 // arch/riscv/kernel/proc.c void do_timer ( void ) { /* 1. \u5982\u679c\u5f53\u524d\u7ebf\u7a0b\u662f idle \u7ebf\u7a0b \u76f4\u63a5\u8fdb\u884c\u8c03\u5ea6 /* 2. \u5982\u679c\u5f53\u524d\u7ebf\u7a0b\u4e0d\u662f idle \u5bf9\u5f53\u524d\u7ebf\u7a0b\u7684\u8fd0\u884c\u5269\u4f59\u65f6\u95f4\u51cf1 \u82e5\u5269\u4f59\u65f6\u95f4\u4efb\u7136\u5927\u4e8e0 \u5219\u76f4\u63a5\u8fd4\u56de \u5426\u5219\u8fdb\u884c\u8c03\u5ea6*/ /* YOUR CODE HERE */ }","title":"4.3.4 \u5b9e\u73b0\u8c03\u5ea6\u5165\u53e3\u51fd\u6570"},{"location":"lab3/#435","text":"\u672c\u6b21\u5b9e\u9a8c\u6211\u4eec\u9700\u8981\u5b9e\u73b0\u4e24\u79cd\u8c03\u5ea6\u7b97\u6cd5\uff1a1.\u77ed\u4f5c\u4e1a\u4f18\u5148\u8c03\u5ea6\u7b97\u6cd5\uff0c2.\u4f18\u5148\u7ea7\u8c03\u5ea6\u7b97\u6cd5\u3002","title":"4.3.5 \u5b9e\u73b0\u7ebf\u7a0b\u8c03\u5ea6"},{"location":"lab3/#4351","text":"\u5f53\u9700\u8981\u8fdb\u884c\u8c03\u5ea6\u65f6\u6309\u7167\u4e00\u4e0b\u89c4\u5219\u8fdb\u884c\u8c03\u5ea6\uff1a \u904d\u5386\u7ebf\u7a0b\u6307\u9488\u6570\u7ec4 task (\u4e0d\u5305\u62ec idle \uff0c\u5373 task[0] )\uff0c\u5728\u6240\u6709\u8fd0\u884c\u72b6\u6001 ( TASK_RUNNING ) \u4e0b\u7684\u7ebf\u7a0b\u8fd0\u884c\u5269\u4f59\u65f6\u95f4 \u6700\u5c11 \u7684\u7ebf\u7a0b\u4f5c\u4e3a\u4e0b\u4e00\u4e2a\u6267\u884c\u7684\u7ebf\u7a0b\u3002 \u5982\u679c \u6240\u6709 \u8fd0\u884c\u72b6\u6001\u4e0b\u7684\u7ebf\u7a0b\u8fd0\u884c\u5269\u4f59\u65f6\u95f4\u90fd\u4e3a0\uff0c\u5219\u5bf9 task[1] ~ task[NR_TASKS-1] \u7684\u8fd0\u884c\u5269\u4f59\u65f6\u95f4\u91cd\u65b0\u8d4b\u503c (\u4f7f\u7528 rand() ) \uff0c\u4e4b\u540e\u518d\u91cd\u65b0\u8fdb\u884c\u8c03\u5ea6\u3002 1 2 3 4 5 // arch/riscv/kernel/proc.c void schedule ( void ) { /* YOUR CODE HERE */ } Debug \u63d0\u793a\uff1a \u5c06 NR_TASKS \u6539\u4e3a\u8f83\u5c0f\u7684\u503c\uff0c\u8c03\u7528 printk \u5c06\u6240\u6709\u7ebf\u7a0b\u7684\u4fe1\u606f\u6253\u5370\u51fa\u6765\u3002","title":"4.3.5.1 \u77ed\u4f5c\u4e1a\u4f18\u5148\u8c03\u5ea6\u7b97\u6cd5"},{"location":"lab3/#4352","text":"\u53c2\u8003 Linux v0.11 \u8c03\u5ea6\u7b97\u6cd5\u5b9e\u73b0 \u5b9e\u73b0\u3002 1 2 3 4 5 // arch/riscv/kernel/proc.c void schedule ( void ) { /* YOUR CODE HERE */ }","title":"4.3.5.2 \u4f18\u5148\u7ea7\u8c03\u5ea6\u7b97\u6cd5"},{"location":"lab3/#44","text":"\u7531\u4e8e\u52a0\u5165\u4e86\u4e00\u4e9b\u65b0\u7684 .c \u6587\u4ef6\uff0c\u53ef\u80fd\u9700\u8981\u4fee\u6539\u4e00\u4e9bMakefile\u6587\u4ef6\uff0c\u8bf7\u540c\u5b66\u81ea\u5df1\u5c1d\u8bd5\u4fee\u6539\uff0c\u4f7f\u9879\u76ee\u53ef\u4ee5\u7f16\u8bd1\u5e76\u8fd0\u884c\u3002 \u7531\u4e8e\u672c\u6b21\u5b9e\u9a8c\u9700\u8981\u5b8c\u6210\u4e24\u4e2a\u8c03\u5ea6\u7b97\u6cd5\uff0c\u56e0\u6b64\u9700\u8981\u4e24\u79cd\u8c03\u5ea6\u7b97\u6cd5\u53ef\u4ee5\u4f7f\u7528 gcc \u2013D \u9009\u9879\u8fdb\u884c\u63a7\u5236\u3002 DSJF \uff08\u77ed\u4f5c\u4e1a\u4f18\u5148\u8c03\u5ea6\uff09\u3002 DPRIORITY \uff08\u4f18\u5148\u7ea7\u8c03\u5ea6\uff09\u3002 \u5728 proc.c \u4e2d\u4f7f\u7528 #ifdef , #endif \u6765\u63a7\u5236\u4ee3\u7801\u3002 \u4fee\u6539Makefile\u4e2d\u7684 CFLAG = ${CF} ${INCLUDE} -DSJF / -DPRIORITY (\u4f5c\u4e1a\u63d0\u4ea4\u7684\u65f6\u5019 Makefile \u9009\u62e9\u4efb\u610f\u4e00\u4e2a\u90fd\u53ef\u4ee5) \u77ed\u4f5c\u4e1a\u4f18\u5148\u8c03\u5ea6\u8f93\u51fa\u793a\u4f8b (\u4e3a\u4e86\u4fbf\u4e8e\u5c55\u793a\uff0c\u8fd9\u91cc\u4e00\u5171\u53ea\u521d\u59cb\u5316\u4e86 4 \u4e2a\u7ebf\u7a0b) \u540c\u5b66\u4eec\u6700\u540e\u63d0\u4ea4\u65f6\u9700\u8981 \u4fdd\u8bc1 NR_TASKS \u4e3a 32 \u4e0d\u53d8 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 OpenSBI v0.9 ____ _____ ____ _____ / __ \\ / ____ | _ \\_ _ | | | | | _ __ ___ _ __ | ( ___ | | _ ) || | | | | | '_ \\ / _ \\ ' _ \\ \\_ __ \\| _ < | | | | __ | | | _ ) | __/ | | | ____ ) | | _ ) || | _ \\_ ___/ | .__/ \\_ __ | _ | | _ | _____/ | ____/_____ | | | | _ | ... Boot HART MIDELEG : 0x0000000000000222 Boot HART MEDELEG : 0x000000000000b109 ...mm_init done ! ...proc_init done ! Hello RISC-V idle process is running! SET [ PID = 1 COUNTER = 10 ] SET [ PID = 2 COUNTER = 10 ] SET [ PID = 3 COUNTER = 5 ] SET [ PID = 4 COUNTER = 2 ] switch to [ PID = 4 COUNTER = 2 ] [ PID = 4 ] is running. auto_inc_local_var = 1 [ PID = 4 ] is running. auto_inc_local_var = 2 switch to [ PID = 3 COUNTER = 5 ] [ PID = 3 ] is running. auto_inc_local_var = 1 ..... [ PID = 3 ] is running. auto_inc_local_var = 5 switch to [ PID = 2 COUNTER = 10 ] [ PID = 2 ] is running. auto_inc_local_var = 1 ... [ PID = 2 ] is running. auto_inc_local_var = 10 switch to [ PID = 1 COUNTER = 10 ] [ PID = 1 ] is running. auto_inc_local_var = 1 ... [ PID = 1 ] is running. auto_inc_local_var = 10 SET [ PID = 1 COUNTER = 9 ] SET [ PID = 2 COUNTER = 4 ] SET [ PID = 3 COUNTER = 4 ] SET [ PID = 4 COUNTER = 10 ] switch to [ PID = 3 COUNTER = 4 ] [ PID = 3 ] is running. auto_inc_local_var = 6 ... [ PID = 3 ] is running. auto_inc_local_var = 9 \u4f18\u5148\u7ea7\u8c03\u5ea6\u8f93\u51fa\u793a\u4f8b 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 OpenSBI v0.9 ____ _____ ____ _____ / __ \\ / ____ | _ \\_ _ | | | | | _ __ ___ _ __ | ( ___ | | _ ) || | | | | | '_ \\ / _ \\ ' _ \\ \\_ __ \\| _ < | | | | __ | | | _ ) | __/ | | | ____ ) | | _ ) || | _ \\_ ___/ | .__/ \\_ __ | _ | | _ | _____/ | ____/_____ | | | | _ | ... Boot HART MIDELEG : 0x0000000000000222 Boot HART MEDELEG : 0x000000000000b109 ...mm_init done ! ...proc_init done ! Hello RISC-V idle process is running! SET [ PID = 1 PRIORITY = 1 COUNTER = 1 ] SET [ PID = 2 PRIORITY = 4 COUNTER = 4 ] SET [ PID = 3 PRIORITY = 10 COUNTER = 10 ] SET [ PID = 4 PRIORITY = 4 COUNTER = 4 ] switch to [ PID = 3 PRIORITY = 10 COUNTER = 10 ] [ PID = 3 ] is running. auto_inc_local_var = 1 ... [ PID = 3 ] is running. auto_inc_local_var = 10 switch to [ PID = 4 PRIORITY = 4 COUNTER = 4 ] [ PID = 4 ] is running. auto_inc_local_var = 1 ... [ PID = 4 ] is running. auto_inc_local_var = 4 switch to [ PID = 2 PRIORITY = 4 COUNTER = 4 ] [ PID = 2 ] is running. auto_inc_local_var = 1 ... [ PID = 2 ] is running. auto_inc_local_var = 4 switch to [ PID = 1 PRIORITY = 1 COUNTER = 1 ] [ PID = 1 ] is running. auto_inc_local_var = 1 SET [ PID = 1 PRIORITY = 1 COUNTER = 1 ] SET [ PID = 2 PRIORITY = 4 COUNTER = 4 ] SET [ PID = 3 PRIORITY = 10 COUNTER = 10 ] SET [ PID = 4 PRIORITY = 4 COUNTER = 4 ] switch to [ PID = 3 PRIORITY = 10 COUNTER = 10 ] [ PID = 3 ] is running. auto_inc_local_var = 11 ...","title":"4.4 \u7f16\u8bd1\u53ca\u6d4b\u8bd5"},{"location":"lab3/#_1","text":"\u5728 RV64 \u4e2d\u4e00\u5171\u7528 32 \u4e2a\u901a\u7528\u5bc4\u5b58\u5668\uff0c \u4e3a\u4ec0\u4e48 context_switch \u4e2d\u53ea\u4fdd\u5b58\u4e8614\u4e2a \uff1f \u5f53\u7ebf\u7a0b\u7b2c\u4e00\u6b21\u8c03\u7528\u65f6\uff0c \u5176 ra \u6240\u4ee3\u8868\u7684\u8fd4\u56de\u70b9\u662f __dummy \u3002 \u90a3\u4e48\u5728\u4e4b\u540e\u7684\u7ebf\u7a0b\u8c03\u7528\u4e2d context_switch \u4e2d\uff0c ra \u4fdd\u5b58/\u6062\u590d\u7684\u51fd\u6570\u8fd4\u56de\u70b9\u662f\u4ec0\u4e48\u5462 \uff1f \u8bf7\u540c\u5b66\u7528gdb\u5c1d\u8bd5\u8ffd\u8e2a\u4e00\u6b21\u5b8c\u6574\u7684\u7ebf\u7a0b\u5207\u6362\u6d41\u7a0b\uff0c \u5e76\u5173\u6ce8\u6bcf\u4e00\u6b21 ra \u7684\u53d8\u6362\u3002","title":"\u601d\u8003\u9898"},{"location":"lab3/#_2","text":"\u540c\u5b66\u9700\u8981\u63d0\u4ea4\u5b9e\u9a8c\u62a5\u544a\u4ee5\u53ca\u6574\u4e2a\u5de5\u7a0b\u4ee3\u7801\u3002\u5728\u63d0\u4ea4\u524d\u8bf7\u4f7f\u7528 make clean \u6e05\u9664\u6240\u6709\u6784\u5efa\u4ea7\u7269\u3002","title":"\u4f5c\u4e1a\u63d0\u4ea4"},{"location":"lab4/","text":"Lab 4: RV64 \u865a\u62df\u5185\u5b58\u7ba1\u7406 1 \u5b9e\u9a8c\u76ee\u7684 \u5b66\u4e60\u865a\u62df\u5185\u5b58\u7684\u76f8\u5173\u77e5\u8bc6\uff0c\u5b9e\u73b0\u7269\u7406\u5730\u5740\u5230\u865a\u62df\u5730\u5740\u7684\u5207\u6362\u3002 \u4e86\u89e3 RISC-V \u67b6\u6784\u4e2d SV39 \u5206\u9875\u6a21\u5f0f\uff0c\u5b9e\u73b0\u865a\u62df\u5730\u5740\u5230\u7269\u7406\u5730\u5740\u7684\u6620\u5c04\uff0c\u5e76\u5bf9\u4e0d\u540c\u7684\u6bb5\u8fdb\u884c\u76f8\u5e94\u7684\u6743\u9650\u8bbe\u7f6e\u3002 2 \u5b9e\u9a8c\u73af\u5883 Docker in Lab0 3 \u80cc\u666f\u77e5\u8bc6 \u5728 lab3 \u4e2d\u6211\u4eec\u8d4b\u4e88\u4e86 OS \u5bf9\u591a\u4e2a\u7ebf\u7a0b\u8c03\u5ea6\u4ee5\u53ca\u5e76\u53d1\u6267\u884c\u7684\u80fd\u529b\uff0c\u7531\u4e8e\u76ee\u524d\u8fd9\u4e9b\u7ebf\u7a0b\u90fd\u662f\u5185\u6838\u7ebf\u7a0b\uff0c\u56e0\u6b64\u4ed6\u4eec\u53ef\u4ee5\u5171\u4eab\u8fd0\u884c\u7a7a\u95f4\uff0c\u5373\u8fd0\u884c\u4e0d\u540c\u7ebf\u7a0b\u5bf9\u7a7a\u95f4\u7684\u4fee\u6539\u662f\u76f8\u4e92\u53ef\u89c1\u7684\u3002\u4f46\u662f\u5982\u679c\u6211\u4eec\u9700\u8981\u7ebf\u7a0b\u76f8\u4e92 \u9694\u79bb \uff0c\u4ee5\u53ca\u5728\u591a\u7ebf\u7a0b\u7684\u60c5\u51b5\u4e0b\u66f4\u52a0 \u9ad8\u6548 \u7684\u4f7f\u7528\u5185\u5b58\uff0c\u6211\u4eec\u5fc5\u987b\u5f15\u5165 \u865a\u62df\u5185\u5b58 \u8fd9\u4e2a\u6982\u5ff5\u3002 \u865a\u62df\u5185\u5b58\u53ef\u4ee5\u4e3a\u8fdb\u7a0b\u63d0\u4f9b\u72ec\u7acb\u7684\u5185\u5b58\u7a7a\u95f4\uff0c\u5236\u9020\u4e00\u79cd\u6bcf\u4e2a\u8fdb\u7a0b\u7684\u5185\u5b58\u90fd\u662f\u72ec\u7acb\u7684\u5047\u8c61\u3002\u865a\u62df\u5185\u5b58\u5230\u7269\u7406\u5185\u5b58\u7684\u6620\u5c04\u4e5f\u5305\u542b\u4e86\u5185\u5b58\u8bbf\u95ee\u6743\u9650\u7684\u4fe1\u606f\uff0c\u65b9\u4fbf kernel \u5b8c\u6210\u6743\u9650\u68c0\u67e5\u3002 \u5728\u672c\u6b21\u5b9e\u9a8c\u4e2d\uff0c\u6211\u4eec\u9700\u8981\u5173\u6ce8 OS \u5982\u4f55 \u5f00\u542f\u865a\u62df\u5185\u5b58 \uff0c\u5982\u4f55\u901a\u8fc7\u8bbe\u7f6e\u9875\u8868\u6765\u5b9e\u73b0 \u5730\u5740\u6620\u5c04 \u548c \u6743\u9650\u63a7\u5236 \u3002 3.1 Linux Kernel \u7684\u865a\u62df\u5185\u5b58\u5e03\u5c40 1 2 3 4 5 6 7 8 9 10 11 12 13 start_address end_address 0x0 0x3fffffffff \u2502 \u2502 \u250c\u2500\u2500\u2500\u2500\u2518 \u250c\u2500\u2500\u2500\u2500\u2518 \u2193 256G \u2193 \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510 \u2502 User Space \u2502 ... \u2502 Kernel Space \u2502 \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518 \u2191 256G \u2191 \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518 \u2502 \u2502 \u2502 0xffffffc000000000 0xffffffffffffffff start_address end_address \u4e0a\u56fe\u662f Linux 5.15 \u4e2d RV64 \u67b6\u6784\u7684\u5185\u5b58\u5e03\u5c40\u3002\u5b83\u662f\u57fa\u4e8e RISC-V \u6807\u51c6\u4e2d\u5b9a\u4e49\u7684 Sv39 \u5730\u5740\u8f6c\u6362\u6a21\u5f0f\u7684\uff08\u89c1\u4e0b\u6587\uff09\u3002\u6211\u4eec\u770b\u5230 0x0000004000000000 \u4ee5\u4e0b\u7684\u865a\u62df\u5730\u5740\u7a7a\u95f4\u5206\u914d\u7ed9 user space\uff0c 0xffffffc000000000 \u53ca\u4ee5\u4e0a\u7684\u865a\u62df\u5730\u5740\u7a7a\u95f4\u5206\u914d\u7ed9 kernel space \u3002\u7531\u4e8e\u6211\u4eec\u8fd8\u672a\u5f15\u5165\u7528\u6237\u6001\u7a0b\u5e8f\uff0c\u76ee\u524d\u6211\u4eec\u53ea\u9700\u8981\u5173\u6ce8 kernel space \u3002\u539f\u59cb\u8bf4\u660e\u6587\u4ef6\u5728 \u6b64\u5904 \u3002 Kernel \u4e3a\u4e86\u9ad8\u6548\u65b9\u4fbf\u5730\u8bbf\u95ee RAM\uff0c\u4f1a\u628a\u6240\u6709\u7269\u7406\u5185\u5b58\u90fd\u6620\u5c04\u5230\u865a\u62df\u5185\u5b58\u91cc kernel space \u4e2d\u7684\u4e00\u5757\u533a\u57df\u3002\u8fd9\u5757\u533a\u57df\u79f0\u4e3a direct mapping area \u3002\u7531\u4e8e\u6b64\u5904\u865a\u62df\u5185\u5b58\u548c\u7269\u7406\u5185\u5b58\u7684\u6620\u5c04\u5173\u7cfb\u662f VA == PA + OFFSET \uff0c \u6240\u4ee5\u8fd9\u79cd\u6620\u5c04\u4e5f\u88ab\u79f0\u4e3a linear mapping \uff08\u6ce8\u610f\uff0c\u8fd9\u4e0e\u7ebf\u6027\u4ee3\u6570\u4e2d\u7684 linear mapping \u662f\u4e0d\u540c\u7684\u2014\u2014\u90a3\u91cc\u7684 linear mapping \u4e00\u5b9a\u628a 0 \u6620\u5c04\u5230 0\uff0c\u800c\u6b64\u5904\u4e0d\u662f\u3002\u5728\u6570\u5b66\u4e0a\u6b64\u5904\u7684\u6620\u5c04\u5e94\u79f0\u4e3a translation transformation\uff0c\u5373\u5e73\u79fb\u53d8\u6362\uff09\u3002\u5728 RISC-V \u67b6\u6784\u7684 Linux Kernel \u4e2d direct mapping area \u4e3a 0xffffffe000000000 ~ 0xffffffff00000000 , \u5171 124 GB \u3002 \u672c\u6b21\u5b9e\u9a8c\u7684\u4efb\u52a1\u5c31\u662f\u5f00\u542f\u865a\u62df\u5185\u5b58\uff0c\u5b9e\u73b0 direct mapping\uff0c\u5e76\u8ba9 lab3 \u4e2d\u7684\u591a\u8fdb\u7a0b\u7a0b\u5e8f\u5728 direct mapping area \u4e2d\u6267\u884c\u3002 \u4e3a\u6b64\uff0c\u6211\u4eec\u9700\u8981\u4e86\u89e3 RISC-V \u67b6\u6784\u4e2d\u865a\u62df\u5185\u5b58\u7684\u5de5\u4f5c\u65b9\u5f0f\u3002 3.2 RISC-V Virtual-Memory System \u865a\u62df\u5185\u5b58\u7684\u672c\u8d28\u662f\u5730\u5740\u8f6c\u6362\u4e0e\u4fdd\u62a4\uff0c\u800c\u8fd9\u662f\u901a\u8fc7\u9875\u8868\u6765\u5b9e\u73b0\u7684\u3002\u5206\u56db\u6b65\u6765\u7406\u89e3\u5730\u5740\u8f6c\u6362\u4e0e\u4fdd\u62a4\uff1a S \u6001\u4e0b\u5982\u4f55\u5f00\u542f\u8f6c\u6362\uff0c\u9875\u8868\u57fa\u5730\u5740\u5b58\u653e\u5728\u54ea\u91cc\uff1a satp register \u6211\u4eec\u4f7f\u7528\u7684\u8f6c\u6362\u6a21\u5f0f\u4e0b\uff0c\u865a\u62df\u5730\u5740\u548c\u7269\u7406\u5730\u5740\u5982\u4f55\u5212\u5206 \u9875\u8868\u9879\uff08Page Table Entry, PTE\uff09\u7684\u683c\u5f0f\u662f\u4ec0\u4e48 \u5f53\u4e00\u5207\u90fd\u8bbe\u7f6e\u597d\u540e\uff0c\u5730\u5740\u8f6c\u6362\u4e0e\u4fdd\u62a4\u662f\u5982\u4f55\u8fdb\u884c\u7684 \u4e0b\u9762\u5206\u522b\u4ecb\u7ecd\u8fd9\u56db\u70b9\u3002 3.2.1 The satp Register\uff08Supervisor Address Translation and Protection Register\uff09 satp \u662f S \u6a21\u5f0f\u4e0b\u63a7\u5236\u5730\u5740\u8f6c\u6362\u4e0e\u4fdd\u62a4\u7684 CSR \u5bc4\u5b58\u5668\uff0c\u5b83\u7684\u683c\u5f0f\u5982\u4e0b\u56fe\uff1a 1 2 3 4 63 60 59 44 43 0 --------------------------------------------------------------------- | MODE | ASID | PPN | --------------------------------------------------------------------- MODE \u5b57\u6bb5\u63a7\u5236\u5730\u5740\u8f6c\u6362\u6a21\u5f0f\uff0c\u9ed8\u8ba4\u4e3a 0\uff0c\u8868\u793a\u4e0d\u505a\u8f6c\u6362\u3002\u5b83\u7684\u6240\u6709\u53d6\u503c\u5982\u4e0b\u56fe\u3002\u5f53 satp.MODE \u88ab\u8bbe\u4e3a 8 \u65f6\uff0c\u6211\u4eec\u5c31\u5f00\u542f\u4e86 Sv39 \u6a21\u5f0f\u7684\u5730\u5740\u8f6c\u6362\u3002 1 2 3 4 5 6 7 8 9 10 11 12 13 RV 64 ---------------------------------------------------------- | Value | Name | Description | |----------------------------------------------------------| | 0 | Bare | No translation or protection | | 1 - 7 | --- | Reserved for standard use | | 8 | Sv39 | Page - based 39 bit virtual addressing | <-- \u6211\u4eec\u4f7f\u7528\u7684mode | 9 | Sv48 | Page - based 48 bit virtual addressing | | 10 | Sv57 | Page - based 57 bit virtual addressing | | 11 | Sv64 | Page - based 64 bit virtual addressing | | 12 - 13 | --- | Reserved for standard use | | 14 - 15 | --- | Reserved for standard use | ----------------------------------------------------------- ASID ( Address Space Identifier ) \uff1a \u6b64\u6b21\u5b9e\u9a8c\u4e2d\u76f4\u63a5\u7f6e 0 \u5373\u53ef\u3002 PPN ( Physical Page Number ) \uff1a\u9876\u7ea7\u9875\u8868\u7684 \u7269\u7406 \u9875\u53f7\u3002\u5728 Sv39 \u4e2d\u7269\u7406\u9875\u7684\u5927\u5c0f\u4e3a 4KiB\uff0c\u6240\u4ee5 PPN == PA >> 12 \u3002 \u5177\u4f53\u4ecb\u7ecd\u8bf7\u9605\u8bfb RISC-V Privileged Spec 4.1.10 \u3002 3.2.2 RISC-V Sv39 Virtual Address and Physical Address 1 2 3 4 5 38 30 29 21 20 12 11 0 --------------------------------------------------------------------- | VPN [ 2 ] | VPN [ 1 ] | VPN [ 0 ] | page offset | --------------------------------------------------------------------- Sv39 virtual address 1 2 3 4 5 55 30 29 21 20 12 11 0 ----------------------------------------------------------------------------- | PPN [ 2 ] | PPN [ 1 ] | PPN [ 0 ] | page offset | ----------------------------------------------------------------------------- Sv39 physical address Sv39 \u6a21\u5f0f\u5b9a\u4e49\u7684\u7269\u7406\u5730\u5740\u6709 56 \u4f4d\uff0c\u865a\u62df\u5730\u5740\u6709 64 \u4f4d\u3002\u4f46\u662f\uff0c\u865a\u62df\u5730\u5740\u7684 64 \u4f4d\u53ea\u6709\u4f4e 39 \u4f4d\u6709\u6548\u2014\u2014\u5728\u4f7f\u7528 64 \u4f4d\u865a\u62df\u5730\u5740\u65f6\uff0c\u5fc5\u987b\u4fdd\u8bc1\u5176 63 ~ 39 \u53f7\u4f4d\u4e0e 38 \u53f7\u4f4d\u76f8\u7b49\uff0c\u5426\u5219\u5c31\u4f1a\u89e6\u53d1 Page Fault Exception\u3002\u5f53\u865a\u62df\u5730\u5740\u7684 63 ~ 38 \u53f7\u4f4d\u90fd\u4e3a 0 \u65f6\uff0c\u8be5\u5730\u5740\u5904\u4e8e user space \u4e2d\uff1b\u90fd\u4e3a 1 \u65f6\u5904\u4e8e kernel space \u4e2d\u3002 Sv39 \u652f\u6301\u4e09\u7ea7\u9875\u8868\u7ed3\u6784\u3002 VPN (Virtual Page Number) \u662f\u865a\u62df\u5730\u5740\u6240\u5728\u9875\u7684\u9875\u53f7\uff0c\u5728\u5730\u5740\u8f6c\u6362\u4e2d\u662f\u67e5\u8be2\u9875\u8868\u6240\u7528\u7684\u4e0b\u6807\u3002VPN[2] ~ VPN[0] \u5206\u522b\u7528\u4e8e\u67e5\u8be2\u9876\u7ea7\u9875\u8868\u3001\u4e8c\u7ea7\u9875\u8868\u3001\u4e09\u7ea7\u9875\u8868\u3002 PPN (Physical Page Number) \u662f\u7269\u7406\u5730\u5740\u6240\u5728\u9875\u7684\u9875\u53f7\u3002 Page Offset \u662f\u9875\u5185\u504f\u79fb\u3002 \u5fc5\u987b\u6307\u51fa\uff0c \u5e76\u4e0d\u662f\u4e09\u7ea7\u9875\u8868\u90fd\u4e00\u5b9a\u8981\u7528\u7684\uff1a\u6211\u4eec\u53ef\u4ee5\u53ea\u7528\u7b2c\u4e00\u7ea7\uff0c\u6216\u53ea\u7528\u524d\u4e24\u7ea7 \u3002 \u53ea\u7528\u7b2c\u4e00\u7ea7\u9875\u8868\u3002\u6b64\u65f6\uff0c\u5047\u8bbe\u6211\u4eec\u62ff VA \u4e2d\u7684 VPN[2] \u67e5\u8be2\u9876\u7ea7\u9875\u8868\u5f97\u5230\u7684 PTE \u4e2d\u7269\u7406\u9875\u53f7\u90e8\u5206\u4e3a {PPN[2], PPN[1], PPN[0]} \uff0c\u90a3\u4e48\u5730\u5740\u8f6c\u6362\u5f97\u5230\u7684\u7269\u7406\u5730\u5740\u5c31\u662f {PPN[2], VPN[1], VPN[0], VA.offset} \u3002\u6b64\u65f6\u865a\u62df\u5185\u5b58\u7684\u4e00\u9875\u5927\u5c0f\u4e3a 1 GiB\uff0c\u56e0\u4e3a {VPN[1], VPN[0], VA.offset} \u8fde\u8d77\u6765\u88ab\u770b\u4f5c\u9875\u5185\u504f\u79fb\uff0c\u4e00\u5171\u6709 30 \u4f4d\u3002 \u53ea\u7528\u524d\u4e24\u7ea7\u9875\u8868\u3002\u6b64\u65f6\u865a\u62df\u5185\u5b58\u7684\u4e00\u9875\u5927\u5c0f\u5c31\u662f 2 MiB \u3002 \u5f53\u7136\uff0c\u6211\u4eec\u53ef\u4ee5\u7528\u4e09\u7ea7\u9875\u8868\uff0c\u6b64\u65f6\u865a\u62df\u5185\u5b58\u7684\u4e00\u9875\u5927\u5c0f\u5c31\u662f 4 KiB\u3002 \u5177\u4f53\u4ecb\u7ecd\u8bf7\u9605\u8bfb RISC-V Privileged Spec 4.4.1 \u3002 3.2.3 RISC-V Sv39 Page Table Entry 1 2 3 4 5 6 7 8 9 10 11 12 13 14 63 54 53 28 27 19 18 10 9 8 7 6 5 4 3 2 1 0 ----------------------------------------------------------------------- | Reserved | PPN [ 2 ] | PPN [ 1 ] | PPN [ 0 ] | RSW | D | A | G | U | X | W | R | V | ----------------------------------------------------------------------- | | | | | | | | | | | | | | | | | ` ---- V - Valid | | | | | | | ` ------ R - Readable | | | | | | ` -------- W - Writable | | | | | ` ---------- X - Executable | | | | ` ------------ U - User | | | ` -------------- G - Global | | ` ---------------- A - Accessed | ` ------------------ D - Dirty ( 0 in page directory ) ` ---------------------- Reserved for supervisor software 0 \uff5e 9 bit: protection bits V : \u6709\u6548\u4f4d\u3002\u8bbf\u95ee\u5230 V = 0 \u7684 PTE \u65f6\u4f1a\u4ea7\u751f Page Fault\u3002 R : R = 1 \u8be5\u9875\u53ef\u8bfb\u3002 W : W = 1 \u8be5\u9875\u53ef\u5199\u3002 X : X = 1 \u8be5\u9875\u53ef\u6267\u884c\u3002 U , G , A , D , RSW \u672c\u6b21\u5b9e\u9a8c\u4e2d\u8bbe\u7f6e\u4e3a 0 \u5373\u53ef\u3002 \u5177\u4f53\u4ecb\u7ecd\u8bf7\u9605\u8bfb RISC-V Privileged Spec 4.4.1 \u3002 3.2.4 RISC-V Address Translation \u865a\u62df\u5730\u5740\u8f6c\u5316\u4e3a\u7269\u7406\u5730\u5740\u6d41\u7a0b\u56fe\u5982\u4e0b\uff0c\u5177\u4f53\u63cf\u8ff0\u89c1 RISC-V Privileged Spec 4.3.2 : 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 Virtual Address Physical Address 9 9 9 12 55 12 11 0 \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510 \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510 \u2502 \u2502 VPN[2] \u2502 VPN[1] \u2502 VPN[0] \u2502 OFFSET \u2502 \u2502 PPN \u2502 OFFSET \u2502 \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518 \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518 \u2502 \u2502 \u2502 \u2502 \u25b2 \u25b2 \u2502 \u2502 \u2502 \u2502 \u2502 \u2502 \u2502 \u2502 \u2502 \u2502 \u2502 \u2502 \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518 \u2502 \u2502 \u2502 \u2502 \u2502 \u2502 \u2502 \u2502 \u2502 \u2502 \u2502 \u2502 \u2502 \u2502 \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518 \u2502 \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510 \u2502 \u2502 \u2502 \u2502511 \u2502 \u2502 \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518 \u2502 \u2502 \u2502 \u2502 \u2502 \u2502 \u2502 \u2502 \u2502 \u2502 \u2502 \u2502 \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510 \u2502 \u2502 \u2502 \u2502 \u2502 \u2502 511 \u2502 \u2502 \u2502 \u2502 \u2502 \u2502 \u2502 \u2502 \u2502 \u2502 \u2502 \u2502 \u2502 \u2502 \u2502 \u2502 \u2502 \u2502 \u2502 \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510 \u2502 \u2502 \u2502 44 10 \u2502 \u2502 \u2502 \u2502 \u2502 511 \u2502 \u2502 \u2502 \u2502 \u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524 \u2502 \u2502 \u2502 \u2502 \u2502 \u2502 \u2502 \u2514\u2500\u2500\u2500\u25ba\u2502 PPN \u2502 flags \u2502 \u2502 \u2502 \u2502 \u2502 \u2502 \u2502 \u2502 \u251c\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524 \u2502 \u2502 44 10 \u2502 \u2502 \u2502 \u2502 \u2502 \u2502 \u2502 \u2502 \u2502 \u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524 \u2502 \u2502 \u2502 \u2502 \u2502 \u2502 \u2502 \u2514\u2500\u2500\u2500\u2500\u25ba\u2502 PPN \u2502 flags \u2502 \u2502 \u2502 \u2502 \u2502 \u2502 \u2502 \u2502 \u251c\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524 \u2502 \u2502 44 10 \u2502 \u2502 \u2502 \u2502 \u2502 \u2502 \u2502 \u2502 \u2502 \u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524 \u2502 1 \u2502 \u2502 \u2502 \u2502 \u2502 \u2502 \u2514\u2500\u2500\u2500\u2500\u25ba\u2502 PPN \u2502 flags \u2502 \u2502 \u2502 \u2502 \u2502 \u2502 \u2502 \u2502 \u251c\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524 \u2502 0 \u2502 \u2502 \u2502 \u2502 \u2502 \u2502 \u2502 \u2502 \u2502 \u2502 \u2514\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518 1 \u2502 \u2502 \u2502 \u2502 \u2502 \u2502 \u2502 \u25b2 \u2502 \u2502 \u2502 \u2502 \u2502 \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518 \u2502 \u2502 0 \u2502 \u2502 \u2502 \u2502 \u2502 \u2502 \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u25ba\u2514\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518 1 \u2502 \u2502 \u2502 \u2502 \u2502 \u2502 \u250c\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2510 \u2502 0 \u2502 \u2502 \u2502 satp \u2502 \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u25ba\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518 \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518 4 \u5b9e\u9a8c\u6307\u5bfc 4.0 \u4efb\u52a1\u4e0e\u9014\u5f84 \u672c\u6b21\u5b9e\u9a8c\u7684\u4efb\u52a1\u662f\u5f00\u542f\u865a\u62df\u5185\u5b58\uff0c\u5b9e\u73b0 direct mapping\uff0c\u5e76\u8ba9 lab3 \u4e2d\u7684\u591a\u8fdb\u7a0b\u7a0b\u5e8f\u5728 direct mapping area \u4e2d\u6267\u884c\u3002 \u4e0b\u9762\u63cf\u8ff0\u5177\u4f53\u5b9e\u73b0\u65b9\u5f0f\u3002\u4e3a\u4e86\u63cf\u8ff0\u6e05\u6670\uff0c\u6211\u4eec\u5148\u5b9a\u4e49\u4e00\u4e9b\u8bb0\u53f7\uff1a \\(p_s\\) \uff1a\u7269\u7406\u5730\u5740\u7684\u8d77\u59cb\u5730\u5740\u503c\uff0c\u672c\u5b9e\u9a8c\u4e2d\u4e3a 0x80000000 \u3002 \\(p_e\\) \uff1a\u7269\u7406\u5730\u5740\u7684\u7ec8\u6b62\u5730\u5740\u503c\uff0c\u672c\u5b9e\u9a8c\u4e2d\u4e3a 0x8020000 \u3002 \\(l\\) \uff1a\u7269\u7406\u5730\u5740\u6bb5\u7684\u957f\u5ea6\uff0c\u672c\u5b9e\u9a8c\u4e2d\u4e3a 0x8000000 \uff0c\u5373 128MiB\u3002 \\(b\\) \uff1a\u4e3a OpenSBI \u9884\u7559\u7684\u5730\u5740\u957f\u5ea6\uff0c\u672c\u5b9e\u9a8c\u4e2d\u4e3a 0x200000 \uff0c\u5373 2 MiB\u3002 \\(v_s\\) \uff1a\u865a\u62df\u5730\u5740\u7684\u8d77\u59cb\u5730\u5740\u503c\uff0c\u672c\u5b9e\u9a8c\u4e2d\u4e3a 0xffffffe000000000 \\(v_e\\) \uff1a\u865a\u62df\u5730\u5740\u7684\u7ec8\u6b62\u5730\u5740\u503c\uff0c\u672c\u5b9e\u9a8c\u4e2d\u4e3a 0xffffffe000200000 \\(t=v_s-p_s\\) \uff0c\u865a\u62df\u5730\u5740\u76f8\u5bf9\u4e8e\u7269\u7406\u5730\u5740\u7684\u504f\u79fb\u91cf (offset) \\([a, b)\\to [c, d)\\) \uff1a\u5185\u5b58\u6620\u5c04\uff0c\u628a \u865a\u62df\u5730\u5740\u7a7a\u95f4 \u7684 \\([a, b)\\) \u6620\u5c04\u5230 \u7269\u7406\u5730\u5740\u7a7a\u95f4 \u7684 \\([c, d)\\) \u3002\u5f53\u7136\uff0c\u8981\u6c42\u4e24\u6bb5\u957f\u5ea6\u76f8\u540c\u3002 \u5b8c\u7f8e\u5f00\u542f\u865a\u62df\u5185\u5b58\u5206\u4e3a\u4e24\u6b65\uff1a \u7b2c\u4e00\u56de\u6620\u5c04\uff0c\u5206\u4e24\u5757 \uff1a \\([p_s, p_s+d)\\to [p_s, p_s+d)\\) \uff0c\u79f0\u4e3a\u7b49\u503c\u6620\u5c04 \\([v_s, v_s+d)\\to [p_s, p_s+d)\\) \uff0c\u79f0\u4e3a\u504f\u79fb\u6620\u5c04\uff08\u5373\u4e0a\u6587\u4e2d\u7684 linear mapping\uff09 \u5176\u4e2d \\(d\\) = 1 GiB\u3002 \u6211\u4eec\u7684\u7269\u7406\u5730\u5740\u6bb5\u53ea\u6709 \\(l\\) = 128 MiB \u8fd9\u4e48\u5927\uff0c\u4e3a\u4ec0\u4e48\u8981\u505a 1 GiB \u7684\u6620\u5c04\u5462\uff1f\u8fd9\u4ec5\u4ec5\u662f\u4e3a\u4e86\u65b9\u4fbf\u3002\u53ef\u4ee5\u60f3\u8c61\uff0c\u5982\u679c\u4f7f\u7528\u4e24\u7ea7\u6216\u4e09\u7ea7\u9875\u8868\uff0c\u5c31\u4f1a\u6d89\u53ca\u591a\u4e2a\u7269\u7406\u9875\u7684\u7ba1\u7406\uff0c\u6bd4\u8f83\u9ebb\u70e6\uff1b\u82e5\u53ea\u7528\u7b2c\u4e00\u7ea7\u9875\u8868\uff0c\u6211\u4eec\u5c31\u53ea\u9700\u8981\u4e00\u4e2a\u7269\u7406\u9875\u6765\u5b58\u653e\u5b83\uff0c\u975e\u5e38\u65b9\u4fbf\u3002\u56e0\u6b64\u5728\u7b2c\u4e00\u56de\u6620\u5c04\u65f6\u6211\u4eec\u5c31\u53ea\u7528\u7b2c\u4e00\u7ea7\u9875\u8868\uff0c\u4ece\u800c\u865a\u62df\u5185\u5b58\u4e00\u9875\u7684\u5927\u5c0f\u5c31\u662f 1 GiB\uff08\u89c1\u4e0a\u6587\uff09\u3002\u53ea\u8981\u6211\u4eec\u5b9e\u9645\u8bbf\u95ee\u7684\u5730\u5740\u90fd\u5728 128 MiB \u7684\u8303\u56f4\u5185\uff0c\u8fd9\u6837\u5c31\u662f\u65e0\u5bb3\u7684\u3002 \u7b2c\u4e8c\u56de\u6620\u5c04 \uff1a \\([v_s+b, v_e)\\to [p_s+b, p_e)\\) \u4e3a\u4ec0\u4e48\u5de6\u7aef\u70b9\u8981\u52a0 \\(b\\) \u5462\uff1f\u56e0\u4e3a \\([v_s, v_s+b)\\) \u8fd9\u4e00\u6bb5\u865a\u62df\u5730\u5740\u6839\u672c\u5c31\u7528\u4e0d\u7740\u2014\u2014\u82e5\u8981\u8bbf\u95ee\u8fd9\u4e00\u6bb5\uff0c\u8bbf\u95ee\u5230\u7684\u662f OpenSBI\uff0c\u4f46\u6211\u4eec\u5728 S \u6001\u4e0b\u4e0d\u4f1a\uff08\u4e5f\u4e0d\u5e94\u8be5\uff09\u8bbf\u95ee\u5b83\u3002\u9700\u8981\u8bbf\u95ee\u5b83\u7684\u662f M \u6001\uff0c\u800c M \u6001\u6839\u672c\u4e0d\u53d7 satp \uff08S \u6a21\u5f0f\u7684\u5730\u5740\u8f6c\u6362\uff09\u5f71\u54cd\u2014\u2014\u5728 M \u6001\u91cc\u7a0b\u5e8f\u76f4\u63a5\u7528\u7269\u7406\u5730\u5740 \\([p_s, p_s+b)\\) \u8bbf\u95ee OpenSBI\u3002 \u7b2c\u4e8c\u56de\u6620\u5c04\u7528\u4e09\u7ea7\u9875\u8868\u6765\u5b9e\u73b0\u3002 \u7b2c\u4e8c\u56de\u6620\u5c04\u4f1a\u8986\u76d6\u7b2c\u4e00\u56de\u6620\u5c04\u3002\u5373\uff0c\u5f53\u6211\u4eec\u628a satp \u6307\u5411\u627f\u8f7d\u7b2c\u4e8c\u56de\u6620\u5c04\u7684\u9875\u8868\u65f6\uff0c\u7b2c\u4e00\u56de\u6620\u5c04\u5c31\u81ea\u52a8\u5931\u6548\u4e86\u3002\u6700\u540e\u6211\u4eec\u5c31\u5f97\u5230\u4e86\u4e0d\u591a\u4e0d\u5c11\u521a\u521a\u597d\u7684\u865a\u62df\u5730\u5740\u5230\u7269\u7406\u5730\u5740\u7684\u6620\u5c04\u3002 \u8fd9\u91cc\u7559\u4e0b\u51e0\u4e2a\u95ee\u9898\uff08\u4e5f\u5728\u601d\u8003\u9898\u4e2d\uff09\uff0c\u8bf7\u540c\u5b66\u601d\u8003\uff1a \u4e3a\u4ec0\u4e48\u7b2c\u4e00\u56de\u6620\u5c04\u91cc\u8981\u505a\u7b49\u503c\u6620\u5c04\uff1f \u4e3a\u4ec0\u4e48\u8981\u5206\u8fd9\u6837\u4e24\u6b65\u5462\uff1f\u80fd\u5426\u4e00\u6b65\u505a\u5b8c\uff1f \u4e0b\u9762\u662f\u5177\u4f53\u7f16\u7a0b\u7684\u6307\u5f15\u3002 4.1 \u51c6\u5907\u5de5\u4f5c \u6b64\u6b21\u5b9e\u9a8c\u57fa\u4e8e lab3 \u540c\u5b66\u6240\u5b9e\u73b0\u7684\u4ee3\u7801\u8fdb\u884c\u3002 \u9700\u8981\u4fee\u6539 defs.h \uff0c\u5199\u5165\u4e0a\u9762\u5b9a\u4e49\u7684\u5e38\u91cf\u3002\u5728 defs.h \u4e2d\u52a0\u5165\u5982\u4e0b\u5185\u5bb9\uff1a 1 2 3 4 5 6 7 #define OPENSBI_SIZE (0x200000) #define VM_START (0xffffffe000000000) #define VM_END (0xffffffff00000000) #define VM_SIZE (VM_END - VM_START) #define PA2VA_OFFSET (VM_START - PHY_START) \u4ece repo \u540c\u6b65\u4ee5\u4e0b\u4ee3\u7801: vmlinux.lds.S , Makefile \u3002\u5e76\u6309\u7167\u4ee5\u4e0b\u6b65\u9aa4\u5c06\u8fd9\u4e9b\u6587\u4ef6\u6b63\u786e\u653e\u7f6e\u3002 1 2 3 4 5 6 . \u2514\u2500\u2500 arch \u2514\u2500\u2500 riscv \u2514\u2500\u2500 kernel \u251c\u2500\u2500 Makefile \u2514\u2500\u2500 vmlinux.lds.S \u8fd9\u91cc\u6211\u4eec\u901a\u8fc7 vmlinux.lds.S \u6a21\u7248\u751f\u6210 vmlinux.lds \u6587\u4ef6\u3002\u94fe\u63a5\u811a\u672c\u4e2d\u7684 ramv \u4ee3\u8868 VMA (Virtual Memory Address)\uff0c\u5373\u865a\u62df\u5730\u5740\uff1b ram \u5219\u4ee3\u8868 LMA (Load Memory Address)\uff0c\u5373\u6211\u4eec OS image \u88ab load \u7684\u5730\u5740\uff0c\u53ef\u4ee5\u7406\u89e3\u4e3a\u7269\u7406\u5730\u5740\u3002\u4f7f\u7528\u4ee5\u4e0a\u7684 vmlinux.lds \u8fdb\u884c\u7f16\u8bd1\u4e4b\u540e\uff0c\u5f97\u5230\u7684 System.map \u4ee5\u53ca vmlinux \u91c7\u7528\u7684\u90fd\u662f\u865a\u62df\u5730\u5740\uff0c\u65b9\u4fbf\u4e4b\u540e debug\u3002 4.2 \u7b2c\u4e00\u56de\u6620\u5c04 \u4e0b\u56fe\u63cf\u7ed8\u4e86\u7b2c\u4e00\u56de\u6620\u5c04\u7684\u72b6\u51b5\uff1a 1 2 3 4 5 6 7 8 9 10 11 12 13 14 Physical Address ------------------------------------------- | OpenSBI | Kernel | ------------------------------------------- ^ 0x80000000 \u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510 | | Virtual Address | | ----------------------------------------------------------------------------------------------- | OpenSBI | Kernel | | OpenSBI | Kernel | ----------------------------------------------------------------------------------------------- ^ ^ 0x80000000 0xffffffe000000000 \u6211\u4eec\u7528\u4e24\u4e2a\u51fd\u6570\u5b9e\u73b0\u7b2c\u4e00\u56de\u6620\u5c04\uff1a arch/riscv/kernel/vm.c : setup_vm \uff1a\u914d\u7f6e\u597d\u9875\u8868\uff1b arch/riscv/kernel/head.S : relocate \uff1a\u914d\u7f6e satp \uff0c\u5e76\u8fd4\u56de\u5230\u9ad8\u5730\u5740\u3002 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 // arch/riscv/kernel/vm.c /* early_pgtbl: \u7b2c\u4e00\u56de\u6620\u5c04\u7684\u9875\u8868, \u5927\u5c0f\u6070\u597d\u4e3a\u4e00\u9875 4 KiB, \u5f00\u5934\u5bf9\u9f50\u9875\u8fb9\u754c */ unsigned long early_pgtbl [ 512 ] __attribute__ (( __aligned__ ( 0x1000 ))); void setup_vm ( void ) { /* 1. \u5982\u524d\u6587\u6240\u8bf4\uff0c\u53ea\u4f7f\u7528\u7b2c\u4e00\u7ea7\u9875\u8868 2. \u56e0\u6b64 VA \u7684 64bit \u4f5c\u4e3a\u5982\u4e0b\u5212\u5206\uff1a | high bit | 9 bit | 30 bit | high bit \u53ef\u4ee5\u5ffd\u7565 \u4e2d\u95f4 9 bit \u4f5c\u4e3a early_pgtbl \u7684 index \u4f4e 30 bit \u4f5c\u4e3a\u9875\u5185\u504f\u79fb 3. Page Table Entry \u7684\u6743\u9650 V | R | W | X \u4f4d\u8bbe\u7f6e\u4e3a 1 */ } 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 # arch/riscv/kernel/head.S _start: call setup_vm call relocate ... j start_kernel relocate: # set ra = ra + PA2VA_OFFSET # set sp = sp + PA2VA_OFFSET (If you have set the sp before) ###################### # YOUR CODE HERE # ###################### # set satp with early_pgtbl ###################### # YOUR CODE HERE # ###################### # flush tlb sfence.vma zero , zero ret .section .bss.stack .globl boot_stack boot_stack: ... Hint 1: sfence.vma \u6307\u4ee4\u7528\u4e8e\u5237\u65b0 TLB Hint 2: \u5728 set satp \u524d\uff0c\u6211\u4eec\u53ea\u53ef\u4ee5\u4f7f\u7528 \u7269\u7406\u5730\u5740 \u6765\u6253\u65ad\u70b9\u3002\u8bbe\u7f6e satp \u4e4b\u540e\uff0c\u624d\u53ef\u4ee5\u4f7f\u7528\u865a\u62df\u5730\u5740\u6253\u65ad\u70b9\uff0c\u540c\u65f6\u4e4b\u524d\u8bbe\u7f6e\u7684\u7269\u7406\u5730\u5740\u65ad\u70b9\u4e5f\u4f1a\u5931\u6548\uff0c\u9700\u8981\u5220\u9664\u3002 Hint 3: \u5982\u679c\u8981\u8c03\u8bd5\u4ee3\u7801\uff0c\u53ef\u4ee5\u4f7f\u7528 .gdbinit \u505a\u4e00\u4e9b\u81ea\u52a8\u5316\u3002\u5728\u542f\u52a8 GDB \u7684\u90a3\u4e2a\u76ee\u5f55\u4e0b\u65b0\u5efa .gdbinit \u6587\u4ef6\uff0c\u5728\u5176\u4e2d\u5199\u5165 GDB \u6307\u4ee4\uff0cGDB \u5c31\u4f1a\u5728\u542f\u52a8\u65f6\u81ea\u52a8\u6267\u884c\u5b83\u4eec\u3002\u6bd4\u5982\u5728\u5176\u4e2d\u5199\u5165 target remote :1234 \u3001\u6253\u65ad\u70b9\u6307\u4ee4\u3001\u6267\u884c\u5230\u65ad\u70b9\u5904\u7684\u6307\u4ee4\uff0cGDB \u5728\u542f\u52a8\u540e\u5c31\u4f1a\u81ea\u52a8\u94fe\u63a5\u4e0a QEMU\uff0c\u6253\u65ad\u70b9\u5e76\u8df3\u5230\u65ad\u70b9\u5904\u3002\u8fd9\u80fd\u6781\u5927\u5730\u63d0\u5347\u8c03\u8bd5\u4f53\u9a8c\u3002 4.3 \u7b2c\u4e8c\u56de\u6620\u5c04 \u4e0b\u56fe\u63cf\u7ed8\u4e86\u7b2c\u4e8c\u56de\u6620\u5c04\u7684\u72b6\u51b5\uff1a 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 Physical Address PHY_START PHY_END \u2193 \u2193 -------------------------------------------------------- | OpenSBI | Kernel | | -------------------------------------------------------- ^ ^ 0x80200000 \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510 \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510 | | | VM_START | Virtual Address | | ---------------------------------------------------------------------------------------------------- | OpenSBI | Kernel | | ----------------------------------------------------------------------------------------------------- ^ 0xffffffe000200000 \u7b2c\u4e8c\u56de\u6620\u5c04\u8981\u4f7f\u7528\u4e09\u7ea7\u9875\u8868\uff0c\u6240\u4ee5\u6211\u4eec\u9700\u8981\u7ba1\u7406\u591a\u4e2a\u9875\u9762\u3002\u4e00\u4e2a\u597d\u529e\u6cd5\u662f\u5148\u6267\u884c mm.c \u4e2d\u7684 mm_init \u521d\u59cb\u5316\u5185\u5b58\u7ba1\u7406\u6a21\u5757\uff0c\u7136\u540e\u518d\u914d\u7f6e\u9875\u8868\u3002\u5f53\u6211\u4eec\u9700\u8981\u65b0\u9875\u65f6\uff0c\u8c03\u7528 kalloc() \u7533\u8bf7\u4e00\u9875\u5373\u53ef\u3002 \u6ce8\u610f\uff0c\u672c\u6b21\u5b9e\u9a8c\u4e0e\u4e4b\u524d\u4e0d\u540c\uff0c mm_init \u8fd0\u884c\u5728\u865a\u62df\u5730\u5740\u4e0a\uff0c\u6240\u4ee5 mm_init \u51fd\u6570\u9700\u8981\u4e00\u4e9b\u4fee\u6539 \uff0c\u8bf7\u4f60\u81ea\u884c\u5b8c\u6210\u3002 \u7b2c\u4e8c\u56de\u6620\u5c04\u4e2d\uff0c\u5efa\u7acb\u9875\u8868\u548c\u8bbe\u7f6e satp \u7528\u4e00\u4e2a\u51fd\u6570 arch/riscv/kernel/vm.c : setup_vm_final \u6765\u5b9e\u73b0\u3002 \u5b8c\u6210\u4e0b\u9762\u7684\u4ee3\u7801\uff0c\u5e76\u5728 head.S \u7684\u9002\u5f53\u4f4d\u7f6e\u8c03\u7528 setup_vm_final \u3002 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 // arch/riscv/kernel/vm.c /* swapper_pg_dir: kernel pagetable \u6839\u76ee\u5f55\uff0c \u5728 setup_vm_final \u8fdb\u884c\u6620\u5c04\u3002 */ unsigned long swapper_pg_dir [ 512 ] __attribute__ (( __aligned__ ( 0x1000 ))); void setup_vm_final ( void ) { memset ( swapper_pg_dir , 0x0 , PGSIZE ); // No OpenSBI mapping required // mapping kernel text X|-|R|V create_mapping (...); // mapping kernel rodata -|-|R|V create_mapping (...); // mapping other memory -|W|R|V create_mapping (...); // set satp with swapper_pg_dir YOUR CODE HERE // flush TLB asm volatile ( \"sfence.vma zero, zero\" ); return ; } /* \u521b\u5efa\u591a\u7ea7\u9875\u8868\u6620\u5c04\u5173\u7cfb */ create_mapping ( uint64 * pgtbl , uint64 va , uint64 pa , uint64 sz , int perm ) { /* pgtbl \u4e3a\u6839\u9875\u8868\u7684\u57fa\u5730\u5740 va, pa \u4e3a\u9700\u8981\u6620\u5c04\u7684\u865a\u62df\u5730\u5740\u3001\u7269\u7406\u5730\u5740 sz \u4e3a\u6620\u5c04\u7684\u5927\u5c0f perm \u4e3a\u6620\u5c04\u7684\u8bfb\u5199\u6743\u9650 \u521b\u5efa\u591a\u7ea7\u9875\u8868\u7684\u65f6\u5019\u53ef\u4ee5\u4f7f\u7528 kalloc() \u6765\u83b7\u53d6\u4e00\u9875\u4f5c\u4e3a\u9875\u8868\u76ee\u5f55 \u53ef\u4ee5\u4f7f\u7528 V bit \u6765\u5224\u65ad\u9875\u8868\u9879\u662f\u5426\u5b58\u5728 */ } 4.4 \u7f16\u8bd1\u53ca\u6d4b\u8bd5 \u7531\u4e8e\u52a0\u5165\u4e86\u4e00\u4e9b\u65b0\u7684 C \u6587\u4ef6\uff0c\u53ef\u80fd\u9700\u8981\u4fee\u6539\u4e00\u4e9b Makefile \u6587\u4ef6\uff0c\u8bf7\u540c\u5b66\u81ea\u5df1\u5c1d\u8bd5\u4fee\u6539\uff0c\u4f7f\u9879\u76ee\u53ef\u4ee5\u7f16\u8bd1\u5e76\u8fd0\u884c\u3002 \u8f93\u51fa\u793a\u4f8b\uff1a 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 OpenSBI v0.9 ____ _____ ____ _____ / __ \\ / ____ | _ \\_ _ | | | | | _ __ ___ _ __ | ( ___ | | _ ) || | | | | | '_ \\ / _ \\ ' _ \\ \\_ __ \\| _ < | | | | __ | | | _ ) | __/ | | | ____ ) | | _ ) || | _ \\_ ___/ | .__/ \\_ __ | _ | | _ | _____/ | ____/_____ | | | | _ | ... Boot HART MIDELEG : 0x0000000000000222 Boot HART MEDELEG : 0x000000000000b109 ...mm_init done ! ...proc_init done ! Hello RISC-V idle process is running! switch to [ PID = 28 COUNTER = 1 ] [ PID = 28 ] is running! thread space begin at 0xffffffe007fa2000 switch to [ PID = 12 COUNTER = 1 ] [ PID = 12 ] is running! thread space begin at 0xffffffe007fb2000 switch to [ PID = 14 COUNTER = 2 ] [ PID = 14 ] is running! thread space begin at 0xffffffe007fb0000 [ PID = 14 ] is running! thread space begin at 0xffffffe007fb0000 switch to [ PID = 9 COUNTER = 2 ] [ PID = 9 ] is running! thread space begin at 0xffffffe007fb5000 [ PID = 9 ] is running! thread space begin at 0xffffffe007fb5000 switch to [ PID = 2 COUNTER = 2 ] [ PID = 2 ] is running! thread space begin at 0xffffffe007fbc000 [ PID = 2 ] is running! thread space begin at 0xffffffe007fbc000 switch to [ PID = 1 COUNTER = 2 ] [ PID = 1 ] is running! thread space begin at 0xffffffe007fbd000 [ PID = 1 ] is running! thread space begin at 0xffffffe007fbd000 switch to [ PID = 29 COUNTER = 3 ] [ PID = 29 ] is running! thread space begin at 0xffffffe007fa1000 [ PID = 29 ] is running! thread space begin at 0xffffffe007fa1000 [ PID = 29 ] is running! thread space begin at 0xffffffe007fa1000 switch to [ PID = 11 COUNTER = 3 ] [ PID = 11 ] is running! thread space begin at 0xffffffe007fb3000 ... \u601d\u8003\u9898 \u9a8c\u8bc1 .text , .rodata \u6bb5\u7684\u5c5e\u6027\u662f\u5426\u6210\u529f\u8bbe\u7f6e\uff0c\u7ed9\u51fa\u622a\u56fe\u3002 \u4e3a\u4ec0\u4e48\u6211\u4eec\u5728 setup_vm \u4e2d\u9700\u8981\u505a\u7b49\u503c\u6620\u5c04? \u5728 Linux \u4e2d\uff0c\u662f\u4e0d\u9700\u8981\u505a\u7b49\u503c\u6620\u5c04\u7684\u3002\u8bf7\u63a2\u7d22\u4e00\u4e0b\u4e0d\u5728 setup_vm \u4e2d\u505a\u7b49\u503c\u6620\u5c04\u7684\u65b9\u6cd5\u3002 \u4f5c\u4e1a\u63d0\u4ea4 \u540c\u5b66\u9700\u8981\u63d0\u4ea4\u5b9e\u9a8c\u62a5\u544a\u4ee5\u53ca\u6574\u4e2a\u5de5\u7a0b\u4ee3\u7801\u3002\u5728\u63d0\u4ea4\u524d\u8bf7\u4f7f\u7528 make clean \u6e05\u9664\u6240\u6709\u6784\u5efa\u4ea7\u7269\u3002","title":"\u5b9e\u9a8c\u6307\u5bfc\u56db"},{"location":"lab4/#lab-4-rv64","text":"","title":"Lab 4: RV64 \u865a\u62df\u5185\u5b58\u7ba1\u7406"},{"location":"lab4/#1","text":"\u5b66\u4e60\u865a\u62df\u5185\u5b58\u7684\u76f8\u5173\u77e5\u8bc6\uff0c\u5b9e\u73b0\u7269\u7406\u5730\u5740\u5230\u865a\u62df\u5730\u5740\u7684\u5207\u6362\u3002 \u4e86\u89e3 RISC-V \u67b6\u6784\u4e2d SV39 \u5206\u9875\u6a21\u5f0f\uff0c\u5b9e\u73b0\u865a\u62df\u5730\u5740\u5230\u7269\u7406\u5730\u5740\u7684\u6620\u5c04\uff0c\u5e76\u5bf9\u4e0d\u540c\u7684\u6bb5\u8fdb\u884c\u76f8\u5e94\u7684\u6743\u9650\u8bbe\u7f6e\u3002","title":"1 \u5b9e\u9a8c\u76ee\u7684"},{"location":"lab4/#2","text":"Docker in Lab0","title":"2 \u5b9e\u9a8c\u73af\u5883"},{"location":"lab4/#3","text":"\u5728 lab3 \u4e2d\u6211\u4eec\u8d4b\u4e88\u4e86 OS \u5bf9\u591a\u4e2a\u7ebf\u7a0b\u8c03\u5ea6\u4ee5\u53ca\u5e76\u53d1\u6267\u884c\u7684\u80fd\u529b\uff0c\u7531\u4e8e\u76ee\u524d\u8fd9\u4e9b\u7ebf\u7a0b\u90fd\u662f\u5185\u6838\u7ebf\u7a0b\uff0c\u56e0\u6b64\u4ed6\u4eec\u53ef\u4ee5\u5171\u4eab\u8fd0\u884c\u7a7a\u95f4\uff0c\u5373\u8fd0\u884c\u4e0d\u540c\u7ebf\u7a0b\u5bf9\u7a7a\u95f4\u7684\u4fee\u6539\u662f\u76f8\u4e92\u53ef\u89c1\u7684\u3002\u4f46\u662f\u5982\u679c\u6211\u4eec\u9700\u8981\u7ebf\u7a0b\u76f8\u4e92 \u9694\u79bb \uff0c\u4ee5\u53ca\u5728\u591a\u7ebf\u7a0b\u7684\u60c5\u51b5\u4e0b\u66f4\u52a0 \u9ad8\u6548 \u7684\u4f7f\u7528\u5185\u5b58\uff0c\u6211\u4eec\u5fc5\u987b\u5f15\u5165 \u865a\u62df\u5185\u5b58 \u8fd9\u4e2a\u6982\u5ff5\u3002 \u865a\u62df\u5185\u5b58\u53ef\u4ee5\u4e3a\u8fdb\u7a0b\u63d0\u4f9b\u72ec\u7acb\u7684\u5185\u5b58\u7a7a\u95f4\uff0c\u5236\u9020\u4e00\u79cd\u6bcf\u4e2a\u8fdb\u7a0b\u7684\u5185\u5b58\u90fd\u662f\u72ec\u7acb\u7684\u5047\u8c61\u3002\u865a\u62df\u5185\u5b58\u5230\u7269\u7406\u5185\u5b58\u7684\u6620\u5c04\u4e5f\u5305\u542b\u4e86\u5185\u5b58\u8bbf\u95ee\u6743\u9650\u7684\u4fe1\u606f\uff0c\u65b9\u4fbf kernel \u5b8c\u6210\u6743\u9650\u68c0\u67e5\u3002 \u5728\u672c\u6b21\u5b9e\u9a8c\u4e2d\uff0c\u6211\u4eec\u9700\u8981\u5173\u6ce8 OS \u5982\u4f55 \u5f00\u542f\u865a\u62df\u5185\u5b58 \uff0c\u5982\u4f55\u901a\u8fc7\u8bbe\u7f6e\u9875\u8868\u6765\u5b9e\u73b0 \u5730\u5740\u6620\u5c04 \u548c \u6743\u9650\u63a7\u5236 \u3002","title":"3 \u80cc\u666f\u77e5\u8bc6"},{"location":"lab4/#31-linux-kernel","text":"1 2 3 4 5 6 7 8 9 10 11 12 13 start_address end_address 0x0 0x3fffffffff \u2502 \u2502 \u250c\u2500\u2500\u2500\u2500\u2518 \u250c\u2500\u2500\u2500\u2500\u2518 \u2193 256G \u2193 \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510 \u2502 User Space \u2502 ... \u2502 Kernel Space \u2502 \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518 \u2191 256G \u2191 \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518 \u2502 \u2502 \u2502 0xffffffc000000000 0xffffffffffffffff start_address end_address \u4e0a\u56fe\u662f Linux 5.15 \u4e2d RV64 \u67b6\u6784\u7684\u5185\u5b58\u5e03\u5c40\u3002\u5b83\u662f\u57fa\u4e8e RISC-V \u6807\u51c6\u4e2d\u5b9a\u4e49\u7684 Sv39 \u5730\u5740\u8f6c\u6362\u6a21\u5f0f\u7684\uff08\u89c1\u4e0b\u6587\uff09\u3002\u6211\u4eec\u770b\u5230 0x0000004000000000 \u4ee5\u4e0b\u7684\u865a\u62df\u5730\u5740\u7a7a\u95f4\u5206\u914d\u7ed9 user space\uff0c 0xffffffc000000000 \u53ca\u4ee5\u4e0a\u7684\u865a\u62df\u5730\u5740\u7a7a\u95f4\u5206\u914d\u7ed9 kernel space \u3002\u7531\u4e8e\u6211\u4eec\u8fd8\u672a\u5f15\u5165\u7528\u6237\u6001\u7a0b\u5e8f\uff0c\u76ee\u524d\u6211\u4eec\u53ea\u9700\u8981\u5173\u6ce8 kernel space \u3002\u539f\u59cb\u8bf4\u660e\u6587\u4ef6\u5728 \u6b64\u5904 \u3002 Kernel \u4e3a\u4e86\u9ad8\u6548\u65b9\u4fbf\u5730\u8bbf\u95ee RAM\uff0c\u4f1a\u628a\u6240\u6709\u7269\u7406\u5185\u5b58\u90fd\u6620\u5c04\u5230\u865a\u62df\u5185\u5b58\u91cc kernel space \u4e2d\u7684\u4e00\u5757\u533a\u57df\u3002\u8fd9\u5757\u533a\u57df\u79f0\u4e3a direct mapping area \u3002\u7531\u4e8e\u6b64\u5904\u865a\u62df\u5185\u5b58\u548c\u7269\u7406\u5185\u5b58\u7684\u6620\u5c04\u5173\u7cfb\u662f VA == PA + OFFSET \uff0c \u6240\u4ee5\u8fd9\u79cd\u6620\u5c04\u4e5f\u88ab\u79f0\u4e3a linear mapping \uff08\u6ce8\u610f\uff0c\u8fd9\u4e0e\u7ebf\u6027\u4ee3\u6570\u4e2d\u7684 linear mapping \u662f\u4e0d\u540c\u7684\u2014\u2014\u90a3\u91cc\u7684 linear mapping \u4e00\u5b9a\u628a 0 \u6620\u5c04\u5230 0\uff0c\u800c\u6b64\u5904\u4e0d\u662f\u3002\u5728\u6570\u5b66\u4e0a\u6b64\u5904\u7684\u6620\u5c04\u5e94\u79f0\u4e3a translation transformation\uff0c\u5373\u5e73\u79fb\u53d8\u6362\uff09\u3002\u5728 RISC-V \u67b6\u6784\u7684 Linux Kernel \u4e2d direct mapping area \u4e3a 0xffffffe000000000 ~ 0xffffffff00000000 , \u5171 124 GB \u3002 \u672c\u6b21\u5b9e\u9a8c\u7684\u4efb\u52a1\u5c31\u662f\u5f00\u542f\u865a\u62df\u5185\u5b58\uff0c\u5b9e\u73b0 direct mapping\uff0c\u5e76\u8ba9 lab3 \u4e2d\u7684\u591a\u8fdb\u7a0b\u7a0b\u5e8f\u5728 direct mapping area \u4e2d\u6267\u884c\u3002 \u4e3a\u6b64\uff0c\u6211\u4eec\u9700\u8981\u4e86\u89e3 RISC-V \u67b6\u6784\u4e2d\u865a\u62df\u5185\u5b58\u7684\u5de5\u4f5c\u65b9\u5f0f\u3002","title":"3.1 Linux Kernel \u7684\u865a\u62df\u5185\u5b58\u5e03\u5c40"},{"location":"lab4/#32-risc-v-virtual-memory-system","text":"\u865a\u62df\u5185\u5b58\u7684\u672c\u8d28\u662f\u5730\u5740\u8f6c\u6362\u4e0e\u4fdd\u62a4\uff0c\u800c\u8fd9\u662f\u901a\u8fc7\u9875\u8868\u6765\u5b9e\u73b0\u7684\u3002\u5206\u56db\u6b65\u6765\u7406\u89e3\u5730\u5740\u8f6c\u6362\u4e0e\u4fdd\u62a4\uff1a S \u6001\u4e0b\u5982\u4f55\u5f00\u542f\u8f6c\u6362\uff0c\u9875\u8868\u57fa\u5730\u5740\u5b58\u653e\u5728\u54ea\u91cc\uff1a satp register \u6211\u4eec\u4f7f\u7528\u7684\u8f6c\u6362\u6a21\u5f0f\u4e0b\uff0c\u865a\u62df\u5730\u5740\u548c\u7269\u7406\u5730\u5740\u5982\u4f55\u5212\u5206 \u9875\u8868\u9879\uff08Page Table Entry, PTE\uff09\u7684\u683c\u5f0f\u662f\u4ec0\u4e48 \u5f53\u4e00\u5207\u90fd\u8bbe\u7f6e\u597d\u540e\uff0c\u5730\u5740\u8f6c\u6362\u4e0e\u4fdd\u62a4\u662f\u5982\u4f55\u8fdb\u884c\u7684 \u4e0b\u9762\u5206\u522b\u4ecb\u7ecd\u8fd9\u56db\u70b9\u3002","title":"3.2 RISC-V Virtual-Memory System"},{"location":"lab4/#321-the-satp-registersupervisor-address-translation-and-protection-register","text":"satp \u662f S \u6a21\u5f0f\u4e0b\u63a7\u5236\u5730\u5740\u8f6c\u6362\u4e0e\u4fdd\u62a4\u7684 CSR \u5bc4\u5b58\u5668\uff0c\u5b83\u7684\u683c\u5f0f\u5982\u4e0b\u56fe\uff1a 1 2 3 4 63 60 59 44 43 0 --------------------------------------------------------------------- | MODE | ASID | PPN | --------------------------------------------------------------------- MODE \u5b57\u6bb5\u63a7\u5236\u5730\u5740\u8f6c\u6362\u6a21\u5f0f\uff0c\u9ed8\u8ba4\u4e3a 0\uff0c\u8868\u793a\u4e0d\u505a\u8f6c\u6362\u3002\u5b83\u7684\u6240\u6709\u53d6\u503c\u5982\u4e0b\u56fe\u3002\u5f53 satp.MODE \u88ab\u8bbe\u4e3a 8 \u65f6\uff0c\u6211\u4eec\u5c31\u5f00\u542f\u4e86 Sv39 \u6a21\u5f0f\u7684\u5730\u5740\u8f6c\u6362\u3002 1 2 3 4 5 6 7 8 9 10 11 12 13 RV 64 ---------------------------------------------------------- | Value | Name | Description | |----------------------------------------------------------| | 0 | Bare | No translation or protection | | 1 - 7 | --- | Reserved for standard use | | 8 | Sv39 | Page - based 39 bit virtual addressing | <-- \u6211\u4eec\u4f7f\u7528\u7684mode | 9 | Sv48 | Page - based 48 bit virtual addressing | | 10 | Sv57 | Page - based 57 bit virtual addressing | | 11 | Sv64 | Page - based 64 bit virtual addressing | | 12 - 13 | --- | Reserved for standard use | | 14 - 15 | --- | Reserved for standard use | ----------------------------------------------------------- ASID ( Address Space Identifier ) \uff1a \u6b64\u6b21\u5b9e\u9a8c\u4e2d\u76f4\u63a5\u7f6e 0 \u5373\u53ef\u3002 PPN ( Physical Page Number ) \uff1a\u9876\u7ea7\u9875\u8868\u7684 \u7269\u7406 \u9875\u53f7\u3002\u5728 Sv39 \u4e2d\u7269\u7406\u9875\u7684\u5927\u5c0f\u4e3a 4KiB\uff0c\u6240\u4ee5 PPN == PA >> 12 \u3002 \u5177\u4f53\u4ecb\u7ecd\u8bf7\u9605\u8bfb RISC-V Privileged Spec 4.1.10 \u3002","title":"3.2.1 The satp Register\uff08Supervisor Address Translation and Protection Register\uff09"},{"location":"lab4/#322-risc-v-sv39-virtual-address-and-physical-address","text":"1 2 3 4 5 38 30 29 21 20 12 11 0 --------------------------------------------------------------------- | VPN [ 2 ] | VPN [ 1 ] | VPN [ 0 ] | page offset | --------------------------------------------------------------------- Sv39 virtual address 1 2 3 4 5 55 30 29 21 20 12 11 0 ----------------------------------------------------------------------------- | PPN [ 2 ] | PPN [ 1 ] | PPN [ 0 ] | page offset | ----------------------------------------------------------------------------- Sv39 physical address Sv39 \u6a21\u5f0f\u5b9a\u4e49\u7684\u7269\u7406\u5730\u5740\u6709 56 \u4f4d\uff0c\u865a\u62df\u5730\u5740\u6709 64 \u4f4d\u3002\u4f46\u662f\uff0c\u865a\u62df\u5730\u5740\u7684 64 \u4f4d\u53ea\u6709\u4f4e 39 \u4f4d\u6709\u6548\u2014\u2014\u5728\u4f7f\u7528 64 \u4f4d\u865a\u62df\u5730\u5740\u65f6\uff0c\u5fc5\u987b\u4fdd\u8bc1\u5176 63 ~ 39 \u53f7\u4f4d\u4e0e 38 \u53f7\u4f4d\u76f8\u7b49\uff0c\u5426\u5219\u5c31\u4f1a\u89e6\u53d1 Page Fault Exception\u3002\u5f53\u865a\u62df\u5730\u5740\u7684 63 ~ 38 \u53f7\u4f4d\u90fd\u4e3a 0 \u65f6\uff0c\u8be5\u5730\u5740\u5904\u4e8e user space \u4e2d\uff1b\u90fd\u4e3a 1 \u65f6\u5904\u4e8e kernel space \u4e2d\u3002 Sv39 \u652f\u6301\u4e09\u7ea7\u9875\u8868\u7ed3\u6784\u3002 VPN (Virtual Page Number) \u662f\u865a\u62df\u5730\u5740\u6240\u5728\u9875\u7684\u9875\u53f7\uff0c\u5728\u5730\u5740\u8f6c\u6362\u4e2d\u662f\u67e5\u8be2\u9875\u8868\u6240\u7528\u7684\u4e0b\u6807\u3002VPN[2] ~ VPN[0] \u5206\u522b\u7528\u4e8e\u67e5\u8be2\u9876\u7ea7\u9875\u8868\u3001\u4e8c\u7ea7\u9875\u8868\u3001\u4e09\u7ea7\u9875\u8868\u3002 PPN (Physical Page Number) \u662f\u7269\u7406\u5730\u5740\u6240\u5728\u9875\u7684\u9875\u53f7\u3002 Page Offset \u662f\u9875\u5185\u504f\u79fb\u3002 \u5fc5\u987b\u6307\u51fa\uff0c \u5e76\u4e0d\u662f\u4e09\u7ea7\u9875\u8868\u90fd\u4e00\u5b9a\u8981\u7528\u7684\uff1a\u6211\u4eec\u53ef\u4ee5\u53ea\u7528\u7b2c\u4e00\u7ea7\uff0c\u6216\u53ea\u7528\u524d\u4e24\u7ea7 \u3002 \u53ea\u7528\u7b2c\u4e00\u7ea7\u9875\u8868\u3002\u6b64\u65f6\uff0c\u5047\u8bbe\u6211\u4eec\u62ff VA \u4e2d\u7684 VPN[2] \u67e5\u8be2\u9876\u7ea7\u9875\u8868\u5f97\u5230\u7684 PTE \u4e2d\u7269\u7406\u9875\u53f7\u90e8\u5206\u4e3a {PPN[2], PPN[1], PPN[0]} \uff0c\u90a3\u4e48\u5730\u5740\u8f6c\u6362\u5f97\u5230\u7684\u7269\u7406\u5730\u5740\u5c31\u662f {PPN[2], VPN[1], VPN[0], VA.offset} \u3002\u6b64\u65f6\u865a\u62df\u5185\u5b58\u7684\u4e00\u9875\u5927\u5c0f\u4e3a 1 GiB\uff0c\u56e0\u4e3a {VPN[1], VPN[0], VA.offset} \u8fde\u8d77\u6765\u88ab\u770b\u4f5c\u9875\u5185\u504f\u79fb\uff0c\u4e00\u5171\u6709 30 \u4f4d\u3002 \u53ea\u7528\u524d\u4e24\u7ea7\u9875\u8868\u3002\u6b64\u65f6\u865a\u62df\u5185\u5b58\u7684\u4e00\u9875\u5927\u5c0f\u5c31\u662f 2 MiB \u3002 \u5f53\u7136\uff0c\u6211\u4eec\u53ef\u4ee5\u7528\u4e09\u7ea7\u9875\u8868\uff0c\u6b64\u65f6\u865a\u62df\u5185\u5b58\u7684\u4e00\u9875\u5927\u5c0f\u5c31\u662f 4 KiB\u3002 \u5177\u4f53\u4ecb\u7ecd\u8bf7\u9605\u8bfb RISC-V Privileged Spec 4.4.1 \u3002","title":"3.2.2 RISC-V Sv39 Virtual Address and Physical Address"},{"location":"lab4/#323-risc-v-sv39-page-table-entry","text":"1 2 3 4 5 6 7 8 9 10 11 12 13 14 63 54 53 28 27 19 18 10 9 8 7 6 5 4 3 2 1 0 ----------------------------------------------------------------------- | Reserved | PPN [ 2 ] | PPN [ 1 ] | PPN [ 0 ] | RSW | D | A | G | U | X | W | R | V | ----------------------------------------------------------------------- | | | | | | | | | | | | | | | | | ` ---- V - Valid | | | | | | | ` ------ R - Readable | | | | | | ` -------- W - Writable | | | | | ` ---------- X - Executable | | | | ` ------------ U - User | | | ` -------------- G - Global | | ` ---------------- A - Accessed | ` ------------------ D - Dirty ( 0 in page directory ) ` ---------------------- Reserved for supervisor software 0 \uff5e 9 bit: protection bits V : \u6709\u6548\u4f4d\u3002\u8bbf\u95ee\u5230 V = 0 \u7684 PTE \u65f6\u4f1a\u4ea7\u751f Page Fault\u3002 R : R = 1 \u8be5\u9875\u53ef\u8bfb\u3002 W : W = 1 \u8be5\u9875\u53ef\u5199\u3002 X : X = 1 \u8be5\u9875\u53ef\u6267\u884c\u3002 U , G , A , D , RSW \u672c\u6b21\u5b9e\u9a8c\u4e2d\u8bbe\u7f6e\u4e3a 0 \u5373\u53ef\u3002 \u5177\u4f53\u4ecb\u7ecd\u8bf7\u9605\u8bfb RISC-V Privileged Spec 4.4.1 \u3002","title":"3.2.3 RISC-V Sv39 Page Table Entry"},{"location":"lab4/#324-risc-v-address-translation","text":"\u865a\u62df\u5730\u5740\u8f6c\u5316\u4e3a\u7269\u7406\u5730\u5740\u6d41\u7a0b\u56fe\u5982\u4e0b\uff0c\u5177\u4f53\u63cf\u8ff0\u89c1 RISC-V Privileged Spec 4.3.2 : 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 Virtual Address Physical Address 9 9 9 12 55 12 11 0 \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510 \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510 \u2502 \u2502 VPN[2] \u2502 VPN[1] \u2502 VPN[0] \u2502 OFFSET \u2502 \u2502 PPN \u2502 OFFSET \u2502 \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518 \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518 \u2502 \u2502 \u2502 \u2502 \u25b2 \u25b2 \u2502 \u2502 \u2502 \u2502 \u2502 \u2502 \u2502 \u2502 \u2502 \u2502 \u2502 \u2502 \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518 \u2502 \u2502 \u2502 \u2502 \u2502 \u2502 \u2502 \u2502 \u2502 \u2502 \u2502 \u2502 \u2502 \u2502 \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518 \u2502 \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510 \u2502 \u2502 \u2502 \u2502511 \u2502 \u2502 \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518 \u2502 \u2502 \u2502 \u2502 \u2502 \u2502 \u2502 \u2502 \u2502 \u2502 \u2502 \u2502 \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510 \u2502 \u2502 \u2502 \u2502 \u2502 \u2502 511 \u2502 \u2502 \u2502 \u2502 \u2502 \u2502 \u2502 \u2502 \u2502 \u2502 \u2502 \u2502 \u2502 \u2502 \u2502 \u2502 \u2502 \u2502 \u2502 \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510 \u2502 \u2502 \u2502 44 10 \u2502 \u2502 \u2502 \u2502 \u2502 511 \u2502 \u2502 \u2502 \u2502 \u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524 \u2502 \u2502 \u2502 \u2502 \u2502 \u2502 \u2502 \u2514\u2500\u2500\u2500\u25ba\u2502 PPN \u2502 flags \u2502 \u2502 \u2502 \u2502 \u2502 \u2502 \u2502 \u2502 \u251c\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524 \u2502 \u2502 44 10 \u2502 \u2502 \u2502 \u2502 \u2502 \u2502 \u2502 \u2502 \u2502 \u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524 \u2502 \u2502 \u2502 \u2502 \u2502 \u2502 \u2502 \u2514\u2500\u2500\u2500\u2500\u25ba\u2502 PPN \u2502 flags \u2502 \u2502 \u2502 \u2502 \u2502 \u2502 \u2502 \u2502 \u251c\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524 \u2502 \u2502 44 10 \u2502 \u2502 \u2502 \u2502 \u2502 \u2502 \u2502 \u2502 \u2502 \u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524 \u2502 1 \u2502 \u2502 \u2502 \u2502 \u2502 \u2502 \u2514\u2500\u2500\u2500\u2500\u25ba\u2502 PPN \u2502 flags \u2502 \u2502 \u2502 \u2502 \u2502 \u2502 \u2502 \u2502 \u251c\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524 \u2502 0 \u2502 \u2502 \u2502 \u2502 \u2502 \u2502 \u2502 \u2502 \u2502 \u2502 \u2514\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518 1 \u2502 \u2502 \u2502 \u2502 \u2502 \u2502 \u2502 \u25b2 \u2502 \u2502 \u2502 \u2502 \u2502 \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518 \u2502 \u2502 0 \u2502 \u2502 \u2502 \u2502 \u2502 \u2502 \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u25ba\u2514\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518 1 \u2502 \u2502 \u2502 \u2502 \u2502 \u2502 \u250c\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2510 \u2502 0 \u2502 \u2502 \u2502 satp \u2502 \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u25ba\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518 \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518","title":"3.2.4 RISC-V Address Translation"},{"location":"lab4/#4","text":"","title":"4 \u5b9e\u9a8c\u6307\u5bfc"},{"location":"lab4/#40","text":"\u672c\u6b21\u5b9e\u9a8c\u7684\u4efb\u52a1\u662f\u5f00\u542f\u865a\u62df\u5185\u5b58\uff0c\u5b9e\u73b0 direct mapping\uff0c\u5e76\u8ba9 lab3 \u4e2d\u7684\u591a\u8fdb\u7a0b\u7a0b\u5e8f\u5728 direct mapping area \u4e2d\u6267\u884c\u3002 \u4e0b\u9762\u63cf\u8ff0\u5177\u4f53\u5b9e\u73b0\u65b9\u5f0f\u3002\u4e3a\u4e86\u63cf\u8ff0\u6e05\u6670\uff0c\u6211\u4eec\u5148\u5b9a\u4e49\u4e00\u4e9b\u8bb0\u53f7\uff1a \\(p_s\\) \uff1a\u7269\u7406\u5730\u5740\u7684\u8d77\u59cb\u5730\u5740\u503c\uff0c\u672c\u5b9e\u9a8c\u4e2d\u4e3a 0x80000000 \u3002 \\(p_e\\) \uff1a\u7269\u7406\u5730\u5740\u7684\u7ec8\u6b62\u5730\u5740\u503c\uff0c\u672c\u5b9e\u9a8c\u4e2d\u4e3a 0x8020000 \u3002 \\(l\\) \uff1a\u7269\u7406\u5730\u5740\u6bb5\u7684\u957f\u5ea6\uff0c\u672c\u5b9e\u9a8c\u4e2d\u4e3a 0x8000000 \uff0c\u5373 128MiB\u3002 \\(b\\) \uff1a\u4e3a OpenSBI \u9884\u7559\u7684\u5730\u5740\u957f\u5ea6\uff0c\u672c\u5b9e\u9a8c\u4e2d\u4e3a 0x200000 \uff0c\u5373 2 MiB\u3002 \\(v_s\\) \uff1a\u865a\u62df\u5730\u5740\u7684\u8d77\u59cb\u5730\u5740\u503c\uff0c\u672c\u5b9e\u9a8c\u4e2d\u4e3a 0xffffffe000000000 \\(v_e\\) \uff1a\u865a\u62df\u5730\u5740\u7684\u7ec8\u6b62\u5730\u5740\u503c\uff0c\u672c\u5b9e\u9a8c\u4e2d\u4e3a 0xffffffe000200000 \\(t=v_s-p_s\\) \uff0c\u865a\u62df\u5730\u5740\u76f8\u5bf9\u4e8e\u7269\u7406\u5730\u5740\u7684\u504f\u79fb\u91cf (offset) \\([a, b)\\to [c, d)\\) \uff1a\u5185\u5b58\u6620\u5c04\uff0c\u628a \u865a\u62df\u5730\u5740\u7a7a\u95f4 \u7684 \\([a, b)\\) \u6620\u5c04\u5230 \u7269\u7406\u5730\u5740\u7a7a\u95f4 \u7684 \\([c, d)\\) \u3002\u5f53\u7136\uff0c\u8981\u6c42\u4e24\u6bb5\u957f\u5ea6\u76f8\u540c\u3002 \u5b8c\u7f8e\u5f00\u542f\u865a\u62df\u5185\u5b58\u5206\u4e3a\u4e24\u6b65\uff1a \u7b2c\u4e00\u56de\u6620\u5c04\uff0c\u5206\u4e24\u5757 \uff1a \\([p_s, p_s+d)\\to [p_s, p_s+d)\\) \uff0c\u79f0\u4e3a\u7b49\u503c\u6620\u5c04 \\([v_s, v_s+d)\\to [p_s, p_s+d)\\) \uff0c\u79f0\u4e3a\u504f\u79fb\u6620\u5c04\uff08\u5373\u4e0a\u6587\u4e2d\u7684 linear mapping\uff09 \u5176\u4e2d \\(d\\) = 1 GiB\u3002 \u6211\u4eec\u7684\u7269\u7406\u5730\u5740\u6bb5\u53ea\u6709 \\(l\\) = 128 MiB \u8fd9\u4e48\u5927\uff0c\u4e3a\u4ec0\u4e48\u8981\u505a 1 GiB \u7684\u6620\u5c04\u5462\uff1f\u8fd9\u4ec5\u4ec5\u662f\u4e3a\u4e86\u65b9\u4fbf\u3002\u53ef\u4ee5\u60f3\u8c61\uff0c\u5982\u679c\u4f7f\u7528\u4e24\u7ea7\u6216\u4e09\u7ea7\u9875\u8868\uff0c\u5c31\u4f1a\u6d89\u53ca\u591a\u4e2a\u7269\u7406\u9875\u7684\u7ba1\u7406\uff0c\u6bd4\u8f83\u9ebb\u70e6\uff1b\u82e5\u53ea\u7528\u7b2c\u4e00\u7ea7\u9875\u8868\uff0c\u6211\u4eec\u5c31\u53ea\u9700\u8981\u4e00\u4e2a\u7269\u7406\u9875\u6765\u5b58\u653e\u5b83\uff0c\u975e\u5e38\u65b9\u4fbf\u3002\u56e0\u6b64\u5728\u7b2c\u4e00\u56de\u6620\u5c04\u65f6\u6211\u4eec\u5c31\u53ea\u7528\u7b2c\u4e00\u7ea7\u9875\u8868\uff0c\u4ece\u800c\u865a\u62df\u5185\u5b58\u4e00\u9875\u7684\u5927\u5c0f\u5c31\u662f 1 GiB\uff08\u89c1\u4e0a\u6587\uff09\u3002\u53ea\u8981\u6211\u4eec\u5b9e\u9645\u8bbf\u95ee\u7684\u5730\u5740\u90fd\u5728 128 MiB \u7684\u8303\u56f4\u5185\uff0c\u8fd9\u6837\u5c31\u662f\u65e0\u5bb3\u7684\u3002 \u7b2c\u4e8c\u56de\u6620\u5c04 \uff1a \\([v_s+b, v_e)\\to [p_s+b, p_e)\\) \u4e3a\u4ec0\u4e48\u5de6\u7aef\u70b9\u8981\u52a0 \\(b\\) \u5462\uff1f\u56e0\u4e3a \\([v_s, v_s+b)\\) \u8fd9\u4e00\u6bb5\u865a\u62df\u5730\u5740\u6839\u672c\u5c31\u7528\u4e0d\u7740\u2014\u2014\u82e5\u8981\u8bbf\u95ee\u8fd9\u4e00\u6bb5\uff0c\u8bbf\u95ee\u5230\u7684\u662f OpenSBI\uff0c\u4f46\u6211\u4eec\u5728 S \u6001\u4e0b\u4e0d\u4f1a\uff08\u4e5f\u4e0d\u5e94\u8be5\uff09\u8bbf\u95ee\u5b83\u3002\u9700\u8981\u8bbf\u95ee\u5b83\u7684\u662f M \u6001\uff0c\u800c M \u6001\u6839\u672c\u4e0d\u53d7 satp \uff08S \u6a21\u5f0f\u7684\u5730\u5740\u8f6c\u6362\uff09\u5f71\u54cd\u2014\u2014\u5728 M \u6001\u91cc\u7a0b\u5e8f\u76f4\u63a5\u7528\u7269\u7406\u5730\u5740 \\([p_s, p_s+b)\\) \u8bbf\u95ee OpenSBI\u3002 \u7b2c\u4e8c\u56de\u6620\u5c04\u7528\u4e09\u7ea7\u9875\u8868\u6765\u5b9e\u73b0\u3002 \u7b2c\u4e8c\u56de\u6620\u5c04\u4f1a\u8986\u76d6\u7b2c\u4e00\u56de\u6620\u5c04\u3002\u5373\uff0c\u5f53\u6211\u4eec\u628a satp \u6307\u5411\u627f\u8f7d\u7b2c\u4e8c\u56de\u6620\u5c04\u7684\u9875\u8868\u65f6\uff0c\u7b2c\u4e00\u56de\u6620\u5c04\u5c31\u81ea\u52a8\u5931\u6548\u4e86\u3002\u6700\u540e\u6211\u4eec\u5c31\u5f97\u5230\u4e86\u4e0d\u591a\u4e0d\u5c11\u521a\u521a\u597d\u7684\u865a\u62df\u5730\u5740\u5230\u7269\u7406\u5730\u5740\u7684\u6620\u5c04\u3002 \u8fd9\u91cc\u7559\u4e0b\u51e0\u4e2a\u95ee\u9898\uff08\u4e5f\u5728\u601d\u8003\u9898\u4e2d\uff09\uff0c\u8bf7\u540c\u5b66\u601d\u8003\uff1a \u4e3a\u4ec0\u4e48\u7b2c\u4e00\u56de\u6620\u5c04\u91cc\u8981\u505a\u7b49\u503c\u6620\u5c04\uff1f \u4e3a\u4ec0\u4e48\u8981\u5206\u8fd9\u6837\u4e24\u6b65\u5462\uff1f\u80fd\u5426\u4e00\u6b65\u505a\u5b8c\uff1f \u4e0b\u9762\u662f\u5177\u4f53\u7f16\u7a0b\u7684\u6307\u5f15\u3002","title":"4.0 \u4efb\u52a1\u4e0e\u9014\u5f84"},{"location":"lab4/#41","text":"\u6b64\u6b21\u5b9e\u9a8c\u57fa\u4e8e lab3 \u540c\u5b66\u6240\u5b9e\u73b0\u7684\u4ee3\u7801\u8fdb\u884c\u3002 \u9700\u8981\u4fee\u6539 defs.h \uff0c\u5199\u5165\u4e0a\u9762\u5b9a\u4e49\u7684\u5e38\u91cf\u3002\u5728 defs.h \u4e2d\u52a0\u5165\u5982\u4e0b\u5185\u5bb9\uff1a 1 2 3 4 5 6 7 #define OPENSBI_SIZE (0x200000) #define VM_START (0xffffffe000000000) #define VM_END (0xffffffff00000000) #define VM_SIZE (VM_END - VM_START) #define PA2VA_OFFSET (VM_START - PHY_START) \u4ece repo \u540c\u6b65\u4ee5\u4e0b\u4ee3\u7801: vmlinux.lds.S , Makefile \u3002\u5e76\u6309\u7167\u4ee5\u4e0b\u6b65\u9aa4\u5c06\u8fd9\u4e9b\u6587\u4ef6\u6b63\u786e\u653e\u7f6e\u3002 1 2 3 4 5 6 . \u2514\u2500\u2500 arch \u2514\u2500\u2500 riscv \u2514\u2500\u2500 kernel \u251c\u2500\u2500 Makefile \u2514\u2500\u2500 vmlinux.lds.S \u8fd9\u91cc\u6211\u4eec\u901a\u8fc7 vmlinux.lds.S \u6a21\u7248\u751f\u6210 vmlinux.lds \u6587\u4ef6\u3002\u94fe\u63a5\u811a\u672c\u4e2d\u7684 ramv \u4ee3\u8868 VMA (Virtual Memory Address)\uff0c\u5373\u865a\u62df\u5730\u5740\uff1b ram \u5219\u4ee3\u8868 LMA (Load Memory Address)\uff0c\u5373\u6211\u4eec OS image \u88ab load \u7684\u5730\u5740\uff0c\u53ef\u4ee5\u7406\u89e3\u4e3a\u7269\u7406\u5730\u5740\u3002\u4f7f\u7528\u4ee5\u4e0a\u7684 vmlinux.lds \u8fdb\u884c\u7f16\u8bd1\u4e4b\u540e\uff0c\u5f97\u5230\u7684 System.map \u4ee5\u53ca vmlinux \u91c7\u7528\u7684\u90fd\u662f\u865a\u62df\u5730\u5740\uff0c\u65b9\u4fbf\u4e4b\u540e debug\u3002","title":"4.1 \u51c6\u5907\u5de5\u4f5c"},{"location":"lab4/#42","text":"\u4e0b\u56fe\u63cf\u7ed8\u4e86\u7b2c\u4e00\u56de\u6620\u5c04\u7684\u72b6\u51b5\uff1a 1 2 3 4 5 6 7 8 9 10 11 12 13 14 Physical Address ------------------------------------------- | OpenSBI | Kernel | ------------------------------------------- ^ 0x80000000 \u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510 | | Virtual Address | | ----------------------------------------------------------------------------------------------- | OpenSBI | Kernel | | OpenSBI | Kernel | ----------------------------------------------------------------------------------------------- ^ ^ 0x80000000 0xffffffe000000000 \u6211\u4eec\u7528\u4e24\u4e2a\u51fd\u6570\u5b9e\u73b0\u7b2c\u4e00\u56de\u6620\u5c04\uff1a arch/riscv/kernel/vm.c : setup_vm \uff1a\u914d\u7f6e\u597d\u9875\u8868\uff1b arch/riscv/kernel/head.S : relocate \uff1a\u914d\u7f6e satp \uff0c\u5e76\u8fd4\u56de\u5230\u9ad8\u5730\u5740\u3002 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 // arch/riscv/kernel/vm.c /* early_pgtbl: \u7b2c\u4e00\u56de\u6620\u5c04\u7684\u9875\u8868, \u5927\u5c0f\u6070\u597d\u4e3a\u4e00\u9875 4 KiB, \u5f00\u5934\u5bf9\u9f50\u9875\u8fb9\u754c */ unsigned long early_pgtbl [ 512 ] __attribute__ (( __aligned__ ( 0x1000 ))); void setup_vm ( void ) { /* 1. \u5982\u524d\u6587\u6240\u8bf4\uff0c\u53ea\u4f7f\u7528\u7b2c\u4e00\u7ea7\u9875\u8868 2. \u56e0\u6b64 VA \u7684 64bit \u4f5c\u4e3a\u5982\u4e0b\u5212\u5206\uff1a | high bit | 9 bit | 30 bit | high bit \u53ef\u4ee5\u5ffd\u7565 \u4e2d\u95f4 9 bit \u4f5c\u4e3a early_pgtbl \u7684 index \u4f4e 30 bit \u4f5c\u4e3a\u9875\u5185\u504f\u79fb 3. Page Table Entry \u7684\u6743\u9650 V | R | W | X \u4f4d\u8bbe\u7f6e\u4e3a 1 */ } 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 # arch/riscv/kernel/head.S _start: call setup_vm call relocate ... j start_kernel relocate: # set ra = ra + PA2VA_OFFSET # set sp = sp + PA2VA_OFFSET (If you have set the sp before) ###################### # YOUR CODE HERE # ###################### # set satp with early_pgtbl ###################### # YOUR CODE HERE # ###################### # flush tlb sfence.vma zero , zero ret .section .bss.stack .globl boot_stack boot_stack: ... Hint 1: sfence.vma \u6307\u4ee4\u7528\u4e8e\u5237\u65b0 TLB Hint 2: \u5728 set satp \u524d\uff0c\u6211\u4eec\u53ea\u53ef\u4ee5\u4f7f\u7528 \u7269\u7406\u5730\u5740 \u6765\u6253\u65ad\u70b9\u3002\u8bbe\u7f6e satp \u4e4b\u540e\uff0c\u624d\u53ef\u4ee5\u4f7f\u7528\u865a\u62df\u5730\u5740\u6253\u65ad\u70b9\uff0c\u540c\u65f6\u4e4b\u524d\u8bbe\u7f6e\u7684\u7269\u7406\u5730\u5740\u65ad\u70b9\u4e5f\u4f1a\u5931\u6548\uff0c\u9700\u8981\u5220\u9664\u3002 Hint 3: \u5982\u679c\u8981\u8c03\u8bd5\u4ee3\u7801\uff0c\u53ef\u4ee5\u4f7f\u7528 .gdbinit \u505a\u4e00\u4e9b\u81ea\u52a8\u5316\u3002\u5728\u542f\u52a8 GDB \u7684\u90a3\u4e2a\u76ee\u5f55\u4e0b\u65b0\u5efa .gdbinit \u6587\u4ef6\uff0c\u5728\u5176\u4e2d\u5199\u5165 GDB \u6307\u4ee4\uff0cGDB \u5c31\u4f1a\u5728\u542f\u52a8\u65f6\u81ea\u52a8\u6267\u884c\u5b83\u4eec\u3002\u6bd4\u5982\u5728\u5176\u4e2d\u5199\u5165 target remote :1234 \u3001\u6253\u65ad\u70b9\u6307\u4ee4\u3001\u6267\u884c\u5230\u65ad\u70b9\u5904\u7684\u6307\u4ee4\uff0cGDB \u5728\u542f\u52a8\u540e\u5c31\u4f1a\u81ea\u52a8\u94fe\u63a5\u4e0a QEMU\uff0c\u6253\u65ad\u70b9\u5e76\u8df3\u5230\u65ad\u70b9\u5904\u3002\u8fd9\u80fd\u6781\u5927\u5730\u63d0\u5347\u8c03\u8bd5\u4f53\u9a8c\u3002","title":"4.2 \u7b2c\u4e00\u56de\u6620\u5c04"},{"location":"lab4/#43","text":"\u4e0b\u56fe\u63cf\u7ed8\u4e86\u7b2c\u4e8c\u56de\u6620\u5c04\u7684\u72b6\u51b5\uff1a 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 Physical Address PHY_START PHY_END \u2193 \u2193 -------------------------------------------------------- | OpenSBI | Kernel | | -------------------------------------------------------- ^ ^ 0x80200000 \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510 \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510 | | | VM_START | Virtual Address | | ---------------------------------------------------------------------------------------------------- | OpenSBI | Kernel | | ----------------------------------------------------------------------------------------------------- ^ 0xffffffe000200000 \u7b2c\u4e8c\u56de\u6620\u5c04\u8981\u4f7f\u7528\u4e09\u7ea7\u9875\u8868\uff0c\u6240\u4ee5\u6211\u4eec\u9700\u8981\u7ba1\u7406\u591a\u4e2a\u9875\u9762\u3002\u4e00\u4e2a\u597d\u529e\u6cd5\u662f\u5148\u6267\u884c mm.c \u4e2d\u7684 mm_init \u521d\u59cb\u5316\u5185\u5b58\u7ba1\u7406\u6a21\u5757\uff0c\u7136\u540e\u518d\u914d\u7f6e\u9875\u8868\u3002\u5f53\u6211\u4eec\u9700\u8981\u65b0\u9875\u65f6\uff0c\u8c03\u7528 kalloc() \u7533\u8bf7\u4e00\u9875\u5373\u53ef\u3002 \u6ce8\u610f\uff0c\u672c\u6b21\u5b9e\u9a8c\u4e0e\u4e4b\u524d\u4e0d\u540c\uff0c mm_init \u8fd0\u884c\u5728\u865a\u62df\u5730\u5740\u4e0a\uff0c\u6240\u4ee5 mm_init \u51fd\u6570\u9700\u8981\u4e00\u4e9b\u4fee\u6539 \uff0c\u8bf7\u4f60\u81ea\u884c\u5b8c\u6210\u3002 \u7b2c\u4e8c\u56de\u6620\u5c04\u4e2d\uff0c\u5efa\u7acb\u9875\u8868\u548c\u8bbe\u7f6e satp \u7528\u4e00\u4e2a\u51fd\u6570 arch/riscv/kernel/vm.c : setup_vm_final \u6765\u5b9e\u73b0\u3002 \u5b8c\u6210\u4e0b\u9762\u7684\u4ee3\u7801\uff0c\u5e76\u5728 head.S \u7684\u9002\u5f53\u4f4d\u7f6e\u8c03\u7528 setup_vm_final \u3002 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 // arch/riscv/kernel/vm.c /* swapper_pg_dir: kernel pagetable \u6839\u76ee\u5f55\uff0c \u5728 setup_vm_final \u8fdb\u884c\u6620\u5c04\u3002 */ unsigned long swapper_pg_dir [ 512 ] __attribute__ (( __aligned__ ( 0x1000 ))); void setup_vm_final ( void ) { memset ( swapper_pg_dir , 0x0 , PGSIZE ); // No OpenSBI mapping required // mapping kernel text X|-|R|V create_mapping (...); // mapping kernel rodata -|-|R|V create_mapping (...); // mapping other memory -|W|R|V create_mapping (...); // set satp with swapper_pg_dir YOUR CODE HERE // flush TLB asm volatile ( \"sfence.vma zero, zero\" ); return ; } /* \u521b\u5efa\u591a\u7ea7\u9875\u8868\u6620\u5c04\u5173\u7cfb */ create_mapping ( uint64 * pgtbl , uint64 va , uint64 pa , uint64 sz , int perm ) { /* pgtbl \u4e3a\u6839\u9875\u8868\u7684\u57fa\u5730\u5740 va, pa \u4e3a\u9700\u8981\u6620\u5c04\u7684\u865a\u62df\u5730\u5740\u3001\u7269\u7406\u5730\u5740 sz \u4e3a\u6620\u5c04\u7684\u5927\u5c0f perm \u4e3a\u6620\u5c04\u7684\u8bfb\u5199\u6743\u9650 \u521b\u5efa\u591a\u7ea7\u9875\u8868\u7684\u65f6\u5019\u53ef\u4ee5\u4f7f\u7528 kalloc() \u6765\u83b7\u53d6\u4e00\u9875\u4f5c\u4e3a\u9875\u8868\u76ee\u5f55 \u53ef\u4ee5\u4f7f\u7528 V bit \u6765\u5224\u65ad\u9875\u8868\u9879\u662f\u5426\u5b58\u5728 */ }","title":"4.3 \u7b2c\u4e8c\u56de\u6620\u5c04"},{"location":"lab4/#44","text":"\u7531\u4e8e\u52a0\u5165\u4e86\u4e00\u4e9b\u65b0\u7684 C \u6587\u4ef6\uff0c\u53ef\u80fd\u9700\u8981\u4fee\u6539\u4e00\u4e9b Makefile \u6587\u4ef6\uff0c\u8bf7\u540c\u5b66\u81ea\u5df1\u5c1d\u8bd5\u4fee\u6539\uff0c\u4f7f\u9879\u76ee\u53ef\u4ee5\u7f16\u8bd1\u5e76\u8fd0\u884c\u3002 \u8f93\u51fa\u793a\u4f8b\uff1a 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 OpenSBI v0.9 ____ _____ ____ _____ / __ \\ / ____ | _ \\_ _ | | | | | _ __ ___ _ __ | ( ___ | | _ ) || | | | | | '_ \\ / _ \\ ' _ \\ \\_ __ \\| _ < | | | | __ | | | _ ) | __/ | | | ____ ) | | _ ) || | _ \\_ ___/ | .__/ \\_ __ | _ | | _ | _____/ | ____/_____ | | | | _ | ... Boot HART MIDELEG : 0x0000000000000222 Boot HART MEDELEG : 0x000000000000b109 ...mm_init done ! ...proc_init done ! Hello RISC-V idle process is running! switch to [ PID = 28 COUNTER = 1 ] [ PID = 28 ] is running! thread space begin at 0xffffffe007fa2000 switch to [ PID = 12 COUNTER = 1 ] [ PID = 12 ] is running! thread space begin at 0xffffffe007fb2000 switch to [ PID = 14 COUNTER = 2 ] [ PID = 14 ] is running! thread space begin at 0xffffffe007fb0000 [ PID = 14 ] is running! thread space begin at 0xffffffe007fb0000 switch to [ PID = 9 COUNTER = 2 ] [ PID = 9 ] is running! thread space begin at 0xffffffe007fb5000 [ PID = 9 ] is running! thread space begin at 0xffffffe007fb5000 switch to [ PID = 2 COUNTER = 2 ] [ PID = 2 ] is running! thread space begin at 0xffffffe007fbc000 [ PID = 2 ] is running! thread space begin at 0xffffffe007fbc000 switch to [ PID = 1 COUNTER = 2 ] [ PID = 1 ] is running! thread space begin at 0xffffffe007fbd000 [ PID = 1 ] is running! thread space begin at 0xffffffe007fbd000 switch to [ PID = 29 COUNTER = 3 ] [ PID = 29 ] is running! thread space begin at 0xffffffe007fa1000 [ PID = 29 ] is running! thread space begin at 0xffffffe007fa1000 [ PID = 29 ] is running! thread space begin at 0xffffffe007fa1000 switch to [ PID = 11 COUNTER = 3 ] [ PID = 11 ] is running! thread space begin at 0xffffffe007fb3000 ...","title":"4.4 \u7f16\u8bd1\u53ca\u6d4b\u8bd5"},{"location":"lab4/#_1","text":"\u9a8c\u8bc1 .text , .rodata \u6bb5\u7684\u5c5e\u6027\u662f\u5426\u6210\u529f\u8bbe\u7f6e\uff0c\u7ed9\u51fa\u622a\u56fe\u3002 \u4e3a\u4ec0\u4e48\u6211\u4eec\u5728 setup_vm \u4e2d\u9700\u8981\u505a\u7b49\u503c\u6620\u5c04? \u5728 Linux \u4e2d\uff0c\u662f\u4e0d\u9700\u8981\u505a\u7b49\u503c\u6620\u5c04\u7684\u3002\u8bf7\u63a2\u7d22\u4e00\u4e0b\u4e0d\u5728 setup_vm \u4e2d\u505a\u7b49\u503c\u6620\u5c04\u7684\u65b9\u6cd5\u3002","title":"\u601d\u8003\u9898"},{"location":"lab4/#_2","text":"\u540c\u5b66\u9700\u8981\u63d0\u4ea4\u5b9e\u9a8c\u62a5\u544a\u4ee5\u53ca\u6574\u4e2a\u5de5\u7a0b\u4ee3\u7801\u3002\u5728\u63d0\u4ea4\u524d\u8bf7\u4f7f\u7528 make clean \u6e05\u9664\u6240\u6709\u6784\u5efa\u4ea7\u7269\u3002","title":"\u4f5c\u4e1a\u63d0\u4ea4"},{"location":"lab5/","text":"Lab 5: RV64 \u7528\u6237\u6a21\u5f0f 1 \u5b9e\u9a8c\u76ee\u7684 \u521b\u5efa\u7528\u6237\u6001\u8fdb\u7a0b\uff0c\u5e76\u8bbe\u7f6e sstatus \u6765\u5b8c\u6210\u5185\u6838\u6001\u8f6c\u6362\u81f3\u7528\u6237\u6001\u3002 \u6b63\u786e\u8bbe\u7f6e\u7528\u6237\u8fdb\u7a0b\u7684 \u7528\u6237\u6001\u6808 \u548c \u5185\u6838\u6001\u6808 \uff0c \u5e76\u5728\u5f02\u5e38\u5904\u7406\u65f6\u6b63\u786e\u5207\u6362\u3002 \u8865\u5145\u5f02\u5e38\u5904\u7406\u903b\u8f91\uff0c\u5b8c\u6210\u6307\u5b9a\u7684\u7cfb\u7edf\u8c03\u7528\uff08 SYS_WRITE, SYS_GETPID \uff09\u529f\u80fd\u3002 2 \u5b9e\u9a8c\u73af\u5883 Docker in Lab0 3 \u80cc\u666f\u77e5\u8bc6 3.0 \u524d\u8a00 \u5728 lab4 \u4e2d\uff0c\u6211\u4eec\u5f00\u542f\u865a\u62df\u5185\u5b58\uff0c\u8fd9\u4e3a\u8fdb\u7a0b\u95f4\u5730\u5740\u7a7a\u95f4\u76f8\u4e92\u9694\u79bb\u6253\u4e0b\u4e86\u57fa\u7840\u3002\u4e4b\u524d\u7684\u5b9e\u9a8c\u4e2d\u6211\u4eec\u53ea\u521b\u5efa\u4e86\u5185\u6838\u7ebf\u7a0b\uff0c\u4ed6\u4eec\u5171\u7528\u4e86\u5730\u5740\u7a7a\u95f4 \uff08\u5171\u7528\u4e00\u4e2a \u5185\u6838\u9875\u8868 swapper_pg_dir \uff09\u3002\u5728\u672c\u6b21\u5b9e\u9a8c\u4e2d\u6211\u4eec\u5c06\u5f15\u5165\u7528\u6237\u6001\u8fdb\u7a0b\u3002\u5f53\u542f\u52a8\u7528\u6237\u6a21\u5f0f\u5e94\u7528\u7a0b\u5e8f\u65f6\uff0c\u5185\u6838\u5c06\u4e3a\u8be5\u5e94\u7528\u7a0b\u5e8f\u521b\u5efa\u4e00\u4e2a\u8fdb\u7a0b\uff0c\u4e3a\u5e94\u7528\u7a0b\u5e8f\u63d0\u4f9b\u4e86\u4e13\u7528\u865a\u62df\u5730\u5740\u7a7a\u95f4\u7b49\u8d44\u6e90\u3002\u56e0\u4e3a\u5e94\u7528\u7a0b\u5e8f\u7684\u865a\u62df\u5730\u5740\u7a7a\u95f4\u662f\u79c1\u6709\u7684\uff0c\u6240\u4ee5\u4e00\u4e2a\u5e94\u7528\u7a0b\u5e8f\u65e0\u6cd5\u66f4\u6539\u5c5e\u4e8e\u53e6\u4e00\u4e2a\u5e94\u7528\u7a0b\u5e8f\u7684\u6570\u636e\u3002\u6bcf\u4e2a\u5e94\u7528\u7a0b\u5e8f\u90fd\u662f\u72ec\u7acb\u8fd0\u884c\u7684\uff0c\u5982\u679c\u4e00\u4e2a\u5e94\u7528\u7a0b\u5e8f\u5d29\u6e83\uff0c\u5176\u4ed6\u5e94\u7528\u7a0b\u5e8f\u548c\u64cd\u4f5c\u7cfb\u7edf\u4e0d\u4f1a\u53d7\u5230\u5f71\u54cd\u3002\u540c\u65f6\uff0c\u7528\u6237\u6a21\u5f0f\u5e94\u7528\u7a0b\u5e8f\u53ef\u8bbf\u95ee\u7684\u865a\u62df\u5730\u5740\u7a7a\u95f4\u4e5f\u53d7\u5230\u9650\u5236\uff0c\u5728\u7528\u6237\u6a21\u5f0f\u4e0b\u65e0\u6cd5\u8bbf\u95ee\u5185\u6838\u7684\u865a\u62df\u5730\u5740\uff0c\u9632\u6b62\u5e94\u7528\u7a0b\u5e8f\u4fee\u6539\u5173\u952e\u64cd\u4f5c\u7cfb\u7edf\u6570\u636e\u3002\u5f53\u7528\u6237\u6001\u7a0b\u5e8f\u9700\u8981\u8bbf\u95ee\u5173\u952e\u8d44\u6e90\u7684\u65f6\u5019\uff0c\u53ef\u4ee5\u901a\u8fc7\u7cfb\u7edf\u8c03\u7528\u6765\u5b8c\u6210\u7528\u6237\u6001\u7a0b\u5e8f\u4e0e\u64cd\u4f5c\u7cfb\u7edf\u4e4b\u95f4\u7684\u4e92\u52a8\u3002 3.1 User \u6a21\u5f0f\u57fa\u7840\u4ecb\u7ecd \u5904\u7406\u5668\u5177\u6709\u4e24\u79cd\u4e0d\u540c\u7684\u6a21\u5f0f\uff1a\u7528\u6237\u6a21\u5f0f\u548c\u5185\u6838\u6a21\u5f0f\u3002\u5728\u5185\u6838\u6a21\u5f0f\u4e0b\uff0c\u6267\u884c\u4ee3\u7801\u5bf9\u5e95\u5c42\u786c\u4ef6\u5177\u6709\u5b8c\u6574\u4e14\u4e0d\u53d7\u9650\u5236\u7684\u8bbf\u95ee\u6743\u9650\uff0c\u5b83\u53ef\u4ee5\u6267\u884c\u4efb\u4f55 CPU \u6307\u4ee4\u5e76\u5f15\u7528\u4efb\u4f55\u5185\u5b58\u5730\u5740\u3002\u5728\u7528\u6237\u6a21\u5f0f\u4e0b\uff0c\u6267\u884c\u4ee3\u7801\u65e0\u6cd5\u76f4\u63a5\u8bbf\u95ee\u786c\u4ef6\uff0c\u5fc5\u987b\u59d4\u6258\u7ed9\u7cfb\u7edf\u63d0\u4f9b\u7684\u63a5\u53e3\u624d\u80fd\u8bbf\u95ee\u786c\u4ef6\u6216\u5185\u5b58\u3002\u5904\u7406\u5668\u6839\u636e\u5904\u7406\u5668\u4e0a\u8fd0\u884c\u7684\u4ee3\u7801\u7c7b\u578b\u5728\u4e24\u79cd\u6a21\u5f0f\u4e4b\u95f4\u5207\u6362\u3002\u5e94\u7528\u7a0b\u5e8f\u4ee5\u7528\u6237\u6a21\u5f0f\u8fd0\u884c\uff0c\u800c\u6838\u5fc3\u64cd\u4f5c\u7cfb\u7edf\u7ec4\u4ef6\u4ee5\u5185\u6838\u6a21\u5f0f\u8fd0\u884c\u3002 3.2 \u7cfb\u7edf\u8c03\u7528\u7ea6\u5b9a \u7cfb\u7edf\u8c03\u7528\u662f\u7528\u6237\u6001\u5e94\u7528\u7a0b\u5e8f\u8bf7\u6c42\u5185\u6838\u670d\u52a1\u7684\u4e00\u79cd\u65b9\u5f0f\u3002\u5728 RISC-V \u4e2d\uff0c\u6211\u4eec\u4f7f\u7528 ecall \u6307\u4ee4\u8fdb\u884c\u7cfb\u7edf\u8c03\u7528\u3002\u5f53\u6267\u884c\u8fd9\u6761\u6307\u4ee4\u65f6\u5904\u7406\u5668\u4f1a\u63d0\u5347\u7279\u6743\u6a21\u5f0f\uff0c\u8df3\u8f6c\u5230\u5f02\u5e38\u5904\u7406\u51fd\u6570\u5904\u7406\u8fd9\u6761\u7cfb\u7edf\u8c03\u7528\u3002 Linux \u4e2d RISC-V \u76f8\u5173\u7684\u7cfb\u7edf\u8c03\u7528\u53ef\u4ee5\u5728 include/uapi/asm-generic/unistd.h \u4e2d\u627e\u5230\uff0c syscall(2) \u624b\u518c\u9875\u4e0a\u5bf9RISC-V\u67b6\u6784\u4e0a\u7684\u8c03\u7528\u8bf4\u660e\u8fdb\u884c\u4e86\u603b\u7ed3\uff0c\u7cfb\u7edf\u8c03\u7528\u53c2\u6570\u4f7f\u7528 a0 - a5 \uff0c\u7cfb\u7edf\u8c03\u7528\u53f7\u4f7f\u7528 a7 \uff0c \u7cfb\u7edf\u8c03\u7528\u7684\u8fd4\u56de\u503c\u4f1a\u88ab\u4fdd\u5b58\u5230 a0, a1 \u4e2d\u3002 3.3 sstatus[SUM] PTE[U] \u5f53\u9875\u8868\u9879 PTE[U] \u7f6e 0 \u65f6\uff0c\u8be5\u9875\u8868\u9879\u5bf9\u5e94\u7684\u5185\u5b58\u9875\u4e3a\u5185\u6838\u9875\uff0c\u8fd0\u884c\u5728 U-Mode \u4e0b\u7684\u4ee3\u7801 \u65e0\u6cd5\u8bbf\u95ee \u3002\u5f53\u9875\u8868\u9879 PTE[U] \u7f6e 1 \u65f6\uff0c\u8be5\u9875\u8868\u9879\u5bf9\u5e94\u7684\u5185\u5b58\u9875\u4e3a\u7528\u6237\u9875\uff0c\u8fd0\u884c\u5728 S-Mode \u4e0b\u7684\u4ee3\u7801 \u65e0\u6cd5\u8bbf\u95ee \u3002\u5982\u679c\u60f3\u8ba9 S \u7279\u6743\u7ea7\u4e0b\u7684\u7a0b\u5e8f\u80fd\u591f\u8bbf\u95ee\u7528\u6237\u9875\uff0c\u9700\u8981\u5bf9 sstatus[SUM] \u4f4d\u7f6e 1 \u3002\u4f46\u662f\u65e0\u8bba\u4ec0\u4e48\u6837\u7684\u60c5\u51b5\u4e0b\uff0c\u7528\u6237\u9875\u4e2d\u7684\u6307\u4ee4\u5bf9\u4e8e S-Mode \u800c\u8a00\u90fd\u662f \u65e0\u6cd5\u6267\u884c \u7684\u3002 3.4 \u7528\u6237\u6001\u6808\u4e0e\u5185\u6838\u6001\u6808 \u5f53\u7528\u6237\u6001\u7a0b\u5e8f\u5728\u7528\u6237\u6001\u8fd0\u884c\u65f6\uff0c\u5176\u4f7f\u7528\u7684\u6808\u4e3a \u7528\u6237\u6001\u6808 \uff0c\u5f53\u8c03\u7528 SYSCALL\u65f6\u5019\uff0c\u9677\u5165\u5185\u6838\u5904\u7406\u65f6\u4f7f\u7528\u7684\u6808\u4e3a \u5185\u6838\u6001\u6808 \uff0c\u56e0\u6b64\u9700\u8981\u533a\u5206\u7528\u6237\u6001\u6808\u548c\u5185\u6838\u6001\u6808\uff0c\u5e76\u5728\u5f02\u5e38\u5904\u7406\u7684\u8fc7\u7a0b\u4e2d\u9700\u8981\u5bf9\u6808\u8fdb\u884c\u5207\u6362\u3002 4 \u5b9e\u9a8c\u6b65\u9aa4 4.1 \u51c6\u5907\u5de5\u7a0b \u6b64\u6b21\u5b9e\u9a8c\u57fa\u4e8e lab4 \u540c\u5b66\u6240\u5b9e\u73b0\u7684\u4ee3\u7801\u8fdb\u884c\u3002 \u9700\u8981\u4fee\u6539 vmlinux.lds.S \uff0c\u5c06\u7528\u6237\u6001\u7a0b\u5e8f uapp \u52a0\u8f7d\u81f3 .data \u6bb5\u3002\u6309\u5982\u4e0b\u4fee\u6539\uff1a 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 ... .data : ALIGN(0x1000){ _sdata = .; *(.sdata .sdata*) *(.data .data.*) _edata = .; . = ALIGN(0x1000); uapp_start = .; *(.uapp .uapp*) uapp_end = .; . = ALIGN(0x1000); } >ramv AT>ram ... \u9700\u8981\u4fee\u6539 defs.h \uff0c\u5728 defs.h \u6dfb\u52a0 \u5982\u4e0b\u5185\u5bb9\uff1a 1 2 #define USER_START (0x0000000000000000) // user space start virtual address #define USER_END (0x0000004000000000) // user space end virtual address \u4ece repo \u540c\u6b65\u4ee5\u4e0b\u6587\u4ef6\u5939: user \uff0c Makefile \u3002\u5e76\u6309\u7167\u4ee5\u4e0b\u6b65\u9aa4\u5c06\u8fd9\u4e9b\u6587\u4ef6\u6b63\u786e\u653e\u7f6e\u3002 1 2 3 4 5 6 7 8 9 10 11 12 13 14 . \u251c\u2500\u2500 arch \u2502 \u2514\u2500\u2500 riscv \u2502 \u2514\u2500\u2500 Makefile \u2514\u2500\u2500 user \u251c\u2500\u2500 Makefile \u251c\u2500\u2500 getpid.c \u251c\u2500\u2500 link.lds \u251c\u2500\u2500 printf.c \u251c\u2500\u2500 start.S \u251c\u2500\u2500 stddef.h \u251c\u2500\u2500 stdio.h \u251c\u2500\u2500 syscall.h \u2514\u2500\u2500 uapp.S \u4fee\u6539 \u6839\u76ee\u5f55 \u4e0b\u7684 Makefile, \u5c06 user \u7eb3\u5165\u5de5\u7a0b\u7ba1\u7406\u3002 \u5728\u6839\u76ee\u5f55\u4e0b make \u4f1a\u751f\u6210 user/uapp.o user/uapp.elf user/uapp.bin \u3002 \u901a\u8fc7 objdump \u6211\u4eec\u53ef\u4ee5\u770b\u5230 uapp \u4f7f\u7528 ecall \u6765\u8c03\u7528 SYSCALL (\u5728 U-Mode \u4e0b\u4f7f\u7528 ecall \u4f1a\u89e6\u53d1environment-call-from-U-mode\u5f02\u5e38)\u3002\u4ece\u800c\u5c06\u63a7\u5236\u6743\u4ea4\u7ed9\u5904\u5728 S-Mode \u7684 OS\uff0c \u7531\u5185\u6838\u6765\u5904\u7406\u76f8\u5173\u5f02\u5e38\u3002 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 0000000000000004 <getpid>: 4: fe010113 addi sp,sp,-32 8: 00813c23 sd s0,24(sp) c: 02010413 addi s0,sp,32 10: fe843783 ld a5,-24(s0) 14: 0ac00893 li a7,172 18: 00000073 ecall <- SYS_GETPID ... 00000000000000d8 <vprintfmt>: ... 60c: 00070513 mv a0,a4 610: 00068593 mv a1,a3 614: 00060613 mv a2,a2 618: 00000073 ecall <- SYS_WRITE ... 4.2 \u521b\u5efa\u7528\u6237\u6001\u8fdb\u7a0b \u672c\u6b21\u5b9e\u9a8c\u53ea\u9700\u8981\u521b\u5efa 4 \u4e2a\u7528\u6237\u6001\u8fdb\u7a0b\uff0c\u4fee\u6539 proc.h \u4e2d\u7684 NR_TASKS \u5373\u53ef\u3002 \u7531\u4e8e\u521b\u5efa\u7528\u6237\u6001\u8fdb\u7a0b\u8981\u5bf9 sepc sstatus sscratch \u505a\u8bbe\u7f6e\uff0c\u6211\u4eec\u5c06\u5176\u52a0\u5165 thread_struct \u4e2d\u3002 \u7531\u4e8e\u591a\u4e2a\u7528\u6237\u6001\u8fdb\u7a0b\u9700\u8981\u4fdd\u8bc1\u76f8\u5bf9\u9694\u79bb\uff0c\u56e0\u6b64\u4e0d\u53ef\u4ee5\u5171\u7528\u9875\u8868\u3002\u6211\u4eec\u4e3a\u6bcf\u4e2a\u7528\u6237\u6001\u8fdb\u7a0b\u90fd\u521b\u5efa\u4e00\u4e2a\u9875\u8868\u3002\u4fee\u6539 task_struct \u5982\u4e0b\u3002 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 // proc.h typedef unsigned long * pagetable_t ; struct thread_struct { uint64_t ra ; uint64_t sp ; uint64_t s [ 12 ]; uint64_t sepc , sstatus , sscratch ; }; struct task_struct { struct thread_info * thread_info ; uint64_t state ; uint64_t counter ; uint64_t priority ; uint64_t pid ; struct thread_struct thread ; pagetable_t pgd ; }; \u4fee\u6539 task_init \u5bf9\u6bcf\u4e2a\u7528\u6237\u6001\u8fdb\u7a0b\uff0c\u5176\u62e5\u6709\u4e24\u4e2a stack\uff1a U-Mode Stack \u4ee5\u53ca S-Mode Stack \uff0c \u5176\u4e2d S-Mode Stack \u5728 lab3 \u4e2d\u6211\u4eec\u5df2\u7ecf\u8bbe\u7f6e\u597d\u4e86\u3002\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7 kalloc \u63a5\u53e3\u7533\u8bf7\u4e00\u4e2a\u7a7a\u7684\u9875\u9762\u6765\u4f5c\u4e3a U-Mode Stack \u3002 \u4e3a\u6bcf\u4e2a\u7528\u6237\u6001\u8fdb\u7a0b\u521b\u5efa\u81ea\u5df1\u7684\u9875\u8868 \u5e76\u5c06 uapp \u6240\u5728\u9875\u9762\uff0c\u4ee5\u53ca U-Mode Stack \u505a\u76f8\u5e94\u7684\u6620\u5c04\uff0c\u540c\u65f6\u4e3a\u4e86\u907f\u514d U-Mode \u548c S-Mode \u5207\u6362\u7684\u65f6\u5019\u5207\u6362\u9875\u8868\uff0c\u6211\u4eec\u4e5f\u5c06\u5185\u6838\u9875\u8868 \uff08 swapper_pg_dir \uff09 \u590d\u5236\u5230\u6bcf\u4e2a\u8fdb\u7a0b\u7684\u9875\u8868\u4e2d\u3002 \u5bf9\u6bcf\u4e2a\u7528\u6237\u6001\u8fdb\u7a0b\u6211\u4eec\u9700\u8981\u5c06 sepc \u4fee\u6539\u4e3a USER_START \uff0c \u8bbe\u7f6e sstatus \u4e2d\u7684 SPP \uff08 \u4f7f\u5f97 sret \u8fd4\u56de\u81f3 U-Mode \uff09\uff0c SPIE \uff08 sret \u4e4b\u540e\u5f00\u542f\u4e2d\u65ad \uff09\uff0c SUM \uff08 S-Mode \u53ef\u4ee5\u8bbf\u95ee User \u9875\u9762 \uff09\uff0c sscratch \u8bbe\u7f6e\u4e3a U-Mode \u7684 sp\uff0c\u5176\u503c\u4e3a USER_END \uff08\u5373 U-Mode Stack \u88ab\u653e\u7f6e\u5728 user space \u7684\u6700\u540e\u4e00\u4e2a\u9875\u9762\uff09\u3002 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 PHY_START PHY_END uapp_start uapp_end \u2502 \u2502 \u2502 \u2502 \u25bc \u25bc \u25bc \u25bc \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510 PA \u2502 \u2502 \u2502 uapp \u2502 \u2502 \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518 \u25b2 \u25b2 \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518 \u2502 \u2502 \u2502 \u2502 \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518 \u2502 \u2502 \u2502 \u2502 \u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510 VA \u2502 UAPP \u2502 \u2502u mode stack\u2502 \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518 \u25b2 \u25b2 \u2502 \u2502 USER_START USER_END * \u4fee\u6539 __switch_to\uff0c \u9700\u8981\u52a0\u5165 \u4fdd\u5b58/\u6062\u590d sepc sstatus sscratch \u4ee5\u53ca \u5207\u6362\u9875\u8868\u7684\u903b\u8f91\u3002 4.3 \u4fee\u6539\u4e2d\u65ad\u5165\u53e3/\u8fd4\u56de\u903b\u8f91 ( _trap ) \u4ee5\u53ca\u4e2d\u65ad\u5904\u7406\u51fd\u6570 \uff08 trap_handler \uff09 \u4e0e ARM \u67b6\u6784\u4e0d\u540c\u7684\u662f\uff0cRISC-V \u4e2d\u53ea\u6709\u4e00\u4e2a\u6808\u6307\u9488\u5bc4\u5b58\u5668( sp )\uff0c\u56e0\u6b64\u9700\u8981\u6211\u4eec\u6765\u5b8c\u6210\u7528\u6237\u6808\u4e0e\u5185\u6838\u6808\u7684\u5207\u6362\u3002 \u7531\u4e8e\u6211\u4eec\u7684\u7528\u6237\u6001\u8fdb\u7a0b\u8fd0\u884c\u5728 U-Mode \u4e0b\uff0c \u4f7f\u7528\u7684\u8fd0\u884c\u6808\u4e5f\u662f U-Mode Stack \uff0c \u56e0\u6b64\u5f53\u89e6\u53d1\u5f02\u5e38\u65f6\uff0c \u6211\u4eec\u9996\u5148\u8981\u5bf9\u6808\u8fdb\u884c\u5207\u6362 \uff08 U-Mode Stack -> S-Mode Stack \uff09\u3002\u540c\u7406 \u8ba9\u6211\u4eec\u5b8c\u6210\u4e86\u5f02\u5e38\u5904\u7406\uff0c \u4ece S-Mode \u8fd4\u56de\u81f3 U-Mode \uff0c \u4e5f\u9700\u8981\u8fdb\u884c\u6808\u5207\u6362 \uff08 S-Mode Stack -> U-Mode Stack \uff09\u3002 \u4fee\u6539 __dummy \u3002\u5728 4.2 \u4e2d \u6211\u4eec\u521d\u59cb\u5316\u65f6\uff0c thread_struct.sp \u4fdd\u5b58\u4e86 S-Mode sp \uff0c thread_struct.sscratch \u4fdd\u5b58\u4e86 U-Mode sp \uff0c \u56e0\u6b64\u5728 S-Mode -> U->Mode \u7684\u65f6\u5019\uff0c\u6211\u4eec\u53ea\u9700\u8981\u4ea4\u6362\u5bf9\u5e94\u7684\u5bc4\u5b58\u5668\u7684\u503c\u5373\u53ef\u3002 \u4fee\u6539 _trap \u3002\u540c\u7406 \u5728 _trap \u7684\u9996\u5c3e\u6211\u4eec\u90fd\u9700\u8981\u505a\u7c7b\u4f3c\u7684\u64cd\u4f5c\u3002 \u6ce8\u610f\u5982\u679c\u662f \u5185\u6838\u7ebf\u7a0b( \u6ca1\u6709 U-Mode Stack ) \u89e6\u53d1\u4e86\u5f02\u5e38\uff0c\u5219\u4e0d\u9700\u8981\u8fdb\u884c\u5207\u6362\u3002\uff08\u5185\u6838\u7ebf\u7a0b\u7684 sp \u6c38\u8fdc\u6307\u5411\u7684 S-Mode Stack\uff0c sscratch \u4e3a 0\uff09 uapp \u4f7f\u7528 ecall \u4f1a\u4ea7\u751f ECALL_FROM_U_MODE exception \u3002\u56e0\u6b64\u6211\u4eec\u9700\u8981\u5728 trap_handler \u91cc\u9762\u8fdb\u884c\u6355\u83b7\u3002\u4fee\u6539 trap_handler \u5982\u4e0b\uff1a 1 2 3 void trap_handler ( uint64_t scause , uint64_t sepc , struct pt_regs * regs ) { ... } \u8fd9\u91cc\u9700\u8981\u89e3\u91ca\u65b0\u589e\u52a0\u7684\u7b2c\u4e09\u4e2a\u53c2\u6570 regs \uff0c \u5728 _trap \u4e2d\u6211\u4eec\u5c06\u5bc4\u5b58\u5668\u7684\u5185\u5bb9 \u8fde\u7eed \u7684\u4fdd\u5b58\u5728 S-Mode Stack\u4e0a\uff0c \u56e0\u6b64\u6211\u4eec\u53ef\u4ee5\u5c06\u8fd9\u4e00\u6bb5\u770b\u505a\u4e00\u4e2a\u53eb\u505a pt_regs \u7684\u7ed3\u6784\u4f53\u3002\u6211\u4eec\u53ef\u4ee5\u4ece\u8fd9\u4e2a\u7ed3\u6784\u4f53\u4e2d\u53d6\u5230\u76f8\u5e94\u7684\u5bc4\u5b58\u5668\u7684\u503c\uff08 \u6bd4\u5982 syscall \u4e2d\u6211\u4eec\u9700\u8981\u4ece a0 ~ a7 \u5bc4\u5b58\u5668\u4e2d\u53d6\u5230\u53c2\u6570 \uff09\u3002 \u793a\u4f8b\u5982\u4e0b\u56fe\uff1a 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 High Addr \u2500\u2500\u2500\u25ba \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510 \u2502 sstatus \u2502 \u2502 \u2502 \u2502 sepc \u2502 \u2502 \u2502 \u2502 x31 \u2502 \u2502 \u2502 \u2502 . \u2502 \u2502 . \u2502 \u2502 . \u2502 \u2502 \u2502 \u2502 x1 \u2502 \u2502 \u2502 \u2502 x0 \u2502 sp (pt_regs) \u2500\u2500\u25ba \u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524 \u2502 \u2502 \u2502 \u2502 \u2502 \u2502 \u2502 \u2502 \u2502 \u2502 \u2502 \u2502 \u2502 \u2502 \u2502 \u2502 \u2502 \u2502 Low Addr \u2500\u2500\u2500\u25ba \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518 \u8bf7\u540c\u5b66\u81ea\u5df1\u8865\u5145 struct pt_regs \u7684\u5b9a\u4e49\uff0c \u4ee5\u53ca\u5728 trap_hanlder \u4e2d\u8865\u5145\u5904\u7406 SYSCALL \u7684\u903b\u8f91\u3002 4.4 \u6dfb\u52a0\u7cfb\u7edf\u8c03\u7528 \u672c\u6b21\u5b9e\u9a8c\u8981\u6c42\u7684\u7cfb\u7edf\u8c03\u7528\u51fd\u6570\u539f\u578b\u4ee5\u53ca\u5177\u4f53\u529f\u80fd\u5982\u4e0b\uff1a 64 \u53f7\u7cfb\u7edf\u8c03\u7528 sys_write(unsigned int fd, const char* buf, size_t count) \u8be5\u8c03\u7528\u5c06\u7528\u6237\u6001\u4f20\u9012\u7684\u5b57\u7b26\u4e32\u6253\u5370\u5230\u5c4f\u5e55\u4e0a\uff0c\u6b64\u5904fd\u4e3a\u6807\u51c6\u8f93\u51fa\uff081\uff09\uff0cbuf\u4e3a\u7528\u6237\u9700\u8981\u6253\u5370\u7684\u8d77\u59cb\u5730\u5740\uff0ccount\u4e3a\u5b57\u7b26\u4e32\u957f\u5ea6\uff0c\u8fd4\u56de\u6253\u5370\u7684\u5b57\u7b26\u6570\u3002( \u5177\u4f53\u89c1 user/printf.c ) 172 \u53f7\u7cfb\u7edf\u8c03\u7528 sys_getpid() \u8be5\u8c03\u7528\u4ececurrent\u4e2d\u83b7\u53d6\u5f53\u524d\u7684pid\u653e\u5165a0\u4e2d\u8fd4\u56de\uff0c\u65e0\u53c2\u6570\u3002\uff08 \u5177\u4f53\u89c1 user/getpid.c \uff09 \u589e\u52a0 syscall.c syscall.h \u6587\u4ef6\uff0c \u5e76\u5728\u5176\u4e2d\u5b9e\u73b0 getpid \u4ee5\u53ca write \u903b\u8f91\u3002 \u7cfb\u7edf\u8c03\u7528\u7684\u8fd4\u56de\u53c2\u6570\u653e\u7f6e\u5728 a0 \u4e2d (\u4e0d\u53ef\u4ee5\u76f4\u63a5\u4fee\u6539\u5bc4\u5b58\u5668\uff0c \u5e94\u8be5\u4fee\u6539 regs \u4e2d\u4fdd\u5b58\u7684\u5185\u5bb9)\u3002 \u9488\u5bf9\u7cfb\u7edf\u8c03\u7528\u8fd9\u4e00\u7c7b\u5f02\u5e38\uff0c \u6211\u4eec\u9700\u8981\u624b\u52a8\u5c06 sepc + 4 \uff08 sepc \u8bb0\u5f55\u7684\u662f\u89e6\u53d1\u5f02\u5e38\u7684\u6307\u4ee4\u5730\u5740\uff0c \u7531\u4e8e\u7cfb\u7edf\u8c03\u7528\u8fd9\u7c7b\u5f02\u5e38\u5904\u7406\u5b8c\u6210\u4e4b\u540e\uff0c \u6211\u4eec\u5e94\u8be5\u7ee7\u7eed\u6267\u884c\u540e\u7eed\u7684\u6307\u4ee4\uff0c\u56e0\u6b64\u9700\u8981\u6211\u4eec\u624b\u52a8\u4fee\u6539 spec \u7684\u5730\u5740\uff0c\u4f7f\u5f97 sret \u4e4b\u540e \u7a0b\u5e8f\u7ee7\u7eed\u6267\u884c\uff09\u3002 4.5 \u4fee\u6539 head.S \u4ee5\u53ca start_kernel \u4e4b\u524d lab \u4e2d\uff0c \u5728 OS boot \u4e4b\u540e\uff0c\u6211\u4eec\u9700\u8981\u7b49\u5f85\u4e00\u4e2a\u65f6\u95f4\u7247\uff0c\u624d\u4f1a\u8fdb\u884c\u8c03\u5ea6\u3002\u6211\u4eec\u73b0\u5728\u66f4\u6539\u4e3a OS boot \u5b8c\u6210\u4e4b\u540e\u7acb\u5373\u8c03\u5ea6 uapp \u8fd0\u884c\u3002 \u5728 start_kernel \u4e2d\u8c03\u7528 schedule() \u6ce8\u610f\u653e\u7f6e\u5728 test() \u4e4b\u524d\u3002 \u5c06 head.S \u4e2d enable interrupt sstatus.SIE \u903b\u8f91\u6ce8\u91ca\uff0c\u786e\u4fdd schedule \u8fc7\u7a0b\u4e0d\u53d7\u4e2d\u65ad\u5f71\u54cd\u3002 4.6 \u7f16\u8bd1\u53ca\u6d4b\u8bd5 \u7531\u4e8e\u52a0\u5165\u4e86\u4e00\u4e9b\u65b0\u7684 .c \u6587\u4ef6\uff0c\u53ef\u80fd\u9700\u8981\u4fee\u6539\u4e00\u4e9bMakefile\u6587\u4ef6\uff0c\u8bf7\u540c\u5b66\u81ea\u5df1\u5c1d\u8bd5\u4fee\u6539\uff0c\u4f7f\u9879\u76ee\u53ef\u4ee5\u7f16\u8bd1\u5e76\u8fd0\u884c\u3002 \u8f93\u51fa\u793a\u4f8b 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 OpenSBI v0.9 ____ _____ ____ _____ / __ \\ / ____ | _ \\_ _ | | | | | _ __ ___ _ __ | ( ___ | | _ ) || | | | | | '_ \\ / _ \\ ' _ \\ \\_ __ \\| _ < | | | | __ | | | _ ) | __/ | | | ____ ) | | _ ) || | _ \\_ ___/ | .__/ \\_ __ | _ | | _ | _____/ | ____/_____ | | | | _ | ... Boot HART MIDELEG : 0x0000000000000222 Boot HART MEDELEG : 0x000000000000b109 ...mm_init done ! ...proc_init done ! [ S-MODE ] Hello RISC-V [ U-MODE ] pid: 4 , sp is 0000003fffffffe0 [ U-MODE ] pid: 3 , sp is 0000003fffffffe0 [ U-MODE ] pid: 2 , sp is 0000003fffffffe0 [ U-MODE ] pid: 1 , sp is 0000003fffffffe0 [ U-MODE ] pid: 4 , sp is 0000003fffffffe0 [ U-MODE ] pid: 3 , sp is 0000003fffffffe0 [ U-MODE ] pid: 2 , sp is 0000003fffffffe0 [ U-MODE ] pid: 1 , sp is 0000003fffffffe0 [ U-MODE ] pid: 4 , sp is 0000003fffffffe0 [ U-MODE ] pid: 3 , sp is 0000003fffffffe0 [ U-MODE ] pid: 2 , sp is 0000003fffffffe0 [ U-MODE ] pid: 1 , sp is 0000003fffffffe0 [ U-MODE ] pid: 4 , sp is 0000003fffffffe0 [ U-MODE ] pid: 3 , sp is 0000003fffffffe0 [ U-MODE ] pid: 2 , sp is 0000003fffffffe0 [ U-MODE ] pid: 1 , sp is 0000003fffffffe0 ... \u4f5c\u4e1a\u63d0\u4ea4 \u540c\u5b66\u9700\u8981\u63d0\u4ea4\u5b9e\u9a8c\u62a5\u544a\u4ee5\u53ca\u6574\u4e2a\u5de5\u7a0b\u4ee3\u7801\u3002\u5728\u63d0\u4ea4\u524d\u8bf7\u4f7f\u7528 make clean \u6e05\u9664\u6240\u6709\u6784\u5efa\u4ea7\u7269\u3002","title":"\u5b9e\u9a8c\u6307\u5bfc\u4e94"},{"location":"lab5/#lab-5-rv64","text":"","title":"Lab 5: RV64 \u7528\u6237\u6a21\u5f0f"},{"location":"lab5/#1","text":"\u521b\u5efa\u7528\u6237\u6001\u8fdb\u7a0b\uff0c\u5e76\u8bbe\u7f6e sstatus \u6765\u5b8c\u6210\u5185\u6838\u6001\u8f6c\u6362\u81f3\u7528\u6237\u6001\u3002 \u6b63\u786e\u8bbe\u7f6e\u7528\u6237\u8fdb\u7a0b\u7684 \u7528\u6237\u6001\u6808 \u548c \u5185\u6838\u6001\u6808 \uff0c \u5e76\u5728\u5f02\u5e38\u5904\u7406\u65f6\u6b63\u786e\u5207\u6362\u3002 \u8865\u5145\u5f02\u5e38\u5904\u7406\u903b\u8f91\uff0c\u5b8c\u6210\u6307\u5b9a\u7684\u7cfb\u7edf\u8c03\u7528\uff08 SYS_WRITE, SYS_GETPID \uff09\u529f\u80fd\u3002","title":"1 \u5b9e\u9a8c\u76ee\u7684"},{"location":"lab5/#2","text":"Docker in Lab0","title":"2 \u5b9e\u9a8c\u73af\u5883"},{"location":"lab5/#3","text":"","title":"3 \u80cc\u666f\u77e5\u8bc6"},{"location":"lab5/#30","text":"\u5728 lab4 \u4e2d\uff0c\u6211\u4eec\u5f00\u542f\u865a\u62df\u5185\u5b58\uff0c\u8fd9\u4e3a\u8fdb\u7a0b\u95f4\u5730\u5740\u7a7a\u95f4\u76f8\u4e92\u9694\u79bb\u6253\u4e0b\u4e86\u57fa\u7840\u3002\u4e4b\u524d\u7684\u5b9e\u9a8c\u4e2d\u6211\u4eec\u53ea\u521b\u5efa\u4e86\u5185\u6838\u7ebf\u7a0b\uff0c\u4ed6\u4eec\u5171\u7528\u4e86\u5730\u5740\u7a7a\u95f4 \uff08\u5171\u7528\u4e00\u4e2a \u5185\u6838\u9875\u8868 swapper_pg_dir \uff09\u3002\u5728\u672c\u6b21\u5b9e\u9a8c\u4e2d\u6211\u4eec\u5c06\u5f15\u5165\u7528\u6237\u6001\u8fdb\u7a0b\u3002\u5f53\u542f\u52a8\u7528\u6237\u6a21\u5f0f\u5e94\u7528\u7a0b\u5e8f\u65f6\uff0c\u5185\u6838\u5c06\u4e3a\u8be5\u5e94\u7528\u7a0b\u5e8f\u521b\u5efa\u4e00\u4e2a\u8fdb\u7a0b\uff0c\u4e3a\u5e94\u7528\u7a0b\u5e8f\u63d0\u4f9b\u4e86\u4e13\u7528\u865a\u62df\u5730\u5740\u7a7a\u95f4\u7b49\u8d44\u6e90\u3002\u56e0\u4e3a\u5e94\u7528\u7a0b\u5e8f\u7684\u865a\u62df\u5730\u5740\u7a7a\u95f4\u662f\u79c1\u6709\u7684\uff0c\u6240\u4ee5\u4e00\u4e2a\u5e94\u7528\u7a0b\u5e8f\u65e0\u6cd5\u66f4\u6539\u5c5e\u4e8e\u53e6\u4e00\u4e2a\u5e94\u7528\u7a0b\u5e8f\u7684\u6570\u636e\u3002\u6bcf\u4e2a\u5e94\u7528\u7a0b\u5e8f\u90fd\u662f\u72ec\u7acb\u8fd0\u884c\u7684\uff0c\u5982\u679c\u4e00\u4e2a\u5e94\u7528\u7a0b\u5e8f\u5d29\u6e83\uff0c\u5176\u4ed6\u5e94\u7528\u7a0b\u5e8f\u548c\u64cd\u4f5c\u7cfb\u7edf\u4e0d\u4f1a\u53d7\u5230\u5f71\u54cd\u3002\u540c\u65f6\uff0c\u7528\u6237\u6a21\u5f0f\u5e94\u7528\u7a0b\u5e8f\u53ef\u8bbf\u95ee\u7684\u865a\u62df\u5730\u5740\u7a7a\u95f4\u4e5f\u53d7\u5230\u9650\u5236\uff0c\u5728\u7528\u6237\u6a21\u5f0f\u4e0b\u65e0\u6cd5\u8bbf\u95ee\u5185\u6838\u7684\u865a\u62df\u5730\u5740\uff0c\u9632\u6b62\u5e94\u7528\u7a0b\u5e8f\u4fee\u6539\u5173\u952e\u64cd\u4f5c\u7cfb\u7edf\u6570\u636e\u3002\u5f53\u7528\u6237\u6001\u7a0b\u5e8f\u9700\u8981\u8bbf\u95ee\u5173\u952e\u8d44\u6e90\u7684\u65f6\u5019\uff0c\u53ef\u4ee5\u901a\u8fc7\u7cfb\u7edf\u8c03\u7528\u6765\u5b8c\u6210\u7528\u6237\u6001\u7a0b\u5e8f\u4e0e\u64cd\u4f5c\u7cfb\u7edf\u4e4b\u95f4\u7684\u4e92\u52a8\u3002","title":"3.0 \u524d\u8a00"},{"location":"lab5/#31-user","text":"\u5904\u7406\u5668\u5177\u6709\u4e24\u79cd\u4e0d\u540c\u7684\u6a21\u5f0f\uff1a\u7528\u6237\u6a21\u5f0f\u548c\u5185\u6838\u6a21\u5f0f\u3002\u5728\u5185\u6838\u6a21\u5f0f\u4e0b\uff0c\u6267\u884c\u4ee3\u7801\u5bf9\u5e95\u5c42\u786c\u4ef6\u5177\u6709\u5b8c\u6574\u4e14\u4e0d\u53d7\u9650\u5236\u7684\u8bbf\u95ee\u6743\u9650\uff0c\u5b83\u53ef\u4ee5\u6267\u884c\u4efb\u4f55 CPU \u6307\u4ee4\u5e76\u5f15\u7528\u4efb\u4f55\u5185\u5b58\u5730\u5740\u3002\u5728\u7528\u6237\u6a21\u5f0f\u4e0b\uff0c\u6267\u884c\u4ee3\u7801\u65e0\u6cd5\u76f4\u63a5\u8bbf\u95ee\u786c\u4ef6\uff0c\u5fc5\u987b\u59d4\u6258\u7ed9\u7cfb\u7edf\u63d0\u4f9b\u7684\u63a5\u53e3\u624d\u80fd\u8bbf\u95ee\u786c\u4ef6\u6216\u5185\u5b58\u3002\u5904\u7406\u5668\u6839\u636e\u5904\u7406\u5668\u4e0a\u8fd0\u884c\u7684\u4ee3\u7801\u7c7b\u578b\u5728\u4e24\u79cd\u6a21\u5f0f\u4e4b\u95f4\u5207\u6362\u3002\u5e94\u7528\u7a0b\u5e8f\u4ee5\u7528\u6237\u6a21\u5f0f\u8fd0\u884c\uff0c\u800c\u6838\u5fc3\u64cd\u4f5c\u7cfb\u7edf\u7ec4\u4ef6\u4ee5\u5185\u6838\u6a21\u5f0f\u8fd0\u884c\u3002","title":"3.1 User \u6a21\u5f0f\u57fa\u7840\u4ecb\u7ecd"},{"location":"lab5/#32","text":"\u7cfb\u7edf\u8c03\u7528\u662f\u7528\u6237\u6001\u5e94\u7528\u7a0b\u5e8f\u8bf7\u6c42\u5185\u6838\u670d\u52a1\u7684\u4e00\u79cd\u65b9\u5f0f\u3002\u5728 RISC-V \u4e2d\uff0c\u6211\u4eec\u4f7f\u7528 ecall \u6307\u4ee4\u8fdb\u884c\u7cfb\u7edf\u8c03\u7528\u3002\u5f53\u6267\u884c\u8fd9\u6761\u6307\u4ee4\u65f6\u5904\u7406\u5668\u4f1a\u63d0\u5347\u7279\u6743\u6a21\u5f0f\uff0c\u8df3\u8f6c\u5230\u5f02\u5e38\u5904\u7406\u51fd\u6570\u5904\u7406\u8fd9\u6761\u7cfb\u7edf\u8c03\u7528\u3002 Linux \u4e2d RISC-V \u76f8\u5173\u7684\u7cfb\u7edf\u8c03\u7528\u53ef\u4ee5\u5728 include/uapi/asm-generic/unistd.h \u4e2d\u627e\u5230\uff0c syscall(2) \u624b\u518c\u9875\u4e0a\u5bf9RISC-V\u67b6\u6784\u4e0a\u7684\u8c03\u7528\u8bf4\u660e\u8fdb\u884c\u4e86\u603b\u7ed3\uff0c\u7cfb\u7edf\u8c03\u7528\u53c2\u6570\u4f7f\u7528 a0 - a5 \uff0c\u7cfb\u7edf\u8c03\u7528\u53f7\u4f7f\u7528 a7 \uff0c \u7cfb\u7edf\u8c03\u7528\u7684\u8fd4\u56de\u503c\u4f1a\u88ab\u4fdd\u5b58\u5230 a0, a1 \u4e2d\u3002","title":"3.2 \u7cfb\u7edf\u8c03\u7528\u7ea6\u5b9a"},{"location":"lab5/#33-sstatussum-pteu","text":"\u5f53\u9875\u8868\u9879 PTE[U] \u7f6e 0 \u65f6\uff0c\u8be5\u9875\u8868\u9879\u5bf9\u5e94\u7684\u5185\u5b58\u9875\u4e3a\u5185\u6838\u9875\uff0c\u8fd0\u884c\u5728 U-Mode \u4e0b\u7684\u4ee3\u7801 \u65e0\u6cd5\u8bbf\u95ee \u3002\u5f53\u9875\u8868\u9879 PTE[U] \u7f6e 1 \u65f6\uff0c\u8be5\u9875\u8868\u9879\u5bf9\u5e94\u7684\u5185\u5b58\u9875\u4e3a\u7528\u6237\u9875\uff0c\u8fd0\u884c\u5728 S-Mode \u4e0b\u7684\u4ee3\u7801 \u65e0\u6cd5\u8bbf\u95ee \u3002\u5982\u679c\u60f3\u8ba9 S \u7279\u6743\u7ea7\u4e0b\u7684\u7a0b\u5e8f\u80fd\u591f\u8bbf\u95ee\u7528\u6237\u9875\uff0c\u9700\u8981\u5bf9 sstatus[SUM] \u4f4d\u7f6e 1 \u3002\u4f46\u662f\u65e0\u8bba\u4ec0\u4e48\u6837\u7684\u60c5\u51b5\u4e0b\uff0c\u7528\u6237\u9875\u4e2d\u7684\u6307\u4ee4\u5bf9\u4e8e S-Mode \u800c\u8a00\u90fd\u662f \u65e0\u6cd5\u6267\u884c \u7684\u3002","title":"3.3 sstatus[SUM] PTE[U]"},{"location":"lab5/#34","text":"\u5f53\u7528\u6237\u6001\u7a0b\u5e8f\u5728\u7528\u6237\u6001\u8fd0\u884c\u65f6\uff0c\u5176\u4f7f\u7528\u7684\u6808\u4e3a \u7528\u6237\u6001\u6808 \uff0c\u5f53\u8c03\u7528 SYSCALL\u65f6\u5019\uff0c\u9677\u5165\u5185\u6838\u5904\u7406\u65f6\u4f7f\u7528\u7684\u6808\u4e3a \u5185\u6838\u6001\u6808 \uff0c\u56e0\u6b64\u9700\u8981\u533a\u5206\u7528\u6237\u6001\u6808\u548c\u5185\u6838\u6001\u6808\uff0c\u5e76\u5728\u5f02\u5e38\u5904\u7406\u7684\u8fc7\u7a0b\u4e2d\u9700\u8981\u5bf9\u6808\u8fdb\u884c\u5207\u6362\u3002","title":"3.4 \u7528\u6237\u6001\u6808\u4e0e\u5185\u6838\u6001\u6808"},{"location":"lab5/#4","text":"","title":"4 \u5b9e\u9a8c\u6b65\u9aa4"},{"location":"lab5/#41","text":"\u6b64\u6b21\u5b9e\u9a8c\u57fa\u4e8e lab4 \u540c\u5b66\u6240\u5b9e\u73b0\u7684\u4ee3\u7801\u8fdb\u884c\u3002 \u9700\u8981\u4fee\u6539 vmlinux.lds.S \uff0c\u5c06\u7528\u6237\u6001\u7a0b\u5e8f uapp \u52a0\u8f7d\u81f3 .data \u6bb5\u3002\u6309\u5982\u4e0b\u4fee\u6539\uff1a 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 ... .data : ALIGN(0x1000){ _sdata = .; *(.sdata .sdata*) *(.data .data.*) _edata = .; . = ALIGN(0x1000); uapp_start = .; *(.uapp .uapp*) uapp_end = .; . = ALIGN(0x1000); } >ramv AT>ram ... \u9700\u8981\u4fee\u6539 defs.h \uff0c\u5728 defs.h \u6dfb\u52a0 \u5982\u4e0b\u5185\u5bb9\uff1a 1 2 #define USER_START (0x0000000000000000) // user space start virtual address #define USER_END (0x0000004000000000) // user space end virtual address \u4ece repo \u540c\u6b65\u4ee5\u4e0b\u6587\u4ef6\u5939: user \uff0c Makefile \u3002\u5e76\u6309\u7167\u4ee5\u4e0b\u6b65\u9aa4\u5c06\u8fd9\u4e9b\u6587\u4ef6\u6b63\u786e\u653e\u7f6e\u3002 1 2 3 4 5 6 7 8 9 10 11 12 13 14 . \u251c\u2500\u2500 arch \u2502 \u2514\u2500\u2500 riscv \u2502 \u2514\u2500\u2500 Makefile \u2514\u2500\u2500 user \u251c\u2500\u2500 Makefile \u251c\u2500\u2500 getpid.c \u251c\u2500\u2500 link.lds \u251c\u2500\u2500 printf.c \u251c\u2500\u2500 start.S \u251c\u2500\u2500 stddef.h \u251c\u2500\u2500 stdio.h \u251c\u2500\u2500 syscall.h \u2514\u2500\u2500 uapp.S \u4fee\u6539 \u6839\u76ee\u5f55 \u4e0b\u7684 Makefile, \u5c06 user \u7eb3\u5165\u5de5\u7a0b\u7ba1\u7406\u3002 \u5728\u6839\u76ee\u5f55\u4e0b make \u4f1a\u751f\u6210 user/uapp.o user/uapp.elf user/uapp.bin \u3002 \u901a\u8fc7 objdump \u6211\u4eec\u53ef\u4ee5\u770b\u5230 uapp \u4f7f\u7528 ecall \u6765\u8c03\u7528 SYSCALL (\u5728 U-Mode \u4e0b\u4f7f\u7528 ecall \u4f1a\u89e6\u53d1environment-call-from-U-mode\u5f02\u5e38)\u3002\u4ece\u800c\u5c06\u63a7\u5236\u6743\u4ea4\u7ed9\u5904\u5728 S-Mode \u7684 OS\uff0c \u7531\u5185\u6838\u6765\u5904\u7406\u76f8\u5173\u5f02\u5e38\u3002 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 0000000000000004 <getpid>: 4: fe010113 addi sp,sp,-32 8: 00813c23 sd s0,24(sp) c: 02010413 addi s0,sp,32 10: fe843783 ld a5,-24(s0) 14: 0ac00893 li a7,172 18: 00000073 ecall <- SYS_GETPID ... 00000000000000d8 <vprintfmt>: ... 60c: 00070513 mv a0,a4 610: 00068593 mv a1,a3 614: 00060613 mv a2,a2 618: 00000073 ecall <- SYS_WRITE ...","title":"4.1 \u51c6\u5907\u5de5\u7a0b"},{"location":"lab5/#42","text":"\u672c\u6b21\u5b9e\u9a8c\u53ea\u9700\u8981\u521b\u5efa 4 \u4e2a\u7528\u6237\u6001\u8fdb\u7a0b\uff0c\u4fee\u6539 proc.h \u4e2d\u7684 NR_TASKS \u5373\u53ef\u3002 \u7531\u4e8e\u521b\u5efa\u7528\u6237\u6001\u8fdb\u7a0b\u8981\u5bf9 sepc sstatus sscratch \u505a\u8bbe\u7f6e\uff0c\u6211\u4eec\u5c06\u5176\u52a0\u5165 thread_struct \u4e2d\u3002 \u7531\u4e8e\u591a\u4e2a\u7528\u6237\u6001\u8fdb\u7a0b\u9700\u8981\u4fdd\u8bc1\u76f8\u5bf9\u9694\u79bb\uff0c\u56e0\u6b64\u4e0d\u53ef\u4ee5\u5171\u7528\u9875\u8868\u3002\u6211\u4eec\u4e3a\u6bcf\u4e2a\u7528\u6237\u6001\u8fdb\u7a0b\u90fd\u521b\u5efa\u4e00\u4e2a\u9875\u8868\u3002\u4fee\u6539 task_struct \u5982\u4e0b\u3002 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 // proc.h typedef unsigned long * pagetable_t ; struct thread_struct { uint64_t ra ; uint64_t sp ; uint64_t s [ 12 ]; uint64_t sepc , sstatus , sscratch ; }; struct task_struct { struct thread_info * thread_info ; uint64_t state ; uint64_t counter ; uint64_t priority ; uint64_t pid ; struct thread_struct thread ; pagetable_t pgd ; }; \u4fee\u6539 task_init \u5bf9\u6bcf\u4e2a\u7528\u6237\u6001\u8fdb\u7a0b\uff0c\u5176\u62e5\u6709\u4e24\u4e2a stack\uff1a U-Mode Stack \u4ee5\u53ca S-Mode Stack \uff0c \u5176\u4e2d S-Mode Stack \u5728 lab3 \u4e2d\u6211\u4eec\u5df2\u7ecf\u8bbe\u7f6e\u597d\u4e86\u3002\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7 kalloc \u63a5\u53e3\u7533\u8bf7\u4e00\u4e2a\u7a7a\u7684\u9875\u9762\u6765\u4f5c\u4e3a U-Mode Stack \u3002 \u4e3a\u6bcf\u4e2a\u7528\u6237\u6001\u8fdb\u7a0b\u521b\u5efa\u81ea\u5df1\u7684\u9875\u8868 \u5e76\u5c06 uapp \u6240\u5728\u9875\u9762\uff0c\u4ee5\u53ca U-Mode Stack \u505a\u76f8\u5e94\u7684\u6620\u5c04\uff0c\u540c\u65f6\u4e3a\u4e86\u907f\u514d U-Mode \u548c S-Mode \u5207\u6362\u7684\u65f6\u5019\u5207\u6362\u9875\u8868\uff0c\u6211\u4eec\u4e5f\u5c06\u5185\u6838\u9875\u8868 \uff08 swapper_pg_dir \uff09 \u590d\u5236\u5230\u6bcf\u4e2a\u8fdb\u7a0b\u7684\u9875\u8868\u4e2d\u3002 \u5bf9\u6bcf\u4e2a\u7528\u6237\u6001\u8fdb\u7a0b\u6211\u4eec\u9700\u8981\u5c06 sepc \u4fee\u6539\u4e3a USER_START \uff0c \u8bbe\u7f6e sstatus \u4e2d\u7684 SPP \uff08 \u4f7f\u5f97 sret \u8fd4\u56de\u81f3 U-Mode \uff09\uff0c SPIE \uff08 sret \u4e4b\u540e\u5f00\u542f\u4e2d\u65ad \uff09\uff0c SUM \uff08 S-Mode \u53ef\u4ee5\u8bbf\u95ee User \u9875\u9762 \uff09\uff0c sscratch \u8bbe\u7f6e\u4e3a U-Mode \u7684 sp\uff0c\u5176\u503c\u4e3a USER_END \uff08\u5373 U-Mode Stack \u88ab\u653e\u7f6e\u5728 user space \u7684\u6700\u540e\u4e00\u4e2a\u9875\u9762\uff09\u3002 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 PHY_START PHY_END uapp_start uapp_end \u2502 \u2502 \u2502 \u2502 \u25bc \u25bc \u25bc \u25bc \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510 PA \u2502 \u2502 \u2502 uapp \u2502 \u2502 \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518 \u25b2 \u25b2 \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518 \u2502 \u2502 \u2502 \u2502 \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518 \u2502 \u2502 \u2502 \u2502 \u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510 VA \u2502 UAPP \u2502 \u2502u mode stack\u2502 \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518 \u25b2 \u25b2 \u2502 \u2502 USER_START USER_END * \u4fee\u6539 __switch_to\uff0c \u9700\u8981\u52a0\u5165 \u4fdd\u5b58/\u6062\u590d sepc sstatus sscratch \u4ee5\u53ca \u5207\u6362\u9875\u8868\u7684\u903b\u8f91\u3002","title":"4.2 \u521b\u5efa\u7528\u6237\u6001\u8fdb\u7a0b"},{"location":"lab5/#43-_trap-trap_handler","text":"\u4e0e ARM \u67b6\u6784\u4e0d\u540c\u7684\u662f\uff0cRISC-V \u4e2d\u53ea\u6709\u4e00\u4e2a\u6808\u6307\u9488\u5bc4\u5b58\u5668( sp )\uff0c\u56e0\u6b64\u9700\u8981\u6211\u4eec\u6765\u5b8c\u6210\u7528\u6237\u6808\u4e0e\u5185\u6838\u6808\u7684\u5207\u6362\u3002 \u7531\u4e8e\u6211\u4eec\u7684\u7528\u6237\u6001\u8fdb\u7a0b\u8fd0\u884c\u5728 U-Mode \u4e0b\uff0c \u4f7f\u7528\u7684\u8fd0\u884c\u6808\u4e5f\u662f U-Mode Stack \uff0c \u56e0\u6b64\u5f53\u89e6\u53d1\u5f02\u5e38\u65f6\uff0c \u6211\u4eec\u9996\u5148\u8981\u5bf9\u6808\u8fdb\u884c\u5207\u6362 \uff08 U-Mode Stack -> S-Mode Stack \uff09\u3002\u540c\u7406 \u8ba9\u6211\u4eec\u5b8c\u6210\u4e86\u5f02\u5e38\u5904\u7406\uff0c \u4ece S-Mode \u8fd4\u56de\u81f3 U-Mode \uff0c \u4e5f\u9700\u8981\u8fdb\u884c\u6808\u5207\u6362 \uff08 S-Mode Stack -> U-Mode Stack \uff09\u3002 \u4fee\u6539 __dummy \u3002\u5728 4.2 \u4e2d \u6211\u4eec\u521d\u59cb\u5316\u65f6\uff0c thread_struct.sp \u4fdd\u5b58\u4e86 S-Mode sp \uff0c thread_struct.sscratch \u4fdd\u5b58\u4e86 U-Mode sp \uff0c \u56e0\u6b64\u5728 S-Mode -> U->Mode \u7684\u65f6\u5019\uff0c\u6211\u4eec\u53ea\u9700\u8981\u4ea4\u6362\u5bf9\u5e94\u7684\u5bc4\u5b58\u5668\u7684\u503c\u5373\u53ef\u3002 \u4fee\u6539 _trap \u3002\u540c\u7406 \u5728 _trap \u7684\u9996\u5c3e\u6211\u4eec\u90fd\u9700\u8981\u505a\u7c7b\u4f3c\u7684\u64cd\u4f5c\u3002 \u6ce8\u610f\u5982\u679c\u662f \u5185\u6838\u7ebf\u7a0b( \u6ca1\u6709 U-Mode Stack ) \u89e6\u53d1\u4e86\u5f02\u5e38\uff0c\u5219\u4e0d\u9700\u8981\u8fdb\u884c\u5207\u6362\u3002\uff08\u5185\u6838\u7ebf\u7a0b\u7684 sp \u6c38\u8fdc\u6307\u5411\u7684 S-Mode Stack\uff0c sscratch \u4e3a 0\uff09 uapp \u4f7f\u7528 ecall \u4f1a\u4ea7\u751f ECALL_FROM_U_MODE exception \u3002\u56e0\u6b64\u6211\u4eec\u9700\u8981\u5728 trap_handler \u91cc\u9762\u8fdb\u884c\u6355\u83b7\u3002\u4fee\u6539 trap_handler \u5982\u4e0b\uff1a 1 2 3 void trap_handler ( uint64_t scause , uint64_t sepc , struct pt_regs * regs ) { ... } \u8fd9\u91cc\u9700\u8981\u89e3\u91ca\u65b0\u589e\u52a0\u7684\u7b2c\u4e09\u4e2a\u53c2\u6570 regs \uff0c \u5728 _trap \u4e2d\u6211\u4eec\u5c06\u5bc4\u5b58\u5668\u7684\u5185\u5bb9 \u8fde\u7eed \u7684\u4fdd\u5b58\u5728 S-Mode Stack\u4e0a\uff0c \u56e0\u6b64\u6211\u4eec\u53ef\u4ee5\u5c06\u8fd9\u4e00\u6bb5\u770b\u505a\u4e00\u4e2a\u53eb\u505a pt_regs \u7684\u7ed3\u6784\u4f53\u3002\u6211\u4eec\u53ef\u4ee5\u4ece\u8fd9\u4e2a\u7ed3\u6784\u4f53\u4e2d\u53d6\u5230\u76f8\u5e94\u7684\u5bc4\u5b58\u5668\u7684\u503c\uff08 \u6bd4\u5982 syscall \u4e2d\u6211\u4eec\u9700\u8981\u4ece a0 ~ a7 \u5bc4\u5b58\u5668\u4e2d\u53d6\u5230\u53c2\u6570 \uff09\u3002 \u793a\u4f8b\u5982\u4e0b\u56fe\uff1a 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 High Addr \u2500\u2500\u2500\u25ba \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510 \u2502 sstatus \u2502 \u2502 \u2502 \u2502 sepc \u2502 \u2502 \u2502 \u2502 x31 \u2502 \u2502 \u2502 \u2502 . \u2502 \u2502 . \u2502 \u2502 . \u2502 \u2502 \u2502 \u2502 x1 \u2502 \u2502 \u2502 \u2502 x0 \u2502 sp (pt_regs) \u2500\u2500\u25ba \u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524 \u2502 \u2502 \u2502 \u2502 \u2502 \u2502 \u2502 \u2502 \u2502 \u2502 \u2502 \u2502 \u2502 \u2502 \u2502 \u2502 \u2502 \u2502 Low Addr \u2500\u2500\u2500\u25ba \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518 \u8bf7\u540c\u5b66\u81ea\u5df1\u8865\u5145 struct pt_regs \u7684\u5b9a\u4e49\uff0c \u4ee5\u53ca\u5728 trap_hanlder \u4e2d\u8865\u5145\u5904\u7406 SYSCALL \u7684\u903b\u8f91\u3002","title":"4.3 \u4fee\u6539\u4e2d\u65ad\u5165\u53e3/\u8fd4\u56de\u903b\u8f91 ( _trap ) \u4ee5\u53ca\u4e2d\u65ad\u5904\u7406\u51fd\u6570 \uff08 trap_handler \uff09"},{"location":"lab5/#44","text":"\u672c\u6b21\u5b9e\u9a8c\u8981\u6c42\u7684\u7cfb\u7edf\u8c03\u7528\u51fd\u6570\u539f\u578b\u4ee5\u53ca\u5177\u4f53\u529f\u80fd\u5982\u4e0b\uff1a 64 \u53f7\u7cfb\u7edf\u8c03\u7528 sys_write(unsigned int fd, const char* buf, size_t count) \u8be5\u8c03\u7528\u5c06\u7528\u6237\u6001\u4f20\u9012\u7684\u5b57\u7b26\u4e32\u6253\u5370\u5230\u5c4f\u5e55\u4e0a\uff0c\u6b64\u5904fd\u4e3a\u6807\u51c6\u8f93\u51fa\uff081\uff09\uff0cbuf\u4e3a\u7528\u6237\u9700\u8981\u6253\u5370\u7684\u8d77\u59cb\u5730\u5740\uff0ccount\u4e3a\u5b57\u7b26\u4e32\u957f\u5ea6\uff0c\u8fd4\u56de\u6253\u5370\u7684\u5b57\u7b26\u6570\u3002( \u5177\u4f53\u89c1 user/printf.c ) 172 \u53f7\u7cfb\u7edf\u8c03\u7528 sys_getpid() \u8be5\u8c03\u7528\u4ececurrent\u4e2d\u83b7\u53d6\u5f53\u524d\u7684pid\u653e\u5165a0\u4e2d\u8fd4\u56de\uff0c\u65e0\u53c2\u6570\u3002\uff08 \u5177\u4f53\u89c1 user/getpid.c \uff09 \u589e\u52a0 syscall.c syscall.h \u6587\u4ef6\uff0c \u5e76\u5728\u5176\u4e2d\u5b9e\u73b0 getpid \u4ee5\u53ca write \u903b\u8f91\u3002 \u7cfb\u7edf\u8c03\u7528\u7684\u8fd4\u56de\u53c2\u6570\u653e\u7f6e\u5728 a0 \u4e2d (\u4e0d\u53ef\u4ee5\u76f4\u63a5\u4fee\u6539\u5bc4\u5b58\u5668\uff0c \u5e94\u8be5\u4fee\u6539 regs \u4e2d\u4fdd\u5b58\u7684\u5185\u5bb9)\u3002 \u9488\u5bf9\u7cfb\u7edf\u8c03\u7528\u8fd9\u4e00\u7c7b\u5f02\u5e38\uff0c \u6211\u4eec\u9700\u8981\u624b\u52a8\u5c06 sepc + 4 \uff08 sepc \u8bb0\u5f55\u7684\u662f\u89e6\u53d1\u5f02\u5e38\u7684\u6307\u4ee4\u5730\u5740\uff0c \u7531\u4e8e\u7cfb\u7edf\u8c03\u7528\u8fd9\u7c7b\u5f02\u5e38\u5904\u7406\u5b8c\u6210\u4e4b\u540e\uff0c \u6211\u4eec\u5e94\u8be5\u7ee7\u7eed\u6267\u884c\u540e\u7eed\u7684\u6307\u4ee4\uff0c\u56e0\u6b64\u9700\u8981\u6211\u4eec\u624b\u52a8\u4fee\u6539 spec \u7684\u5730\u5740\uff0c\u4f7f\u5f97 sret \u4e4b\u540e \u7a0b\u5e8f\u7ee7\u7eed\u6267\u884c\uff09\u3002","title":"4.4 \u6dfb\u52a0\u7cfb\u7edf\u8c03\u7528"},{"location":"lab5/#45-heads-start_kernel","text":"\u4e4b\u524d lab \u4e2d\uff0c \u5728 OS boot \u4e4b\u540e\uff0c\u6211\u4eec\u9700\u8981\u7b49\u5f85\u4e00\u4e2a\u65f6\u95f4\u7247\uff0c\u624d\u4f1a\u8fdb\u884c\u8c03\u5ea6\u3002\u6211\u4eec\u73b0\u5728\u66f4\u6539\u4e3a OS boot \u5b8c\u6210\u4e4b\u540e\u7acb\u5373\u8c03\u5ea6 uapp \u8fd0\u884c\u3002 \u5728 start_kernel \u4e2d\u8c03\u7528 schedule() \u6ce8\u610f\u653e\u7f6e\u5728 test() \u4e4b\u524d\u3002 \u5c06 head.S \u4e2d enable interrupt sstatus.SIE \u903b\u8f91\u6ce8\u91ca\uff0c\u786e\u4fdd schedule \u8fc7\u7a0b\u4e0d\u53d7\u4e2d\u65ad\u5f71\u54cd\u3002","title":"4.5 \u4fee\u6539 head.S \u4ee5\u53ca start_kernel"},{"location":"lab5/#46","text":"\u7531\u4e8e\u52a0\u5165\u4e86\u4e00\u4e9b\u65b0\u7684 .c \u6587\u4ef6\uff0c\u53ef\u80fd\u9700\u8981\u4fee\u6539\u4e00\u4e9bMakefile\u6587\u4ef6\uff0c\u8bf7\u540c\u5b66\u81ea\u5df1\u5c1d\u8bd5\u4fee\u6539\uff0c\u4f7f\u9879\u76ee\u53ef\u4ee5\u7f16\u8bd1\u5e76\u8fd0\u884c\u3002 \u8f93\u51fa\u793a\u4f8b 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 OpenSBI v0.9 ____ _____ ____ _____ / __ \\ / ____ | _ \\_ _ | | | | | _ __ ___ _ __ | ( ___ | | _ ) || | | | | | '_ \\ / _ \\ ' _ \\ \\_ __ \\| _ < | | | | __ | | | _ ) | __/ | | | ____ ) | | _ ) || | _ \\_ ___/ | .__/ \\_ __ | _ | | _ | _____/ | ____/_____ | | | | _ | ... Boot HART MIDELEG : 0x0000000000000222 Boot HART MEDELEG : 0x000000000000b109 ...mm_init done ! ...proc_init done ! [ S-MODE ] Hello RISC-V [ U-MODE ] pid: 4 , sp is 0000003fffffffe0 [ U-MODE ] pid: 3 , sp is 0000003fffffffe0 [ U-MODE ] pid: 2 , sp is 0000003fffffffe0 [ U-MODE ] pid: 1 , sp is 0000003fffffffe0 [ U-MODE ] pid: 4 , sp is 0000003fffffffe0 [ U-MODE ] pid: 3 , sp is 0000003fffffffe0 [ U-MODE ] pid: 2 , sp is 0000003fffffffe0 [ U-MODE ] pid: 1 , sp is 0000003fffffffe0 [ U-MODE ] pid: 4 , sp is 0000003fffffffe0 [ U-MODE ] pid: 3 , sp is 0000003fffffffe0 [ U-MODE ] pid: 2 , sp is 0000003fffffffe0 [ U-MODE ] pid: 1 , sp is 0000003fffffffe0 [ U-MODE ] pid: 4 , sp is 0000003fffffffe0 [ U-MODE ] pid: 3 , sp is 0000003fffffffe0 [ U-MODE ] pid: 2 , sp is 0000003fffffffe0 [ U-MODE ] pid: 1 , sp is 0000003fffffffe0 ...","title":"4.6 \u7f16\u8bd1\u53ca\u6d4b\u8bd5"},{"location":"lab5/#_1","text":"\u540c\u5b66\u9700\u8981\u63d0\u4ea4\u5b9e\u9a8c\u62a5\u544a\u4ee5\u53ca\u6574\u4e2a\u5de5\u7a0b\u4ee3\u7801\u3002\u5728\u63d0\u4ea4\u524d\u8bf7\u4f7f\u7528 make clean \u6e05\u9664\u6240\u6709\u6784\u5efa\u4ea7\u7269\u3002","title":"\u4f5c\u4e1a\u63d0\u4ea4"},{"location":"lab6/","text":"Lab 6: RV64 \u7f3a\u9875\u5f02\u5e38\u5904\u7406\u4ee5\u53ca fork \u673a\u5236 1. \u5b9e\u9a8c\u76ee\u7684 \u901a\u8fc7 vm_area_struct \u6570\u636e\u7ed3\u6784\u5b9e\u73b0\u5bf9\u8fdb\u7a0b \u591a\u533a\u57df \u865a\u62df\u5185\u5b58\u7684\u7ba1\u7406\u3002 \u5728 Lab5 \u5b9e\u73b0\u7528\u6237\u6001\u7a0b\u5e8f\u7684\u57fa\u7840\u4e0a\uff0c\u6dfb\u52a0\u7f3a\u9875\u5f02\u5e38\u5904\u7406 Page Fault Handler \u3002 \u4e3a\u8fdb\u7a0b\u52a0\u5165 fork \u673a\u5236\uff0c\u80fd\u591f\u652f\u6301\u901a\u8fc7 fork \u521b\u5efa\u65b0\u7684\u7528\u6237\u6001\u8fdb\u7a0b\u3002 2. \u5b9e\u9a8c\u73af\u5883 Docker in Lab0 3. \u80cc\u666f\u77e5\u8bc6 3.1 vm_area_struct \u4ecb\u7ecd \u5728linux\u7cfb\u7edf\u4e2d\uff0c vm_area_struct \u662f\u865a\u62df\u5185\u5b58\u7ba1\u7406\u7684\u57fa\u672c\u5355\u5143\uff0c vm_area_struct \u4fdd\u5b58\u4e86\u6709\u5173\u8fde\u7eed\u865a\u62df\u5185\u5b58\u533a\u57df(\u7b80\u79f0vma)\u7684\u4fe1\u606f\u3002linux \u5177\u4f53\u67d0\u4e00\u8fdb\u7a0b\u7684\u865a\u62df\u5185\u5b58\u533a\u57df\u6620\u5c04\u5173\u7cfb\u53ef\u4ee5\u901a\u8fc7 procfs\u3010Link\u3011 \u8bfb\u53d6 /proc/pid/maps \u7684\u5185\u5bb9\u6765\u83b7\u53d6: \u6bd4\u5982\uff0c\u5982\u4e0b\u4e00\u4e2a\u5e38\u89c4\u7684 bash \u8fdb\u7a0b\uff0c\u5047\u8bbe\u5b83\u7684\u8fdb\u7a0b\u53f7\u4e3a 7884 \uff0c\u5219\u901a\u8fc7\u8f93\u5165\u5982\u4e0b\u547d\u4ee4\uff0c\u5c31\u53ef\u4ee5\u67e5\u770b\u8be5\u8fdb\u7a0b\u5177\u4f53\u7684\u865a\u62df\u5730\u5740\u5185\u5b58\u6620\u5c04\u60c5\u51b5(\u90e8\u5206\u4fe1\u606f\u5df2\u7701\u7565)\u3002 1 2 3 4 5 6 7 8 9 10 11 12 13 14 #cat /proc/7884/maps 556f22759000-556f22786000 r--p 00000000 08 :05 16515165 /usr/bin/bash 556f22786000-556f22837000 r-xp 0002d000 08 :05 16515165 /usr/bin/bash 556f22837000-556f2286e000 r--p 000de000 08 :05 16515165 /usr/bin/bash 556f2286e000-556f22872000 r--p 00114000 08 :05 16515165 /usr/bin/bash 556f22872000-556f2287b000 rw-p 00118000 08 :05 16515165 /usr/bin/bash 556f22fa5000-556f2312c000 rw-p 00000000 00 :00 0 [ heap ] 7fb9edb0f000-7fb9edb12000 r--p 00000000 08 :05 16517264 /usr/lib/x86_64-linux-gnu/libnss_files-2.31.so 7fb9edb12000-7fb9edb19000 r-xp 00003000 08 :05 16517264 /usr/lib/x86_64-linux-gnu/libnss_files-2.31.so ... 7ffee5cdc000-7ffee5cfd000 rw-p 00000000 00 :00 0 [ stack ] 7ffee5dce000-7ffee5dd1000 r--p 00000000 00 :00 0 [ vvar ] 7ffee5dd1000-7ffee5dd2000 r-xp 00000000 00 :00 0 [ vdso ] ffffffffff600000-ffffffffff601000 --xp 00000000 00 :00 0 [ vsyscall ] \u4ece\u4e2d\u6211\u4eec\u53ef\u4ee5\u8bfb\u53d6\u5982\u4e0b\u4e00\u4e9b\u6709\u5173\u8be5\u8fdb\u7a0b\u5185\u865a\u62df\u5185\u5b58\u6620\u5c04\u7684\u5173\u952e\u4fe1\u606f\uff1a vm_start : (\u7b2c1\u5217) \u6307\u7684\u662f\u8be5\u6bb5\u865a\u62df\u5185\u5b58\u533a\u57df\u7684\u5f00\u59cb\u5730\u5740 vm_end : (\u7b2c2\u5217) \u6307\u7684\u662f\u8be5\u6bb5\u865a\u62df\u5185\u5b58\u533a\u57df\u7684\u7ed3\u675f\u5730\u5740 vm_flags : (\u7b2c3\u5217) \u8be5 vm_area \u7684\u4e00\u7ec4\u6743\u9650(rwx)\u6807\u5fd7\uff0c vm_flags \u7684\u5177\u4f53\u53d6\u503c\u5b9a\u4e49\u53ef\u53c2\u8003linux\u6e90\u4ee3\u7801\u7684 linux/mm.h vm_pgoff : (\u7b2c4\u5217) \u865a\u62df\u5185\u5b58\u6620\u5c04\u533a\u57df\u5728\u6587\u4ef6\u5185\u7684\u504f\u79fb\u91cf vm_file : (\u7b2c5/6/7\u5217)\u5206\u522b\u8868\u793a\uff1a\u6620\u5c04\u6587\u4ef6\u6240\u5c5e\u8bbe\u5907\u53f7/\u4ee5\u53ca\u6307\u5411\u5173\u8054\u6587\u4ef6\u7ed3\u6784\u7684\u6307\u9488(\u5982\u679c\u6709\u7684\u8bdd\uff0c\u4e00\u822c\u4e3a\u6587\u4ef6\u7cfb\u7edf\u7684inode)/\u4ee5\u53ca\u6587\u4ef6\u540d \u5176\u5b83\u4fdd\u5b58\u5728 vm_area_struct \u4e2d\u7684\u4fe1\u606f\u8fd8\u6709\uff1a vm_ops : \u8be5 vm_area \u4e2d\u7684\u4e00\u7ec4\u5de5\u4f5c\u51fd\u6570 vm_next/vm_prev : \u540c\u4e00\u8fdb\u7a0b\u7684\u6240\u6709\u865a\u62df\u5185\u5b58\u533a\u57df\u7531 \u94fe\u8868\u7ed3\u6784 \u94fe\u63a5\u8d77\u6765\uff0c\u8fd9\u662f\u5206\u522b\u6307\u5411\u524d\u540e\u4e24\u4e2a vm_area_struct \u7ed3\u6784\u4f53\u7684\u6307\u9488 3.2 \u7f3a\u9875\u5f02\u5e38 Page Fault \u7f3a\u9875\u5f02\u5e38\u662f\u4e00\u79cd\u6b63\u5728\u8fd0\u884c\u7684\u7a0b\u5e8f\u8bbf\u95ee\u5f53\u524d\u672a\u7531\u5185\u5b58\u7ba1\u7406\u5355\u5143\uff08 MMU \uff09\u6620\u5c04\u5230\u865a\u62df\u5185\u5b58\u7684\u9875\u9762\u65f6\uff0c\u7531\u8ba1\u7b97\u673a\u786c\u4ef6\u5f15\u53d1\u7684\u5f02\u5e38\u7c7b\u578b\u3002\u8bbf\u95ee\u672a\u88ab\u6620\u5c04\u7684\u9875\u6216\u8bbf\u95ee\u6743\u9650\u4e0d\u8db3\uff0c\u90fd\u4f1a\u5bfc\u81f4\u8be5\u7c7b\u5f02\u5e38\u7684\u53d1\u751f\u3002\u5904\u7406\u7f3a\u9875\u5f02\u5e38\u901a\u5e38\u662f\u64cd\u4f5c\u7cfb\u7edf\u5185\u6838\u7684\u4e00\u90e8\u5206\u3002\u5f53\u5904\u7406\u7f3a\u9875\u5f02\u5e38\u65f6\uff0c\u64cd\u4f5c\u7cfb\u7edf\u5c06\u5c1d\u8bd5\u4f7f\u6240\u9700\u9875\u9762\u5728\u7269\u7406\u5185\u5b58\u4e2d\u7684\u4f4d\u7f6e\u53d8\u5f97\u53ef\u8bbf\u95ee\uff08\u5efa\u7acb\u65b0\u7684\u6620\u5c04\u5173\u7cfb\u5230\u865a\u62df\u5185\u5b58\uff09\u3002\u800c\u5982\u679c\u5728\u975e\u6cd5\u8bbf\u95ee\u5185\u5b58\u7684\u60c5\u51b5\u4e0b\uff0c\u5373\u53d1\u73b0\u89e6\u53d1 Page Fault \u7684\u865a\u62df\u5185\u5b58\u5730\u5740\uff08 Bad Address \uff09\u4e0d\u5728\u5f53\u524d\u8fdb\u7a0b vm_area_struct \u94fe\u8868\u4e2d\u6240\u5b9a\u4e49\u7684\u5141\u8bb8\u8bbf\u95ee\u7684\u865a\u62df\u5185\u5b58\u5730\u5740\u8303\u56f4\u5185\uff0c\u6216\u8bbf\u95ee\u4f4d\u7f6e\u7684\u6743\u9650\u6761\u4ef6\u4e0d\u6ee1\u8db3\u65f6\uff0c\u7f3a\u9875\u5f02\u5e38\u5904\u7406\u5c06\u7ec8\u6b62\u8be5\u7a0b\u5e8f\u7684\u7ee7\u7eed\u8fd0\u884c\u3002 3.2.1 RISC-V Page Faults RISC-V \u5f02\u5e38\u5904\u7406\uff1a\u5f53\u7cfb\u7edf\u8fd0\u884c\u53d1\u751f\u5f02\u5e38\u65f6\uff0c\u53ef\u5373\u65f6\u5730\u901a\u8fc7\u89e3\u6790csr scause\u5bc4\u5b58\u5668\u7684\u503c\uff0c\u8bc6\u522b\u5982\u4e0b\u4e09\u79cd\u4e0d\u540c\u7684Page Fault\u3002 SCAUSE \u5bc4\u5b58\u5668\u6307\u793a\u53d1\u751f\u5f02\u5e38\u7684\u79cd\u7c7b\uff1a Interrupt Exception Code Description 0 12 Instruction Page Fault 0 13 Load Page Fault 0 15 Store/AMO Page Fault 3.2.2 \u5e38\u89c4\u5904\u7406 Page Fault \u7684\u65b9\u5f0f\u4ecb\u7ecd \u5904\u7406\u7f3a\u9875\u5f02\u5e38\u65f6\u6240\u9700\u7684\u4fe1\u606f\u5982\u4e0b\uff1a \u89e6\u53d1 Page Fault \u65f6\u8bbf\u95ee\u7684\u865a\u62df\u5185\u5b58\u5730\u5740 VA\u3002\u5f53\u89e6\u53d1 page fault \u65f6\uff0c stval \u5bc4\u5b58\u5668\u88ab\u88ab\u786c\u4ef6\u81ea\u52a8\u8bbe\u7f6e\u4e3a\u8be5\u51fa\u9519\u7684VA\u5730\u5740 \u5bfc\u81f4 Page Fault \u7684\u7c7b\u578b\uff1a Exception Code = 12: page fault caused by an instruction fetch Exception Code = 13: page fault caused by a read Exception Code = 15: page fault caused by a write \u53d1\u751f Page Fault \u65f6\u7684\u6307\u4ee4\u6267\u884c\u4f4d\u7f6e\uff0c\u4fdd\u5b58\u5728 sepc \u4e2d \u5f53\u524d\u8fdb\u7a0b\u5408\u6cd5\u7684 VMA \u6620\u5c04\u5173\u7cfb\uff0c\u4fdd\u5b58\u5728 vm_area_struct \u94fe\u8868\u4e2d 3.3 fork \u7cfb\u7edf\u8c03\u7528 fork() \u901a\u8fc7\u590d\u5236\u5f53\u524d\u8fdb\u7a0b\u521b\u5efa\u4e00\u4e2a\u65b0\u7684\u8fdb\u7a0b\uff0c\u65b0\u8fdb\u7a0b\u79f0\u4e3a\u5b50\u8fdb\u7a0b\uff0c\u800c\u539f\u8fdb\u7a0b\u79f0\u4e3a\u7236\u8fdb\u7a0b\u3002 \u5b50\u8fdb\u7a0b\u548c\u7236\u8fdb\u7a0b\u5728\u4e0d\u540c\u7684\u5185\u5b58\u7a7a\u95f4\u4e0a\u8fd0\u884c\u3002 \u7236\u8fdb\u7a0b fork \u6210\u529f\u65f6 \u8fd4\u56de\uff1a\u5b50\u8fdb\u7a0b\u7684pid \uff0c\u5b50\u8fdb\u7a0b \u8fd4\u56de\uff1a0 \u3002 fork \u5931\u8d25\u5219\u7236\u8fdb\u7a0b \u8fd4\u56de\uff1a-1 \u3002 \u521b\u5efa\u7684\u5b50\u8fdb\u7a0b\u9700\u8981\u62f7\u8d1d\u7236\u8fdb\u7a0b task_struct \u3001 pgd \u3001 mm_struct \u4ee5\u53ca\u7236\u8fdb\u7a0b\u7684 user stack \u7b49\u4fe1\u606f\u3002 Linux \u4e2d\u4f7f\u7528\u4e86 copy-on-write \u673a\u5236\uff0c fork \u521b\u5efa\u7684\u5b50\u8fdb\u7a0b\u9996\u5148\u4e0e\u7236\u8fdb\u7a0b\u5171\u4eab\u7269\u7406\u5185\u5b58\u7a7a\u95f4\uff0c\u76f4\u5230\u7236\u5b50\u8fdb\u7a0b\u6709\u4fee\u6539\u5185\u5b58\u7684\u64cd\u4f5c\u53d1\u751f\u65f6\u518d\u4e3a\u5b50\u8fdb\u7a0b\u5206\u914d\u7269\u7406\u5185\u5b58\u3002 4 \u5b9e\u9a8c\u6b65\u9aa4 4.1 \u51c6\u5907\u5de5\u4f5c \u6b64\u6b21\u5b9e\u9a8c\u57fa\u4e8e lab5 \u540c\u5b66\u6240\u5b9e\u73b0\u7684\u4ee3\u7801\u8fdb\u884c\u3002 \u4ece repo \u540c\u6b65\u4ee5\u4e0b\u6587\u4ef6\u5939: user \u5e76\u6309\u7167\u4ee5\u4e0b\u6b65\u9aa4\u5c06\u8fd9\u4e9b\u6587\u4ef6\u6b63\u786e\u653e\u7f6e\u3002 1 2 3 4 5 6 7 8 9 10 11 . \u2514\u2500\u2500 user \u251c\u2500\u2500 Makefile \u251c\u2500\u2500 getpid.c \u251c\u2500\u2500 link.lds \u251c\u2500\u2500 printf.c \u251c\u2500\u2500 start.S \u251c\u2500\u2500 stddef.h \u251c\u2500\u2500 stdio.h \u251c\u2500\u2500 syscall.h \u2514\u2500\u2500 uapp.S \u5728 user/getpid.c \u4e2d\u6211\u4eec\u8bbe\u7f6e\u4e86\u4e09\u4e2a main \u51fd\u6570\u3002\u5728\u5b9e\u73b0\u4e86 Page Fault \u4e4b\u540e\u7b2c\u4e00\u4e2a main \u51fd\u6570\u53ef\u4ee5\u6210\u529f\u8fd0\u884c\u3002\u5728\u5b9e\u73b0\u4e86 fork \u4e4b\u540e\u5176\u4f59\u4e24\u4e2a main \u51fd\u6570\u53ef\u4ee5\u6210\u529f\u8fd0\u884c\u3002 \u4fee\u6539 task_init \u51fd\u6570\u4e2d\u4fee\u6539\u4e3a\u4ec5\u521d\u59cb\u5316\u4e00\u4e2a\u8fdb\u7a0b\uff0c\u4e4b\u540e\u5176\u4f59\u7684\u8fdb\u7a0b\u5747\u901a\u8fc7 fork \u521b\u5efa\u3002 4.2 \u5b9e\u73b0\u865a\u62df\u5185\u5b58\u7ba1\u7406\u529f\u80fd\uff1a \u4fee\u6539 proc.h \u5982\u4e0b 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 /* vm_area_struct vm_flags */ #define VM_READ 0x00000001 #define VM_WRITE 0x00000002 #define VM_EXEC 0x00000004 struct vm_area_struct { struct mm_struct * vm_mm ; /* The mm_struct we belong to. */ uint64_t vm_start ; /* Our start address within vm_mm. */ uint64_t vm_end ; /* The first byte after our end address within vm_mm. */ /* linked list of VM areas per task, sorted by address */ struct vm_area_struct * vm_next , * vm_prev ; uint64_t vm_flags ; /* Flags as listed above. */ }; struct mm_struct { struct vm_area_struct * mmap ; /* list of VMAs */ }; struct task_struct { struct thread_info * thread_info ; uint64_t state ; uint64_t counter ; uint64_t priority ; uint64_t pid ; struct thread_struct thread ; pagetable_t pgd ; struct mm_struct * mm ; }; \u6bcf\u4e00\u4e2a vm_area_struct \u90fd\u5bf9\u5e94\u4e8e\u8fdb\u7a0b\u5730\u5740\u7a7a\u95f4\u7684\u552f\u4e00\u533a\u95f4\u3002 \u4e3a\u4e86\u652f\u6301 Demand Paging \uff08\u89c1 4.3\uff09\uff0c\u6211\u4eec\u9700\u8981\u652f\u6301\u5bf9 vm_area_struct \u7684\u6dfb\u52a0\uff0c\u67e5\u627e\u3002 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 /* * @mm : current thread's mm_struct * @address : the va to look up * * @return : the VMA if found or NULL if not found */ struct vm_area_struct * find_vma ( struct mm_struct * mm , uint64_t addr ) { } /* * @mm : current thread's mm_struct * @addr : the suggested va to map * @length : memory size to map * @prot : protection * * @return : start va */ uint64_t do_mmap ( struct mm_struct * mm , uint64_t addr , uint64_t length , int prot ) { /* \u9700\u8981\u6ce8\u610f\u7684\u662f do_mmap \u4e2d\u7684 addr \u53ef\u80fd\u65e0\u6cd5\u88ab\u6ee1\u8db3 \u6bd4\u5982 addr \u5df2\u7ecf\u88ab\u5360\u7528, \u56e0\u6b64\u9700\u8981\u5224\u65ad\uff0c \u5982\u679c\u4e0d\u5408\u6cd5\uff0c\u9700\u8981\u91cd\u65b0\u627e\u5230\u4e00\u4e2a\u5408\u9002\u7684\u4f4d\u7f6e\u8fdb\u884c\u6620\u5c04\u3002 */ } 4.3 Page Fault Handler Demand Paging \u5728\u6620\u5c04\u9875\u9762\u65f6\uff0c\u6211\u4eec\u4e0d\u771f\u6b63\u5bf9\u9875\u8868\u8fdb\u884c\u4fee\u6539\uff0c\u53ea\u5728 mm->mmap \u94fe\u8868\u4e0a\u6dfb\u52a0\u4e00\u4e2a vma \u8bb0\u5f55\u3002 \u5f53\u6211\u4eec\u771f\u6b63\u8bbf\u95ee\u8fd9\u4e2a\u9875\u9762\u65f6\uff0c\u6211\u4eec\u9700\u8981\u6839\u636e\u7f3a\u9875\u7684\u5730\u5740\uff0c\u627e\u5230\u5176\u6240\u5728\u7684 vma \uff0c\u6839\u636e vma \u4e2d\u7684\u4fe1\u606f\u5bf9\u9875\u8868\u8fdb\u884c\u6620\u5c04\u3002 \u4fee\u6539 task_init \u51fd\u6570\u4ee3\u7801\uff0c\u66f4\u6539\u4e3a Demand Paging \u5220\u9664\u4e4b\u524d\u5b9e\u9a8c\u4e2d\u5bf9 U-MODE \u4ee3\u7801\uff0c\u6808\u8fdb\u884c\u6620\u5c04\u7684\u4ee3\u7801 \u8c03\u7528 do_mmap \u51fd\u6570\uff0c\u5efa\u7acb\u7528\u6237\u8fdb\u7a0b\u7684\u865a\u62df\u5730\u5740\u7a7a\u95f4\u4fe1\u606f\uff0c\u5305\u62ec\u4e24\u4e2a\u533a\u57df: \u4ee3\u7801\u533a\u57df, \u8be5\u533a\u57df\u4ece\u865a\u62df\u5730\u5740 USER_START \u5f00\u59cb\uff0c\u5927\u5c0f\u4e3a uapp_end - uapp_start \uff0c \u6743\u9650\u4e3a VM_READ | VM_WRITE | VM_EXEC \u7528\u6237\u6808\uff0c\u8303\u56f4\u4e3a [USER_END - PGSIZE, USER_END) \uff0c\u6743\u9650\u4e3a VM_READ | VM_WRITE \u5728\u5b8c\u6210\u4e0a\u8ff0\u4fee\u6539\u4e4b\u540e\uff0c\u5982\u679c\u8fd0\u884c\u4ee3\u7801\u6211\u4eec\u53ef\u4ee5\u622a\u83b7 \u4e00\u4e2a page fault. \u5982\u4e0b\u56fe \uff08\u6ce8\u610f\uff1a\u7531\u4e8e\u8bd5\u4f8b\u4ee3\u7801\u4ee5\u53ca\u6b63\u786e\u5904\u7406 page fault\uff0c \u6240\u4ee5\u6211\u4eec\u53ef\u4ee5\u770b\u5230\u4e00\u7cfb\u5217\u7684page fault \uff09 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 // Instruction Page Fault scause = 0x000000000000000c, sepc = 0x0000000000000000, stval = 0x0000000000000000 // Store/AMO Page Fault: sepc \u662f code address\uff0c stval \u662f \u5199\u5165\u7684\u5730\u5740 ( \u4f4d\u4e8e user stack \u5185 ) \u3002 scause = 0x000000000000000f, sepc = 0x0000000000000070, stval = 0x0000003ffffffff8 ************************** uapp asm ************************** ..... Disassembly of section .text.main: 000000000000006c <main>: 6c: fe010113 addi sp,sp,-32 70 : 00113c23 sd ra,24 ( sp ) <- Page Fault 74 : 00813823 sd s0,16 ( sp ) 78 : 02010413 addi s0,sp,32 7c: fbdff0ef jal ra,38 <fork> 80 : 00050793 mv a5,a0 84 : fef42223 sw a5,-28 ( s0 ) 88 : fe442783 lw a5,-28 ( s0 ) ...... ************************** uapp asm ************************** \u5b9e\u73b0 Page Fault \u7684\u68c0\u6d4b\u4e0e\u5904\u7406 \u4fee\u6539 trap.c , \u6dfb\u52a0\u6355\u83b7 Page Fault \u7684\u903b\u8f91 \u5f53\u6355\u83b7\u4e86 Page Fault \u4e4b\u540e\uff0c\u9700\u8981\u5b9e\u73b0\u7f3a\u9875\u5f02\u5e38\u7684\u5904\u7406\u51fd\u6570 do_page_fault 1 2 3 4 5 6 7 8 9 10 11 12 void do_page_fault ( struct pt_regs * regs ) { /* 1. \u901a\u8fc7 stval \u83b7\u5f97\u8bbf\u95ee\u51fa\u9519\u7684\u865a\u62df\u5185\u5b58\u5730\u5740\uff08Bad Address\uff09 2. \u901a\u8fc7 sepc \u83b7\u5f97\u5f53\u524d\u7684 Page Fault \u7c7b\u578b 3. \u901a\u8fc7 find_vm() \u627e\u5230\u5339\u914d\u7684 vm_area 4. \u901a\u8fc7 vm_area \u7684 vm_flags \u5bf9\u5f53\u524d\u7684 Page Fault \u7c7b\u578b\u8fdb\u884c\u68c0\u67e5 4.1 Instruction Page Fault -> VM_EXEC 4.2 Load Page Fault -> VM_READ 4.3 Store Page Fault -> VM_WRITE 5. \u6700\u540e\u8c03\u7528 create_mapping \u5bf9\u9875\u8868\u8fdb\u884c\u6620\u5c04 */ } 4.4 \u5b9e\u73b0 fork() \u4fee\u6539 task_struct \u589e\u52a0\u7ed3\u6784\u6210\u5458 trapframe \uff0c \u5982\u4e0b\uff1a 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 struct task_struct { struct thread_info * thread_info ; uint64_t state ; uint64_t counter ; uint64_t priority ; uint64_t pid ; struct thread_struct thread ; pagetable_t pgd ; struct mm_struct * mm ; struct pt_regs * trapframe ; }; trapframe \u6210\u5458\u7528\u4e8e\u4fdd\u5b58\u5f02\u5e38\u4e0a\u4e0b\u6587\uff0c\u5f53\u6211\u4eec fork \u51fa\u6765\u4e00\u4e2a\u5b50\u8fdb\u7a0b\u65f6\u5019\uff0c\u6211\u4eec\u5c06\u7236\u8fdb\u7a0b\u7684\u4e0a\u4e0b\u6587\u73af\u5883\u590d\u5236\u5230\u5b50\u8fdb\u7a0b\u7684 trapframe \u4e2d\u3002\u5f53\u5b50\u8fdb\u7a0b\u88ab\u8c03\u5ea6\u65f6\u5019\uff0c\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7 trapframe \u6765\u6062\u590d\u4e0a\u4e0b\u6587\u73af\u5883\u3002 fork() \u6240\u8c03\u7528\u7684 syscall \u4e3a SYS_CLONE\uff0c\u7cfb\u7edf\u8c03\u7528\u53f7\u4e3a 220 1 #define SYS_CLONE 220 \u5b9e\u73b0 clone \uff0c \u4e3a\u4e86\u7b80\u5355\u8d77\u89c1 clone \u53ea\u63a5\u53d7\u4e00\u4e2a\u53c2\u6570 pt_regs * 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 void forkret () { ret_from_fork ( current -> trapframe ); } uint64_t do_fork ( struct pt_regs * regs ) { /* 1. \u53c2\u8003 task_init \u521b\u5efa\u4e00\u4e2a\u65b0\u7684 \u5b50\u8fdb\u7a0b, \u5c06 thread.ra \u8bbe\u7f6e\u4e3a forkret 2. \u4e3a\u5b50\u8fdb\u7a0b\u7533\u8bf7 user stack, \u5e76\u5c06\u7236\u8fdb\u7a0b\u7684 user stack \u6570\u636e\u590d\u5236\u5230\u5176 \u4e2d. \u540c\u65f6\u5c06\u5b50\u8fdb\u7a0b\u7684 user stack \u7684\u5730\u5740\u4fdd\u5b58\u5728 thread_info->user_sp \u4e2d 3. \u5728 task_init \u4e2d\u6211\u4eec\u8fdb\u7a0b\u7684 user-mode sp \u53ef\u4ee5\u76f4\u63a5\u8bbe\u7f6e\u4e3a USER_END, \u4f46\u662f\u8fd9\u91cc\u9700\u8981\u8bbe\u7f6e\u4e3a\u5f53\u524d\u8fdb\u7a0b(\u7236\u8fdb\u7a0b)\u7684 user-mode sp 4. \u5c06\u7236\u8fdb\u7a0b\u4e0a\u4e0b\u6587\u73af\u5883\u4fdd\u5b58\u5230\u5b50\u8fdb\u7a0b\u7684 trapframe \u4e2d 5. \u5c06\u5b50\u8fdb\u7a0b\u7684 trapframe->a0 \u4fee\u6539\u4e3a 0 6. \u590d\u5236\u7236\u8fdb\u7a0b\u7684 mm_struct \u4ee5\u53ca vm_area_struct 7. \u521b\u5efa\u5b50\u8fdb\u7a0b\u7684\u9875\u8868 \u8fd9\u91cc\u53ea\u505a\u5185\u6838\u7684\u6620\u5c04,\u5373 swapper_pg_dir 8. \u8fd4\u56de\u5b50\u8fdb\u7a0b\u7684 pid */ } uint64_t clone ( struct pt_regs * regs ) { return do_fork ( regs ); } \u53c2\u8003 _trap \u4e2d\u7684\u6062\u590d\u903b\u8f91 \u5728 entry.S \u4e2d\u5b9e\u73b0 ret_from_fork , \u51fd\u6570\u539f\u578b\u5982\u4e0b\uff1a \u6ce8\u610f\u6062\u590d\u5bc4\u5b58\u5668\u7684\u987a\u5e8f _trap \u4e2d\u662f\u4ece stack \u4e0a\u6062\u590d\uff0c\u8fd9\u91cc\u4ece trapframe \u4e2d\u6062\u590d 1 void ret_from_fork ( struct pt_regs * trapframe ); \u4fee\u6539 Page Fault \u5904\u7406: \u5728\u4e4b\u524d\u7684 Page Fault \u5904\u7406\u4e2d\uff0c\u6211\u4eec\u5bf9\u7528\u6237\u6808 Page Fault \u5904\u7406\u65b9\u6cd5\u662f\u81ea\u7531\u5206\u914d\u4e00\u9875\u4f5c\u4e3a\u7528\u6237\u6808\u5e76\u6620\u5c04\u5230 [USER_END - PAGE_SIZE, USER_END) \u7684\u865a\u62df\u5730\u5740\u3002\u4f46\u7531 fork \u521b\u5efa\u7684\u8fdb\u7a0b\uff0c\u5b83\u7684\u7528\u6237\u6808\u5df2\u7ecf\u62f7\u8d1d\u5b8c\u6bd5\uff0c\u56e0\u6b64 Page Fault \u5904\u7406\u65f6\u76f4\u63a5\u4e3a\u8be5\u9875\u5efa\u7acb\u6620\u5c04\u5373\u53ef ( \u901a\u8fc7 thread_info->user_sp \u6765\u8fdb\u884c\u5224\u65ad)\u3002 4.5 \u7f16\u8bd1\u53ca\u6d4b\u8bd5 \u8f93\u51fa\u793a\u4f8b 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 OpenSBI v0.9 ____ _____ ____ _____ / __ \\ / ____ | _ \\_ _ | | | | | _ __ ___ _ __ | ( ___ | | _ ) || | | | | | '_ \\ / _ \\ ' _ \\ \\_ __ \\| _ < | | | | __ | | | _ ) | __/ | | | ____ ) | | _ ) || | _ \\_ ___/ | .__/ \\_ __ | _ | | _ | _____/ | ____/_____ | | | | _ | ... Boot HART MIDELEG : 0x0000000000000222 Boot HART MEDELEG : 0x000000000000b109 ...mm_init done ! ...proc_init done ! [ S-MODE ] Hello RISC-V scause = 0x000000000000000c, sepc = 0x0000000000000000, stval = 0x0000000000000000 scause = 0x000000000000000f, sepc = 0x0000000000000070, stval = 0x0000003ffffffff8 [ PID = 1 ] fork [ PID = 2 ] [ PID = 1 ] fork [ PID = 3 ] [ PID = 1 ] is running! scause = 0x000000000000000c, sepc = 0x0000000000000050, stval = 0x0000000000000050 scause = 0x000000000000000f, sepc = 0x0000000000000054, stval = 0x0000003fffffffc8 [ PID = 3 ] is running! scause = 0x000000000000000c, sepc = 0x0000000000000050, stval = 0x0000000000000050 scause = 0x000000000000000f, sepc = 0x0000000000000054, stval = 0x0000003fffffffc8 [ PID = 2 ] fork [ PID = 4 ] [ PID = 2 ] is running! [ PID = 1 ] is running! scause = 0x000000000000000c, sepc = 0x0000000000000050, stval = 0x0000000000000050 scause = 0x000000000000000f, sepc = 0x0000000000000054, stval = 0x0000003fffffffc8 [ PID = 4 ] is running! [ PID = 3 ] is running! [ PID = 2 ] is running! ... \u4f5c\u4e1a\u63d0\u4ea4 \u540c\u5b66\u9700\u8981\u63d0\u4ea4\u5b9e\u9a8c\u62a5\u544a\u4ee5\u53ca\u6574\u4e2a\u5de5\u7a0b\u4ee3\u7801\u3002\u5728\u63d0\u4ea4\u524d\u8bf7\u4f7f\u7528 make clean \u6e05\u9664\u6240\u6709\u6784\u5efa\u4ea7\u7269\u3002","title":"\u5b9e\u9a8c\u6307\u5bfc\u516d"},{"location":"lab6/#lab-6-rv64-fork","text":"","title":"Lab 6: RV64 \u7f3a\u9875\u5f02\u5e38\u5904\u7406\u4ee5\u53ca fork \u673a\u5236"},{"location":"lab6/#1","text":"\u901a\u8fc7 vm_area_struct \u6570\u636e\u7ed3\u6784\u5b9e\u73b0\u5bf9\u8fdb\u7a0b \u591a\u533a\u57df \u865a\u62df\u5185\u5b58\u7684\u7ba1\u7406\u3002 \u5728 Lab5 \u5b9e\u73b0\u7528\u6237\u6001\u7a0b\u5e8f\u7684\u57fa\u7840\u4e0a\uff0c\u6dfb\u52a0\u7f3a\u9875\u5f02\u5e38\u5904\u7406 Page Fault Handler \u3002 \u4e3a\u8fdb\u7a0b\u52a0\u5165 fork \u673a\u5236\uff0c\u80fd\u591f\u652f\u6301\u901a\u8fc7 fork \u521b\u5efa\u65b0\u7684\u7528\u6237\u6001\u8fdb\u7a0b\u3002","title":"1. \u5b9e\u9a8c\u76ee\u7684"},{"location":"lab6/#2","text":"Docker in Lab0","title":"2. \u5b9e\u9a8c\u73af\u5883"},{"location":"lab6/#3","text":"","title":"3. \u80cc\u666f\u77e5\u8bc6"},{"location":"lab6/#31-vm_area_struct","text":"\u5728linux\u7cfb\u7edf\u4e2d\uff0c vm_area_struct \u662f\u865a\u62df\u5185\u5b58\u7ba1\u7406\u7684\u57fa\u672c\u5355\u5143\uff0c vm_area_struct \u4fdd\u5b58\u4e86\u6709\u5173\u8fde\u7eed\u865a\u62df\u5185\u5b58\u533a\u57df(\u7b80\u79f0vma)\u7684\u4fe1\u606f\u3002linux \u5177\u4f53\u67d0\u4e00\u8fdb\u7a0b\u7684\u865a\u62df\u5185\u5b58\u533a\u57df\u6620\u5c04\u5173\u7cfb\u53ef\u4ee5\u901a\u8fc7 procfs\u3010Link\u3011 \u8bfb\u53d6 /proc/pid/maps \u7684\u5185\u5bb9\u6765\u83b7\u53d6: \u6bd4\u5982\uff0c\u5982\u4e0b\u4e00\u4e2a\u5e38\u89c4\u7684 bash \u8fdb\u7a0b\uff0c\u5047\u8bbe\u5b83\u7684\u8fdb\u7a0b\u53f7\u4e3a 7884 \uff0c\u5219\u901a\u8fc7\u8f93\u5165\u5982\u4e0b\u547d\u4ee4\uff0c\u5c31\u53ef\u4ee5\u67e5\u770b\u8be5\u8fdb\u7a0b\u5177\u4f53\u7684\u865a\u62df\u5730\u5740\u5185\u5b58\u6620\u5c04\u60c5\u51b5(\u90e8\u5206\u4fe1\u606f\u5df2\u7701\u7565)\u3002 1 2 3 4 5 6 7 8 9 10 11 12 13 14 #cat /proc/7884/maps 556f22759000-556f22786000 r--p 00000000 08 :05 16515165 /usr/bin/bash 556f22786000-556f22837000 r-xp 0002d000 08 :05 16515165 /usr/bin/bash 556f22837000-556f2286e000 r--p 000de000 08 :05 16515165 /usr/bin/bash 556f2286e000-556f22872000 r--p 00114000 08 :05 16515165 /usr/bin/bash 556f22872000-556f2287b000 rw-p 00118000 08 :05 16515165 /usr/bin/bash 556f22fa5000-556f2312c000 rw-p 00000000 00 :00 0 [ heap ] 7fb9edb0f000-7fb9edb12000 r--p 00000000 08 :05 16517264 /usr/lib/x86_64-linux-gnu/libnss_files-2.31.so 7fb9edb12000-7fb9edb19000 r-xp 00003000 08 :05 16517264 /usr/lib/x86_64-linux-gnu/libnss_files-2.31.so ... 7ffee5cdc000-7ffee5cfd000 rw-p 00000000 00 :00 0 [ stack ] 7ffee5dce000-7ffee5dd1000 r--p 00000000 00 :00 0 [ vvar ] 7ffee5dd1000-7ffee5dd2000 r-xp 00000000 00 :00 0 [ vdso ] ffffffffff600000-ffffffffff601000 --xp 00000000 00 :00 0 [ vsyscall ] \u4ece\u4e2d\u6211\u4eec\u53ef\u4ee5\u8bfb\u53d6\u5982\u4e0b\u4e00\u4e9b\u6709\u5173\u8be5\u8fdb\u7a0b\u5185\u865a\u62df\u5185\u5b58\u6620\u5c04\u7684\u5173\u952e\u4fe1\u606f\uff1a vm_start : (\u7b2c1\u5217) \u6307\u7684\u662f\u8be5\u6bb5\u865a\u62df\u5185\u5b58\u533a\u57df\u7684\u5f00\u59cb\u5730\u5740 vm_end : (\u7b2c2\u5217) \u6307\u7684\u662f\u8be5\u6bb5\u865a\u62df\u5185\u5b58\u533a\u57df\u7684\u7ed3\u675f\u5730\u5740 vm_flags : (\u7b2c3\u5217) \u8be5 vm_area \u7684\u4e00\u7ec4\u6743\u9650(rwx)\u6807\u5fd7\uff0c vm_flags \u7684\u5177\u4f53\u53d6\u503c\u5b9a\u4e49\u53ef\u53c2\u8003linux\u6e90\u4ee3\u7801\u7684 linux/mm.h vm_pgoff : (\u7b2c4\u5217) \u865a\u62df\u5185\u5b58\u6620\u5c04\u533a\u57df\u5728\u6587\u4ef6\u5185\u7684\u504f\u79fb\u91cf vm_file : (\u7b2c5/6/7\u5217)\u5206\u522b\u8868\u793a\uff1a\u6620\u5c04\u6587\u4ef6\u6240\u5c5e\u8bbe\u5907\u53f7/\u4ee5\u53ca\u6307\u5411\u5173\u8054\u6587\u4ef6\u7ed3\u6784\u7684\u6307\u9488(\u5982\u679c\u6709\u7684\u8bdd\uff0c\u4e00\u822c\u4e3a\u6587\u4ef6\u7cfb\u7edf\u7684inode)/\u4ee5\u53ca\u6587\u4ef6\u540d \u5176\u5b83\u4fdd\u5b58\u5728 vm_area_struct \u4e2d\u7684\u4fe1\u606f\u8fd8\u6709\uff1a vm_ops : \u8be5 vm_area \u4e2d\u7684\u4e00\u7ec4\u5de5\u4f5c\u51fd\u6570 vm_next/vm_prev : \u540c\u4e00\u8fdb\u7a0b\u7684\u6240\u6709\u865a\u62df\u5185\u5b58\u533a\u57df\u7531 \u94fe\u8868\u7ed3\u6784 \u94fe\u63a5\u8d77\u6765\uff0c\u8fd9\u662f\u5206\u522b\u6307\u5411\u524d\u540e\u4e24\u4e2a vm_area_struct \u7ed3\u6784\u4f53\u7684\u6307\u9488","title":"3.1 vm_area_struct \u4ecb\u7ecd"},{"location":"lab6/#32-page-fault","text":"\u7f3a\u9875\u5f02\u5e38\u662f\u4e00\u79cd\u6b63\u5728\u8fd0\u884c\u7684\u7a0b\u5e8f\u8bbf\u95ee\u5f53\u524d\u672a\u7531\u5185\u5b58\u7ba1\u7406\u5355\u5143\uff08 MMU \uff09\u6620\u5c04\u5230\u865a\u62df\u5185\u5b58\u7684\u9875\u9762\u65f6\uff0c\u7531\u8ba1\u7b97\u673a\u786c\u4ef6\u5f15\u53d1\u7684\u5f02\u5e38\u7c7b\u578b\u3002\u8bbf\u95ee\u672a\u88ab\u6620\u5c04\u7684\u9875\u6216\u8bbf\u95ee\u6743\u9650\u4e0d\u8db3\uff0c\u90fd\u4f1a\u5bfc\u81f4\u8be5\u7c7b\u5f02\u5e38\u7684\u53d1\u751f\u3002\u5904\u7406\u7f3a\u9875\u5f02\u5e38\u901a\u5e38\u662f\u64cd\u4f5c\u7cfb\u7edf\u5185\u6838\u7684\u4e00\u90e8\u5206\u3002\u5f53\u5904\u7406\u7f3a\u9875\u5f02\u5e38\u65f6\uff0c\u64cd\u4f5c\u7cfb\u7edf\u5c06\u5c1d\u8bd5\u4f7f\u6240\u9700\u9875\u9762\u5728\u7269\u7406\u5185\u5b58\u4e2d\u7684\u4f4d\u7f6e\u53d8\u5f97\u53ef\u8bbf\u95ee\uff08\u5efa\u7acb\u65b0\u7684\u6620\u5c04\u5173\u7cfb\u5230\u865a\u62df\u5185\u5b58\uff09\u3002\u800c\u5982\u679c\u5728\u975e\u6cd5\u8bbf\u95ee\u5185\u5b58\u7684\u60c5\u51b5\u4e0b\uff0c\u5373\u53d1\u73b0\u89e6\u53d1 Page Fault \u7684\u865a\u62df\u5185\u5b58\u5730\u5740\uff08 Bad Address \uff09\u4e0d\u5728\u5f53\u524d\u8fdb\u7a0b vm_area_struct \u94fe\u8868\u4e2d\u6240\u5b9a\u4e49\u7684\u5141\u8bb8\u8bbf\u95ee\u7684\u865a\u62df\u5185\u5b58\u5730\u5740\u8303\u56f4\u5185\uff0c\u6216\u8bbf\u95ee\u4f4d\u7f6e\u7684\u6743\u9650\u6761\u4ef6\u4e0d\u6ee1\u8db3\u65f6\uff0c\u7f3a\u9875\u5f02\u5e38\u5904\u7406\u5c06\u7ec8\u6b62\u8be5\u7a0b\u5e8f\u7684\u7ee7\u7eed\u8fd0\u884c\u3002","title":"3.2 \u7f3a\u9875\u5f02\u5e38 Page Fault"},{"location":"lab6/#321-risc-v-page-faults","text":"RISC-V \u5f02\u5e38\u5904\u7406\uff1a\u5f53\u7cfb\u7edf\u8fd0\u884c\u53d1\u751f\u5f02\u5e38\u65f6\uff0c\u53ef\u5373\u65f6\u5730\u901a\u8fc7\u89e3\u6790csr scause\u5bc4\u5b58\u5668\u7684\u503c\uff0c\u8bc6\u522b\u5982\u4e0b\u4e09\u79cd\u4e0d\u540c\u7684Page Fault\u3002 SCAUSE \u5bc4\u5b58\u5668\u6307\u793a\u53d1\u751f\u5f02\u5e38\u7684\u79cd\u7c7b\uff1a Interrupt Exception Code Description 0 12 Instruction Page Fault 0 13 Load Page Fault 0 15 Store/AMO Page Fault","title":"3.2.1 RISC-V Page Faults"},{"location":"lab6/#322-page-fault","text":"\u5904\u7406\u7f3a\u9875\u5f02\u5e38\u65f6\u6240\u9700\u7684\u4fe1\u606f\u5982\u4e0b\uff1a \u89e6\u53d1 Page Fault \u65f6\u8bbf\u95ee\u7684\u865a\u62df\u5185\u5b58\u5730\u5740 VA\u3002\u5f53\u89e6\u53d1 page fault \u65f6\uff0c stval \u5bc4\u5b58\u5668\u88ab\u88ab\u786c\u4ef6\u81ea\u52a8\u8bbe\u7f6e\u4e3a\u8be5\u51fa\u9519\u7684VA\u5730\u5740 \u5bfc\u81f4 Page Fault \u7684\u7c7b\u578b\uff1a Exception Code = 12: page fault caused by an instruction fetch Exception Code = 13: page fault caused by a read Exception Code = 15: page fault caused by a write \u53d1\u751f Page Fault \u65f6\u7684\u6307\u4ee4\u6267\u884c\u4f4d\u7f6e\uff0c\u4fdd\u5b58\u5728 sepc \u4e2d \u5f53\u524d\u8fdb\u7a0b\u5408\u6cd5\u7684 VMA \u6620\u5c04\u5173\u7cfb\uff0c\u4fdd\u5b58\u5728 vm_area_struct \u94fe\u8868\u4e2d","title":"3.2.2 \u5e38\u89c4\u5904\u7406 Page Fault \u7684\u65b9\u5f0f\u4ecb\u7ecd"},{"location":"lab6/#33-fork","text":"fork() \u901a\u8fc7\u590d\u5236\u5f53\u524d\u8fdb\u7a0b\u521b\u5efa\u4e00\u4e2a\u65b0\u7684\u8fdb\u7a0b\uff0c\u65b0\u8fdb\u7a0b\u79f0\u4e3a\u5b50\u8fdb\u7a0b\uff0c\u800c\u539f\u8fdb\u7a0b\u79f0\u4e3a\u7236\u8fdb\u7a0b\u3002 \u5b50\u8fdb\u7a0b\u548c\u7236\u8fdb\u7a0b\u5728\u4e0d\u540c\u7684\u5185\u5b58\u7a7a\u95f4\u4e0a\u8fd0\u884c\u3002 \u7236\u8fdb\u7a0b fork \u6210\u529f\u65f6 \u8fd4\u56de\uff1a\u5b50\u8fdb\u7a0b\u7684pid \uff0c\u5b50\u8fdb\u7a0b \u8fd4\u56de\uff1a0 \u3002 fork \u5931\u8d25\u5219\u7236\u8fdb\u7a0b \u8fd4\u56de\uff1a-1 \u3002 \u521b\u5efa\u7684\u5b50\u8fdb\u7a0b\u9700\u8981\u62f7\u8d1d\u7236\u8fdb\u7a0b task_struct \u3001 pgd \u3001 mm_struct \u4ee5\u53ca\u7236\u8fdb\u7a0b\u7684 user stack \u7b49\u4fe1\u606f\u3002 Linux \u4e2d\u4f7f\u7528\u4e86 copy-on-write \u673a\u5236\uff0c fork \u521b\u5efa\u7684\u5b50\u8fdb\u7a0b\u9996\u5148\u4e0e\u7236\u8fdb\u7a0b\u5171\u4eab\u7269\u7406\u5185\u5b58\u7a7a\u95f4\uff0c\u76f4\u5230\u7236\u5b50\u8fdb\u7a0b\u6709\u4fee\u6539\u5185\u5b58\u7684\u64cd\u4f5c\u53d1\u751f\u65f6\u518d\u4e3a\u5b50\u8fdb\u7a0b\u5206\u914d\u7269\u7406\u5185\u5b58\u3002","title":"3.3 fork \u7cfb\u7edf\u8c03\u7528"},{"location":"lab6/#4","text":"","title":"4 \u5b9e\u9a8c\u6b65\u9aa4"},{"location":"lab6/#41","text":"\u6b64\u6b21\u5b9e\u9a8c\u57fa\u4e8e lab5 \u540c\u5b66\u6240\u5b9e\u73b0\u7684\u4ee3\u7801\u8fdb\u884c\u3002 \u4ece repo \u540c\u6b65\u4ee5\u4e0b\u6587\u4ef6\u5939: user \u5e76\u6309\u7167\u4ee5\u4e0b\u6b65\u9aa4\u5c06\u8fd9\u4e9b\u6587\u4ef6\u6b63\u786e\u653e\u7f6e\u3002 1 2 3 4 5 6 7 8 9 10 11 . \u2514\u2500\u2500 user \u251c\u2500\u2500 Makefile \u251c\u2500\u2500 getpid.c \u251c\u2500\u2500 link.lds \u251c\u2500\u2500 printf.c \u251c\u2500\u2500 start.S \u251c\u2500\u2500 stddef.h \u251c\u2500\u2500 stdio.h \u251c\u2500\u2500 syscall.h \u2514\u2500\u2500 uapp.S \u5728 user/getpid.c \u4e2d\u6211\u4eec\u8bbe\u7f6e\u4e86\u4e09\u4e2a main \u51fd\u6570\u3002\u5728\u5b9e\u73b0\u4e86 Page Fault \u4e4b\u540e\u7b2c\u4e00\u4e2a main \u51fd\u6570\u53ef\u4ee5\u6210\u529f\u8fd0\u884c\u3002\u5728\u5b9e\u73b0\u4e86 fork \u4e4b\u540e\u5176\u4f59\u4e24\u4e2a main \u51fd\u6570\u53ef\u4ee5\u6210\u529f\u8fd0\u884c\u3002 \u4fee\u6539 task_init \u51fd\u6570\u4e2d\u4fee\u6539\u4e3a\u4ec5\u521d\u59cb\u5316\u4e00\u4e2a\u8fdb\u7a0b\uff0c\u4e4b\u540e\u5176\u4f59\u7684\u8fdb\u7a0b\u5747\u901a\u8fc7 fork \u521b\u5efa\u3002","title":"4.1 \u51c6\u5907\u5de5\u4f5c"},{"location":"lab6/#42","text":"\u4fee\u6539 proc.h \u5982\u4e0b 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 /* vm_area_struct vm_flags */ #define VM_READ 0x00000001 #define VM_WRITE 0x00000002 #define VM_EXEC 0x00000004 struct vm_area_struct { struct mm_struct * vm_mm ; /* The mm_struct we belong to. */ uint64_t vm_start ; /* Our start address within vm_mm. */ uint64_t vm_end ; /* The first byte after our end address within vm_mm. */ /* linked list of VM areas per task, sorted by address */ struct vm_area_struct * vm_next , * vm_prev ; uint64_t vm_flags ; /* Flags as listed above. */ }; struct mm_struct { struct vm_area_struct * mmap ; /* list of VMAs */ }; struct task_struct { struct thread_info * thread_info ; uint64_t state ; uint64_t counter ; uint64_t priority ; uint64_t pid ; struct thread_struct thread ; pagetable_t pgd ; struct mm_struct * mm ; }; \u6bcf\u4e00\u4e2a vm_area_struct \u90fd\u5bf9\u5e94\u4e8e\u8fdb\u7a0b\u5730\u5740\u7a7a\u95f4\u7684\u552f\u4e00\u533a\u95f4\u3002 \u4e3a\u4e86\u652f\u6301 Demand Paging \uff08\u89c1 4.3\uff09\uff0c\u6211\u4eec\u9700\u8981\u652f\u6301\u5bf9 vm_area_struct \u7684\u6dfb\u52a0\uff0c\u67e5\u627e\u3002 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 /* * @mm : current thread's mm_struct * @address : the va to look up * * @return : the VMA if found or NULL if not found */ struct vm_area_struct * find_vma ( struct mm_struct * mm , uint64_t addr ) { } /* * @mm : current thread's mm_struct * @addr : the suggested va to map * @length : memory size to map * @prot : protection * * @return : start va */ uint64_t do_mmap ( struct mm_struct * mm , uint64_t addr , uint64_t length , int prot ) { /* \u9700\u8981\u6ce8\u610f\u7684\u662f do_mmap \u4e2d\u7684 addr \u53ef\u80fd\u65e0\u6cd5\u88ab\u6ee1\u8db3 \u6bd4\u5982 addr \u5df2\u7ecf\u88ab\u5360\u7528, \u56e0\u6b64\u9700\u8981\u5224\u65ad\uff0c \u5982\u679c\u4e0d\u5408\u6cd5\uff0c\u9700\u8981\u91cd\u65b0\u627e\u5230\u4e00\u4e2a\u5408\u9002\u7684\u4f4d\u7f6e\u8fdb\u884c\u6620\u5c04\u3002 */ }","title":"4.2 \u5b9e\u73b0\u865a\u62df\u5185\u5b58\u7ba1\u7406\u529f\u80fd\uff1a"},{"location":"lab6/#43-page-fault-handler","text":"Demand Paging \u5728\u6620\u5c04\u9875\u9762\u65f6\uff0c\u6211\u4eec\u4e0d\u771f\u6b63\u5bf9\u9875\u8868\u8fdb\u884c\u4fee\u6539\uff0c\u53ea\u5728 mm->mmap \u94fe\u8868\u4e0a\u6dfb\u52a0\u4e00\u4e2a vma \u8bb0\u5f55\u3002 \u5f53\u6211\u4eec\u771f\u6b63\u8bbf\u95ee\u8fd9\u4e2a\u9875\u9762\u65f6\uff0c\u6211\u4eec\u9700\u8981\u6839\u636e\u7f3a\u9875\u7684\u5730\u5740\uff0c\u627e\u5230\u5176\u6240\u5728\u7684 vma \uff0c\u6839\u636e vma \u4e2d\u7684\u4fe1\u606f\u5bf9\u9875\u8868\u8fdb\u884c\u6620\u5c04\u3002 \u4fee\u6539 task_init \u51fd\u6570\u4ee3\u7801\uff0c\u66f4\u6539\u4e3a Demand Paging \u5220\u9664\u4e4b\u524d\u5b9e\u9a8c\u4e2d\u5bf9 U-MODE \u4ee3\u7801\uff0c\u6808\u8fdb\u884c\u6620\u5c04\u7684\u4ee3\u7801 \u8c03\u7528 do_mmap \u51fd\u6570\uff0c\u5efa\u7acb\u7528\u6237\u8fdb\u7a0b\u7684\u865a\u62df\u5730\u5740\u7a7a\u95f4\u4fe1\u606f\uff0c\u5305\u62ec\u4e24\u4e2a\u533a\u57df: \u4ee3\u7801\u533a\u57df, \u8be5\u533a\u57df\u4ece\u865a\u62df\u5730\u5740 USER_START \u5f00\u59cb\uff0c\u5927\u5c0f\u4e3a uapp_end - uapp_start \uff0c \u6743\u9650\u4e3a VM_READ | VM_WRITE | VM_EXEC \u7528\u6237\u6808\uff0c\u8303\u56f4\u4e3a [USER_END - PGSIZE, USER_END) \uff0c\u6743\u9650\u4e3a VM_READ | VM_WRITE \u5728\u5b8c\u6210\u4e0a\u8ff0\u4fee\u6539\u4e4b\u540e\uff0c\u5982\u679c\u8fd0\u884c\u4ee3\u7801\u6211\u4eec\u53ef\u4ee5\u622a\u83b7 \u4e00\u4e2a page fault. \u5982\u4e0b\u56fe \uff08\u6ce8\u610f\uff1a\u7531\u4e8e\u8bd5\u4f8b\u4ee3\u7801\u4ee5\u53ca\u6b63\u786e\u5904\u7406 page fault\uff0c \u6240\u4ee5\u6211\u4eec\u53ef\u4ee5\u770b\u5230\u4e00\u7cfb\u5217\u7684page fault \uff09 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 // Instruction Page Fault scause = 0x000000000000000c, sepc = 0x0000000000000000, stval = 0x0000000000000000 // Store/AMO Page Fault: sepc \u662f code address\uff0c stval \u662f \u5199\u5165\u7684\u5730\u5740 ( \u4f4d\u4e8e user stack \u5185 ) \u3002 scause = 0x000000000000000f, sepc = 0x0000000000000070, stval = 0x0000003ffffffff8 ************************** uapp asm ************************** ..... Disassembly of section .text.main: 000000000000006c <main>: 6c: fe010113 addi sp,sp,-32 70 : 00113c23 sd ra,24 ( sp ) <- Page Fault 74 : 00813823 sd s0,16 ( sp ) 78 : 02010413 addi s0,sp,32 7c: fbdff0ef jal ra,38 <fork> 80 : 00050793 mv a5,a0 84 : fef42223 sw a5,-28 ( s0 ) 88 : fe442783 lw a5,-28 ( s0 ) ...... ************************** uapp asm ************************** \u5b9e\u73b0 Page Fault \u7684\u68c0\u6d4b\u4e0e\u5904\u7406 \u4fee\u6539 trap.c , \u6dfb\u52a0\u6355\u83b7 Page Fault \u7684\u903b\u8f91 \u5f53\u6355\u83b7\u4e86 Page Fault \u4e4b\u540e\uff0c\u9700\u8981\u5b9e\u73b0\u7f3a\u9875\u5f02\u5e38\u7684\u5904\u7406\u51fd\u6570 do_page_fault 1 2 3 4 5 6 7 8 9 10 11 12 void do_page_fault ( struct pt_regs * regs ) { /* 1. \u901a\u8fc7 stval \u83b7\u5f97\u8bbf\u95ee\u51fa\u9519\u7684\u865a\u62df\u5185\u5b58\u5730\u5740\uff08Bad Address\uff09 2. \u901a\u8fc7 sepc \u83b7\u5f97\u5f53\u524d\u7684 Page Fault \u7c7b\u578b 3. \u901a\u8fc7 find_vm() \u627e\u5230\u5339\u914d\u7684 vm_area 4. \u901a\u8fc7 vm_area \u7684 vm_flags \u5bf9\u5f53\u524d\u7684 Page Fault \u7c7b\u578b\u8fdb\u884c\u68c0\u67e5 4.1 Instruction Page Fault -> VM_EXEC 4.2 Load Page Fault -> VM_READ 4.3 Store Page Fault -> VM_WRITE 5. \u6700\u540e\u8c03\u7528 create_mapping \u5bf9\u9875\u8868\u8fdb\u884c\u6620\u5c04 */ }","title":"4.3 Page Fault Handler"},{"location":"lab6/#44-fork","text":"\u4fee\u6539 task_struct \u589e\u52a0\u7ed3\u6784\u6210\u5458 trapframe \uff0c \u5982\u4e0b\uff1a 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 struct task_struct { struct thread_info * thread_info ; uint64_t state ; uint64_t counter ; uint64_t priority ; uint64_t pid ; struct thread_struct thread ; pagetable_t pgd ; struct mm_struct * mm ; struct pt_regs * trapframe ; }; trapframe \u6210\u5458\u7528\u4e8e\u4fdd\u5b58\u5f02\u5e38\u4e0a\u4e0b\u6587\uff0c\u5f53\u6211\u4eec fork \u51fa\u6765\u4e00\u4e2a\u5b50\u8fdb\u7a0b\u65f6\u5019\uff0c\u6211\u4eec\u5c06\u7236\u8fdb\u7a0b\u7684\u4e0a\u4e0b\u6587\u73af\u5883\u590d\u5236\u5230\u5b50\u8fdb\u7a0b\u7684 trapframe \u4e2d\u3002\u5f53\u5b50\u8fdb\u7a0b\u88ab\u8c03\u5ea6\u65f6\u5019\uff0c\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7 trapframe \u6765\u6062\u590d\u4e0a\u4e0b\u6587\u73af\u5883\u3002 fork() \u6240\u8c03\u7528\u7684 syscall \u4e3a SYS_CLONE\uff0c\u7cfb\u7edf\u8c03\u7528\u53f7\u4e3a 220 1 #define SYS_CLONE 220 \u5b9e\u73b0 clone \uff0c \u4e3a\u4e86\u7b80\u5355\u8d77\u89c1 clone \u53ea\u63a5\u53d7\u4e00\u4e2a\u53c2\u6570 pt_regs * 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 void forkret () { ret_from_fork ( current -> trapframe ); } uint64_t do_fork ( struct pt_regs * regs ) { /* 1. \u53c2\u8003 task_init \u521b\u5efa\u4e00\u4e2a\u65b0\u7684 \u5b50\u8fdb\u7a0b, \u5c06 thread.ra \u8bbe\u7f6e\u4e3a forkret 2. \u4e3a\u5b50\u8fdb\u7a0b\u7533\u8bf7 user stack, \u5e76\u5c06\u7236\u8fdb\u7a0b\u7684 user stack \u6570\u636e\u590d\u5236\u5230\u5176 \u4e2d. \u540c\u65f6\u5c06\u5b50\u8fdb\u7a0b\u7684 user stack \u7684\u5730\u5740\u4fdd\u5b58\u5728 thread_info->user_sp \u4e2d 3. \u5728 task_init \u4e2d\u6211\u4eec\u8fdb\u7a0b\u7684 user-mode sp \u53ef\u4ee5\u76f4\u63a5\u8bbe\u7f6e\u4e3a USER_END, \u4f46\u662f\u8fd9\u91cc\u9700\u8981\u8bbe\u7f6e\u4e3a\u5f53\u524d\u8fdb\u7a0b(\u7236\u8fdb\u7a0b)\u7684 user-mode sp 4. \u5c06\u7236\u8fdb\u7a0b\u4e0a\u4e0b\u6587\u73af\u5883\u4fdd\u5b58\u5230\u5b50\u8fdb\u7a0b\u7684 trapframe \u4e2d 5. \u5c06\u5b50\u8fdb\u7a0b\u7684 trapframe->a0 \u4fee\u6539\u4e3a 0 6. \u590d\u5236\u7236\u8fdb\u7a0b\u7684 mm_struct \u4ee5\u53ca vm_area_struct 7. \u521b\u5efa\u5b50\u8fdb\u7a0b\u7684\u9875\u8868 \u8fd9\u91cc\u53ea\u505a\u5185\u6838\u7684\u6620\u5c04,\u5373 swapper_pg_dir 8. \u8fd4\u56de\u5b50\u8fdb\u7a0b\u7684 pid */ } uint64_t clone ( struct pt_regs * regs ) { return do_fork ( regs ); } \u53c2\u8003 _trap \u4e2d\u7684\u6062\u590d\u903b\u8f91 \u5728 entry.S \u4e2d\u5b9e\u73b0 ret_from_fork , \u51fd\u6570\u539f\u578b\u5982\u4e0b\uff1a \u6ce8\u610f\u6062\u590d\u5bc4\u5b58\u5668\u7684\u987a\u5e8f _trap \u4e2d\u662f\u4ece stack \u4e0a\u6062\u590d\uff0c\u8fd9\u91cc\u4ece trapframe \u4e2d\u6062\u590d 1 void ret_from_fork ( struct pt_regs * trapframe ); \u4fee\u6539 Page Fault \u5904\u7406: \u5728\u4e4b\u524d\u7684 Page Fault \u5904\u7406\u4e2d\uff0c\u6211\u4eec\u5bf9\u7528\u6237\u6808 Page Fault \u5904\u7406\u65b9\u6cd5\u662f\u81ea\u7531\u5206\u914d\u4e00\u9875\u4f5c\u4e3a\u7528\u6237\u6808\u5e76\u6620\u5c04\u5230 [USER_END - PAGE_SIZE, USER_END) \u7684\u865a\u62df\u5730\u5740\u3002\u4f46\u7531 fork \u521b\u5efa\u7684\u8fdb\u7a0b\uff0c\u5b83\u7684\u7528\u6237\u6808\u5df2\u7ecf\u62f7\u8d1d\u5b8c\u6bd5\uff0c\u56e0\u6b64 Page Fault \u5904\u7406\u65f6\u76f4\u63a5\u4e3a\u8be5\u9875\u5efa\u7acb\u6620\u5c04\u5373\u53ef ( \u901a\u8fc7 thread_info->user_sp \u6765\u8fdb\u884c\u5224\u65ad)\u3002","title":"4.4 \u5b9e\u73b0 fork()"},{"location":"lab6/#45","text":"\u8f93\u51fa\u793a\u4f8b 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 OpenSBI v0.9 ____ _____ ____ _____ / __ \\ / ____ | _ \\_ _ | | | | | _ __ ___ _ __ | ( ___ | | _ ) || | | | | | '_ \\ / _ \\ ' _ \\ \\_ __ \\| _ < | | | | __ | | | _ ) | __/ | | | ____ ) | | _ ) || | _ \\_ ___/ | .__/ \\_ __ | _ | | _ | _____/ | ____/_____ | | | | _ | ... Boot HART MIDELEG : 0x0000000000000222 Boot HART MEDELEG : 0x000000000000b109 ...mm_init done ! ...proc_init done ! [ S-MODE ] Hello RISC-V scause = 0x000000000000000c, sepc = 0x0000000000000000, stval = 0x0000000000000000 scause = 0x000000000000000f, sepc = 0x0000000000000070, stval = 0x0000003ffffffff8 [ PID = 1 ] fork [ PID = 2 ] [ PID = 1 ] fork [ PID = 3 ] [ PID = 1 ] is running! scause = 0x000000000000000c, sepc = 0x0000000000000050, stval = 0x0000000000000050 scause = 0x000000000000000f, sepc = 0x0000000000000054, stval = 0x0000003fffffffc8 [ PID = 3 ] is running! scause = 0x000000000000000c, sepc = 0x0000000000000050, stval = 0x0000000000000050 scause = 0x000000000000000f, sepc = 0x0000000000000054, stval = 0x0000003fffffffc8 [ PID = 2 ] fork [ PID = 4 ] [ PID = 2 ] is running! [ PID = 1 ] is running! scause = 0x000000000000000c, sepc = 0x0000000000000050, stval = 0x0000000000000050 scause = 0x000000000000000f, sepc = 0x0000000000000054, stval = 0x0000003fffffffc8 [ PID = 4 ] is running! [ PID = 3 ] is running! [ PID = 2 ] is running! ...","title":"4.5 \u7f16\u8bd1\u53ca\u6d4b\u8bd5"},{"location":"lab6/#_1","text":"\u540c\u5b66\u9700\u8981\u63d0\u4ea4\u5b9e\u9a8c\u62a5\u544a\u4ee5\u53ca\u6574\u4e2a\u5de5\u7a0b\u4ee3\u7801\u3002\u5728\u63d0\u4ea4\u524d\u8bf7\u4f7f\u7528 make clean \u6e05\u9664\u6240\u6709\u6784\u5efa\u4ea7\u7269\u3002","title":"\u4f5c\u4e1a\u63d0\u4ea4"}]}