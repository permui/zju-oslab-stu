
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://zjusec.gitee.io/os21fall/lab4/">
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.3.0, mkdocs-material-8.2.9">
    
    
      
        <title>实验指导四 - 浙江大学21年秋操作系统实验</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.120efc48.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.9647289d.min.css">
        
      
    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CCascadia:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Cascadia"}</style>
      
    
    
      <link rel="stylesheet" href="../stylesheets/extra.css">
    
    <script>__md_scope=new URL("..",location),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="" data-md-color-accent="">
  
    
    
      <script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#lab-4-rv64" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="浙江大学21年秋操作系统实验" class="md-header__button md-logo" aria-label="浙江大学21年秋操作系统实验" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            浙江大学21年秋操作系统实验
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              实验指导四
            
          </span>
        </div>
      </div>
    </div>
    
      <form class="md-header__option" data-md-component="palette">
        
          
          
          <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="" data-md-color-accent=""  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_1">
          
            <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_2" hidden>
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 6H7c-3.31 0-6 2.69-6 6s2.69 6 6 6h10c3.31 0 6-2.69 6-6s-2.69-6-6-6zm0 10H7c-2.21 0-4-1.79-4-4s1.79-4 4-4h10c2.21 0 4 1.79 4 4s-1.79 4-4 4zM7 9c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg>
            </label>
          
        
          
          
          <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="" data-md-color-accent=""  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_2">
          
            <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_1" hidden>
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 7H7a5 5 0 0 0-5 5 5 5 0 0 0 5 5h10a5 5 0 0 0 5-5 5 5 0 0 0-5-5m0 8a3 3 0 0 1-3-3 3 3 0 0 1 3-3 3 3 0 0 1 3 3 3 3 0 0 1-3 3Z"/></svg>
            </label>
          
        
      </form>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://gitee.com/zjusec/os21fall" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.1.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    zjusec/os21fall
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="浙江大学21年秋操作系统实验" class="md-nav__button md-logo" aria-label="浙江大学21年秋操作系统实验" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    浙江大学21年秋操作系统实验
  </label>
  
    <div class="md-nav__source">
      <a href="https://gitee.com/zjusec/os21fall" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.1.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    zjusec/os21fall
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../lab0/" class="md-nav__link">
        实验指导零
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../lab1/" class="md-nav__link">
        实验指导一
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../lab2/" class="md-nav__link">
        实验指导二
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../lab3/" class="md-nav__link">
        实验指导三
      </a>
    </li>
  

    
      
      
      

  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          实验指导四
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        实验指导四
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#1" class="md-nav__link">
    1 实验目的
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2" class="md-nav__link">
    2 实验环境
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#3" class="md-nav__link">
    3 背景知识
  </a>
  
    <nav class="md-nav" aria-label="3 背景知识">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#31-linux-kernel" class="md-nav__link">
    3.1 Linux Kernel 的虚拟内存布局
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#32-risc-v-virtual-memory-system" class="md-nav__link">
    3.2 RISC-V Virtual-Memory System
  </a>
  
    <nav class="md-nav" aria-label="3.2 RISC-V Virtual-Memory System">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#321-the-satp-registersupervisor-address-translation-and-protection-register" class="md-nav__link">
    3.2.1 The satp Register（Supervisor Address Translation and Protection Register）
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#322-risc-v-sv39-virtual-address-and-physical-address" class="md-nav__link">
    3.2.2 RISC-V Sv39 Virtual Address and Physical Address
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#323-risc-v-sv39-page-table-entry" class="md-nav__link">
    3.2.3 RISC-V Sv39 Page Table Entry
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#324-risc-v-address-translation" class="md-nav__link">
    3.2.4 RISC-V Address Translation
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#4" class="md-nav__link">
    4 实验指导
  </a>
  
    <nav class="md-nav" aria-label="4 实验指导">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#40" class="md-nav__link">
    4.0 任务与途径
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#41" class="md-nav__link">
    4.1 准备工作
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#42" class="md-nav__link">
    4.2 第一回映射
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#43" class="md-nav__link">
    4.3 第二回映射
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#44" class="md-nav__link">
    4.4 编译及测试
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    思考题
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    作业提交
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../lab5/" class="md-nav__link">
        实验指导五
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../lab6/" class="md-nav__link">
        实验指导六
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../faq/" class="md-nav__link">
        常见问题及解答
      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#1" class="md-nav__link">
    1 实验目的
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2" class="md-nav__link">
    2 实验环境
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#3" class="md-nav__link">
    3 背景知识
  </a>
  
    <nav class="md-nav" aria-label="3 背景知识">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#31-linux-kernel" class="md-nav__link">
    3.1 Linux Kernel 的虚拟内存布局
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#32-risc-v-virtual-memory-system" class="md-nav__link">
    3.2 RISC-V Virtual-Memory System
  </a>
  
    <nav class="md-nav" aria-label="3.2 RISC-V Virtual-Memory System">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#321-the-satp-registersupervisor-address-translation-and-protection-register" class="md-nav__link">
    3.2.1 The satp Register（Supervisor Address Translation and Protection Register）
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#322-risc-v-sv39-virtual-address-and-physical-address" class="md-nav__link">
    3.2.2 RISC-V Sv39 Virtual Address and Physical Address
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#323-risc-v-sv39-page-table-entry" class="md-nav__link">
    3.2.3 RISC-V Sv39 Page Table Entry
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#324-risc-v-address-translation" class="md-nav__link">
    3.2.4 RISC-V Address Translation
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#4" class="md-nav__link">
    4 实验指导
  </a>
  
    <nav class="md-nav" aria-label="4 实验指导">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#40" class="md-nav__link">
    4.0 任务与途径
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#41" class="md-nav__link">
    4.1 准备工作
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#42" class="md-nav__link">
    4.2 第一回映射
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#43" class="md-nav__link">
    4.3 第二回映射
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#44" class="md-nav__link">
    4.4 编译及测试
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    思考题
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    作业提交
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                


<h1 id="lab-4-rv64">Lab 4: RV64 虚拟内存管理</h1>
<h2 id="1">1 实验目的</h2>
<ul>
<li>学习虚拟内存的相关知识，实现物理地址到虚拟地址的切换。</li>
<li>了解 RISC-V 架构中 SV39 分页模式，实现虚拟地址到物理地址的映射，并对不同的段进行相应的权限设置。</li>
</ul>
<h2 id="2">2 实验环境</h2>
<ul>
<li>Docker in Lab0</li>
</ul>
<h2 id="3">3 背景知识</h2>
<p>在 <a href="../lab3/">lab3</a> 中我们赋予了 OS 对多个线程调度以及并发执行的能力，由于目前这些线程都是内核线程，因此他们可以共享运行空间，即运行不同线程对空间的修改是相互可见的。但是如果我们需要线程相互<strong>隔离</strong>，以及在多线程的情况下更加<strong>高效</strong>的使用内存，我们必须引入<em>虚拟内存</em>这个概念。</p>
<p>虚拟内存可以为进程提供独立的内存空间，制造一种每个进程的内存都是独立的假象。虚拟内存到物理内存的映射也包含了内存访问权限的信息，方便 kernel 完成权限检查。</p>
<p>在本次实验中，我们需要关注 OS 如何<strong>开启虚拟内存</strong>，如何通过设置页表来实现<strong>地址映射</strong>和<strong>权限控制</strong>。</p>
<h3 id="31-linux-kernel">3.1 Linux Kernel 的虚拟内存布局</h3>
<p><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>start_address           end_address
    0x0                 0x3fffffffff
     │                       │
┌────┘                  ┌────┘
↓        256G           ↓                                
┌───────────────────────┬──────────┬────────────────┐
│      User Space       │    ...   │  Kernel Space  │
└───────────────────────┴──────────┴────────────────┘
                                   ↑     256G       ↑
                      ┌────────────┘                │ 
                      │                             │
              0xffffffc000000000           0xffffffffffffffff
                start_address                  end_address
</code></pre></div>
</td></tr></table>
上图是 Linux 5.15 中 RV64 架构的内存布局。它是基于 RISC-V 标准中定义的 Sv39 地址转换模式的（见下文）。我们看到 <code>0x0000004000000000</code> 以下的虚拟地址空间分配给 user space，<code>0xffffffc000000000</code> 及以上的虚拟地址空间分配给 <code>kernel space</code>。由于我们还未引入用户态程序，目前我们只需要关注 <code>kernel space</code>。原始说明文件在<a href="https://elixir.bootlin.com/linux/v5.15/source/Documentation/riscv/vm-layout.rst">此处</a>。</p>
<p>Kernel 为了高效方便地访问 RAM，会把所有物理内存都映射到虚拟内存里 kernel space 中的一块区域。这块区域称为 <em>direct mapping area</em>。由于此处虚拟内存和物理内存的映射关系是 <code>VA == PA + OFFSET</code>， 所以这种映射也被称为 <em>linear mapping</em>（注意，这与线性代数中的 linear mapping 是不同的——那里的 linear mapping 一定把 0 映射到 0，而此处不是。在数学上此处的映射应称为 translation transformation，即平移变换）。在 RISC-V 架构的 Linux Kernel 中 direct mapping area 为 <code>0xffffffe000000000 ~ 0xffffffff00000000</code>, 共 124 GB 。</p>
<p><strong>本次实验的任务就是开启虚拟内存，实现 direct mapping，并让 lab3 中的多进程程序在 direct mapping area 中执行。</strong></p>
<p>为此，我们需要了解 RISC-V 架构中虚拟内存的工作方式。</p>
<h3 id="32-risc-v-virtual-memory-system">3.2 RISC-V Virtual-Memory System</h3>
<p>虚拟内存的本质是地址转换与保护，而这是通过页表来实现的。分四步来理解地址转换与保护：</p>
<ol>
<li>S 态下如何开启转换，页表基地址存放在哪里：<code>satp</code> register</li>
<li>我们使用的转换模式下，虚拟地址和物理地址如何划分</li>
<li>页表项（Page Table Entry, PTE）的格式是什么</li>
<li>当一切都设置好后，地址转换与保护是如何进行的</li>
</ol>
<p>下面分别介绍这四点。</p>
<h4 id="321-the-satp-registersupervisor-address-translation-and-protection-register">3.2.1 The <code>satp</code> Register（Supervisor Address Translation and Protection Register）</h4>
<p><code>satp</code> 是 S 模式下控制地址转换与保护的 CSR 寄存器，它的格式如下图：</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="w"> </span><span class="mi">63</span><span class="w">      </span><span class="mi">60</span><span class="w"> </span><span class="mi">59</span><span class="w">                  </span><span class="mi">44</span><span class="w"> </span><span class="mi">43</span><span class="w">                                </span><span class="mi">0</span><span class="w"></span>
<span class="w"> </span><span class="o">---------------------------------------------------------------------</span><span class="w"></span>
<span class="o">|</span><span class="w">   </span><span class="n">MODE</span><span class="w">   </span><span class="o">|</span><span class="w">         </span><span class="n">ASID</span><span class="w">         </span><span class="o">|</span><span class="w">                </span><span class="n">PPN</span><span class="w">                </span><span class="o">|</span><span class="w"></span>
<span class="w"> </span><span class="o">---------------------------------------------------------------------</span><span class="w"></span>
</code></pre></div>
</td></tr></table>
<ul>
<li>MODE 字段控制地址转换模式，默认为 0，表示不做转换。它的所有取值如下图。当 <code>satp.MODE</code> 被设为 8 时，我们就开启了 Sv39 模式的地址转换。
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="w">                             </span><span class="n">RV</span><span class="w"> </span><span class="mi">64</span><span class="w"></span>
<span class="w">     </span><span class="o">----------------------------------------------------------</span><span class="w"></span>
<span class="w">    </span><span class="o">|</span><span class="w">  </span><span class="n">Value</span><span class="w">  </span><span class="o">|</span><span class="w">  </span><span class="n">Name</span><span class="w">  </span><span class="o">|</span><span class="w">  </span><span class="n">Description</span><span class="w">                          </span><span class="o">|</span><span class="w"></span>
<span class="w">    </span><span class="o">|----------------------------------------------------------|</span><span class="w"></span>
<span class="w">    </span><span class="o">|</span><span class="w">    </span><span class="mi">0</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">Bare</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="n">No</span><span class="w"> </span><span class="n">translation</span><span class="w"> </span><span class="n">or</span><span class="w"> </span><span class="n">protection</span><span class="w">          </span><span class="o">|</span><span class="w"></span>
<span class="w">    </span><span class="o">|</span><span class="w">  </span><span class="mi">1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">7</span><span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="o">---</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">Reserved</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">standard</span><span class="w"> </span><span class="n">use</span><span class="w">             </span><span class="o">|</span><span class="w"></span>
<span class="w">    </span><span class="o">|</span><span class="w">    </span><span class="mi">8</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">Sv39</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="n">Page</span><span class="o">-</span><span class="n">based</span><span class="w"> </span><span class="mi">39</span><span class="w"> </span><span class="n">bit</span><span class="w"> </span><span class="n">virtual</span><span class="w"> </span><span class="n">addressing</span><span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="o">&lt;--</span><span class="w"> </span><span class="n">我们使用的mode</span><span class="w"></span>
<span class="w">    </span><span class="o">|</span><span class="w">    </span><span class="mi">9</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">Sv48</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="n">Page</span><span class="o">-</span><span class="n">based</span><span class="w"> </span><span class="mi">48</span><span class="w"> </span><span class="n">bit</span><span class="w"> </span><span class="n">virtual</span><span class="w"> </span><span class="n">addressing</span><span class="w">  </span><span class="o">|</span><span class="w"></span>
<span class="w">    </span><span class="o">|</span><span class="w">    </span><span class="mi">10</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="n">Sv57</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="n">Page</span><span class="o">-</span><span class="n">based</span><span class="w"> </span><span class="mi">57</span><span class="w"> </span><span class="n">bit</span><span class="w"> </span><span class="n">virtual</span><span class="w"> </span><span class="n">addressing</span><span class="w">  </span><span class="o">|</span><span class="w"></span>
<span class="w">    </span><span class="o">|</span><span class="w">    </span><span class="mi">11</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="n">Sv64</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="n">Page</span><span class="o">-</span><span class="n">based</span><span class="w"> </span><span class="mi">64</span><span class="w"> </span><span class="n">bit</span><span class="w"> </span><span class="n">virtual</span><span class="w"> </span><span class="n">addressing</span><span class="w">  </span><span class="o">|</span><span class="w"></span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mi">12</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">13</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="o">---</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">Reserved</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">standard</span><span class="w"> </span><span class="n">use</span><span class="w">             </span><span class="o">|</span><span class="w"></span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mi">14</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">15</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="o">---</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">Reserved</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">standard</span><span class="w"> </span><span class="n">use</span><span class="w">             </span><span class="o">|</span><span class="w"></span>
<span class="w">     </span><span class="o">-----------------------------------------------------------</span><span class="w"></span>
</code></pre></div>
</td></tr></table></li>
<li>ASID ( Address Space Identifier ) ： 此次实验中直接置 0 即可。</li>
<li>PPN ( Physical Page Number ) ：顶级页表的<strong>物理</strong>页号。在 Sv39 中物理页的大小为 4KiB，所以 <code>PPN == PA &gt;&gt; 12</code>。</li>
</ul>
<p>具体介绍请阅读 <a href="https://www.five-embeddev.com/riscv-isa-manual/latest/supervisor.html#sec:satp">RISC-V Privileged Spec 4.1.10</a>。</p>
<h4 id="322-risc-v-sv39-virtual-address-and-physical-address">3.2.2 RISC-V Sv39 Virtual Address and Physical Address</h4>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="w">     </span><span class="mi">38</span><span class="w">        </span><span class="mi">30</span><span class="w"> </span><span class="mi">29</span><span class="w">        </span><span class="mi">21</span><span class="w"> </span><span class="mi">20</span><span class="w">        </span><span class="mi">12</span><span class="w"> </span><span class="mi">11</span><span class="w">                           </span><span class="mi">0</span><span class="w"></span>
<span class="w">     </span><span class="o">---------------------------------------------------------------------</span><span class="w"></span>
<span class="w">    </span><span class="o">|</span><span class="w">   </span><span class="n">VPN</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="w">   </span><span class="o">|</span><span class="w">   </span><span class="n">VPN</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w">   </span><span class="o">|</span><span class="w">   </span><span class="n">VPN</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w">   </span><span class="o">|</span><span class="w">          </span><span class="n">page</span><span class="w"> </span><span class="n">offset</span><span class="w">         </span><span class="o">|</span><span class="w"></span>
<span class="w">     </span><span class="o">---------------------------------------------------------------------</span><span class="w"></span>
<span class="w">                            </span><span class="n">Sv39</span><span class="w"> </span><span class="n">virtual</span><span class="w"> </span><span class="n">address</span><span class="w"></span>
</code></pre></div>
</td></tr></table>
<p><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="w"> </span><span class="mi">55</span><span class="w">                </span><span class="mi">30</span><span class="w"> </span><span class="mi">29</span><span class="w">        </span><span class="mi">21</span><span class="w"> </span><span class="mi">20</span><span class="w">        </span><span class="mi">12</span><span class="w"> </span><span class="mi">11</span><span class="w">                           </span><span class="mi">0</span><span class="w"></span>
<span class="w"> </span><span class="o">-----------------------------------------------------------------------------</span><span class="w"></span>
<span class="o">|</span><span class="w">       </span><span class="n">PPN</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="w">       </span><span class="o">|</span><span class="w">   </span><span class="n">PPN</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w">   </span><span class="o">|</span><span class="w">   </span><span class="n">PPN</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w">   </span><span class="o">|</span><span class="w">          </span><span class="n">page</span><span class="w"> </span><span class="n">offset</span><span class="w">         </span><span class="o">|</span><span class="w"></span>
<span class="w"> </span><span class="o">-----------------------------------------------------------------------------</span><span class="w"></span>
<span class="w">                            </span><span class="n">Sv39</span><span class="w"> </span><span class="n">physical</span><span class="w"> </span><span class="n">address</span><span class="w"></span>
</code></pre></div>
</td></tr></table>
Sv39 模式定义的物理地址有 56 位，虚拟地址有 64 位。但是，虚拟地址的 64 位只有低 39 位有效——在使用 64 位虚拟地址时，必须保证其 63 ~ 39 号位与 38 号位相等，否则就会触发 Page Fault Exception。当虚拟地址的 63 ~ 38 号位都为 0 时，该地址处于 user space 中；都为 1 时处于 kernel space 中。</p>
<p>Sv39 支持三级页表结构。</p>
<ul>
<li>VPN (Virtual Page Number) 是虚拟地址所在页的页号，在地址转换中是查询页表所用的下标。VPN[2] ~ VPN[0] 分别用于查询顶级页表、二级页表、三级页表。</li>
<li>PPN (Physical Page Number) 是物理地址所在页的页号。</li>
<li>Page Offset 是页内偏移。</li>
</ul>
<p>必须指出，<strong>并不是三级页表都一定要用的：我们可以只用第一级，或只用前两级</strong>。</p>
<ul>
<li>只用第一级页表。此时，假设我们拿 <code>VA</code> 中的 <code>VPN[2]</code> 查询顶级页表得到的 PTE 中物理页号部分为 <code>{PPN[2], PPN[1], PPN[0]}</code>，那么地址转换得到的物理地址就是 <code>{PPN[2], VPN[1], VPN[0], VA.offset}</code>。此时虚拟内存的一页大小为 1 GiB，因为 <code>{VPN[1], VPN[0], VA.offset}</code> 连起来被看作页内偏移，一共有 30 位。</li>
<li>只用前两级页表。此时虚拟内存的一页大小就是 2 MiB 。</li>
<li>当然，我们可以用三级页表，此时虚拟内存的一页大小就是 4 KiB。</li>
</ul>
<p>具体介绍请阅读 <a href="https://www.five-embeddev.com/riscv-isa-manual/latest/supervisor.html#sec:sv39">RISC-V Privileged Spec 4.4.1</a>。</p>
<h4 id="323-risc-v-sv39-page-table-entry">3.2.3 RISC-V Sv39 Page Table Entry</h4>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="w"> </span><span class="mi">63</span><span class="w">      </span><span class="mi">54</span><span class="w"> </span><span class="mi">53</span><span class="w">        </span><span class="mi">28</span><span class="w"> </span><span class="mi">27</span><span class="w">        </span><span class="mi">19</span><span class="w"> </span><span class="mi">18</span><span class="w">        </span><span class="mi">10</span><span class="w"> </span><span class="mi">9</span><span class="w">   </span><span class="mi">8</span><span class="w"> </span><span class="mi">7</span><span class="w"> </span><span class="mi">6</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="w"> </span><span class="o">-----------------------------------------------------------------------</span><span class="w"></span>
<span class="o">|</span><span class="w"> </span><span class="n">Reserved</span><span class="w"> </span><span class="o">|</span><span class="w">   </span><span class="n">PPN</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="w">   </span><span class="o">|</span><span class="w">   </span><span class="n">PPN</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w">   </span><span class="o">|</span><span class="w">   </span><span class="n">PPN</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="n">RSW</span><span class="w"> </span><span class="o">|</span><span class="n">D</span><span class="o">|</span><span class="n">A</span><span class="o">|</span><span class="n">G</span><span class="o">|</span><span class="n">U</span><span class="o">|</span><span class="n">X</span><span class="o">|</span><span class="n">W</span><span class="o">|</span><span class="n">R</span><span class="o">|</span><span class="n">V</span><span class="o">|</span><span class="w"></span>
<span class="w"> </span><span class="o">-----------------------------------------------------------------------</span><span class="w"></span>
<span class="w">                                                     </span><span class="o">|</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="o">|</span><span class="w"></span>
<span class="w">                                                     </span><span class="o">|</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="err">`</span><span class="o">----</span><span class="w"> </span><span class="n">V</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Valid</span><span class="w"></span>
<span class="w">                                                     </span><span class="o">|</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="err">`</span><span class="o">------</span><span class="w"> </span><span class="n">R</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Readable</span><span class="w"></span>
<span class="w">                                                     </span><span class="o">|</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="err">`</span><span class="o">--------</span><span class="w"> </span><span class="n">W</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Writable</span><span class="w"></span>
<span class="w">                                                     </span><span class="o">|</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="err">`</span><span class="o">----------</span><span class="w"> </span><span class="n">X</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Executable</span><span class="w"></span>
<span class="w">                                                     </span><span class="o">|</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="err">`</span><span class="o">------------</span><span class="w"> </span><span class="n">U</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">User</span><span class="w"></span>
<span class="w">                                                     </span><span class="o">|</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="err">`</span><span class="o">--------------</span><span class="w"> </span><span class="n">G</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Global</span><span class="w"></span>
<span class="w">                                                     </span><span class="o">|</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="err">`</span><span class="o">----------------</span><span class="w"> </span><span class="n">A</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Accessed</span><span class="w"></span>
<span class="w">                                                     </span><span class="o">|</span><span class="w">   </span><span class="err">`</span><span class="o">------------------</span><span class="w"> </span><span class="n">D</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Dirty</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="n">page</span><span class="w"> </span><span class="n">directory</span><span class="p">)</span><span class="w"></span>
<span class="w">                                                     </span><span class="err">`</span><span class="o">----------------------</span><span class="w"> </span><span class="n">Reserved</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">supervisor</span><span class="w"> </span><span class="n">software</span><span class="w"></span>
</code></pre></div>
</td></tr></table>
<ul>
<li>0 ～ 9 bit: protection bits<ul>
<li>V : 有效位。访问到 V = 0 的 PTE 时会产生 Page Fault。</li>
<li>R : R = 1 该页可读。</li>
<li>W : W = 1 该页可写。</li>
<li>X : X = 1 该页可执行。</li>
<li>U , G , A , D , RSW 本次实验中设置为 0 即可。</li>
</ul>
</li>
</ul>
<p>具体介绍请阅读 <a href="https://www.five-embeddev.com/riscv-isa-manual/latest/supervisor.html#sec:sv39">RISC-V Privileged Spec 4.4.1</a>。</p>
<h4 id="324-risc-v-address-translation">3.2.4 RISC-V Address Translation</h4>
<p>虚拟地址转化为物理地址流程图如下，具体描述见 <a href="https://www.five-embeddev.com/riscv-isa-manual/latest/supervisor.html#sv32algorithm">RISC-V Privileged Spec 4.3.2</a> :
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>                                Virtual Address                                     Physical Address

                          9             9            9              12          55        12 11       0
   ┌────────────────┬────────────┬────────────┬─────────────┬────────────────┐ ┌────────────┬──────────┐
   │                │   VPN[2]   │   VPN[1]   │   VPN[0]    │     OFFSET     │ │     PPN    │  OFFSET  │
   └────────────────┴────┬───────┴─────┬──────┴──────┬──────┴───────┬────────┘ └────────────┴──────────┘
                         │             │             │              │                 ▲          ▲
                         │             │             │              │                 │          │
                         │             │             │              │                 │          │
┌────────────────────────┘             │             │              │                 │          │
│                                      │             │              │                 │          │
│                                      │             │              └─────────────────┼──────────┘
│    ┌─────────────────┐               │             │                                │
│511 │                 │  ┌────────────┘             │                                │
│    │                 │  │                          │                                │
│    │                 │  │     ┌─────────────────┐  │                                │
│    │                 │  │ 511 │                 │  │                                │
│    │                 │  │     │                 │  │                                │
│    │                 │  │     │                 │  │     ┌─────────────────┐        │
│    │   44       10   │  │     │                 │  │ 511 │                 │        │
│    ├────────┬────────┤  │     │                 │  │     │                 │        │
└───►│   PPN  │  flags │  │     │                 │  │     │                 │        │
     ├────┬───┴────────┤  │     │   44       10   │  │     │                 │        │
     │    │            │  │     ├────────┬────────┤  │     │                 │        │
     │    │            │  └────►│   PPN  │  flags │  │     │                 │        │
     │    │            │        ├────┬───┴────────┤  │     │   44       10   │        │
     │    │            │        │    │            │  │     ├────────┬────────┤        │
   1 │    │            │        │    │            │  └────►│   PPN  │  flags │        │
     │    │            │        │    │            │        ├────┬───┴────────┤        │
   0 │    │            │        │    │            │        │    │            │        │
     └────┼────────────┘      1 │    │            │        │    │            │        │
     ▲    │                     │    │            │        │    └────────────┼────────┘
     │    │                   0 │    │            │        │                 │
     │    └────────────────────►└────┼────────────┘      1 │                 │
     │                               │                     │                 │
 ┌───┴────┐                          │                   0 │                 │
 │  satp  │                          └────────────────────►└─────────────────┘
 └────────┘
</code></pre></div>
</td></tr></table></p>
<h2 id="4">4 实验指导</h2>
<h3 id="40">4.0 任务与途径</h3>
<p><strong>本次实验的任务是开启虚拟内存，实现 direct mapping，并让 lab3 中的多进程程序在 direct mapping area 中执行。</strong></p>
<p>下面描述具体实现方式。为了描述清晰，我们先定义一些记号：</p>
<ul>
<li><span class="arithmatex">\(p_s\)</span>：物理地址的起始地址值，本实验中为 <code>0x80000000</code>。</li>
<li><span class="arithmatex">\(p_e\)</span>：物理地址的终止地址值，本实验中为 <code>0x8020000</code>。</li>
<li><span class="arithmatex">\(l\)</span>：物理地址段的长度，本实验中为 <code>0x8000000</code>，即 128MiB。</li>
<li><span class="arithmatex">\(b\)</span>：为 OpenSBI 预留的地址长度，本实验中为 <code>0x200000</code>，即 2 MiB。 </li>
<li><span class="arithmatex">\(v_s\)</span>：虚拟地址的起始地址值，本实验中为 <code>0xffffffe000000000</code></li>
<li><span class="arithmatex">\(v_e\)</span>：虚拟地址的终止地址值，本实验中为 <code>0xffffffe000200000</code></li>
<li><span class="arithmatex">\(t=v_s-p_s\)</span>，虚拟地址相对于物理地址的偏移量 (offset)</li>
<li><span class="arithmatex">\([a, b)\to [c, d)\)</span>：内存映射，把<strong>虚拟地址空间</strong>的 <span class="arithmatex">\([a, b)\)</span> 映射到<strong>物理地址空间</strong>的 <span class="arithmatex">\([c, d)\)</span>。当然，要求两段长度相同。</li>
</ul>
<p>完美开启虚拟内存分为两步：</p>
<p><strong>第一回映射，分两块</strong>：</p>
<ul>
<li><span class="arithmatex">\([p_s, p_s+d)\to [p_s, p_s+d)\)</span>，称为等值映射</li>
<li><span class="arithmatex">\([v_s, v_s+d)\to [p_s, p_s+d)\)</span>，称为偏移映射（即上文中的 linear mapping）</li>
</ul>
<p>其中 <span class="arithmatex">\(d\)</span> = 1 GiB。</p>
<p>我们的物理地址段只有 <span class="arithmatex">\(l\)</span> = 128 MiB 这么大，为什么要做 1 GiB 的映射呢？这仅仅是为了方便。可以想象，如果使用两级或三级页表，就会涉及多个物理页的管理，比较麻烦；若只用第一级页表，我们就只需要一个物理页来存放它，非常方便。因此在第一回映射时我们就只用第一级页表，从而虚拟内存一页的大小就是 1 GiB（见上文）。只要我们实际访问的地址都在 128 MiB 的范围内，这样就是无害的。</p>
<p><strong>第二回映射</strong>：</p>
<ul>
<li><span class="arithmatex">\([v_s+b, v_e)\to [p_s+b, p_e)\)</span> </li>
</ul>
<p>为什么左端点要加 <span class="arithmatex">\(b\)</span> 呢？因为 <span class="arithmatex">\([v_s, v_s+b)\)</span> 这一段虚拟地址根本就用不着——若要访问这一段，访问到的是 OpenSBI，但我们在 S 态下不会（也不应该）访问它。需要访问它的是 M 态，而 M 态根本不受 <code>satp</code>（S 模式的地址转换）影响——在 M 态里程序直接用物理地址 <span class="arithmatex">\([p_s, p_s+b)\)</span> 访问 OpenSBI。</p>
<p>第二回映射用三级页表来实现。</p>
<p>第二回映射会覆盖第一回映射。即，当我们把 <code>satp</code> 指向承载第二回映射的页表时，第一回映射就自动失效了。最后我们就得到了不多不少刚刚好的虚拟地址到物理地址的映射。</p>
<p>这里留下几个问题（也在思考题中），请同学思考：</p>
<ul>
<li>为什么第一回映射里要做等值映射？</li>
<li>为什么要分这样两步呢？能否一步做完？</li>
</ul>
<p>下面是具体编程的指引。</p>
<h3 id="41">4.1 准备工作</h3>
<p>此次实验基于 lab3 同学所实现的代码进行。</p>
<p>需要修改 <code>defs.h</code>，写入上面定义的常量。在 <code>defs.h</code> 中加入如下内容：
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span>
<span class="normal">7</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="cp">#define OPENSBI_SIZE (0x200000)</span>

<span class="cp">#define VM_START (0xffffffe000000000)</span>
<span class="cp">#define VM_END   (0xffffffff00000000)</span>
<span class="cp">#define VM_SIZE  (VM_END - VM_START)</span>

<span class="cp">#define PA2VA_OFFSET (VM_START - PHY_START)</span>
</code></pre></div>
</td></tr></table></p>
<p>从 <code>repo</code> 同步以下代码: <code>vmlinux.lds.S</code>, <code>Makefile</code>。并按照以下步骤将这些文件正确放置。
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>.
└── arch
    └── riscv
        └── kernel
            ├── Makefile
            └── vmlinux.lds.S
</code></pre></div>
</td></tr></table>
这里我们通过 <code>vmlinux.lds.S</code> 模版生成 <code>vmlinux.lds</code>文件。链接脚本中的 <code>ramv</code> 代表 VMA (Virtual Memory Address)，即虚拟地址；<code>ram</code> 则代表 LMA (Load Memory Address)，即我们 OS image 被 load 的地址，可以理解为物理地址。使用以上的 <code>vmlinux.lds</code> 进行编译之后，得到的 <code>System.map</code> 以及 <code>vmlinux</code> 采用的都是虚拟地址，方便之后 debug。</p>
<h3 id="42">4.2 第一回映射</h3>
<p>下图描绘了第一回映射的状况：
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>Physical Address
-------------------------------------------
                     | OpenSBI | Kernel |
-------------------------------------------
                     ^
                0x80000000
                     ├───────────────────────────────────────────────────┐
                     |                                                   |
Virtual Address      |                                                   |
-----------------------------------------------------------------------------------------------
                     | OpenSBI | Kernel |                                | OpenSBI | Kernel |
-----------------------------------------------------------------------------------------------
                     ^                                                   ^
                0x80000000                                       0xffffffe000000000
</code></pre></div>
</td></tr></table></p>
<p>我们用两个函数实现第一回映射：</p>
<ul>
<li><code>arch/riscv/kernel/vm.c : setup_vm</code>：配置好页表；</li>
<li><code>arch/riscv/kernel/head.S : relocate</code>：配置 <code>satp</code>，并返回到高地址。</li>
</ul>
<p><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="c1">// arch/riscv/kernel/vm.c</span>

<span class="cm">/* early_pgtbl: 第一回映射的页表, 大小恰好为一页 4 KiB, 开头对齐页边界 */</span><span class="w"></span>
<span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w">  </span><span class="n">early_pgtbl</span><span class="p">[</span><span class="mi">512</span><span class="p">]</span><span class="w"> </span><span class="n">__attribute__</span><span class="p">((</span><span class="n">__aligned__</span><span class="p">(</span><span class="mh">0x1000</span><span class="p">)));</span><span class="w"></span>

<span class="kt">void</span><span class="w"> </span><span class="nf">setup_vm</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="cm">/* </span>
<span class="cm">    1. 如前文所说，只使用第一级页表</span>
<span class="cm">    2. 因此 VA 的 64bit 作为如下划分： | high bit | 9 bit | 30 bit |</span>
<span class="cm">        high bit 可以忽略</span>
<span class="cm">        中间 9 bit 作为 early_pgtbl 的 index</span>
<span class="cm">        低 30 bit 作为页内偏移</span>
<span class="cm">    3. Page Table Entry 的权限 V | R | W | X 位设置为 1</span>
<span class="cm">    */</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
</td></tr></table>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="c1"># arch/riscv/kernel/head.S</span>

<span class="nl">_start:</span><span class="w"></span>

<span class="w">    </span><span class="nf">call</span><span class="w"> </span><span class="no">setup_vm</span><span class="w"></span>
<span class="w">    </span><span class="nf">call</span><span class="w"> </span><span class="no">relocate</span><span class="w"></span>

<span class="w">    </span><span class="na">...</span><span class="w"></span>

<span class="w">    </span><span class="nf">j</span><span class="w"> </span><span class="no">start_kernel</span><span class="w"></span>

<span class="nl">relocate:</span><span class="w"></span>
<span class="w">    </span><span class="c1"># set ra = ra + PA2VA_OFFSET</span>
<span class="w">    </span><span class="c1"># set sp = sp + PA2VA_OFFSET (If you have set the sp before)</span>

<span class="w">    </span><span class="c1">###################### </span>
<span class="w">    </span><span class="c1">#   YOUR CODE HERE   #</span>
<span class="w">    </span><span class="c1">######################</span>

<span class="w">    </span><span class="c1"># set satp with early_pgtbl</span>

<span class="w">    </span><span class="c1">###################### </span>
<span class="w">    </span><span class="c1">#   YOUR CODE HERE   #</span>
<span class="w">    </span><span class="c1">######################</span>

<span class="w">    </span><span class="c1"># flush tlb</span>
<span class="w">    </span><span class="nf">sfence.vma</span><span class="w"> </span><span class="no">zero</span><span class="p">,</span><span class="w"> </span><span class="no">zero</span><span class="w"></span>

<span class="w">    </span><span class="nf">ret</span><span class="w"></span>

<span class="w">    </span><span class="na">.section</span><span class="w"> </span><span class="no">.bss.stack</span><span class="w"></span>
<span class="w">    </span><span class="na">.globl</span><span class="w"> </span><span class="no">boot_stack</span><span class="w"></span>
<span class="nl">boot_stack:</span><span class="w"></span>
<span class="w">    </span><span class="na">...</span><span class="w"></span>
</code></pre></div>
</td></tr></table></p>
<blockquote>
<p>Hint 1: <code>sfence.vma</code> 指令用于刷新 TLB</p>
<p>Hint 2: 在 set satp 前，我们只可以使用<strong>物理地址</strong>来打断点。设置 satp 之后，才可以使用虚拟地址打断点，同时之前设置的物理地址断点也会失效，需要删除。</p>
<p>Hint 3: 如果要调试代码，可以使用 <code>.gdbinit</code> 做一些自动化。在启动 GDB 的那个目录下新建 <code>.gdbinit</code> 文件，在其中写入 GDB 指令，GDB 就会在启动时自动执行它们。比如在其中写入 <code>target remote :1234</code>、打断点指令、执行到断点处的指令，GDB 在启动后就会自动链接上 QEMU，打断点并跳到断点处。这能极大地提升调试体验。</p>
</blockquote>
<h3 id="43">4.3 第二回映射</h3>
<p>下图描绘了第二回映射的状况：
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>Physical Address
     PHY_START                           PHY_END
         ↓                                  ↓
--------------------------------------------------------
         | OpenSBI | Kernel |               |
--------------------------------------------------------
                   ^                        ^
               0x80200000                   └───────────────────────────────────────────────────┐
                   └───────────────────────────────────────────────────┐                        |
                                                                       |                        |
                                                                    VM_START                    |
Virtual Address                                                        |                        |
----------------------------------------------------------------------------------------------------
                                                             | OpenSBI | Kernel |               |
-----------------------------------------------------------------------------------------------------
                                                                       ^
                                                               0xffffffe000200000
</code></pre></div>
</td></tr></table></p>
<p>第二回映射要使用三级页表，所以我们需要管理多个页面。一个好办法是先执行 <code>mm.c</code> 中的 <code>mm_init</code> 初始化内存管理模块，然后再配置页表。当我们需要新页时，调用 <code>kalloc()</code> 申请一页即可。<strong>注意，本次实验与之前不同， <code>mm_init</code> 运行在虚拟地址上，所以 <code>mm_init</code> 函数需要一些修改</strong>，请你自行完成。</p>
<p>第二回映射中，建立页表和设置 <code>satp</code> 用一个函数 <code>arch/riscv/kernel/vm.c : setup_vm_final</code> 来实现。</p>
<p>完成下面的代码，并在 <code>head.S</code> 的适当位置调用 <code>setup_vm_final</code>。</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="c1">// arch/riscv/kernel/vm.c </span>

<span class="cm">/* swapper_pg_dir: kernel pagetable 根目录， 在 setup_vm_final 进行映射。 */</span><span class="w"></span>
<span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w">  </span><span class="n">swapper_pg_dir</span><span class="p">[</span><span class="mi">512</span><span class="p">]</span><span class="w"> </span><span class="n">__attribute__</span><span class="p">((</span><span class="n">__aligned__</span><span class="p">(</span><span class="mh">0x1000</span><span class="p">)));</span><span class="w"></span>

<span class="kt">void</span><span class="w"> </span><span class="nf">setup_vm_final</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">memset</span><span class="p">(</span><span class="n">swapper_pg_dir</span><span class="p">,</span><span class="w"> </span><span class="mh">0x0</span><span class="p">,</span><span class="w"> </span><span class="n">PGSIZE</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="c1">// No OpenSBI mapping required</span>

<span class="w">    </span><span class="c1">// mapping kernel text X|-|R|V</span>
<span class="w">    </span><span class="n">create_mapping</span><span class="p">(...);</span><span class="w"></span>

<span class="w">    </span><span class="c1">// mapping kernel rodata -|-|R|V</span>
<span class="w">    </span><span class="n">create_mapping</span><span class="p">(...);</span><span class="w"></span>

<span class="w">    </span><span class="c1">// mapping other memory -|W|R|V</span>
<span class="w">    </span><span class="n">create_mapping</span><span class="p">(...);</span><span class="w"></span>

<span class="w">    </span><span class="c1">// set satp with swapper_pg_dir</span>

<span class="w">    </span><span class="n">YOUR</span><span class="w"> </span><span class="n">CODE</span><span class="w"> </span><span class="n">HERE</span><span class="w"></span>

<span class="w">    </span><span class="c1">// flush TLB</span>
<span class="w">    </span><span class="k">asm</span><span class="w"> </span><span class="k">volatile</span><span class="p">(</span><span class="s">&quot;sfence.vma zero, zero&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>


<span class="cm">/* 创建多级页表映射关系 */</span><span class="w"></span>
<span class="n">create_mapping</span><span class="p">(</span><span class="n">uint64</span><span class="w"> </span><span class="o">*</span><span class="n">pgtbl</span><span class="p">,</span><span class="w"> </span><span class="n">uint64</span><span class="w"> </span><span class="n">va</span><span class="p">,</span><span class="w"> </span><span class="n">uint64</span><span class="w"> </span><span class="n">pa</span><span class="p">,</span><span class="w"> </span><span class="n">uint64</span><span class="w"> </span><span class="n">sz</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">perm</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="cm">/*</span>
<span class="cm">    pgtbl 为根页表的基地址</span>
<span class="cm">    va, pa 为需要映射的虚拟地址、物理地址</span>
<span class="cm">    sz 为映射的大小</span>
<span class="cm">    perm 为映射的读写权限</span>

<span class="cm">    创建多级页表的时候可以使用 kalloc() 来获取一页作为页表目录</span>
<span class="cm">    可以使用 V bit 来判断页表项是否存在</span>
<span class="cm">    */</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
</td></tr></table>
<h3 id="44">4.4 编译及测试</h3>
<p>由于加入了一些新的 C 文件，可能需要修改一些 Makefile 文件，请同学自己尝试修改，使项目可以编译并运行。</p>
<p>输出示例：
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>OpenSBI v0.9
  ____                    _____ ____ _____
 / __ <span class="se">\ </span>                 / ____<span class="p">|</span>  _ <span class="se">\_</span>   _<span class="p">|</span>
<span class="p">|</span> <span class="p">|</span>  <span class="p">|</span> <span class="p">|</span>_ __   ___ _ __ <span class="p">|</span> <span class="o">(</span>___ <span class="p">|</span> <span class="p">|</span>_<span class="o">)</span> <span class="o">||</span> <span class="p">|</span>
<span class="p">|</span> <span class="p">|</span>  <span class="p">|</span> <span class="p">|</span> <span class="s1">&#39;_ \ / _ \ &#39;</span>_ <span class="se">\ \_</span>__ <span class="se">\|</span>  _ &lt; <span class="p">|</span> <span class="p">|</span>
<span class="p">|</span> <span class="p">|</span>__<span class="p">|</span> <span class="p">|</span> <span class="p">|</span>_<span class="o">)</span> <span class="p">|</span>  __/ <span class="p">|</span> <span class="p">|</span> <span class="p">|</span>____<span class="o">)</span> <span class="p">|</span> <span class="p">|</span>_<span class="o">)</span> <span class="o">||</span> <span class="p">|</span>_
 <span class="se">\_</span>___/<span class="p">|</span> .__/ <span class="se">\_</span>__<span class="p">|</span>_<span class="p">|</span> <span class="p">|</span>_<span class="p">|</span>_____/<span class="p">|</span>____/_____<span class="p">|</span>
       <span class="p">|</span> <span class="p">|</span>
       <span class="p">|</span>_<span class="p">|</span>

...

Boot HART MIDELEG         : 0x0000000000000222
Boot HART MEDELEG         : 0x000000000000b109

...mm_init <span class="k">done</span>!
...proc_init <span class="k">done</span>!
Hello RISC-V
idle process is running!

switch to <span class="o">[</span><span class="nv">PID</span> <span class="o">=</span> <span class="m">28</span> <span class="nv">COUNTER</span> <span class="o">=</span> <span class="m">1</span><span class="o">]</span> 
<span class="o">[</span><span class="nv">PID</span> <span class="o">=</span> <span class="m">28</span><span class="o">]</span> is running! thread space begin at 0xffffffe007fa2000

switch to <span class="o">[</span><span class="nv">PID</span> <span class="o">=</span> <span class="m">12</span> <span class="nv">COUNTER</span> <span class="o">=</span> <span class="m">1</span><span class="o">]</span> 
<span class="o">[</span><span class="nv">PID</span> <span class="o">=</span> <span class="m">12</span><span class="o">]</span> is running! thread space begin at 0xffffffe007fb2000

switch to <span class="o">[</span><span class="nv">PID</span> <span class="o">=</span> <span class="m">14</span> <span class="nv">COUNTER</span> <span class="o">=</span> <span class="m">2</span><span class="o">]</span> 
<span class="o">[</span><span class="nv">PID</span> <span class="o">=</span> <span class="m">14</span><span class="o">]</span> is running! thread space begin at 0xffffffe007fb0000
<span class="o">[</span><span class="nv">PID</span> <span class="o">=</span> <span class="m">14</span><span class="o">]</span> is running! thread space begin at 0xffffffe007fb0000

switch to <span class="o">[</span><span class="nv">PID</span> <span class="o">=</span> <span class="m">9</span> <span class="nv">COUNTER</span> <span class="o">=</span> <span class="m">2</span><span class="o">]</span> 
<span class="o">[</span><span class="nv">PID</span> <span class="o">=</span> <span class="m">9</span><span class="o">]</span> is running! thread space begin at 0xffffffe007fb5000
<span class="o">[</span><span class="nv">PID</span> <span class="o">=</span> <span class="m">9</span><span class="o">]</span> is running! thread space begin at 0xffffffe007fb5000

switch to <span class="o">[</span><span class="nv">PID</span> <span class="o">=</span> <span class="m">2</span> <span class="nv">COUNTER</span> <span class="o">=</span> <span class="m">2</span><span class="o">]</span> 
<span class="o">[</span><span class="nv">PID</span> <span class="o">=</span> <span class="m">2</span><span class="o">]</span> is running! thread space begin at 0xffffffe007fbc000
<span class="o">[</span><span class="nv">PID</span> <span class="o">=</span> <span class="m">2</span><span class="o">]</span> is running! thread space begin at 0xffffffe007fbc000

switch to <span class="o">[</span><span class="nv">PID</span> <span class="o">=</span> <span class="m">1</span> <span class="nv">COUNTER</span> <span class="o">=</span> <span class="m">2</span><span class="o">]</span> 
<span class="o">[</span><span class="nv">PID</span> <span class="o">=</span> <span class="m">1</span><span class="o">]</span> is running! thread space begin at 0xffffffe007fbd000
<span class="o">[</span><span class="nv">PID</span> <span class="o">=</span> <span class="m">1</span><span class="o">]</span> is running! thread space begin at 0xffffffe007fbd000

switch to <span class="o">[</span><span class="nv">PID</span> <span class="o">=</span> <span class="m">29</span> <span class="nv">COUNTER</span> <span class="o">=</span> <span class="m">3</span><span class="o">]</span> 
<span class="o">[</span><span class="nv">PID</span> <span class="o">=</span> <span class="m">29</span><span class="o">]</span> is running! thread space begin at 0xffffffe007fa1000
<span class="o">[</span><span class="nv">PID</span> <span class="o">=</span> <span class="m">29</span><span class="o">]</span> is running! thread space begin at 0xffffffe007fa1000
<span class="o">[</span><span class="nv">PID</span> <span class="o">=</span> <span class="m">29</span><span class="o">]</span> is running! thread space begin at 0xffffffe007fa1000

switch to <span class="o">[</span><span class="nv">PID</span> <span class="o">=</span> <span class="m">11</span> <span class="nv">COUNTER</span> <span class="o">=</span> <span class="m">3</span><span class="o">]</span> 
<span class="o">[</span><span class="nv">PID</span> <span class="o">=</span> <span class="m">11</span><span class="o">]</span> is running! thread space begin at 0xffffffe007fb3000
...
</code></pre></div>
</td></tr></table></p>
<h2 id="_1">思考题</h2>
<ol>
<li>验证 <code>.text</code>, <code>.rodata</code> 段的属性是否成功设置，给出截图。</li>
<li>为什么我们在 <code>setup_vm</code> 中需要做等值映射?</li>
<li>在 Linux 中，是不需要做等值映射的。请探索一下不在 <code>setup_vm</code> 中做等值映射的方法。</li>
</ol>
<h2 id="_2">作业提交</h2>
<p>同学需要提交实验报告以及整个工程代码。在提交前请使用 <code>make clean</code> 清除所有构建产物。</p>

              
            </article>
          </div>
        </div>
        
          <a href="#" class="md-top md-icon" data-md-component="top" data-md-state="hidden">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12Z"/></svg>
            Back to top
          </a>
        
      </main>
      
        <footer class="md-footer">
  
    <nav class="md-footer__inner md-grid" aria-label="Footer">
      
        
        <a href="../lab3/" class="md-footer__link md-footer__link--prev" aria-label="Previous: 实验指导三" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Previous
              </span>
              实验指导三
            </div>
          </div>
        </a>
      
      
        
        <a href="../lab5/" class="md-footer__link md-footer__link--next" aria-label="Next: 实验指导五" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Next
              </span>
              实验指导五
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"/></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "..", "features": ["navigation.top"], "search": "../assets/javascripts/workers/search.2a1c317c.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version.title": "Select version"}}</script>
    
    
      <script src="../assets/javascripts/bundle.6e54b5cd.min.js"></script>
      
        <script src="../javascripts/mathjax.js"></script>
      
        <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
      
        <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
      
    
  </body>
</html>