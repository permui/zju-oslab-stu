
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://zjusec.gitee.io/os21fall/lab6/">
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.3.0, mkdocs-material-8.2.9">
    
    
      
        <title>实验指导六 - 浙江大学21年秋操作系统实验</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.120efc48.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.9647289d.min.css">
        
      
    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CCascadia:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Cascadia"}</style>
      
    
    
      <link rel="stylesheet" href="../stylesheets/extra.css">
    
    <script>__md_scope=new URL("..",location),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="" data-md-color-accent="">
  
    
    
      <script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#lab-6-rv64-fork" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="浙江大学21年秋操作系统实验" class="md-header__button md-logo" aria-label="浙江大学21年秋操作系统实验" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            浙江大学21年秋操作系统实验
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              实验指导六
            
          </span>
        </div>
      </div>
    </div>
    
      <form class="md-header__option" data-md-component="palette">
        
          
          
          <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="" data-md-color-accent=""  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_1">
          
            <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_2" hidden>
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 6H7c-3.31 0-6 2.69-6 6s2.69 6 6 6h10c3.31 0 6-2.69 6-6s-2.69-6-6-6zm0 10H7c-2.21 0-4-1.79-4-4s1.79-4 4-4h10c2.21 0 4 1.79 4 4s-1.79 4-4 4zM7 9c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg>
            </label>
          
        
          
          
          <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="" data-md-color-accent=""  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_2">
          
            <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_1" hidden>
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 7H7a5 5 0 0 0-5 5 5 5 0 0 0 5 5h10a5 5 0 0 0 5-5 5 5 0 0 0-5-5m0 8a3 3 0 0 1-3-3 3 3 0 0 1 3-3 3 3 0 0 1 3 3 3 3 0 0 1-3 3Z"/></svg>
            </label>
          
        
      </form>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://gitee.com/zjusec/os21fall" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.1.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    zjusec/os21fall
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="浙江大学21年秋操作系统实验" class="md-nav__button md-logo" aria-label="浙江大学21年秋操作系统实验" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    浙江大学21年秋操作系统实验
  </label>
  
    <div class="md-nav__source">
      <a href="https://gitee.com/zjusec/os21fall" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.1.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    zjusec/os21fall
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../lab0/" class="md-nav__link">
        实验指导零
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../lab1/" class="md-nav__link">
        实验指导一
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../lab2/" class="md-nav__link">
        实验指导二
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../lab3/" class="md-nav__link">
        实验指导三
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../lab4/" class="md-nav__link">
        实验指导四
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../lab5/" class="md-nav__link">
        实验指导五
      </a>
    </li>
  

    
      
      
      

  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          实验指导六
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        实验指导六
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#1" class="md-nav__link">
    1. 实验目的
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2" class="md-nav__link">
    2. 实验环境
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#3" class="md-nav__link">
    3. 背景知识
  </a>
  
    <nav class="md-nav" aria-label="3. 背景知识">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#31-vm_area_struct" class="md-nav__link">
    3.1 vm_area_struct 介绍
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#32-page-fault" class="md-nav__link">
    3.2 缺页异常 Page Fault
  </a>
  
    <nav class="md-nav" aria-label="3.2 缺页异常 Page Fault">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#321-risc-v-page-faults" class="md-nav__link">
    3.2.1 RISC-V Page Faults
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#322-page-fault" class="md-nav__link">
    3.2.2 常规处理 Page Fault 的方式介绍
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#33-fork" class="md-nav__link">
    3.3 fork 系统调用
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#4" class="md-nav__link">
    4 实验步骤
  </a>
  
    <nav class="md-nav" aria-label="4 实验步骤">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#41" class="md-nav__link">
    4.1 准备工作
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#42" class="md-nav__link">
    4.2 实现虚拟内存管理功能：
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#43-page-fault-handler" class="md-nav__link">
    4.3 Page Fault Handler
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#44-fork" class="md-nav__link">
    4.4 实现 fork()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#45" class="md-nav__link">
    4.5 编译及测试
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    作业提交
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../faq/" class="md-nav__link">
        常见问题及解答
      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#1" class="md-nav__link">
    1. 实验目的
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2" class="md-nav__link">
    2. 实验环境
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#3" class="md-nav__link">
    3. 背景知识
  </a>
  
    <nav class="md-nav" aria-label="3. 背景知识">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#31-vm_area_struct" class="md-nav__link">
    3.1 vm_area_struct 介绍
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#32-page-fault" class="md-nav__link">
    3.2 缺页异常 Page Fault
  </a>
  
    <nav class="md-nav" aria-label="3.2 缺页异常 Page Fault">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#321-risc-v-page-faults" class="md-nav__link">
    3.2.1 RISC-V Page Faults
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#322-page-fault" class="md-nav__link">
    3.2.2 常规处理 Page Fault 的方式介绍
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#33-fork" class="md-nav__link">
    3.3 fork 系统调用
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#4" class="md-nav__link">
    4 实验步骤
  </a>
  
    <nav class="md-nav" aria-label="4 实验步骤">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#41" class="md-nav__link">
    4.1 准备工作
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#42" class="md-nav__link">
    4.2 实现虚拟内存管理功能：
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#43-page-fault-handler" class="md-nav__link">
    4.3 Page Fault Handler
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#44-fork" class="md-nav__link">
    4.4 实现 fork()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#45" class="md-nav__link">
    4.5 编译及测试
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    作业提交
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                


<h1 id="lab-6-rv64-fork">Lab 6: RV64 缺页异常处理以及 fork 机制</h1>
<h2 id="1">1. 实验目的</h2>
<ul>
<li>通过 <strong>vm_area_struct</strong> 数据结构实现对进程<strong>多区域</strong>虚拟内存的管理。</li>
<li>在 <strong>Lab5</strong> 实现用户态程序的基础上，添加缺页异常处理 <strong>Page Fault Handler</strong>。</li>
<li>为进程加入 <strong>fork</strong> 机制，能够支持通过 <strong>fork</strong> 创建新的用户态进程。</li>
</ul>
<h2 id="2">2. 实验环境</h2>
<ul>
<li>Docker in Lab0</li>
</ul>
<h2 id="3">3. 背景知识</h2>
<h3 id="31-vm_area_struct">3.1 vm_area_struct 介绍</h3>
<p>在linux系统中，<code>vm_area_struct</code> 是虚拟内存管理的基本单元， <code>vm_area_struct</code> 保存了有关连续虚拟内存区域(简称vma)的信息。linux 具体某一进程的虚拟内存区域映射关系可以通过 <a href="https://man7.org/linux/man-pages/man5/procfs.5.html">procfs【Link】</a> 读取 <code>/proc/pid/maps</code> 的内容来获取:</p>
<p>比如，如下一个常规的 <code>bash</code> 进程，假设它的进程号为 <code>7884</code> ，则通过输入如下命令，就可以查看该进程具体的虚拟地址内存映射情况(部分信息已省略)。</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="c1">#cat /proc/7884/maps</span>
556f22759000-556f22786000 r--p <span class="m">00000000</span> <span class="m">08</span>:05 <span class="m">16515165</span>                   /usr/bin/bash
556f22786000-556f22837000 r-xp 0002d000 <span class="m">08</span>:05 <span class="m">16515165</span>                   /usr/bin/bash
556f22837000-556f2286e000 r--p 000de000 <span class="m">08</span>:05 <span class="m">16515165</span>                   /usr/bin/bash
556f2286e000-556f22872000 r--p <span class="m">00114000</span> <span class="m">08</span>:05 <span class="m">16515165</span>                   /usr/bin/bash
556f22872000-556f2287b000 rw-p <span class="m">00118000</span> <span class="m">08</span>:05 <span class="m">16515165</span>                   /usr/bin/bash
556f22fa5000-556f2312c000 rw-p <span class="m">00000000</span> <span class="m">00</span>:00 <span class="m">0</span>                          <span class="o">[</span>heap<span class="o">]</span>
7fb9edb0f000-7fb9edb12000 r--p <span class="m">00000000</span> <span class="m">08</span>:05 <span class="m">16517264</span>                   /usr/lib/x86_64-linux-gnu/libnss_files-2.31.so
7fb9edb12000-7fb9edb19000 r-xp <span class="m">00003000</span> <span class="m">08</span>:05 <span class="m">16517264</span>                   /usr/lib/x86_64-linux-gnu/libnss_files-2.31.so                 
...
7ffee5cdc000-7ffee5cfd000 rw-p <span class="m">00000000</span> <span class="m">00</span>:00 <span class="m">0</span>                          <span class="o">[</span>stack<span class="o">]</span>
7ffee5dce000-7ffee5dd1000 r--p <span class="m">00000000</span> <span class="m">00</span>:00 <span class="m">0</span>                          <span class="o">[</span>vvar<span class="o">]</span>
7ffee5dd1000-7ffee5dd2000 r-xp <span class="m">00000000</span> <span class="m">00</span>:00 <span class="m">0</span>                          <span class="o">[</span>vdso<span class="o">]</span>
ffffffffff600000-ffffffffff601000 --xp <span class="m">00000000</span> <span class="m">00</span>:00 <span class="m">0</span>                  <span class="o">[</span>vsyscall<span class="o">]</span>
</code></pre></div>
</td></tr></table>
<p>从中我们可以读取如下一些有关该进程内虚拟内存映射的关键信息：</p>
<ul>
<li><code>vm_start</code> :  (第1列) 指的是该段虚拟内存区域的开始地址</li>
<li><code>vm_end</code> :  (第2列) 指的是该段虚拟内存区域的结束地址</li>
<li><code>vm_flags</code> :  (第3列) 该 <code>vm_area</code> 的一组权限(rwx)标志， <code>vm_flags</code> 的具体取值定义可参考linux源代码的 <a href="https://elixir.bootlin.com/linux/v5.14/source/include/linux/mm.h#L265">linux/mm.h</a></li>
<li><code>vm_pgoff</code> :  (第4列) 虚拟内存映射区域在文件内的偏移量</li>
<li><code>vm_file</code> :  (第5/6/7列)分别表示：映射文件所属设备号/以及指向关联文件结构的指针(如果有的话，一般为文件系统的inode)/以及文件名</li>
</ul>
<p>其它保存在 <code>vm_area_struct</code> 中的信息还有：</p>
<ul>
<li><code>vm_ops</code> :  该<code>vm_area</code>中的一组工作函数</li>
<li><code>vm_next/vm_prev</code>: 同一进程的所有虚拟内存区域由<strong>链表结构</strong>链接起来，这是分别指向前后两个 <code>vm_area_struct</code> 结构体的指针</li>
</ul>
<h3 id="32-page-fault">3.2 缺页异常 Page Fault</h3>
<p>缺页异常是一种正在运行的程序访问当前未由内存管理单元（ MMU ）映射到虚拟内存的页面时，由计算机硬件引发的异常类型。访问未被映射的页或访问权限不足，都会导致该类异常的发生。处理缺页异常通常是操作系统内核的一部分。当处理缺页异常时，操作系统将尝试使所需页面在物理内存中的位置变得可访问（建立新的映射关系到虚拟内存）。而如果在非法访问内存的情况下，即发现触发 <code>Page Fault</code> 的虚拟内存地址（ Bad Address ）不在当前进程 <code>vm_area_struct</code> 链表中所定义的允许访问的虚拟内存地址范围内，或访问位置的权限条件不满足时，缺页异常处理将终止该程序的继续运行。 </p>
<h4 id="321-risc-v-page-faults">3.2.1 RISC-V Page Faults</h4>
<p>RISC-V 异常处理：当系统运行发生异常时，可即时地通过解析csr scause寄存器的值，识别如下三种不同的Page Fault。</p>
<p><strong>SCAUSE</strong> 寄存器指示发生异常的种类：</p>
<table>
<thead>
<tr>
<th>Interrupt</th>
<th>Exception Code</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>0</td>
<td>12</td>
<td>Instruction Page Fault</td>
</tr>
<tr>
<td>0</td>
<td>13</td>
<td>Load Page Fault</td>
</tr>
<tr>
<td>0</td>
<td>15</td>
<td>Store/AMO Page Fault</td>
</tr>
</tbody>
</table>
<h4 id="322-page-fault">3.2.2 常规处理 <strong>Page Fault</strong> 的方式介绍</h4>
<p>处理缺页异常时所需的信息如下：</p>
<ul>
<li>触发 <strong>Page Fault</strong> 时访问的虚拟内存地址 VA。当触发 page fault 时，<code>stval</code> 寄存器被被硬件自动设置为该出错的VA地址</li>
<li>导致 <strong>Page Fault</strong> 的类型：<ul>
<li>Exception Code = 12: page fault caused by an instruction fetch </li>
<li>Exception Code = 13: page fault caused by a read  </li>
<li>Exception Code = 15: page fault caused by a write </li>
</ul>
</li>
<li>发生 <strong>Page Fault</strong> 时的指令执行位置，保存在 <code>sepc</code> 中</li>
<li>当前进程合法的 <strong>VMA</strong> 映射关系，保存在<code>vm_area_struct</code>链表中</li>
</ul>
<h3 id="33-fork">3.3 <code>fork</code> 系统调用</h3>
<ul>
<li><code>fork()</code>通过复制当前进程创建一个新的进程，新进程称为子进程，而原进程称为父进程。</li>
<li>子进程和父进程在不同的内存空间上运行。</li>
<li>父进程<code>fork</code>成功时<code>返回：子进程的pid</code>，子进程<code>返回：0</code>。<code>fork</code>失败则父进程<code>返回：-1</code>。</li>
<li>创建的子进程需要拷贝父进程 <code>task_struct</code>、<code>pgd</code>、<code>mm_struct</code> 以及父进程的 <code>user stack</code> 等信息。</li>
<li>Linux 中使用了 <code>copy-on-write</code> 机制，<code>fork</code> 创建的子进程首先与父进程共享物理内存空间，直到父子进程有修改内存的操作发生时再为子进程分配物理内存。</li>
</ul>
<h2 id="4">4 实验步骤</h2>
<h3 id="41">4.1 准备工作</h3>
<ul>
<li>此次实验基于 lab5 同学所实现的代码进行。</li>
<li>从 repo 同步以下文件夹: user 并按照以下步骤将这些文件正确放置。
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>.
└── user
    ├── Makefile
    ├── getpid.c
    ├── link.lds
    ├── printf.c
    ├── start.S
    ├── stddef.h
    ├── stdio.h
    ├── syscall.h
    └── uapp.S
</code></pre></div>
</td></tr></table></li>
<li>在 <code>user/getpid.c</code> 中我们设置了三个 <code>main</code> 函数。在实现了 <code>Page Fault</code> 之后第一个 <code>main</code> 函数可以成功运行。在实现了 <code>fork</code> 之后其余两个 <code>main</code> 函数可以成功运行。</li>
<li>修改 <code>task_init</code> 函数中修改为仅初始化一个进程，之后其余的进程均通过 <code>fork</code> 创建。</li>
</ul>
<h3 id="42">4.2 实现虚拟内存管理功能：</h3>
<ul>
<li>修改 <code>proc.h</code> 如下
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="cm">/* vm_area_struct vm_flags */</span><span class="w"></span>
<span class="cp">#define VM_READ     0x00000001</span>
<span class="cp">#define VM_WRITE    0x00000002</span>
<span class="cp">#define VM_EXEC     0x00000004</span>

<span class="k">struct</span><span class="w"> </span><span class="nc">vm_area_struct</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">mm_struct</span><span class="w"> </span><span class="o">*</span><span class="n">vm_mm</span><span class="p">;</span><span class="w">    </span><span class="cm">/* The mm_struct we belong to. */</span><span class="w"></span>
<span class="w">    </span><span class="kt">uint64_t</span><span class="w"> </span><span class="n">vm_start</span><span class="p">;</span><span class="w">          </span><span class="cm">/* Our start address within vm_mm. */</span><span class="w"></span>
<span class="w">    </span><span class="kt">uint64_t</span><span class="w"> </span><span class="n">vm_end</span><span class="p">;</span><span class="w">            </span><span class="cm">/* The first byte after our end address </span>
<span class="cm">                                    within vm_mm. */</span><span class="w"></span>

<span class="w">    </span><span class="cm">/* linked list of VM areas per task, sorted by address */</span><span class="w"></span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">vm_area_struct</span><span class="w"> </span><span class="o">*</span><span class="n">vm_next</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">vm_prev</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="kt">uint64_t</span><span class="w"> </span><span class="n">vm_flags</span><span class="p">;</span><span class="w">      </span><span class="cm">/* Flags as listed above. */</span><span class="w"></span>
<span class="p">};</span><span class="w"></span>

<span class="k">struct</span><span class="w"> </span><span class="nc">mm_struct</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">vm_area_struct</span><span class="w"> </span><span class="o">*</span><span class="n">mmap</span><span class="p">;</span><span class="w">       </span><span class="cm">/* list of VMAs */</span><span class="w"></span>
<span class="p">};</span><span class="w"></span>

<span class="k">struct</span><span class="w"> </span><span class="nc">task_struct</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">thread_info</span><span class="o">*</span><span class="w"> </span><span class="n">thread_info</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="kt">uint64_t</span><span class="w"> </span><span class="n">state</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="kt">uint64_t</span><span class="w"> </span><span class="n">counter</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="kt">uint64_t</span><span class="w"> </span><span class="n">priority</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="kt">uint64_t</span><span class="w"> </span><span class="n">pid</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">thread_struct</span><span class="w"> </span><span class="kr">thread</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="n">pagetable_t</span><span class="w"> </span><span class="n">pgd</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">mm_struct</span><span class="w"> </span><span class="o">*</span><span class="n">mm</span><span class="p">;</span><span class="w"></span>
<span class="p">};</span><span class="w"></span>
</code></pre></div>
</td></tr></table></li>
<li>每一个 vm_area_struct 都对应于进程地址空间的唯一区间。</li>
<li>为了支持 <code>Demand Paging</code>（见 4.3），我们需要支持对 vm_area_struct 的添加，查找。
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="cm">/*</span>
<span class="cm">* @mm          : current thread&#39;s mm_struct</span>
<span class="cm">* @address     : the va to look up</span>
<span class="cm">*</span>
<span class="cm">* @return      : the VMA if found or NULL if not found</span>
<span class="cm">*/</span><span class="w"></span>
<span class="k">struct</span><span class="w"> </span><span class="nc">vm_area_struct</span><span class="w"> </span><span class="o">*</span><span class="n">find_vma</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">mm_struct</span><span class="w"> </span><span class="o">*</span><span class="n">mm</span><span class="p">,</span><span class="w"> </span><span class="kt">uint64_t</span><span class="w"> </span><span class="n">addr</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>

<span class="p">}</span><span class="w"></span>

<span class="cm">/*</span>
<span class="cm"> * @mm     : current thread&#39;s mm_struct</span>
<span class="cm"> * @addr   : the suggested va to map</span>
<span class="cm"> * @length : memory size to map</span>
<span class="cm"> * @prot   : protection</span>
<span class="cm"> *</span>
<span class="cm"> * @return : start va</span>
<span class="cm">*/</span><span class="w"></span>
<span class="kt">uint64_t</span><span class="w"> </span><span class="n">do_mmap</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">mm_struct</span><span class="w"> </span><span class="o">*</span><span class="n">mm</span><span class="p">,</span><span class="w"> </span><span class="kt">uint64_t</span><span class="w"> </span><span class="n">addr</span><span class="p">,</span><span class="w"> </span><span class="kt">uint64_t</span><span class="w"> </span><span class="n">length</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">prot</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="cm">/*</span>
<span class="cm">    需要注意的是 do_mmap 中的 addr 可能无法被满足</span>
<span class="cm">    比如 addr 已经被占用, 因此需要判断，</span>
<span class="cm">    如果不合法，需要重新找到一个合适的位置进行映射。 </span>
<span class="cm">    */</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
</td></tr></table></li>
</ul>
<h3 id="43-page-fault-handler">4.3 Page Fault Handler</h3>
<ul>
<li><code>Demand Paging</code><ul>
<li>在映射页面时，我们不真正对页表进行修改，只在 <code>mm-&gt;mmap</code> 链表上添加一个 <code>vma</code> 记录。</li>
<li>当我们真正访问这个页面时，我们需要根据缺页的地址，找到其所在的 <code>vma</code>，根据 <code>vma</code> 中的信息对页表进行映射。</li>
</ul>
</li>
<li>修改 <code>task_init</code> 函数代码，更改为 <code>Demand Paging</code><ul>
<li>删除之前实验中对 <code>U-MODE</code> 代码，栈进行映射的代码</li>
<li>调用 <code>do_mmap</code> 函数，建立用户进程的虚拟地址空间信息，包括两个区域:<ul>
<li>代码区域, 该区域从虚拟地址 <code>USER_START</code> 开始，大小为 <code>uapp_end - uapp_start</code>， 权限为 <code>VM_READ | VM_WRITE | VM_EXEC</code></li>
<li>用户栈，范围为 <code>[USER_END - PGSIZE, USER_END)</code> ，权限为 <code>VM_READ | VM_WRITE</code></li>
</ul>
</li>
</ul>
</li>
<li>在完成上述修改之后，如果运行代码我们可以截获 一个 page fault. 如下图 （注意：由于试例代码以及正确处理 page fault， 所以我们可以看到一系列的page fault ）
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>// Instruction Page Fault
<span class="nv">scause</span> <span class="o">=</span> 0x000000000000000c, <span class="nv">sepc</span> <span class="o">=</span> 0x0000000000000000, <span class="nv">stval</span> <span class="o">=</span> 0x0000000000000000 

// Store/AMO Page Fault: sepc 是 code address， stval 是 写入的地址 <span class="o">(</span>位于 user stack 内<span class="o">)</span>。
<span class="nv">scause</span> <span class="o">=</span> 0x000000000000000f, <span class="nv">sepc</span> <span class="o">=</span> 0x0000000000000070, <span class="nv">stval</span> <span class="o">=</span> 0x0000003ffffffff8 

************************** uapp asm **************************
 .....

 Disassembly of section .text.main:

 000000000000006c &lt;main&gt;:
   6c:   fe010113                addi    sp,sp,-32
   <span class="m">70</span>:   00113c23                sd      ra,24<span class="o">(</span>sp<span class="o">)</span> &lt;- Page Fault
   <span class="m">74</span>:   <span class="m">00813823</span>                sd      s0,16<span class="o">(</span>sp<span class="o">)</span>
   <span class="m">78</span>:   <span class="m">02010413</span>                addi    s0,sp,32
   7c:   fbdff0ef                jal     ra,38 &lt;fork&gt;
   <span class="m">80</span>:   <span class="m">00050793</span>                mv      a5,a0
   <span class="m">84</span>:   fef42223                sw      a5,-28<span class="o">(</span>s0<span class="o">)</span>
   <span class="m">88</span>:   fe442783                lw      a5,-28<span class="o">(</span>s0<span class="o">)</span>

......
************************** uapp asm **************************
</code></pre></div>
</td></tr></table></li>
<li>实现 Page Fault 的检测与处理<ul>
<li>修改<code>trap.c</code>, 添加捕获 Page Fault 的逻辑</li>
<li>当捕获了 <code>Page Fault</code> 之后，需要实现缺页异常的处理函数  <code>do_page_fault</code>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="kt">void</span><span class="w"> </span><span class="nf">do_page_fault</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">pt_regs</span><span class="w"> </span><span class="o">*</span><span class="n">regs</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="cm">/*</span>
<span class="cm">    1. 通过 stval 获得访问出错的虚拟内存地址（Bad Address）</span>
<span class="cm">    2. 通过 sepc 获得当前的 Page Fault 类型</span>
<span class="cm">    3. 通过 find_vm() 找到匹配的 vm_area</span>
<span class="cm">    4. 通过 vm_area 的 vm_flags 对当前的 Page Fault 类型进行检查</span>
<span class="cm">        4.1 Instruction Page Fault      -&gt; VM_EXEC</span>
<span class="cm">        4.2 Load Page Fault             -&gt; VM_READ</span>
<span class="cm">        4.3 Store Page Fault            -&gt; VM_WRITE</span>
<span class="cm">    5. 最后调用 create_mapping 对页表进行映射</span>
<span class="cm">    */</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
</td></tr></table></li>
</ul>
</li>
</ul>
<h3 id="44-fork">4.4 实现 fork()</h3>
<ul>
<li>修改 <code>task_struct</code> 增加结构成员 <code>trapframe</code>， 如下：
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="k">struct</span><span class="w"> </span><span class="nc">task_struct</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">thread_info</span><span class="o">*</span><span class="w"> </span><span class="n">thread_info</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="kt">uint64_t</span><span class="w"> </span><span class="n">state</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="kt">uint64_t</span><span class="w"> </span><span class="n">counter</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="kt">uint64_t</span><span class="w"> </span><span class="n">priority</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="kt">uint64_t</span><span class="w"> </span><span class="n">pid</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">thread_struct</span><span class="w"> </span><span class="kr">thread</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="n">pagetable_t</span><span class="w"> </span><span class="n">pgd</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">mm_struct</span><span class="w"> </span><span class="o">*</span><span class="n">mm</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">pt_regs</span><span class="w"> </span><span class="o">*</span><span class="n">trapframe</span><span class="p">;</span><span class="w"></span>
<span class="p">};</span><span class="w"></span>
</code></pre></div>
</td></tr></table>
<code>trapframe</code> 成员用于保存异常上下文，当我们 <code>fork</code> 出来一个子进程时候，我们将父进程的上下文环境复制到子进程的 <code>trapframe</code> 中。当子进程被调度时候，我们可以通过 <code>trapframe</code> 来恢复上下文环境。</li>
<li>fork() 所调用的 syscall 为 SYS_CLONE，系统调用号为 220
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="cp">#define SYS_CLONE 220</span>
</code></pre></div>
</td></tr></table></li>
<li>实现 <code>clone</code>， 为了简单起见 <code>clone</code> 只接受一个参数 <code>pt_regs *</code>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="kt">void</span><span class="w"> </span><span class="nf">forkret</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">ret_from_fork</span><span class="p">(</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">trapframe</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kt">uint64_t</span><span class="w"> </span><span class="nf">do_fork</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">pt_regs</span><span class="w"> </span><span class="o">*</span><span class="n">regs</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="cm">/*</span>
<span class="cm">    1. 参考 task_init 创建一个新的 子进程, 将 thread.ra 设置为 forkret</span>
<span class="cm">    2. 为子进程申请 user stack, 并将父进程的 user stack 数据复制到其</span>
<span class="cm">       中. 同时将子进程的 user stack 的地址保存在 thread_info-&gt;user_sp 中</span>
<span class="cm">    3. 在 task_init 中我们进程的 user-mode sp 可以直接设置为 </span>
<span class="cm">       USER_END, 但是这里需要设置为当前进程(父进程)的 user-mode sp</span>
<span class="cm">    4. 将父进程上下文环境保存到子进程的 trapframe 中</span>
<span class="cm">    5. 将子进程的 trapframe-&gt;a0 修改为 0</span>
<span class="cm">    6. 复制父进程的 mm_struct 以及 vm_area_struct</span>
<span class="cm">    7. 创建子进程的页表 这里只做内核的映射,即 swapper_pg_dir</span>
<span class="cm">    8. 返回子进程的 pid</span>
<span class="cm">    */</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kt">uint64_t</span><span class="w"> </span><span class="nf">clone</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">pt_regs</span><span class="w"> </span><span class="o">*</span><span class="n">regs</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">do_fork</span><span class="p">(</span><span class="n">regs</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
</td></tr></table></li>
<li>参考 <code>_trap</code> 中的恢复逻辑 在 <code>entry.S</code> 中实现 <code>ret_from_fork</code>, 函数原型如下：<ul>
<li>注意恢复寄存器的顺序</li>
<li><code>_trap</code> 中是从 <code>stack</code> 上恢复，这里从 <code>trapframe</code> 中恢复
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="kt">void</span><span class="w"> </span><span class="nf">ret_from_fork</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">pt_regs</span><span class="w"> </span><span class="o">*</span><span class="n">trapframe</span><span class="p">);</span><span class="w"></span>
</code></pre></div>
</td></tr></table></li>
</ul>
</li>
<li>修改 <code>Page Fault</code> 处理:<ul>
<li>在之前的 <code>Page Fault</code> 处理中，我们对用户栈 <code>Page Fault</code> 处理方法是自由分配一页作为用户栈并映射到<code>[USER_END - PAGE_SIZE, USER_END)</code>的虚拟地址。但由 <code>fork</code> 创建的进程，它的用户栈已经拷贝完毕，因此 <code>Page Fault</code> 处理时直接为该页建立映射即可 ( 通过  <code>thread_info-&gt;user_sp</code> 来进行判断)。</li>
</ul>
</li>
</ul>
<h3 id="45">4.5 编译及测试</h3>
<ul>
<li>输出示例
    <table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>OpenSBI v0.9
     ____                    _____ ____ _____
    / __ <span class="se">\ </span>                 / ____<span class="p">|</span>  _ <span class="se">\_</span>   _<span class="p">|</span>
    <span class="p">|</span> <span class="p">|</span>  <span class="p">|</span> <span class="p">|</span>_ __   ___ _ __ <span class="p">|</span> <span class="o">(</span>___ <span class="p">|</span> <span class="p">|</span>_<span class="o">)</span> <span class="o">||</span> <span class="p">|</span>
    <span class="p">|</span> <span class="p">|</span>  <span class="p">|</span> <span class="p">|</span> <span class="s1">&#39;_ \ / _ \ &#39;</span>_ <span class="se">\ \_</span>__ <span class="se">\|</span>  _ &lt; <span class="p">|</span> <span class="p">|</span>
    <span class="p">|</span> <span class="p">|</span>__<span class="p">|</span> <span class="p">|</span> <span class="p">|</span>_<span class="o">)</span> <span class="p">|</span>  __/ <span class="p">|</span> <span class="p">|</span> <span class="p">|</span>____<span class="o">)</span> <span class="p">|</span> <span class="p">|</span>_<span class="o">)</span> <span class="o">||</span> <span class="p">|</span>_
    <span class="se">\_</span>___/<span class="p">|</span> .__/ <span class="se">\_</span>__<span class="p">|</span>_<span class="p">|</span> <span class="p">|</span>_<span class="p">|</span>_____/<span class="p">|</span>____/_____<span class="p">|</span>
        <span class="p">|</span> <span class="p">|</span>
        <span class="p">|</span>_<span class="p">|</span>

    ...

    Boot HART MIDELEG         : 0x0000000000000222
    Boot HART MEDELEG         : 0x000000000000b109

    ...mm_init <span class="k">done</span>!
    ...proc_init <span class="k">done</span>!
    <span class="o">[</span>S-MODE<span class="o">]</span> Hello RISC-V

    <span class="nv">scause</span> <span class="o">=</span> 0x000000000000000c, <span class="nv">sepc</span> <span class="o">=</span> 0x0000000000000000, <span class="nv">stval</span> <span class="o">=</span> 0x0000000000000000
    <span class="nv">scause</span> <span class="o">=</span> 0x000000000000000f, <span class="nv">sepc</span> <span class="o">=</span> 0x0000000000000070, <span class="nv">stval</span> <span class="o">=</span> 0x0000003ffffffff8
    <span class="o">[</span><span class="nv">PID</span> <span class="o">=</span> <span class="m">1</span><span class="o">]</span> fork <span class="o">[</span><span class="nv">PID</span> <span class="o">=</span> <span class="m">2</span><span class="o">]</span>
    <span class="o">[</span><span class="nv">PID</span> <span class="o">=</span> <span class="m">1</span><span class="o">]</span> fork <span class="o">[</span><span class="nv">PID</span> <span class="o">=</span> <span class="m">3</span><span class="o">]</span>
    <span class="o">[</span><span class="nv">PID</span> <span class="o">=</span> <span class="m">1</span><span class="o">]</span> is running!

    <span class="nv">scause</span> <span class="o">=</span> 0x000000000000000c, <span class="nv">sepc</span> <span class="o">=</span> 0x0000000000000050, <span class="nv">stval</span> <span class="o">=</span> 0x0000000000000050
    <span class="nv">scause</span> <span class="o">=</span> 0x000000000000000f, <span class="nv">sepc</span> <span class="o">=</span> 0x0000000000000054, <span class="nv">stval</span> <span class="o">=</span> 0x0000003fffffffc8
    <span class="o">[</span><span class="nv">PID</span> <span class="o">=</span> <span class="m">3</span><span class="o">]</span> is running!

    <span class="nv">scause</span> <span class="o">=</span> 0x000000000000000c, <span class="nv">sepc</span> <span class="o">=</span> 0x0000000000000050, <span class="nv">stval</span> <span class="o">=</span> 0x0000000000000050
    <span class="nv">scause</span> <span class="o">=</span> 0x000000000000000f, <span class="nv">sepc</span> <span class="o">=</span> 0x0000000000000054, <span class="nv">stval</span> <span class="o">=</span> 0x0000003fffffffc8
    <span class="o">[</span><span class="nv">PID</span> <span class="o">=</span> <span class="m">2</span><span class="o">]</span> fork <span class="o">[</span><span class="nv">PID</span> <span class="o">=</span> <span class="m">4</span><span class="o">]</span>
    <span class="o">[</span><span class="nv">PID</span> <span class="o">=</span> <span class="m">2</span><span class="o">]</span> is running!

    <span class="o">[</span><span class="nv">PID</span> <span class="o">=</span> <span class="m">1</span><span class="o">]</span> is running!

    <span class="nv">scause</span> <span class="o">=</span> 0x000000000000000c, <span class="nv">sepc</span> <span class="o">=</span> 0x0000000000000050, <span class="nv">stval</span> <span class="o">=</span> 0x0000000000000050
    <span class="nv">scause</span> <span class="o">=</span> 0x000000000000000f, <span class="nv">sepc</span> <span class="o">=</span> 0x0000000000000054, <span class="nv">stval</span> <span class="o">=</span> 0x0000003fffffffc8
    <span class="o">[</span><span class="nv">PID</span> <span class="o">=</span> <span class="m">4</span><span class="o">]</span> is running!

    <span class="o">[</span><span class="nv">PID</span> <span class="o">=</span> <span class="m">3</span><span class="o">]</span> is running!

    <span class="o">[</span><span class="nv">PID</span> <span class="o">=</span> <span class="m">2</span><span class="o">]</span> is running!
    ...
</code></pre></div>
</td></tr></table></li>
</ul>
<h2 id="_1">作业提交</h2>
<p>同学需要提交实验报告以及整个工程代码。在提交前请使用 <code>make clean</code> 清除所有构建产物。</p>

              
            </article>
          </div>
        </div>
        
          <a href="#" class="md-top md-icon" data-md-component="top" data-md-state="hidden">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12Z"/></svg>
            Back to top
          </a>
        
      </main>
      
        <footer class="md-footer">
  
    <nav class="md-footer__inner md-grid" aria-label="Footer">
      
        
        <a href="../lab5/" class="md-footer__link md-footer__link--prev" aria-label="Previous: 实验指导五" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Previous
              </span>
              实验指导五
            </div>
          </div>
        </a>
      
      
        
        <a href="../faq/" class="md-footer__link md-footer__link--next" aria-label="Next: 常见问题及解答" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Next
              </span>
              常见问题及解答
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"/></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "..", "features": ["navigation.top"], "search": "../assets/javascripts/workers/search.2a1c317c.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version.title": "Select version"}}</script>
    
    
      <script src="../assets/javascripts/bundle.6e54b5cd.min.js"></script>
      
        <script src="../javascripts/mathjax.js"></script>
      
        <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
      
        <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
      
    
  </body>
</html>